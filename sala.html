<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Memorial</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --bg:#18191a;
    --surface:#242526;
    --surface2:#2d2e30;
    --text:#e4e6eb;
    --muted:#b0b3b8;
    --line:#3a3b3c;

    --primary:#0866ff;
    --primary2:#0b5cff;
    --primarySoft: rgba(8,102,255,.16);

    --good:#31a24c;
    --danger:#ff5b5b;

    --shadow:0 10px 22px rgba(0,0,0,.35);
  }

  *{ box-sizing:border-box; }
  html,body{ width:100%; max-width:100%; overflow-x:hidden; }
  body{
    margin:0;
    background: var(--bg);
    color: var(--text);
    font-family: Arial, sans-serif;
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* ===================== TOPBAR ===================== */
  .topbar{
    position: sticky; top:0; z-index:9999;
    background: var(--surface);
    border-bottom: 1px solid var(--line);
    box-shadow: 0 2px 14px rgba(0,0,0,.35);
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:flex-start;
    gap:12px;
    padding-top: calc(10px + env(safe-area-inset-top));
  }
  .brand{
    font-weight:900;
    color: var(--text);
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .btn{
    border:none;
    cursor:pointer;
    font-weight:900;
    padding:10px 12px;
    border-radius:999px;
    background: var(--primary);
    color:#fff;
    user-select:none;
    display:inline-flex;
    align-items:center;
    gap:8px;
    justify-content:center;
    text-decoration:none;
    transition:.15s;
    white-space:nowrap;
  }
  .btn:hover{ background: var(--primary2); }
  .btn:active{ transform:scale(.99); }
  .btn.ghost{
    background: rgba(255,255,255,.06);
    color: var(--text);
    border:1px solid rgba(255,255,255,.10);
  }
  .btn.ghost:hover{ background: rgba(255,255,255,.09); }
  .btn.icon{ width:44px; height:44px; padding:0; }

  /* ====================== LOGIN ====================== */
  .login-overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.72);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 9999999;
    padding: 16px;
  }
  .login-card{
    width: min(520px, 94vw);
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 18px;
    text-align:center;
  }
  .login-title{
    font-size: clamp(18px, 6vw, 24px);
    font-weight: 900;
    color: var(--primary);
    letter-spacing:.3px;
    margin: 4px 0 14px 0;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .login-input{
    width:100%;
    background: var(--surface2);
    border:1px solid var(--line);
    border-radius: 999px;
    padding: 14px 18px;
    color: var(--text);
    outline:none;
    font-size: 16px;
  }
  .login-input:focus{
    border-color: rgba(8,102,255,.65);
    box-shadow: 0 0 0 4px var(--primarySoft);
  }
  .login-btn{
    width: 100%;
    margin-top: 12px;
    border:none;
    border-radius: 999px;
    padding: 14px 12px;
    font-weight: 900;
    cursor:pointer;
    font-size: 16px;
    transition:.18s;
    background: var(--primary);
    color:#fff;
  }
  .login-btn:hover{ background: var(--primary2); }

  /* ✅ input file NÃO pode display:none */
  .filePicker{
    position:absolute;
    left:-99999px;
    top:0;
    width:1px;
    height:1px;
    opacity:0;
  }

  .wrap{ width:min(1100px, 100%); margin: 0 auto; padding: 12px; }

  /* ===================== HEADER PERFIL ===================== */
  .hero{
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,.22);
    padding: 14px;
  }
  .heroTop{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .meLeft{ display:flex; gap:12px; align-items:center; min-width:0; }
  .meAvatar{
    width:56px; height:56px; border-radius:50%;
    overflow:hidden;
    background:#3a3b3c;
    border: 2px solid var(--surface);
    box-shadow: 0 1px 10px rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    flex:0 0 auto;
  }
  .meAvatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .meInit{ font-weight:900; color: var(--text); }
  .meText{ min-width:0; }
  .meTitle{
    font-weight:900;
    font-size: 18px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 68vw;
  }
  .meSub{
    color: var(--muted);
    font-weight:900;
    font-size: 13px;
    margin-top:4px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .pill{
    display:inline-flex;
    gap:8px;
    align-items:center;
    padding:7px 12px;
    border-radius:999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    color: var(--text);
    font-weight:900;
    font-size:13px;
  }
  .onlineDot{
    width:10px; height:10px; border-radius:50%;
    background: var(--good);
    box-shadow: 0 0 0 2px rgba(49,162,76,.18);
    animation: blinkDot .9s infinite;
  }
  @keyframes blinkDot{
    0%,100%{ transform:scale(1); opacity:1; }
    50%{ transform:scale(1.25); opacity:.35; }
  }

  /* botões abaixo do nome (como pedido) */
  .heroActions{
    margin-top: 12px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .heroActions .btn{ flex: 1 1 180px; }
  @media (max-width:520px){
    .heroActions .btn{ flex: 1 1 100%; }
  }

  /* ===================== SEÇÕES ===================== */
  .sectionTitle{
    margin: 14px 2px 10px 2px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .sectionTitle .left{
    font-weight: 900;
    letter-spacing: .2px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .tiny{ font-size:12px; color: var(--muted); font-weight:900; }

  .card{
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding:12px;
    box-shadow: 0 6px 18px rgba(0,0,0,.25);
  }

  /* ===================== ORGANIZADO: UPLOAD BOX ===================== */
  .field{ display:flex; flex-direction:column; gap:7px; margin-bottom:12px; }
  .label{ font-weight:900; color: var(--muted); font-size:13px; letter-spacing:.2px; }
  .input, .textarea{
    width:100%;
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding: 12px 12px;
    color: var(--text);
    outline:none;
    font-size:15px;
  }
  .input:focus, .textarea:focus{
    border-color: rgba(8,102,255,.65);
    box-shadow: 0 0 0 4px var(--primarySoft);
    background: rgba(255,255,255,.07);
  }
  .textarea{ min-height: 90px; resize: vertical; }

  .uploadBox{
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    padding: 12px;
  }
  .uploadTop{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .uploadTitle{
    display:flex; align-items:center; gap:10px;
    font-weight:900;
    letter-spacing:.2px;
  }
  .miniStat{
    font-weight:900;
    font-size:12px;
    color: var(--muted);
    padding: 6px 10px;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.22);
  }
  .dropArea{
    margin-top:10px;
    border-radius: 16px;
    border: 1px dashed rgba(255,255,255,.20);
    background: rgba(0,0,0,.18);
    padding: 12px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .dropText{
    color: var(--muted);
    font-weight:900;
    line-height:1.35;
  }
  .rowBtns{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

  .previewGrid{
    margin-top: 12px;
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:8px;
  }
  @media (max-width: 880px){ .previewGrid{ grid-template-columns: repeat(4, 1fr);} }
  @media (max-width: 640px){ .previewGrid{ grid-template-columns: repeat(3, 1fr);} }

  .pItem{
    position:relative;
    border-radius: 14px;
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.10);
    background:#000;
    height: 110px;
  }
  .pItem img, .pItem video{
    width:100%; height:100%;
    object-fit: cover;
    display:block;
  }
  .removeBtn{
    position:absolute;
    top:6px; right:6px;
    width:28px; height:28px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.55);
    color: #fff;
    font-weight:900;
    cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    user-select:none;
  }
  .removeBtn:hover{ background: rgba(0,0,0,.70); }
  .removeBtn:active{ transform: scale(.96); }

  .mutedHint{
    color: var(--muted);
    font-weight:900;
    font-size: 13px;
    padding: 10px;
    border-radius: 14px;
    border: 1px dashed rgba(255,255,255,.14);
    background: rgba(255,255,255,.03);
    margin-top: 10px;
    line-height:1.35;
  }

  .dangerBtn{
    background: rgba(255,91,91,.12) !important;
    border: 1px solid rgba(255,91,91,.35) !important;
    color: #ffd6d6 !important;
  }
  .dangerBtn:hover{ background: rgba(255,91,91,.18) !important; }

  /* ===================== GRID DE ÁLBUNS (dono acima + capa abaixo) ===================== */
  .albumsGrid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
  }
  @media (max-width: 980px){ .albumsGrid{ grid-template-columns: repeat(3, 1fr);} }
  @media (max-width: 700px){ .albumsGrid{ grid-template-columns: repeat(2, 1fr);} }
  @media (max-width: 420px){ .albumsGrid{ grid-template-columns: 1fr;} }

  .albumCard{
    border-radius: 16px;
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    box-shadow: 0 10px 18px rgba(0,0,0,.22);
    cursor:pointer;
    user-select:none;
    display:flex;
    flex-direction:column;
    min-height: 220px;
  }
  .albumOwnerTop{
    display:flex;
    align-items:center;
    gap:10px;
    padding: 10px 10px 8px 10px;
    background: rgba(0,0,0,.18);
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  .oAva{
    width:30px; height:30px;
    border-radius:50%;
    overflow:hidden;
    background:#3a3b3c;
    display:flex; align-items:center; justify-content:center;
    flex:0 0 auto;
  }
  .oAva img{ width:100%; height:100%; object-fit:cover; display:block; }
  .oInit{ font-weight:900; font-size:12px; color: var(--text); }
  .oName{
    font-weight:900;
    font-size: 13px;
    color: var(--text);
    max-width: 70%;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .albumCoverBox{
    width:100%;
    aspect-ratio: 1 / 1;
    background:#000;
    position:relative;
  }
  .albumCoverBox img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    opacity:.95;
  }
  .albumBottom{
    padding: 10px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .albumTitle{
    font-weight:900;
    font-size: 14px;
    line-height:1.2;
    overflow:hidden;
    text-overflow:ellipsis;
    display:-webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  .albumMetaTiny{
    font-weight:900;
    font-size: 12px;
    color: var(--muted);
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  /* ===================== MODAIS ===================== */
  .modalOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.72);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 9999998;
    padding: 14px;
  }
  .modalCard{
    width: min(860px, 96vw);
    max-height: min(92vh, 900px);
    overflow:auto;
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 14px;
  }
  .modalTop{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    position: sticky;
    top: 0;
    background: linear-gradient(180deg, rgba(36,37,38,1) 0%, rgba(36,37,38,.92) 100%);
    padding: 8px 0 10px 0;
    z-index: 2;
  }
  .modalTitle{
    font-weight:900;
    letter-spacing:.2px;
    display:flex; align-items:center; gap:10px;
  }

  /* ===================== ALBUM VIEW ===================== */
  .albumHeader{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .albumHeroLeft{ display:flex; gap:12px; align-items:center; min-width:0; }
  .albumHeroCover{
    width:86px; height:86px;
    border-radius: 16px;
    overflow:hidden;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 18px rgba(0,0,0,.22);
    flex:0 0 auto;
  }
  .albumHeroCover img{ width:100%; height:100%; object-fit:cover; display:block; background:#000; }
  .albumHeroText{ min-width: 220px; max-width: 760px; }
  .albumHeroText h2{
    margin:0;
    font-size: 20px;
    font-weight: 900;
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .albumHeroText .desc{
    margin-top:6px;
    color: var(--muted);
    font-weight: 900;
    font-size: 13px;
    line-height:1.35;
    word-break: break-word;
  }

  .mediaSection{
    margin-top: 14px;
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    padding: 12px;
  }
  .secTitle{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-weight:900;
    letter-spacing:.2px;
  }
  .mediaGrid{
    margin-top: 12px;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  @media (max-width: 820px){ .mediaGrid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 520px){ .mediaGrid{ grid-template-columns: 1fr; } }

  .mediaItem{
    border-radius: 14px;
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.10);
    background:#000;
    cursor: pointer;
  }
  .mediaItem img, .mediaItem video{
    width:100%;
    height: 220px;
    object-fit: cover;
    display:block;
    background:#000;
  }
  .mediaItem video{ height: 240px; }

  /* toast */
  .toast{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(14px + env(safe-area-inset-bottom));
    background: rgba(0,0,0,.72);
    border: 1px solid rgba(255,255,255,.14);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 999px;
    box-shadow: var(--shadow);
    display:none;
    z-index: 9999999;
    font-weight:900;
  }

  /* ===================== FOTO VIEWER (Swipe) ===================== */
  .viewerOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.92);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 99999999;
    touch-action: none;
  }
  .viewerTop{
    position:absolute;
    left:0; right:0; top:0;
    padding-top: env(safe-area-inset-top);
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    pointer-events:none;
  }
  .viewerTop .vLeft, .viewerTop .vRight, .viewerTop .vCenter{ pointer-events:auto; }
  .viewerTop .vCenter{
    flex:1;
    display:flex;
    justify-content:center;
    min-width:0;
  }
  .viewerCounter{
    font-weight:900;
    color:#fff;
    background: rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.16);
    padding: 8px 12px;
    border-radius: 999px;
    max-width: 72vw;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .viewerBtn{
    width:44px; height:44px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.45);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;
  }
  .viewerBtn:active{ transform: scale(.98); }
  .viewerStage{
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .viewerImg{
    max-width: 100vw;
    max-height: 100vh;
    width: 100%;
    height: 100%;
    object-fit: contain;
    user-select:none;
    -webkit-user-drag: none;
  }
  .viewerHint{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom: calc(16px + env(safe-area-inset-bottom));
    color:#fff;
    font-weight:900;
    font-size: 12px;
    opacity:.85;
    background: rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.12);
    padding: 8px 12px;
    border-radius: 999px;
    pointer-events:none;
  }
  @media (min-width: 820px){
    .viewerHint{ display:none; }
  }

  /* painel simples (sem tabs) */
  .panel{ display:none; }
  .panel.active{ display:block; }
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-title"><i class="fa-solid fa-user"></i> ENTRAR</div>
    <input id="loginName" class="login-input" maxlength="24" placeholder="Digite seu nome" autocomplete="off">
    <button class="login-btn" onclick="confirmarNome()">Entrar</button>
    <div class="tiny" style="margin-top:10px; line-height:1.35;">
      Você cria álbuns com <b>capa</b>, <b>fotos</b> e <b>vídeos</b>.<br>
      Limite: <b>até 10 fotos</b> e <b>até 10 vídeos</b> por álbum.
    </div>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <button class="btn ghost icon" title="Voltar" aria-label="Voltar" onclick="voltarHome()">
    <i class="fa-solid fa-arrow-left"></i>
  </button>
  <!-- ✅ título Memorial do lado esquerdo -->
  <div class="brand">MEMORIAL</div>
</div>

<div class="wrap">

  <!-- ✅ nome + foto do usuário logado, e abaixo botões -->
  <div class="hero">
    <div class="heroTop">
      <div class="meLeft">
        <div class="meAvatar" id="meAvatarBox" title="Avatar do usuário">
          <img id="meAvatarImg" style="display:none;" alt="Sua foto">
          <div id="meAvatarInit" class="meInit">U</div>
        </div>
        <div class="meText">
          <div class="meTitle" id="meName">—</div>
          <div class="meSub">
            <span class="pill"><span class="onlineDot"></span> Online</span>
            <span class="pill"><i class="fa-solid fa-folder-open"></i> <span id="myAlbumsCount">0</span> álbuns</span>
          </div>
        </div>
      </div>

      <div class="rowBtns" style="justify-content:flex-end;">
        <button class="btn ghost" onclick="recarregarTudo()"><i class="fa-solid fa-rotate"></i> Recarregar</button>
      </div>
    </div>

    <!-- ✅ abaixo do nome: Criar álbum e Meus álbuns -->
    <div class="heroActions">
      <button class="btn" onclick="abrirModalCriarAlbum()"><i class="fa-solid fa-plus"></i> Criar álbum</button>
      <button class="btn ghost" onclick="setPanel('my')"><i class="fa-solid fa-user"></i> Meus álbuns</button>
      <button class="btn ghost" onclick="setPanel('albums')"><i class="fa-solid fa-images"></i> Memórias</button>
    </div>
  </div>

  <!-- ✅ Título "Memórias" -->
  <div class="sectionTitle">
    <div class="left"><i class="fa-solid fa-images" style="color:var(--primary)"></i> Memórias</div>
    <div class="tiny" id="allAlbumsCount">0 álbuns</div>
  </div>

  <!-- ÁLBUNS (todos) -->
  <div class="panel active" id="panel_albums">
    <div class="card">
      <div id="albumsGrid" class="albumsGrid"></div>
      <div id="albumsEmpty" class="mutedHint" style="display:none;">
        Ainda não existe nenhum álbum. Clique em <b>Criar álbum</b> para começar.
      </div>
    </div>
  </div>

  <!-- MEUS ÁLBUNS -->
  <div class="panel" id="panel_my" style="margin-top:12px;">
    <div class="card">
      <div class="sectionTitle" style="margin:0 0 10px 0;">
        <div class="left"><i class="fa-solid fa-user" style="color:var(--primary)"></i> Meus álbuns</div>
        <div class="tiny" id="onlyMyCount">0 álbuns</div>
      </div>
      <div id="myAlbumsGrid" class="albumsGrid"></div>
      <div id="myAlbumsEmpty" class="mutedHint" style="display:none;">
        Você ainda não criou nenhum álbum.
      </div>
    </div>
  </div>

</div>

<!-- ===================== MODAL: CRIAR/EDITAR ALBUM ===================== -->
<div class="modalOverlay" id="modalAlbum">
  <div class="modalCard">
    <div class="modalTop">
      <div class="modalTitle" id="albumModalTitle"><i class="fa-solid fa-folder-plus" style="color:var(--primary)"></i> Criar álbum</div>
      <button class="btn ghost icon" onclick="fecharModal('modalAlbum')" aria-label="Fechar"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="field">
      <div class="label">Título do álbum</div>
      <input id="albumTitle" class="input" maxlength="60" placeholder="Ex: Meu Pai de Santo • 2025">
    </div>

    <div class="field">
      <div class="label">Descrição do álbum (opcional)</div>
      <textarea id="albumDesc" class="textarea" maxlength="600" placeholder="Escreva uma descrição..."></textarea>
    </div>

    <!-- CAPA -->
    <div class="uploadBox">
      <div class="uploadTop">
        <div class="uploadTitle"><i class="fa-solid fa-image" style="color:var(--primary)"></i> Capa do álbum</div>
        <div class="miniStat" id="albumCoverStatus">Nenhuma capa selecionada</div>
      </div>

      <div class="dropArea">
        <div class="dropText">
          Escolha uma imagem para ser a capa do álbum.<br>
          <span style="opacity:.9;">(melhor em formato quadrado)</span>
        </div>
        <div class="rowBtns">
          <button class="btn ghost" onclick="pickAlbumCover()"><i class="fa-solid fa-folder-open"></i> Selecionar capa</button>
          <button class="btn ghost" onclick="clearCover()" title="Remover seleção"><i class="fa-solid fa-eraser"></i></button>
        </div>
      </div>

      <input id="albumCoverInput" class="filePicker" type="file" accept="image/*">

      <div id="albumCoverPreview" style="margin-top:12px; display:none;">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <div class="albumHeroCover" style="width:140px; height:140px;">
            <img id="albumCoverPreviewImg" alt="Prévia da capa">
          </div>
          <div class="tiny" id="albumCoverHint">Prévia da capa.</div>
        </div>
      </div>
    </div>

    <!-- FOTOS -->
    <div class="uploadBox" style="margin-top:12px;">
      <div class="uploadTop">
        <div class="uploadTitle"><i class="fa-solid fa-images" style="color:var(--primary)"></i> Fotos do álbum</div>
        <div class="miniStat"><span id="albumPhotosCount">0</span> / 10</div>
      </div>

      <div class="dropArea">
        <div class="dropText">
          Selecione até <b>10 fotos</b>.<br>
          <span style="opacity:.9;">Você pode remover fotos clicando no ✕.</span>
        </div>
        <div class="rowBtns">
          <button class="btn ghost" onclick="pickAlbumPhotos()"><i class="fa-solid fa-folder-open"></i> Selecionar fotos</button>
          <button class="btn ghost" onclick="clearPhotos()" title="Limpar seleção"><i class="fa-solid fa-broom"></i></button>
        </div>
      </div>

      <input id="albumPhotosInput" class="filePicker" type="file" accept="image/*" multiple>

      <div id="albumPhotosPreviewWrap" style="display:none;">
        <div class="previewGrid" id="albumPhotosPreviewGrid"></div>
      </div>

      <div class="tiny" id="albumPhotosStatus" style="margin-top:10px;">Nenhuma foto selecionada.</div>
    </div>

    <!-- VÍDEOS -->
    <div class="uploadBox" style="margin-top:12px;">
      <div class="uploadTop">
        <div class="uploadTitle"><i class="fa-solid fa-video" style="color:var(--primary)"></i> Vídeos do álbum</div>
        <div class="miniStat"><span id="albumVideosCount">0</span> / 10</div>
      </div>

      <div class="dropArea">
        <div class="dropText">
          Selecione até <b>10 vídeos</b>.<br>
          <span style="opacity:.9;">Remova vídeos clicando no ✕.</span>
        </div>
        <div class="rowBtns">
          <button class="btn ghost" onclick="pickAlbumVideos()"><i class="fa-solid fa-folder-open"></i> Selecionar vídeos</button>
          <button class="btn ghost" onclick="clearVideos()" title="Limpar seleção"><i class="fa-solid fa-broom"></i></button>
        </div>
      </div>

      <input id="albumVideosInput" class="filePicker" type="file" accept="video/*" multiple>

      <div id="albumVideosPreviewWrap" style="display:none;">
        <div class="previewGrid" id="albumVideosPreviewGrid"></div>
      </div>

      <div class="tiny" id="albumVideosStatus" style="margin-top:10px;">Nenhum vídeo selecionado.</div>
    </div>

    <div class="rowBtns" style="margin-top:14px; justify-content:space-between;">
      <div class="tiny" id="albumModeHint">Modo: Criar</div>
      <div class="rowBtns">
        <button class="btn" id="albumSaveBtn" onclick="salvarAlbum()"><i class="fa-solid fa-check"></i> Salvar</button>
        <button class="btn ghost" onclick="fecharModal('modalAlbum')"><i class="fa-solid fa-ban"></i> Cancelar</button>
      </div>
    </div>

    <div class="tiny" style="margin-top:12px; line-height:1.35;">
      Ao salvar, o álbum aparece para todos na galeria com capa + dono. Ao clicar, mostra tudo.
    </div>
  </div>
</div>

<!-- ===================== MODAL: VER ALBUM ===================== -->
<div class="modalOverlay" id="modalViewAlbum">
  <div class="modalCard">
    <div class="modalTop">
      <div class="modalTitle"><i class="fa-solid fa-images" style="color:var(--primary)"></i> Álbum</div>
      <button class="btn ghost icon" onclick="fecharModal('modalViewAlbum')" aria-label="Fechar"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div id="albumViewTop"></div>

    <div class="rowBtns" id="albumOwnerActions" style="margin-top:12px; display:none;">
      <button class="btn ghost" onclick="editarAlbumAtual()"><i class="fa-solid fa-pen"></i> Editar</button>
      <button class="btn ghost dangerBtn" onclick="excluirAlbumAtual()"><i class="fa-solid fa-trash"></i> Excluir</button>
    </div>

    <div class="mutedHint" id="albumNotOwnerHint" style="display:none; margin-top:12px;">
      Você está vendo este álbum como visitante (somente leitura).
    </div>

    <div id="albumBody"></div>
  </div>
</div>

<!-- ===================== FOTO VIEWER SWIPE ===================== -->
<div class="viewerOverlay" id="photoViewer">
  <div class="viewerTop">
    <div class="vLeft">
      <div class="viewerBtn" onclick="closePhotoViewer()" title="Fechar"><i class="fa-solid fa-xmark"></i></div>
    </div>
    <div class="vCenter">
      <div class="viewerCounter" id="viewerCounter">1/1</div>
    </div>
    <div class="vRight">
      <div class="viewerBtn" onclick="toggleViewerUI()" title="Ocultar/Mostrar HUD"><i class="fa-solid fa-eye"></i></div>
    </div>
  </div>

  <div class="viewerStage" id="viewerStage">
    <img id="viewerImg" class="viewerImg" alt="Foto">
  </div>

  <div class="viewerHint">Arraste para o lado (← →) para passar as fotos</div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
/* ====================== URLs ====================== */
const SITE_HOME_URL  = "https://marcio2307.github.io/terreiro/site.html";

/* ====================== FIREBASE ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6aabf41e9.png"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();
const ST = firebase.storage();

/* ====================== HELPERS ====================== */
function escapeHTML(str){
  str = (str == null ? "" : String(str));
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 1700);
}
function randId(prefix="id"){
  return prefix + "_" + Date.now() + "_" + Math.random().toString(36).slice(2);
}
function voltarHome(){
  const nome = (localStorage.getItem("nome_passageiro") || "").trim();
  const uid  = (localStorage.getItem("uid_passageiro") || "").trim();
  if(nome) sessionStorage.setItem("nome_passageiro", nome);
  if(uid)  sessionStorage.setItem("uid_passageiro", uid);
  window.location.href = SITE_HOME_URL;
}
function recarregarTudo(){
  toast("Recarregando...");
  setTimeout(()=> location.reload(), 200);
}

/* ====================== LOGIN + UID ====================== */
function getOrCreateUID(){
  let uid = localStorage.getItem("uid_passageiro");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem("uid_passageiro", uid);
  }
  sessionStorage.setItem("uid_passageiro", uid);
  return uid;
}
let UID = getOrCreateUID();

function getNomeSalvo(){
  return (localStorage.getItem("nome_passageiro") || "").trim();
}
let USER_NAME = getNomeSalvo();

const loginOverlay = document.getElementById("loginOverlay");
const loginName = document.getElementById("loginName");

function abrirLogin(){
  loginOverlay.style.display = "flex";
  document.body.style.overflow = "hidden";
  setTimeout(()=>{ try{ loginName.focus(); }catch(e){} }, 50);
}
function fecharLogin(){
  loginOverlay.style.display = "none";
  document.body.style.overflow = "";
}
function confirmarNome(){
  let nome = (loginName.value || "").trim();
  if(nome.length < 2){
    alert("Digite um nome com pelo menos 2 letras.");
    try{ loginName.focus(); }catch(e){}
    return;
  }
  localStorage.setItem("nome_passageiro", nome);
  sessionStorage.setItem("nome_passageiro", nome);
  USER_NAME = nome;
  UID = getOrCreateUID();
  fecharLogin();
  ensureMyProfile();
  setTimeout(()=>{ location.reload(); }, 80);
}
(function exigirLogin(){
  if(!USER_NAME) abrirLogin();
})();
document.addEventListener("keydown", (e)=>{
  if(loginOverlay.style.display === "flex" && e.key === "Enter"){ confirmarNome(); }
});

/* ====================== PERFIL (profiles/{uid}) ====================== */
const MY_PROFILE_REF = ()=> DB.ref("profiles/" + UID);

async function ensureMyProfile(){
  if(!USER_NAME) return;
  const ref = MY_PROFILE_REF();
  const snap = await ref.once("value");
  if(!snap.exists()){
    await ref.set({
      uid: UID,
      name: USER_NAME,
      avatarDataUrl: "",
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    });
  }else{
    const p = snap.val() || {};
    if(!p.name || p.name !== USER_NAME){
      await ref.update({ name: USER_NAME, updatedAt: firebase.database.ServerValue.TIMESTAMP });
    }
  }
}
async function getMyProfile(){
  const snap = await MY_PROFILE_REF().once("value");
  return snap.val() || { uid: UID, name: USER_NAME, avatarDataUrl: "" };
}

/* ====================== UI PERFIL (nome + foto) ====================== */
const meNameEl = document.getElementById("meName");
const meAvatarImg  = document.getElementById("meAvatarImg");
const meAvatarInit = document.getElementById("meAvatarInit");

function setMyAvatar(url, name){
  if(url){
    meAvatarImg.src = url;
    meAvatarImg.style.display = "block";
    meAvatarInit.style.display = "none";
  }else{
    meAvatarImg.style.display = "none";
    meAvatarInit.style.display = "flex";
    meAvatarInit.textContent = initials(name || "U");
  }
}

/* ====================== PAINÉIS ====================== */
function setPanel(which){
  document.getElementById("panel_albums").classList.remove("active");
  document.getElementById("panel_my").classList.remove("active");
  document.getElementById("panel_"+which).classList.add("active");
}

/* ====================== MODAIS ====================== */
function abrirModal(id){
  document.getElementById(id).style.display = "flex";
  document.body.style.overflow = "hidden";
}
function fecharModal(id){
  document.getElementById(id).style.display = "none";
  document.body.style.overflow = "";
}

/* ====================== STORAGE UPLOAD ====================== */
const MAX_IMG_MB = 12;
function checkImgSize(file){
  const mb = file.size/(1024*1024);
  if(mb > MAX_IMG_MB){
    alert(`Arquivo muito grande (${mb.toFixed(1)}MB). Envie até ${MAX_IMG_MB}MB (imagens).`);
    return false;
  }
  return true;
}
async function uploadToStorage(file, folder){
  const ext = (file.name || "").split(".").pop().toLowerCase() || "bin";
  const name = (Date.now() + "_" + Math.random().toString(36).slice(2) + "." + ext);
  const path = `${folder}/${name}`;
  const ref = ST.ref().child(path);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  return { url, path };
}

/* ====================== DADOS: ÁLBUNS ====================== */
const ALBUMS_REF = DB.ref("albums");

/* ====================== UI: CRIAR/EDITAR ====================== */
const albumModalTitle = document.getElementById("albumModalTitle");
const albumModeHint = document.getElementById("albumModeHint");
const albumSaveBtn = document.getElementById("albumSaveBtn");

const albumCoverInput = document.getElementById("albumCoverInput");
const albumCoverStatus = document.getElementById("albumCoverStatus");
const albumCoverPreview = document.getElementById("albumCoverPreview");
const albumCoverPreviewImg = document.getElementById("albumCoverPreviewImg");

const albumPhotosInput = document.getElementById("albumPhotosInput");
const albumPhotosCountEl = document.getElementById("albumPhotosCount");
const albumPhotosStatus = document.getElementById("albumPhotosStatus");
const albumPhotosPreviewWrap = document.getElementById("albumPhotosPreviewWrap");
const albumPhotosPreviewGrid = document.getElementById("albumPhotosPreviewGrid");

const albumVideosInput = document.getElementById("albumVideosInput");
const albumVideosCountEl = document.getElementById("albumVideosCount");
const albumVideosStatus = document.getElementById("albumVideosStatus");
const albumVideosPreviewWrap = document.getElementById("albumVideosPreviewWrap");
const albumVideosPreviewGrid = document.getElementById("albumVideosPreviewGrid");

let pendingCoverFile = null;
let pendingPhotoFiles = [];
let pendingVideoFiles = [];

/* modo edição */
let EDIT_MODE = false;
let EDIT_ALBUM_ID = "";
let EDIT_EXISTING = null;

function resetAlbumModal(){
  document.getElementById("albumTitle").value = "";
  document.getElementById("albumDesc").value = "";

  pendingCoverFile = null;
  pendingPhotoFiles = [];
  pendingVideoFiles = [];

  albumCoverStatus.textContent = "Nenhuma capa selecionada";
  albumCoverPreview.style.display = "none";

  albumPhotosCountEl.textContent = "0";
  albumPhotosStatus.textContent = "Nenhuma foto selecionada.";
  albumPhotosPreviewWrap.style.display = "none";
  albumPhotosPreviewGrid.innerHTML = "";

  albumVideosCountEl.textContent = "0";
  albumVideosStatus.textContent = "Nenhum vídeo selecionado.";
  albumVideosPreviewWrap.style.display = "none";
  albumVideosPreviewGrid.innerHTML = "";
}

function abrirModalCriarAlbum(){
  if(!USER_NAME){ abrirLogin(); return; }
  EDIT_MODE = false;
  EDIT_ALBUM_ID = "";
  EDIT_EXISTING = null;

  resetAlbumModal();
  albumModalTitle.innerHTML = `<i class="fa-solid fa-folder-plus" style="color:var(--primary)"></i> Criar álbum`;
  albumModeHint.textContent = "Modo: Criar";
  albumSaveBtn.innerHTML = `<i class="fa-solid fa-check"></i> Salvar`;
  abrirModal("modalAlbum");
}

function editarAlbumAtual(){
  if(!CURRENT_ALBUM_DATA) return;
  const isOwner = (CURRENT_ALBUM_DATA.ownerUid||"") === UID;
  if(!isOwner){ alert("Somente o dono pode editar."); return; }

  EDIT_MODE = true;
  EDIT_ALBUM_ID = CURRENT_ALBUM_DATA.albumId;
  EDIT_EXISTING = CURRENT_ALBUM_DATA;

  resetAlbumModal();

  document.getElementById("albumTitle").value = CURRENT_ALBUM_DATA.title || "";
  document.getElementById("albumDesc").value = CURRENT_ALBUM_DATA.description || "";

  if(CURRENT_ALBUM_DATA.coverUrl){
    albumCoverStatus.textContent = "Capa atual carregada";
    albumCoverPreviewImg.src = CURRENT_ALBUM_DATA.coverUrl;
    albumCoverPreview.style.display = "block";
  }

  albumPhotosStatus.textContent = `No álbum: ${(CURRENT_ALBUM_DATA.photos||[]).length} foto(s). Você pode adicionar mais.`;
  albumVideosStatus.textContent = `No álbum: ${(CURRENT_ALBUM_DATA.videos||[]).length} vídeo(s). Você pode adicionar mais.`;

  albumModalTitle.innerHTML = `<i class="fa-solid fa-pen" style="color:var(--primary)"></i> Editar álbum`;
  albumModeHint.textContent = "Modo: Editar (você pode adicionar mídia e trocar capa)";
  albumSaveBtn.innerHTML = `<i class="fa-solid fa-floppy-disk"></i> Atualizar`;

  fecharModal("modalViewAlbum");
  abrirModal("modalAlbum");
}

function pickAlbumCover(){ albumCoverInput.value=""; albumCoverInput.click(); }
function clearCover(){
  pendingCoverFile = null;
  albumCoverStatus.textContent = EDIT_MODE ? "Mantendo capa atual (se existir)" : "Nenhuma capa selecionada";
  if(!EDIT_MODE) albumCoverPreview.style.display = "none";
}

albumCoverInput.addEventListener("change", ()=>{
  const f = albumCoverInput.files && albumCoverInput.files[0];
  if(!f) return;
  if(!f.type || !f.type.startsWith("image/")){
    alert("Escolha uma imagem para a capa.");
    return;
  }
  if(!checkImgSize(f)) return;

  pendingCoverFile = f;
  albumCoverStatus.textContent = `Selecionada: ${f.name}`;
  const url = URL.createObjectURL(f);
  albumCoverPreviewImg.src = url;
  albumCoverPreview.style.display = "block";
});

function pickAlbumPhotos(){ albumPhotosInput.value=""; albumPhotosInput.click(); }
function clearPhotos(){
  pendingPhotoFiles = [];
  albumPhotosCountEl.textContent = "0";
  albumPhotosStatus.textContent = "Nenhuma foto selecionada.";
  albumPhotosPreviewWrap.style.display = "none";
  albumPhotosPreviewGrid.innerHTML = "";
}

function renderPhotosPreview(){
  const count = pendingPhotoFiles.length;
  albumPhotosCountEl.textContent = String(count);
  if(count === 0){
    albumPhotosStatus.textContent = "Nenhuma foto selecionada.";
    albumPhotosPreviewWrap.style.display = "none";
    albumPhotosPreviewGrid.innerHTML = "";
    return;
  }
  albumPhotosStatus.textContent = `${count} foto(s) selecionada(s).`;
  albumPhotosPreviewWrap.style.display = "block";

  albumPhotosPreviewGrid.innerHTML = pendingPhotoFiles.map((f, idx)=>{
    const url = URL.createObjectURL(f);
    return `
      <div class="pItem" title="${escapeHTML(f.name)}">
        <img src="${url}" alt="foto">
        <div class="removeBtn" onclick="removePhoto(${idx})">✕</div>
      </div>
    `;
  }).join("");
}
function removePhoto(idx){
  pendingPhotoFiles.splice(idx, 1);
  renderPhotosPreview();
}

albumPhotosInput.addEventListener("change", ()=>{
  const files = Array.from(albumPhotosInput.files || []).filter(f => (f.type||"").startsWith("image/"));
  const merged = pendingPhotoFiles.concat(files).slice(0, 10);
  pendingPhotoFiles = merged;
  renderPhotosPreview();
});

function pickAlbumVideos(){ albumVideosInput.value=""; albumVideosInput.click(); }
function clearVideos(){
  pendingVideoFiles = [];
  albumVideosCountEl.textContent = "0";
  albumVideosStatus.textContent = "Nenhum vídeo selecionado.";
  albumVideosPreviewWrap.style.display = "none";
  albumVideosPreviewGrid.innerHTML = "";
}

function renderVideosPreview(){
  const count = pendingVideoFiles.length;
  albumVideosCountEl.textContent = String(count);
  if(count === 0){
    albumVideosStatus.textContent = "Nenhum vídeo selecionado.";
    albumVideosPreviewWrap.style.display = "none";
    albumVideosPreviewGrid.innerHTML = "";
    return;
  }
  albumVideosStatus.textContent = `${count} vídeo(s) selecionado(s).`;
  albumVideosPreviewWrap.style.display = "block";

  albumVideosPreviewGrid.innerHTML = pendingVideoFiles.map((f, idx)=>{
    const url = URL.createObjectURL(f);
    return `
      <div class="pItem" title="${escapeHTML(f.name)}">
        <video src="${url}" muted playsinline></video>
        <div class="removeBtn" onclick="removeVideo(${idx})">✕</div>
      </div>
    `;
  }).join("");

  setTimeout(()=>{
    document.querySelectorAll("#albumVideosPreviewGrid video").forEach(v=>{
      try{ v.play().catch(()=>{}); }catch(e){}
    });
  }, 50);
}
function removeVideo(idx){
  pendingVideoFiles.splice(idx, 1);
  renderVideosPreview();
}

albumVideosInput.addEventListener("change", ()=>{
  const files = Array.from(albumVideosInput.files || []).filter(f => (f.type||"").startsWith("video/"));
  const merged = pendingVideoFiles.concat(files).slice(0, 10);
  pendingVideoFiles = merged;
  renderVideosPreview();
});

/* ====================== SALVAR (criar/editar) ====================== */
async function salvarAlbum(){
  if(!USER_NAME){ abrirLogin(); return; }

  const title = (document.getElementById("albumTitle").value || "").trim().slice(0,60);
  const description = (document.getElementById("albumDesc").value || "").trim().slice(0,600);

  if(title.length < 2){
    alert("Digite um título com pelo menos 2 letras.");
    return;
  }

  try{
    const me = await getMyProfile();

    if(!EDIT_MODE){
      toast("Criando álbum...");
      const albumId = randId("alb");
      const baseFolder = `memorial/albums/${UID}/${albumId}`;

      let coverUrl = "", coverPath = "";
      if(pendingCoverFile){
        const up = await uploadToStorage(pendingCoverFile, `${baseFolder}/cover`);
        coverUrl = up.url; coverPath = up.path;
      }

      const photos = [];
      for(const f of pendingPhotoFiles){
        if(!checkImgSize(f)) continue;
        const up = await uploadToStorage(f, `${baseFolder}/photos`);
        photos.push({ url: up.url, path: up.path });
      }

      const videos = [];
      for(const f of pendingVideoFiles){
        const up = await uploadToStorage(f, `${baseFolder}/videos`);
        videos.push({ url: up.url, path: up.path });
      }

      const payload = {
        albumId,
        ownerUid: UID,
        ownerName: (me.name || USER_NAME || "Usuário"),
        ownerAvatar: (me.avatarDataUrl || "").toString(),
        title,
        description,
        coverUrl,
        coverPath,
        photos: photos.slice(0,10),
        videos: videos.slice(0,10),
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      };

      await DB.ref("albums/" + albumId).set(payload);

      fecharModal("modalAlbum");
      toast("Álbum criado ✅");
      return;
    }

    toast("Atualizando álbum...");
    const albumId = EDIT_ALBUM_ID;
    const ref = DB.ref("albums/" + albumId);
    const snap = await ref.once("value");
    const cur = snap.val();
    if(!cur){
      alert("Álbum não encontrado.");
      return;
    }
    if((cur.ownerUid||"") !== UID){
      alert("Você não é o dono deste álbum.");
      return;
    }

    const baseFolder = `memorial/albums/${UID}/${albumId}`;

    let coverUrl = cur.coverUrl || "";
    let coverPath = cur.coverPath || "";
    if(pendingCoverFile){
      if(coverPath){
        try{ await ST.ref().child(coverPath).delete(); }catch(e){}
      }
      const up = await uploadToStorage(pendingCoverFile, `${baseFolder}/cover`);
      coverUrl = up.url; coverPath = up.path;
    }

    const oldPhotos = Array.isArray(cur.photos) ? cur.photos : [];
    const roomPhotos = Math.max(0, 10 - oldPhotos.length);
    const toAddPhotos = pendingPhotoFiles.slice(0, roomPhotos);

    const newPhotos = [];
    for(const f of toAddPhotos){
      if(!checkImgSize(f)) continue;
      const up = await uploadToStorage(f, `${baseFolder}/photos`);
      newPhotos.push({ url: up.url, path: up.path });
    }

    const oldVideos = Array.isArray(cur.videos) ? cur.videos : [];
    const roomVideos = Math.max(0, 10 - oldVideos.length);
    const toAddVideos = pendingVideoFiles.slice(0, roomVideos);

    const newVideos = [];
    for(const f of toAddVideos){
      const up = await uploadToStorage(f, `${baseFolder}/videos`);
      newVideos.push({ url: up.url, path: up.path });
    }

    await ref.update({
      title,
      description,
      coverUrl,
      coverPath,
      photos: oldPhotos.concat(newPhotos).slice(0,10),
      videos: oldVideos.concat(newVideos).slice(0,10),
      ownerName: (me.name || USER_NAME || "Usuário"),
      ownerAvatar: (me.avatarDataUrl || "").toString(),
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    });

    fecharModal("modalAlbum");
    toast("Álbum atualizado ✅");
    setTimeout(()=> abrirAlbum(albumId), 150);

  }catch(e){
    console.log(e);
    alert("Erro ao salvar álbum.");
  }
}

/* ====================== LISTAR ÁLBUNS ====================== */
const albumsGrid = document.getElementById("albumsGrid");
const myAlbumsGrid = document.getElementById("myAlbumsGrid");
const albumsEmpty = document.getElementById("albumsEmpty");
const myAlbumsEmpty = document.getElementById("myAlbumsEmpty");

const allAlbumsCount = document.getElementById("allAlbumsCount");
const onlyMyCount = document.getElementById("onlyMyCount");
const myAlbumsCountEl = document.getElementById("myAlbumsCount");

function ownerAvatarHTML(url, ownerName){
  if(url) return `<img src="${escapeHTML(url)}" alt="dono">`;
  return `<div class="oInit">${escapeHTML(initials(ownerName||"U"))}</div>`;
}

function albumCardHTML(a){
  const cover = a.coverUrl
    ? `<img src="${escapeHTML(a.coverUrl)}" alt="capa">`
    : `<img src="data:image/svg+xml;utf8,${encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'>
        <defs>
          <linearGradient id='g' x1='0' x2='1' y1='0' y2='1'>
            <stop stop-color='#2d2e30' offset='0'/>
            <stop stop-color='#18191a' offset='1'/>
          </linearGradient>
        </defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#b0b3b8' font-size='34' font-family='Arial' font-weight='900'>
          Sem capa
        </text>
      </svg>
    `)}">`;

  return `
    <div class="albumCard" onclick="abrirAlbum('${escapeHTML(a.albumId)}')">
      <!-- ✅ acima da capa: foto + nome do dono -->
      <div class="albumOwnerTop">
        <div class="oAva">${ownerAvatarHTML(a.ownerAvatar || "", a.ownerName || "")}</div>
        <div class="oName">${escapeHTML(a.ownerName || "Usuário")}</div>
      </div>

      <!-- ✅ capa -->
      <div class="albumCoverBox">${cover}</div>

      <!-- título -->
      <div class="albumBottom">
        <div class="albumTitle">${escapeHTML(a.title || "Álbum")}</div>
        <div class="albumMetaTiny">
          <span><i class="fa-solid fa-clock"></i> ${escapeHTML(fmtDate(a.updatedAt || a.createdAt || Date.now()))}</span>
        </div>
      </div>
    </div>
  `;
}

let albumsCache = [];

function renderAlbumsFromCache(){
  const all = albumsCache.slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  const mine = all.filter(a => (a.ownerUid||"") === UID);

  allAlbumsCount.textContent = `${all.length} álbuns`;
  onlyMyCount.textContent = `${mine.length} álbuns`;
  myAlbumsCountEl.textContent = mine.length;

  if(all.length === 0){
    albumsGrid.innerHTML = "";
    albumsEmpty.style.display = "block";
  }else{
    albumsEmpty.style.display = "none";
    albumsGrid.innerHTML = all.map(albumCardHTML).join("");
  }

  if(mine.length === 0){
    myAlbumsGrid.innerHTML = "";
    myAlbumsEmpty.style.display = "block";
  }else{
    myAlbumsEmpty.style.display = "none";
    myAlbumsGrid.innerHTML = mine.map(albumCardHTML).join("");
  }
}

function listenAlbums(){
  ALBUMS_REF.on("value", (snap)=>{
    const obj = snap.val() || {};
    albumsCache = Object.keys(obj).map(id => obj[id]).filter(Boolean);
    renderAlbumsFromCache();
  });
}

/* ====================== FOTO VIEWER (Swipe) ====================== */
const photoViewer = document.getElementById("photoViewer");
const viewerImg = document.getElementById("viewerImg");
const viewerCounter = document.getElementById("viewerCounter");
const viewerStage = document.getElementById("viewerStage");

let VIEWER_LIST = [];
let VIEWER_INDEX = 0;
let VIEWER_HUD_VISIBLE = true;

function openPhotoViewer(listUrls, startIndex){
  VIEWER_LIST = (listUrls || []).slice();
  VIEWER_INDEX = Math.max(0, Math.min(startIndex || 0, VIEWER_LIST.length-1));
  if(VIEWER_LIST.length === 0) return;

  photoViewer.style.display = "flex";
  document.body.style.overflow = "hidden";
  renderViewer();
}
function closePhotoViewer(){
  photoViewer.style.display = "none";
  document.body.style.overflow = "";
}
function renderViewer(){
  const total = VIEWER_LIST.length;
  const idx = VIEWER_INDEX;
  viewerCounter.textContent = `${idx+1}/${total}`;
  viewerImg.src = VIEWER_LIST[idx];
}
function nextPhoto(){
  if(VIEWER_LIST.length === 0) return;
  VIEWER_INDEX = (VIEWER_INDEX + 1) % VIEWER_LIST.length;
  renderViewer();
}
function prevPhoto(){
  if(VIEWER_LIST.length === 0) return;
  VIEWER_INDEX = (VIEWER_INDEX - 1 + VIEWER_LIST.length) % VIEWER_LIST.length;
  renderViewer();
}
function toggleViewerUI(){
  VIEWER_HUD_VISIBLE = !VIEWER_HUD_VISIBLE;
  const top = photoViewer.querySelector(".viewerTop");
  const hint = photoViewer.querySelector(".viewerHint");
  top.style.display = VIEWER_HUD_VISIBLE ? "flex" : "none";
  hint.style.display = VIEWER_HUD_VISIBLE ? "" : "none";
}

(function setupViewerGestures(){
  let startX = 0, startY = 0, dx = 0, dy = 0;
  let tracking = false;

  function onStart(e){
    tracking = true;
    dx = dy = 0;
    const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
    startX = p.clientX;
    startY = p.clientY;
  }
  function onMove(e){
    if(!tracking) return;
    const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
    dx = p.clientX - startX;
    dy = p.clientY - startY;
    if(e.cancelable) e.preventDefault();
  }
  function onEnd(){
    if(!tracking) return;
    tracking = false;

    const absX = Math.abs(dx);
    const absY = Math.abs(dy);

    if(absX > 50 && absX > absY){
      if(dx < 0) nextPhoto();
      else prevPhoto();
      return;
    }
    if(absX < 8 && absY < 8){
      toggleViewerUI();
    }
  }

  viewerStage.addEventListener("touchstart", onStart, {passive:true});
  viewerStage.addEventListener("touchmove", onMove, {passive:false});
  viewerStage.addEventListener("touchend", onEnd, {passive:true});

  document.addEventListener("keydown", (e)=>{
    if(photoViewer.style.display !== "flex") return;
    if(e.key === "Escape") closePhotoViewer();
    if(e.key === "ArrowRight") nextPhoto();
    if(e.key === "ArrowLeft") prevPhoto();
  });

  photoViewer.addEventListener("click", (e)=>{
    if(e.target === photoViewer) closePhotoViewer();
  });
})();

/* ====================== ABRIR ÁLBUM (ver tudo) ====================== */
let CURRENT_ALBUM_ID = "";
let CURRENT_ALBUM_DATA = null;

const albumViewTop = document.getElementById("albumViewTop");
const albumBody = document.getElementById("albumBody");
const albumOwnerActions = document.getElementById("albumOwnerActions");
const albumNotOwnerHint = document.getElementById("albumNotOwnerHint");

function mediaGridHTML(items, kind){
  const arr = Array.isArray(items) ? items : [];
  if(arr.length === 0){
    return `<div class="mutedHint">Nenhum ${kind} neste álbum.</div>`;
  }

  if(kind === "foto"){
    const urls = arr.map(x => (x && x.url) ? String(x.url) : "").filter(Boolean);
    return `
      <div class="mediaGrid">
        ${arr.map((x, i)=>{
          const u = escapeHTML(x.url||"");
          return `
            <div class="mediaItem" onclick="openPhotoViewer(${JSON.stringify(urls).replace(/</g,'\\u003c')}, ${i})">
              <img src="${u}" alt="foto" loading="lazy">
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  return `
    <div class="mediaGrid">
      ${arr.map(x=>{
        return `
          <div class="mediaItem" style="cursor:default;">
            <video src="${escapeHTML(x.url||"")}" controls playsinline preload="metadata"></video>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

async function abrirAlbum(albumId){
  const a = albumsCache.find(x => x.albumId === albumId);
  if(!a){
    alert("Álbum não encontrado.");
    return;
  }
  CURRENT_ALBUM_ID = albumId;

  abrirModal("modalViewAlbum");
  albumBody.innerHTML = `<div class="mutedHint">Carregando conteúdo do álbum...</div>`;

  try{
    const snap = await DB.ref("albums/" + albumId).once("value");
    const fresh = snap.val() || a;
    CURRENT_ALBUM_DATA = fresh;

    const cover = fresh.coverUrl
      ? `<img src="${escapeHTML(fresh.coverUrl)}" alt="capa">`
      : `<img src="data:image/svg+xml;utf8,${encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='600' height='600'>
          <rect width='100%' height='100%' fill='#2d2e30'/>
          <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#b0b3b8' font-size='24' font-family='Arial' font-weight='900'>
            Sem capa
          </text>
        </svg>
      `)}">`;

    albumViewTop.innerHTML = `
      <div class="albumHeader">
        <div class="albumHeroLeft">
          <div class="albumHeroCover">${cover}</div>
          <div class="albumHeroText">
            <h2>${escapeHTML(fresh.title || "Álbum")}</h2>
            <div class="desc">${escapeHTML(fresh.description || "Sem descrição.")}</div>
            <div class="tiny" style="margin-top:8px;">
              <i class="fa-solid fa-user"></i> Dono: <b>${escapeHTML(fresh.ownerName || "Usuário")}</b>
              &nbsp;•&nbsp; <i class="fa-solid fa-clock"></i> ${escapeHTML(fmtDate(fresh.createdAt||Date.now()))}
            </div>
          </div>
        </div>
      </div>
    `;

    const isOwner = (fresh.ownerUid||"") === UID;
    albumOwnerActions.style.display = isOwner ? "flex" : "none";
    albumNotOwnerHint.style.display = isOwner ? "none" : "block";

    const photos = Array.isArray(fresh.photos) ? fresh.photos : [];
    const videos = Array.isArray(fresh.videos) ? fresh.videos : [];

    albumBody.innerHTML = `
      <div class="mediaSection">
        <div class="secTitle">
          <div><i class="fa-solid fa-images" style="color:var(--primary)"></i> Fotos</div>
          <div class="tiny">${photos.length} / 10</div>
        </div>
        ${mediaGridHTML(photos, "foto")}
      </div>

      <div class="mediaSection">
        <div class="secTitle">
          <div><i class="fa-solid fa-video" style="color:var(--primary)"></i> Vídeos</div>
          <div class="tiny">${videos.length} / 10</div>
        </div>
        ${mediaGridHTML(videos, "vídeo")}
      </div>
    `;
  }catch(e){
    console.log(e);
    albumBody.innerHTML = `<div class="mutedHint">Erro ao carregar o álbum.</div>`;
  }
}

/* ====================== EXCLUIR ÁLBUM (dono) ====================== */
async function excluirAlbumAtual(){
  if(!CURRENT_ALBUM_DATA || !CURRENT_ALBUM_ID) return;
  const isOwner = (CURRENT_ALBUM_DATA.ownerUid||"") === UID;
  if(!isOwner){ alert("Somente o dono pode excluir."); return; }
  if(!confirm("Excluir o álbum e todos os arquivos (fotos/vídeos/capa)?")) return;

  try{
    toast("Excluindo álbum...");
    const snap = await DB.ref("albums/" + CURRENT_ALBUM_ID).once("value");
    const a = snap.val() || CURRENT_ALBUM_DATA;

    const paths = [];
    if(a.coverPath) paths.push(String(a.coverPath));
    (Array.isArray(a.photos) ? a.photos : []).forEach(x=>{ if(x && x.path) paths.push(String(x.path)); });
    (Array.isArray(a.videos) ? a.videos : []).forEach(x=>{ if(x && x.path) paths.push(String(x.path)); });

    await DB.ref("albums/" + CURRENT_ALBUM_ID).remove();

    for(const p of paths){
      try{ await ST.ref().child(p).delete(); }catch(e){}
    }

    fecharModal("modalViewAlbum");
    toast("Álbum excluído ✅");
  }catch(e){
    console.log(e);
    alert("Erro ao excluir álbum.");
  }
}

/* ====================== BOOT ====================== */
async function carregarMinhaUI(){
  meNameEl.textContent = USER_NAME || "Usuário";
  setMyAvatar("", USER_NAME);

  await ensureMyProfile();

  try{
    const snap = await MY_PROFILE_REF().once("value");
    const p = snap.val() || {};
    const nm = p.name || USER_NAME || "Usuário";
    const ava = (p.avatarDataUrl || "").toString();

    meNameEl.textContent = nm;
    setMyAvatar(ava, nm);

    MY_PROFILE_REF().on("value", (s)=>{
      const px = s.val() || {};
      const nm2 = px.name || USER_NAME || "Usuário";
      const ava2 = (px.avatarDataUrl || "").toString();
      meNameEl.textContent = nm2;
      setMyAvatar(ava2, nm2);
    });
  }catch(e){}
}

(async function boot(){
  if(!USER_NAME) return;
  await carregarMinhaUI();
  listenAlbums();
  setPanel("albums");
})();
</script>

</body>
</html>
