<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sala de VideoconferÃªncia</title>

<!-- LOGIN GOOGLE -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial;
    color: white;
    background: #111;
}

/* LOGIN */
#loginScreen {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.92);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 9999;
}

#loginScreen img {
    height: 130px;
    margin-bottom: 20px;
}

/* VIDEOS */
#videos {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
    gap: 12px;
    padding: 15px;
}

video {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 12px;
    background: black;
}

/* CONTROLES */
#controls {
    position: fixed;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    gap: 10px;
}

button {
    padding: 12px 18px;
    background: #00ffaa;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    color: black;
}
</style>
</head>
<body>

<!-- LOGIN GOOGLE -->
<div id="loginScreen">
    <img src="https://i.ibb.co/JRvgqKGM/5c081edd-21e9-48fb-9a91-834cfdd112fc-removebg-preview.png">
    <div id="googleBtn"></div>
</div>

<h2 style="text-align:center;margin-top:10px;">Sala de VideoconferÃªncia</h2>

<div id="videos"></div>

<div id="controls">
    <button id="toggleCam">ðŸŽ¥ CÃ¢mera</button>
    <button id="toggleMic">ðŸŽ™ Microfone</button>
</div>

<script>
/* ============================================================
   ðŸ”¥ FIREBASE OFICIAL DO SEU PROJETO
   ============================================================ */
const firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.firebasestorage.app",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============================================================
   ðŸ”¥ LOGIN GOOGLE AUTOMÃTICO
   ============================================================ */
let usuario = localStorage.getItem("usuario");

function decodeJwt(t) {
    return JSON.parse(atob(t.split('.')[1]));
}

function handleLogin(resp) {
    const data = decodeJwt(resp.credential);
    usuario = data.email;

    localStorage.setItem("usuario", usuario);

    loginScreen.style.display = "none";
    iniciarSala();
}

google.accounts.id.initialize({
    client_id: "627442405379-srqriainr8okj7ldg96njd1va5bvt7oi.apps.googleusercontent.com",
    callback: handleLogin,
    auto_select: true
});

google.accounts.id.renderButton(
    document.getElementById("googleBtn"),
    { theme: "filled_black", size: "large" }
);

/* ============================================================
   ðŸ”¥ SE JÃ ESTIVER LOGADO â†’ ENTRA DIRETO NA SALA
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {
    if (usuario) {
        loginScreen.style.display = "none";
        iniciarSala();
    }
});
</script>

<script>
/* ============================================================
   ðŸ”¥ SALA WEBRTC COMPLETA
   ============================================================ */
const roomId = "sala-global";
const peers = {};
let localStream;

async function iniciarSala() {

    document.getElementById("controls").style.display = "flex";

    // pede cÃ¢mera automaticamente
    localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
    });

    addVideo(localStream);

    const roomRef = db.collection("salas").doc(roomId);
    const candRef = roomRef.collection("candidates");

    roomRef.onSnapshot(snap => {
        const data = snap.data();
        if (!data) return;

        if (data.offer && !peers[data.offerId]) {
            answerOffer(data.offer, data.offerId);
        }
    });

    candRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
            const data = change.doc.data();
            if (peers[data.id] && data.candidate) {
                await peers[data.id].addIceCandidate(
                    new RTCIceCandidate(data.candidate)
                );
            }
        });
    });

    createOffer(roomRef, candRef);
}

/* insere vÃ­deos no grid */
function addVideo(stream) {
    const v = document.createElement("video");
    v.srcObject = stream;
    v.autoplay = true;
    v.playsinline = true;
    v.muted = (stream === localStream);
    document.getElementById("videos").appendChild(v);
}

/* cria oferta */
async function createOffer(roomRef, candRef) {

    const peer = new RTCPeerConnection();
    const id = usuario.replace(/\W/g,'') + "_" + Math.random().toString(36).substring(2);

    peers[id] = peer;

    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

    peer.onicecandidate = e => {
        if (e.candidate)
            candRef.add({ id, candidate: e.candidate.toJSON() });
    };

    peer.ontrack = e => addVideo(e.streams[0]);

    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);

    await roomRef.set({ offer, offerId: id });
}

/* responde a oferta */
async function answerOffer(offer, offerId) {

    const peer = new RTCPeerConnection();
    peers[offerId] = peer;

    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
    peer.ontrack = e => addVideo(e.streams[0]);

    await peer.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);

    db.collection("salas").doc(roomId).update({
        answer, answerId: offerId
    });
}

/* CONTROLES */
toggleCam.onclick = () => {
    let t = localStream.getVideoTracks()[0];
    t.enabled = !t.enabled;
};

toggleMic.onclick = () => {
    let t = localStream.getAudioTracks()[0];
    t.enabled = !t.enabled;
};
</script>

</body>
</html>
