<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sala de Videoconfer√™ncia</title>

<!-- GOOGLE LOGIN -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial;
    background: #000; /* FUNDO PRETO */
    color: white;
}

/* LOGIN GOOGLE */
#loginBox {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 99999;
}

#loginBox img {
    height: 130px;
    margin-bottom: 25px;
}

/* GRID DOS V√çDEOS */
#videos {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px,1fr));
    gap: 12px;
    padding: 15px;
}

video {
    width: 100%;
    height: 180px;
    background: black;
    border-radius: 12px;
    object-fit: cover;
}

/* CONTROLES */
#controls {
    display: none;
    gap: 12px;
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
}

button {
    background: #00ffaa;
    color: #000;
    padding: 12px 18px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
    <img src="https://i.ibb.co/JRvgqKGM/5c081edd-21e9-48fb-9a91-834cfdd112fc-removebg-preview.png">
    <div id="googleBtn"></div>
</div>

<h2 style="text-align:center;margin-top:10px;">Sala de Videoconfer√™ncia</h2>

<div id="videos"></div>

<div id="controls">
    <button id="toggleCam">üé• C√¢mera</button>
    <button id="toggleMic">üéô Microfone</button>
</div>

<script>
/* =====================================
   üî• CONFIG FIREBASE DO SEU PROJETO
   ===================================== */
const firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.firebasestorage.app",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =====================================
   üî• LOGIN GOOGLE
   ===================================== */
let usuario = localStorage.getItem("usuario");

function decodeJwt(token) {
    return JSON.parse(atob(token.split('.')[1]));
}

function googleLogin(response) {
    const data = decodeJwt(response.credential);
    usuario = data.email;

    localStorage.setItem("usuario", usuario);

    loginBox.style.display = "none";
    iniciarSala();
}

google.accounts.id.initialize({
    client_id: "627442405379-srqriainr8okj7ldg96njd1va5bvt7oi.apps.googleusercontent.com",
    callback: googleLogin,
    auto_select: true
});

google.accounts.id.renderButton(
    document.getElementById("googleBtn"),
    { theme: "filled_black", size: "large", width: 270 }
);

/* SE J√Å ESTAVA LOGADO, ENTRA DIRETO */
document.addEventListener("DOMContentLoaded", () => {
    if (usuario) {
        loginBox.style.display = "none";
        iniciarSala();
    }
});
</script>

<script>
/* =====================================
   üî• SISTEMA DE VIDEOCONFER√äNCIA
   ===================================== */

const roomId = "sala-global";
const peers = {};
let localStream;

async function iniciarSala() {

    controls.style.display = "flex";

    /* PEDIR C√ÇMERA AUTOMATICAMENTE */
    localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
    });

    addVideo(localStream);

    const roomRef = db.collection("salas").doc(roomId);
    const candRef = roomRef.collection("candidates");

    roomRef.onSnapshot((snap) => {
        const data = snap.data();
        if (!data) return;

        if (data.offer && !peers[data.offerId]) {
            answerOffer(data.offer, data.offerId);
        }
    });

    candRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
            const data = change.doc.data();

            if (peers[data.id] && data.candidate) {
                await peers[data.id].addIceCandidate(
                    new RTCIceCandidate(data.candidate)
                );
            }
        });
    });

    createOffer(roomRef, candRef);
}

/* Adiciona v√≠deo no grid */
function addVideo(stream) {
    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.playsinline = true;
    video.muted = (stream === localStream);

    document.getElementById("videos").appendChild(video);
}

/* Cria oferta */
async function createOffer(roomRef, candRef) {

    const peer = new RTCPeerConnection();
    const id = usuario.replace(/\W/g,'') + "_" + Math.random().toString(36).substring(2);

    peers[id] = peer;

    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

    peer.onicecandidate = e => {
        if (e.candidate)
            candRef.add({ id, candidate: e.candidate.toJSON() });
    };

    peer.ontrack = e => addVideo(e.streams[0]);

    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);

    await roomRef.set({ offer, offerId: id });
}

/* Responde oferta */
async function answerOffer(offer, offerId) {

    const peer = new RTCPeerConnection();
    peers[offerId] = peer;

    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
    peer.ontrack = e => addVideo(e.streams[0]);

    await peer.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);

    db.collection("salas").doc(roomId).update({
        answer,
        answerId: offerId
    });
}

/* CONTROLES */
toggleCam.onclick = () => {
    const t = localStream.getVideoTracks()[0];
    t.enabled = !t.enabled;
};

toggleMic.onclick = () => {
    const t = localStream.getAudioTracks()[0];
    t.enabled = !t.enabled;
};
</script>

</body>
</html>
