<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sala de VideoconferÃªncia</title>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial;
    background: #000; /* FUNDO PRETO */
    color: white;
}

h2 {
    text-align: center;
    margin-top: 10px;
}

#videos {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px,1fr));
    gap: 12px;
    padding: 15px;
}

video {
    width: 100%;
    height: 180px;
    background: black;
    border-radius: 12px;
    object-fit: cover;
}

#controls {
    display: flex;
    gap: 12px;
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
}

button {
    background: #00ffaa;
    color: #000;
    padding: 12px 18px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>
<body>

<h2>Sala de VideoconferÃªncia</h2>

<div id="videos"></div>

<div id="controls">
    <button id="toggleCam">ðŸŽ¥ CÃ¢mera</button>
    <button id="toggleMic">ðŸŽ™ Microfone</button>
</div>

<script>
/* CONFIG FIREBASE */
const firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.firebasestorage.app",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const roomId = "sala-global";
const peers = {};
let localStream;

/* =====================================
   ðŸ”¥ INÃCIO AUTOMÃTICO DA SALA
   ===================================== */
window.onload = () => {
    iniciarSala();
};

async function iniciarSala() {

    /* PEDIR CÃ‚MERA DIRETO */
    localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
    });

    addVideo(localStream);

    const roomRef = db.collection("salas").doc(roomId);
    const candRef = roomRef.collection("candidates");

    roomRef.onSnapshot((snap) => {
        const data = snap.data();
        if (!data) return;

        if (data.offer && !peers[data.offerId]) {
            answerOffer(data.offer, data.offerId);
        }
    });

    candRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
            const data = change.doc.data();

            if (peers[data.id] && data.candidate) {
                await peers[data.id].addIceCandidate(
                    new RTCIceCandidate(data.candidate)
                );
            }
        });
    });

    createOffer(roomRef, candRef);
}

/* Adiciona vÃ­deo na grade */
function addVideo(stream) {
    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.playsinline = true;
    video.muted = (stream === localStream);
    document.getElementById("videos").appendChild(video);
}

/* Cria Offer */
async function createOffer(roomRef, candRef) {

    const peer = new RTCPeerConnection();
    const id = Math.random().toString(36).substring(2);

    peers[id] = peer;

    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

    peer.onicecandidate = e => {
        if (e.candidate)
            candRef.add({ id, candidate: e.candidate.toJSON() });
    };

    peer.ontrack = e => addVideo(e.streams[0]);

    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);

    await roomRef.set({ offer, offerId: id });
}

/* Responde Offer */
async function answerOffer(offer, offerId) {

    const peer = new RTCPeerConnection();
    peers[offerId] = peer;

    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
    peer.ontrack = e => addVideo(e.streams[0]);

    await peer.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);

    db.collection("salas").doc(roomId).update({
        answer,
        answerId: offerId
    });
}

/* CONTROLES */
toggleCam.onclick = () => {
    const t = localStream.getVideoTracks()[0];
    t.enabled = !t.enabled;
};

toggleMic.onclick = () => {
    const t = localStream.getAudioTracks()[0];
    t.enabled = !t.enabled;
};
</script>

</body>
</html>
