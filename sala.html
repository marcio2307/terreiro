<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sala de Videoconferﾃｪncia</title>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: Arial;
    text-align: center;
}

#permissionBox {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.90);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 25px;
    z-index: 99999;
}

#videos {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(200px,1fr));
    gap: 10px;
    padding: 10px;
    margin-top: 10px;
}

video {
    width: 100%;
    height: 180px;
    background: #000;
    border-radius: 10px;
    object-fit: cover;
}

#allowBtn {
    background: #00ffaa;
    color: #000;
    border: none;
    padding: 15px 25px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 10px;
    cursor: pointer;
}
</style>
</head>
<body>

<h2>Sala de Videoconferﾃｪncia</h2>

<!-- PERMISSﾃグ ANTES DE TUDO -->
<div id="permissionBox">
    <img src="https://cdn-icons-png.flaticon.com/512/4221/4221419.png" width="90">
    <h3>Permitir acesso ﾃ cﾃ｢mera e ao microfone</h3>
    <button id="allowBtn">Permitir agora</button>
</div>

<div id="videos"></div>

<script>
/* 
===========================================
櫨 FIREBASE CONFIG
===========================================
*/
const firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.firebasestorage.app",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/*
===========================================
櫨 FUNﾃﾃグ DE PERMISSﾃグ
===========================================
*/
let localStream;
let peers = {};
const roomId = "sala-global";

document.getElementById("allowBtn").onclick = async function () {

    try {
        // 櫨 AGORA PEDE PERMISSﾃグ DE VERDADE
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });

        document.getElementById("permissionBox").style.display = "none";

        iniciarSala();

    } catch (e) {
        alert("Vocﾃｪ precisa permitir a cﾃ｢mera e o microfone.");
    }
};

/*
===========================================
櫨 ADICIONAR Vﾃ好EO NA TELA
===========================================
*/
function addVideo(stream) {
    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.playsinline = true;
    video.muted = (stream === localStream);
    document.getElementById("videos").appendChild(video);
}

/*
===========================================
櫨 INICIAR SALA DE VIDEOCONFERﾃ劾CIA
===========================================
*/
async function iniciarSala() {

    addVideo(localStream);

    const roomRef = db.collection("salas").doc(roomId);
    const candRef = roomRef.collection("candidates");

    // RECEBE OFERTAS
    roomRef.onSnapshot((snap) => {
        const data = snap.data();
        if (!data) return;

        if (data.offer && !peers[data.offerId]) {
            answerOffer(data.offer, data.offerId);
        }
    });

    // RECEBE CANDIDATOS ICE
    candRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            const data = change.doc.data();

            if (peers[data.id] && data.candidate) {
                peers[data.id].addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        });
    });

    createOffer(roomRef, candRef);
}

/*
===========================================
櫨 CRIAR OFFER
===========================================
*/
async function createOffer(roomRef, candRef) {

    const peer = new RTCPeerConnection();
    const id = Math.random().toString(36).substring(2);

    peers[id] = peer;

    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

    peer.ontrack = e => addVideo(e.streams[0]);

    peer.onicecandidate = e => {
        if (e.candidate) {
            candRef.add({ id, candidate: e.candidate.toJSON() });
        }
    };

    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);

    await roomRef.set({ offer, offerId: id });
}

/*
===========================================
櫨 RESPONDER OFFER (ANSWER)
===========================================
*/
async function answerOffer(offer, offerId) {

    const peer = new RTCPeerConnection();
    peers[offerId] = peer;

    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

    peer.ontrack = e => addVideo(e.streams[0]);

    await peer.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);

    db.collection("salas").doc(roomId).update({
        answer,
        answerId: offerId
    });
}
</script>

</body>
</html>
