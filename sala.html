<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sala Global â€“ ReuniÃ£o</title>

<style>
  body { margin: 0; background: #000; overflow: hidden; }

  #videos {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 6px;
    padding: 6px;
    height: 100vh;
    overflow-y: auto;
    background: #000;
  }

  /* Celular â€“ 3 por linha */
  @media (max-width: 768px) {
    #videos { grid-template-columns: repeat(3, 1fr); }
  }

  video {
    width: 100%;
    height: 100%;
    background: #111;
    object-fit: cover;
    border-radius: 8px;
  }
</style>
</head>
<body>

<div id="videos"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

/* ðŸ”¥ SEU FIREBASE REAL (rastreio-31b3f) */
const firebaseConfig = {
  apiKey: "AIzaSyCrX9MuOeKyaWLCwgGjYMyrjKCXQXe-ZXY",
  authDomain: "rastreio-31b3f.firebaseapp.com",
  databaseURL: "https://rastreio-31b3f-default-rtdb.firebaseio.com",
  projectId: "rastreio-31b3f",
  storageBucket: "rastreio-31b3f.firebasestorage.app",
  messagingSenderId: "1133443616013",
  appId: "1:1133443616013:web:b155ef7b855ac48d6f2ee4",
  measurementId: "G-QDSNM5PWDX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ðŸ”¥ Sala nova, limpa */
const ROOM = "sala_global_31b3f";
let localStream;
let peers = {};
let myId;

const videoGrid = document.getElementById("videos");

async function startCamera() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video: { width: 320, height: 240 },
    audio: true
  });

  const me = document.createElement("video");
  me.srcObject = localStream;
  me.autoplay = true;
  me.muted = true;
  videoGrid.appendChild(me);
}

function createPeer(remoteId) {
  const pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = event => {
    const vid = document.createElement("video");
    vid.srcObject = event.streams[0];
    vid.autoplay = true;
    videoGrid.appendChild(vid);
  };

  pc.onicecandidate = e => {
    if (e.candidate) {
      set(push(ref(db, `${ROOM}/ice`)), {
        from: myId,
        to: remoteId,
        candidate: JSON.stringify(e.candidate)
      });
    }
  };

  return pc;
}

async function joinRoom() {
  await startCamera();

  /* Gerar ID Ãºnico */
  myId = push(ref(db, `${ROOM}/users`)).key;
  set(ref(db, `${ROOM}/users/${myId}`), true);
  onDisconnect(ref(db, `${ROOM}/users/${myId}`)).remove();

  /* Detectar usuÃ¡rios */
  onValue(ref(db, `${ROOM}/users`), async snap => {
    const users = snap.val();
    if (!users) return;

    for (let uid of Object.keys(users)) {
      if (uid === myId) continue;
      if (peers[uid]) continue;

      const pc = createPeer(uid);
      peers[uid] = pc;

      const offer = await pc.createOffer();
      pc.setLocalDescription(offer);

      set(push(ref(db, `${ROOM}/signals`)), {
        type: "offer",
        from: myId,
        to: uid,
        sdp: JSON.stringify(offer)
      });
    }
  });

  /* Receber OFFER e ANSWER */
  onValue(ref(db, `${ROOM}/signals`), async snap => {
    const data = snap.val();
    if (!data) return;

    for (let key of Object.keys(data)) {
      const msg = data[key];
      if (msg.to !== myId) continue;

      if (msg.type === "offer") {
        const pc = createPeer(msg.from);
        peers[msg.from] = pc;

        pc.setRemoteDescription(JSON.parse(msg.sdp));
        const answer = await pc.createAnswer();
        pc.setLocalDescription(answer);

        set(push(ref(db, `${ROOM}/signals`)), {
          type: "answer",
          from: myId,
          to: msg.from,
          sdp: JSON.stringify(answer)
        });
      }

      if (msg.type === "answer") {
        const pc = peers[msg.from];
        if (pc) pc.setRemoteDescription(JSON.parse(msg.sdp));
      }
    }
  });

  /* Receber ICE */
  onValue(ref(db, `${ROOM}/ice`), async snap => {
    const data = snap.val();
    if (!data) return;

    for (let key of Object.keys(data)) {
      const msg = data[key];
      if (msg.to !== myId) continue;

      const pc = peers[msg.from];
      if (pc) pc.addIceCandidate(JSON.parse(msg.candidate));
    }
  });
}

joinRoom();
</script>

</body>
</html>
