<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sala Global – Videoconferência</title>

<style>
    body {
        margin: 0;
        background: #000;
        overflow: hidden;
        font-family: Arial, sans-serif;
    }

    #videos {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 10px;
        padding: 10px;
        height: 100vh;
        overflow-y: auto;
        background: #000;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        background: #111;
        box-shadow: 0 0 10px #000;
    }
</style>
</head>
<body>

<div id="videos"></div>

<script type="module">
/* ---------------------- Firebase ---------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onDisconnect } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAYhKhK5SFaWkFlqZhXi3nVbsWzdbjteO0",
  authDomain: "rastreio-8bb0a.firebaseapp.com",
  databaseURL: "https://rastreio-8bb0a-default-rtdb.firebaseio.com",
  projectId: "rastreio-8bb0a",
  storageBucket: "rastreio-8bb0a.appspot.com",
  messagingSenderId: "676710436203",
  appId: "1:676710436203:web:b48ebc7189ff71e564d02e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ROOM = "global_room_zoom";
const peers = {};
let localStream;

const videosDiv = document.getElementById("videos");

/* ---------------------- 1. Abre Câmera ---------------------- */
async function initCamera() {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

    const myVid = document.createElement("video");
    myVid.srcObject = localStream;
    myVid.autoplay = true;
    myVid.muted = true;
    videosDiv.appendChild(myVid);
}

/* ---------------------- 2. Cria Peer ---------------------- */
function createPeer(id) {
    const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    peers[id] = pc;

    localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
    });

    pc.ontrack = event => {
        const vid = document.createElement("video");
        vid.srcObject = event.streams[0];
        vid.autoplay = true;
        videosDiv.appendChild(vid);
    };

    pc.onicecandidate = e => {
        if (e.candidate) {
            push(ref(db, `${ROOM}/signals/${id}/ice`), JSON.stringify(e.candidate));
        }
    };

    return pc;
}

/* ---------------------- 3. Entra na sala ---------------------- */
async function joinRoom() {
    await initCamera();

    const myId = push(ref(db, `${ROOM}/users`)).key;

    const myRef = ref(db, `${ROOM}/users/${myId}`);
    set(myRef, true);
    onDisconnect(myRef).remove();

    onChildAdded(ref(db, `${ROOM}/users`), async snap => {
        const userId = snap.key;
        if (userId === myId) return;

        const pc = createPeer(userId);
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        set(ref(db, `${ROOM}/signals/${userId}/offer`), {
            from: myId,
            sdp: JSON.stringify(offer)
        });
    });

    onChildAdded(ref(db, `${ROOM}/signals/${myId}/offer`), async snap => {
        const data = snap.val();
        const from = data.from;

        const pc = createPeer(from);
        await pc.setRemoteDescription(JSON.parse(data.sdp));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        set(ref(db, `${ROOM}/signals/${from}/answer`), {
            from: myId,
            sdp: JSON.stringify(answer)
        });
    });

    onChildAdded(ref(db, `${ROOM}/signals/${myId}/answer`), async snap => {
        const data = snap.val();
        const from = data.from;

        if (peers[from] && !peers[from].currentRemoteDescription) {
            peers[from].setRemoteDescription(JSON.parse(data.sdp));
        }
    });

    onChildAdded(ref(db, `${ROOM}/signals/${myId}/ice`), async snap => {
        const candidate = JSON.parse(snap.val());
        for (const p in peers) {
            try { peers[p].addIceCandidate(candidate); } catch {}
        }
    });
}

joinRoom();
</script>

</body>
</html>
