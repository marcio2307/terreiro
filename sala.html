<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sala Global – Videoconferência</title>

<style>
    body {
        margin: 0;
        background: #000;
        overflow: hidden;
    }

    #videos {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 10px;
        padding: 10px;
        height: 100vh;
        overflow-y: auto;
        background: #000;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        background: #111;
        box-shadow: 0 0 10px #000;
    }
</style>
</head>
<body>

<div id="videos"></div>

<script type="module">

/* ---------------------- Firebase ---------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAYhKhK5SFaWkFlqZhXi3nVbsWzdbjteO0",
  authDomain: "rastreio-8bb0a.firebaseapp.com",
  databaseURL: "https://rastreio-8bb0a-default-rtdb.firebaseio.com",
  projectId: "rastreio-8bb0a",
  storageBucket: "rastreio-8bb0a.appspot.com",
  messagingSenderId: "676710436203",
  appId: "1:676710436203:web:b48ebc7189ff71e564d02e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ROOM = "sala_lotada";
const peers = {};
let localStream;

const videosDiv = document.getElementById("videos");

/* ---------------------- 1. Iniciar câmera ---------------------- */
async function startCamera() {
    localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
    });

    const myVideo = document.createElement("video");
    myVideo.srcObject = localStream;
    myVideo.autoplay = true;
    myVideo.muted = true;
    videosDiv.appendChild(myVideo);
}

/* ---------------------- 2. Criar PeerConnection ---------------------- */
function createPeerConnection(peerId) {
    const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
    });

    pc.ontrack = e => {
        const vid = document.createElement("video");
        vid.srcObject = e.streams[0];
        vid.autoplay = true;
        videosDiv.appendChild(vid);
    };

    pc.onicecandidate = e => {
        if (e.candidate) {
            set(push(ref(db, `${ROOM}/ice/${peerId}`)), {
                type: "ice",
                candidate: JSON.stringify(e.candidate),
                from: myId
            });
        }
    };

    return pc;
}

/* ---------------------- 3. Entrar na sala ---------------------- */
let myId;

async function joinRoom() {
    await startCamera();

    myId = push(ref(db, `${ROOM}/users`)).key;
    set(ref(db, `${ROOM}/users/${myId}`), true);

    onDisconnect(ref(db, `${ROOM}/users/${myId}`)).remove();

    onValue(ref(db, `${ROOM}/users`), async snapshot => {
        const users = snapshot.val();
        if (!users) return;

        for (const userId of Object.keys(users)) {
            if (userId === myId) continue;
            if (peers[userId]) continue;

            const pc = createPeerConnection(userId);
            peers[userId] = pc;

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            set(push(ref(db, `${ROOM}/signals`)), {
                type: "offer",
                sdp: JSON.stringify(offer),
                from: myId,
                to: userId
            });
        }
    });

    onValue(ref(db, `${ROOM}/signals`), async snapshot => {
        const data = snapshot.val();
        if (!data) return;

        for (const key of Object.keys(data)) {
            const msg = data[key];

            if (msg.to !== myId) continue;

            if (msg.type === "offer") {
                const pc = createPeerConnection(msg.from);
                peers[msg.from] = pc;

                await pc.setRemoteDescription(JSON.parse(msg.sdp));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                set(push(ref(db, `${ROOM}/signals`)), {
                    type: "answer",
                    sdp: JSON.stringify(answer),
                    from: myId,
                    to: msg.from
                });
            }

            if (msg.type === "answer") {
                const pc = peers[msg.from];
                if (pc && !pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(JSON.parse(msg.sdp));
                }
            }
        }
    });

    onValue(ref(db, `${ROOM}/ice`), async snapshot => {
        const data = snapshot.val();
        if (!data) return;

        for (const key of Object.keys(data)) {
            const msg = data[key];

            if (msg.to !== myId) continue;

            const pc = peers[msg.from];
            if (!pc) continue;

            if (msg.type === "ice") {
                try {
                    await pc.addIceCandidate(JSON.parse(msg.candidate));
                } catch {}
            }
        }
    });
}

joinRoom();
</script>

</body>
</html>
