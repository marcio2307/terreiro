<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sala Global ‚Äì Videoconfer√™ncia</title>

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    background: #000;
    overflow: hidden;
    font-family: sans-serif;
  }

  /* === GRADE DIN√ÇMICA === */
  #videos {
    display: grid;
    gap: 8px;
    padding: 8px;
    height: 100vh;
    overflow-y: auto;
    background: #000;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  }

  /* CELULAR ‚Äî 2 colunas */
  @media (max-width: 600px) {
    #videos {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* QUADRADO PERFEITO */
  .video-box {
    position: relative;
    width: 100%;
    padding-top: 100%;
    background: #111;
    border-radius: 14px;
    overflow: hidden;
  }

  .video-box video {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 14px;
  }

  /* === BOT√ïES EM CIMA DO V√çDEO === */
  .controls-small {
    position: absolute;
    top: 6px;
    right: 6px;
    display: flex;
    gap: 6px;
    z-index: 10;
  }

  .btn-small {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    border: none;
    font-size: 18px;
    color: white;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .btn-end {
    background: #d50000;
  }

  .btn-mic {
    background: #444;
  }

  .btn-mic.off {
    background: #888;
  }

</style>
</head>
<body>

<div id="videos"></div>

<script type="module">
/* ===== FIREBASE ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getDatabase, ref, push, set, onChildAdded, onValue,
  onDisconnect, remove
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrX9MuOeKyaWLCwgGjYMyrjKCXQXe-ZXY",
  authDomain: "rastreio-31b3f.firebaseapp.com",
  databaseURL: "https://rastreio-31b3f-default-rtdb.firebaseio.com",
  projectId: "rastreio-31b3f",
  storageBucket: "rastreio-31b3f.firebasestorage.app",
  messagingSenderId: "1133443616013",
  appId: "1:1133443616013:web:b155ef7b855ac48d6f2ee4",
  measurementId: "G-QDSNM5PWDX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ROOM = "sala_global_31b3f";

let localStream;
let peers = {};
let remoteVideos = {};  
let myId;

const videoGrid = document.getElementById("videos");

/* === CRIAR QUADRADO DE V√çDEO + BOT√ïES === */
function addVideoBox(stream, isMe = false) {
  const box = document.createElement("div");
  box.className = "video-box";

  const vid = document.createElement("video");
  vid.srcObject = stream;
  vid.autoplay = true;
  vid.playsInline = true;
  if (isMe) vid.muted = true;

  /* === BOT√ïES INDIVIDUAIS === */
  const ctrl = document.createElement("div");
  ctrl.className = "controls-small";

  const micBtn = document.createElement("button");
  micBtn.className = "btn-small btn-mic";
  micBtn.innerText = "üé§";

  if (isMe) {
    micBtn.onclick = () => {
      const track = localStream.getAudioTracks()[0];
      track.enabled = !track.enabled;
      micBtn.classList.toggle("off");
      micBtn.innerText = track.enabled ? "üé§" : "üîá";
    };
  } else {
    micBtn.style.opacity = "0.5";
    micBtn.style.pointerEvents = "none";
  }

  const endBtn = document.createElement("button");
  endBtn.className = "btn-small btn-end";
  endBtn.innerText = "üìû";

  if (isMe) {
    endBtn.onclick = () => {
      window.location.href = "https://marcio2307.github.io/terreiro/";
    };
  } else {
    endBtn.style.opacity = "0.5";
    endBtn.style.pointerEvents = "none";
  }

  ctrl.appendChild(micBtn);
  ctrl.appendChild(endBtn);

  box.appendChild(vid);
  box.appendChild(ctrl);

  videoGrid.appendChild(box);

  return { box, vid };
}

/* === AJUSTAR TAMANHO === */
function adjustLayout() {
  const total = videoGrid.children.length;

  [...videoGrid.children].forEach(el => el.classList.remove("full"));

  // 1 usu√°rio = tela cheia
  if (total === 1) {
    const box = videoGrid.children[0];
    box.style.gridColumn = "1 / -1";
    box.style.height = "calc(100vh - 20px)";
    box.style.paddingTop = "0";
  } 
  else {
    // restaura quadrado normal
    [...videoGrid.children].forEach(box => {
      box.style.gridColumn = "auto";
      box.style.height = "auto";
      box.style.paddingTop = "100%";
    });
  }
}

/* === C√ÇMERA LOCAL === */
async function startCamera() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" },
    audio: true
  });

  const me = addVideoBox(localStream, true);
  me.box.dataset.id = "me";

  adjustLayout();
}

/* === PEER === */
function createPeer(remoteId) {
  const pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = event => {
    if (!remoteVideos[remoteId]) {
      const box = addVideoBox(event.streams[0], false);
      remoteVideos[remoteId] = box;
      adjustLayout();
    } else {
      remoteVideos[remoteId].vid.srcObject = event.streams[0];
    }
  };

  pc.onicecandidate = e => {
    if (e.candidate) {
      set(push(ref(db, `${ROOM}/ice`)), {
        from: myId,
        to: remoteId,
        candidate: JSON.stringify(e.candidate)
      });
    }
  };

  return pc;
}

/* === ENTRAR NA SALA === */
async function joinRoom() {
  await startCamera();

  myId = push(ref(db, `${ROOM}/users`)).key;
  set(ref(db, `${ROOM}/users/${myId}`), true);
  onDisconnect(ref(db, `${ROOM}/users/${myId}`)).remove();

  onValue(ref(db, `${ROOM}/users`), snap => {
    const users = snap.val() || {};

    for (let uid in remoteVideos) {
      if (!users[uid]) {
        remoteVideos[uid].box.remove();
        delete remoteVideos[uid];

        if (peers[uid]) {
          peers[uid].close();
          delete peers[uid];
        }

        adjustLayout();
      }
    }

    for (let uid of Object.keys(users)) {
      if (uid === myId) continue;
      if (peers[uid]) continue;

      if (myId < uid) {
        const pc = peers[uid] = createPeer(uid);

        pc.createOffer()
          .then(o => pc.setLocalDescription(o))
          .then(() => {
            set(push(ref(db, `${ROOM}/signals`)), {
              type: "offer",
              from: myId,
              to: uid,
              sdp: JSON.stringify(pc.localDescription)
            });
          });
      }
    }
  });

  onChildAdded(ref(db, `${ROOM}/signals`), async snap => {
    const msg = snap.val();
    if (msg.to !== myId) return;

    if (!peers[msg.from]) peers[msg.from] = createPeer(msg.from);
    const pc = peers[msg.from];

    if (msg.type === "offer") {
      await pc.setRemoteDescription(JSON.parse(msg.sdp));
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);

      set(push(ref(db, `${ROOM}/signals`)), {
        type: "answer",
        from: myId,
        to: msg.from,
        sdp: JSON.stringify(ans)
      });

    } else if (msg.type === "answer") {
      await pc.setRemoteDescription(JSON.parse(msg.sdp));
    }

    remove(ref(db, `${ROOM}/signals/${snap.key}`));
  });

  onChildAdded(ref(db, `${ROOM}/ice`), async snap => {
    const msg = snap.val();
    if (msg.to !== myId) return;

    if (peers[msg.from]) {
      await peers[msg.from].addIceCandidate(JSON.parse(msg.candidate));
    }

    remove(ref(db, `${ROOM}/ice/${snap.key}`));
  });
}

joinRoom();
</script>

</body>
</html>
