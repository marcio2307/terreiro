<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>

<!-- üîä SONS -->
<audio id="somEnviar" src="som.mp3"></audio>
<audio id="somReceber" src="som.mp3"></audio>

<style>
html,body{
  margin:0; padding:0;
  width:100%; height:100%;
  background:#000; color:#0f0;
  font-family:Segoe UI, sans-serif;
  overflow:hidden;
}

/* LISTA */
#listaUsuarios{
  position:absolute; inset:0;
  background:#050505;
  overflow-y:auto;
  transition:.3s;
  z-index:10;
}
#listaUsuarios.hidden{ left:-100%; position:absolute; }

.voltarSiteBtn{
  margin:15px;
  padding:8px 14px;
  border:2px solid #0f0;
  border-radius:30px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:8px;
}

#listaUsuarios h2{
  text-align:center;
  border-bottom:2px solid #0f0;
  padding:10px;
}

.userBox{
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px;
  cursor:pointer;
}
.userBox:hover{ background:rgba(0,255,0,.15); }

.userBox img{
  width:48px;height:48px;
  border-radius:50%;
  border:2px solid #0f0;
}

.onlineDot{
  width:10px;height:10px;
  background:#0f0;
  border-radius:50%;
  animation:blink 1s infinite;
}
@keyframes blink{50%{opacity:.3;}}

/* CHAT */
#chatArea{
  position:absolute; inset:0;
  display:flex;
  flex-direction:column;
}

#chatHeader{
  padding:12px;
  background:#0a0a0a;
  border-bottom:2px solid #0f0;
  display:flex;
  align-items:center;
  gap:12px;
}

.botaoVoltar{ font-size:24px; cursor:pointer; display:none; }
#headerFoto{ width:42px;height:42px;border-radius:50%;border:2px solid #0f0; display:none; }

#mensagens{
  flex:1;
  padding:10px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:20px;
  padding-bottom:120px;
}

.msg{
  max-width:75%;
  padding:10px 14px;
  background:#013801;
  border:1px solid #0f0;
  border-radius:18px;
  border-bottom-left-radius:0;
}
.msg.me{
  margin-left:auto;
  background:#065f06;
  color:#fff;
  border-bottom-right-radius:0;
}

.msgHora{
  font-size:11px;
  opacity:.6;
  margin-top:4px;
  text-align:right;
}

#inputArea{
  position:absolute;
  bottom:0; width:100%;
  padding:8px;
  border-top:2px solid #0f0;
  display:flex;
  gap:8px;
}

#msgInput{
  flex:1;
  padding:8px;
  border-radius:25px;
  border:2px solid #0f0;
  background:#000;
  color:#0f0;
}
#sendBtn{
  width:44px;height:44px;
  border-radius:50%;
  background:#0f0;
  color:#000;
  font-size:20px;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- LISTA -->
<div id="listaUsuarios">
  <div class="voltarSiteBtn" onclick="location.href='site.html'">‚Üê Voltar</div>
  <h2>Online Agora</h2>
</div>

<!-- CHAT -->
<div id="chatArea">
  <div id="chatHeader">
    <span class="botaoVoltar" onclick="voltarLista()">‚Üê</span>
    <img id="headerFoto">
    <span id="headerNome">Selecione um usu√°rio</span>
  </div>

  <div id="mensagens"></div>

  <div id="inputArea">
    <input id="msgInput" placeholder="Digite..." disabled>
    <button id="sendBtn" disabled>‚û§</button>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

/* üîê IDENTIDADE (vem do site.html) */
const nome = (localStorage.getItem("nome_passageiro")||"").trim();
const uid  = (localStorage.getItem("uid_passageiro")||"").trim();
const foto = localStorage.getItem("foto_passageiro") ||
  "https://cdn-icons-png.flaticon.com/512/149/149071.png";

if(!nome || !uid){
  alert("Entre no site primeiro.");
  location.href="site.html";
}

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

let app;
try{ app=getApp(); }catch{ app=initializeApp(firebaseConfig); }
const db = getDatabase(app);

/* PRESEN√áA */
const meRef = ref(db,"chat/usuariosOnline/"+uid);

function online(){
  set(meRef,{ uid,nome,foto,online:true,last:Date.now() });
}
function offline(){
  set(meRef,{ uid,nome,foto,online:false,last:Date.now() });
}
onDisconnect(meRef).set({ uid,nome,foto,online:false,last:Date.now() });

let lastTouch=Date.now();
["click","touchstart","keydown","mousemove"].forEach(e=>{
  document.addEventListener(e,()=>{ lastTouch=Date.now(); online(); },{passive:true});
});
setInterval(()=> Date.now()-lastTouch>120000 ? offline():online(),10000);
online();

/* LISTA ONLINE */
onValue(ref(db,"chat/usuariosOnline"),snap=>{
  const lista=document.getElementById("listaUsuarios");
  lista.innerHTML=`<div class="voltarSiteBtn" onclick="location.href='site.html'">‚Üê Voltar</div><h2>Online Agora</h2>`;
  snap.forEach(s=>{
    const u=s.val();
    if(!u.online||u.uid===uid) return;
    const d=document.createElement("div");
    d.className="userBox";
    d.innerHTML=`<img src="${u.foto}"><div class="onlineDot"></div>${u.nome}`;
    d.onclick=()=>abrirChat(u);
    lista.appendChild(d);
  });
});

/* CHAT */
let alvo=null;
function sala(a,b){ return [a,b].sort().join("_"); }

window.abrirChat=u=>{
  alvo=u;
  document.querySelector(".botaoVoltar").style.display="block";
  headerFoto.style.display="block"; headerFoto.src=u.foto;
  headerNome.textContent=u.nome;
  listaUsuarios.classList.add("hidden");
  msgInput.disabled=false; sendBtn.disabled=false;
  carregar();
};

window.voltarLista=()=>{
  alvo=null;
  listaUsuarios.classList.remove("hidden");
  headerFoto.style.display="none";
  document.querySelector(".botaoVoltar").style.display="none";
  headerNome.textContent="Selecione um usu√°rio";
  msgInput.disabled=true; sendBtn.disabled=true;
  mensagens.innerHTML="";
};

function carregar(){
  const path="chat/conversas/"+sala(uid,alvo.uid);
  onValue(ref(db,path),snap=>{
    mensagens.innerHTML="";
    snap.forEach(m=>{
      const d=m.val();
      const div=document.createElement("div");
      div.className="msg"+(d.de===uid?" me":"");
      div.innerHTML=`${d.texto}<div class="msgHora">${new Date(d.hora).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</div>`;
      mensagens.appendChild(div);
      if(d.de!==uid) somReceber.play().catch(()=>{});
    });
    mensagens.scrollTop=mensagens.scrollHeight;
  });
}

sendBtn.onclick=()=>{
  if(!msgInput.value) return;
  push(ref(db,"chat/conversas/"+sala(uid,alvo.uid)),{
    de:uid, nome, texto:msgInput.value, hora:Date.now()
  });
  somEnviar.play().catch(()=>{});
  msgInput.value="";
};
</script>

</body>
</html>
