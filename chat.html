<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Usuários Online</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
*{ box-sizing:border-box; }
html,body{ width:100%; max-width:100%; overflow-x:hidden; }
body{
  margin:0;
  background:#18191A;              /* ✅ estilo FB */
  font-family: Arial, sans-serif;
  color:#E4E6EB;                   /* ✅ texto FB */
  padding-bottom: env(safe-area-inset-bottom);
}

:root{
  --fb-bg:#18191A;
  --fb-surface:#242526;
  --fb-surface-2:#2D2E30;
  --fb-border:rgba(255,255,255,.10);
  --fb-text:#E4E6EB;
  --fb-muted:rgba(228,230,235,.72);
  --fb-blue:#0866FF;
  --fb-green:#31A24C;
  --fb-shadow:0 8px 18px rgba(0,0,0,.35);
  --fb-radius:16px;
}

/* topo */
.topbar{
  position: sticky;
  top:0;
  z-index: 9999;
  background: var(--fb-surface);
  border-bottom: 1px solid var(--fb-border);
  box-shadow: 0 6px 16px rgba(0,0,0,.25);
  padding: 10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
}

.topLeft{
  display:flex;
  align-items:center;
  gap:10px;
  min-width: 44px;
}
.topCenter{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  min-width:0;
}
.title{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight: 900;
  color: var(--fb-text);
  letter-spacing:.3px;
  font-size: 15px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 92vw;
}
.title i{ color: var(--fb-blue); }

.backBtn{
  color: var(--fb-text);
  text-decoration:none;
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius: 999px;
  border: 1px solid var(--fb-border);
  background: var(--fb-surface-2);
  box-shadow: 0 6px 14px rgba(0,0,0,.22);
  user-select:none;
}
.backBtn:active{ transform:scale(.99); }

.rightSpacer{
  width: 44px;
  flex: 0 0 auto;
}

.wrap{
  padding: 14px 12px;
  max-width: 760px;
  margin: 0 auto;
}

.card{
  background: var(--fb-surface);
  border: 1px solid var(--fb-border);
  box-shadow: var(--fb-shadow);
  border-radius: var(--fb-radius);
  padding: 14px;
}

.sub{
  opacity:1;
  font-size: 13px;
  margin-top: 6px;
  color: var(--fb-muted);
}

.list{
  margin-top: 14px;
  display:flex;
  flex-direction:column;
  gap: 10px;
}

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.04);
}

.left{
  display:flex;
  align-items:center;
  gap: 10px;
  min-width:0;
}

/* avatar */
.avatar{
  width:42px;
  height:42px;
  border-radius:50%;
  overflow:hidden;
  background:#3A3B3C;
  border:1px solid rgba(255,255,255,.08);
  display:flex;
  align-items:center;
  justify-content:center;
  flex:0 0 auto;
}
.avatar img{
  width:100%;
  height:100%;
  object-fit: cover;
}
.avatar .init{
  font-weight:900;
  color: var(--fb-text);
}

/* online dot */
.dot{
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--fb-green);
  box-shadow: 0 0 14px rgba(49,162,76,.55);
  animation: blinkDot 1.0s infinite;
  flex:0 0 auto;
}
@keyframes blinkDot{
  0%,100%{ transform: scale(1); opacity: 1; }
  50%{ transform: scale(1.25); opacity: .35; }
}

.name{
  font-weight: 900;
  color: var(--fb-text);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  min-width:0;
}

.time{
  font-size: 12px;
  color: var(--fb-muted);
  white-space:nowrap;
}

.empty{
  padding: 14px;
  border-radius: 14px;
  border: 1px dashed rgba(255,255,255,.16);
  background: rgba(255,255,255,.04);
  color: var(--fb-text);
  text-align:center;
  font-weight: 900;
}

.pillHead{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:900;
  color: var(--fb-text);
}
.pillHead i{ color: var(--fb-green); }

/* toque suave */
.row:active{ transform: scale(.995); }
</style>
</head>

<body>

<div class="topbar">
  <div class="topLeft">
    <a class="backBtn" href="javascript:history.back()">
      <i class="fa-solid fa-arrow-left"></i> Voltar
    </a>
  </div>

  <div class="topCenter">
    <div class="title"><i class="fa-solid fa-users"></i> Usuários Online</div>
  </div>

  <div class="rightSpacer"></div>
</div>

<div class="wrap">
  <div class="card">
    <div class="pillHead">
      <i class="fa-solid fa-circle"></i>
      <div>Lista em tempo real</div>
    </div>
    <div class="sub">Mostra quem está online agora.</div>

    <div class="list" id="list"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();

const listEl = document.getElementById("list");
const ONLINE_WINDOW_MS = 70000;

function escapeHTML(str){
  str = (str == null ? "" : String(str));
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function fmt(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}

DB.ref("presence").on("value", async snap=>{
  const obj = snap.val() || {};
  const now = Date.now();

  let arr = Object.values(obj).filter(u=>{
    return u && u.online === true && (now - (u.lastActive||0)) <= ONLINE_WINDOW_MS;
  });

  if(arr.length === 0){
    listEl.innerHTML = `<div class="empty">Ninguém online agora</div>`;
    return;
  }

  const rows = await Promise.all(arr.map(async u=>{
    const uid = u.uid;
    const nome = u.userName || "Usuário";
    const la = fmt(u.lastActive);

    let avatarHTML = `<div class="avatar"><div class="init">${escapeHTML(initials(nome))}</div></div>`;

    try{
      const pSnap = await DB.ref("profiles/"+uid).once("value");
      const p = pSnap.val() || {};
      const foto = p.avatarDataUrl || p.avatarUrl;
      if(foto){
        avatarHTML = `<div class="avatar"><img src="${escapeHTML(foto)}" alt="foto"></div>`;
      }
    }catch(e){}

    return `
      <div class="row">
        <div class="left">
          ${avatarHTML}
          <span class="dot"></span>
          <div class="name">${escapeHTML(nome)}</div>
        </div>
        <div class="time">${escapeHTML(la)}</div>
      </div>
    `;
  }));

  listEl.innerHTML = rows.join("");
});
</script>

</body>
</html>
