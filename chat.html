<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Lojas & Serviços (Estilo Facebook 2025) — Anúncios</title>

<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
<link rel="preconnect" href="https://coletivo-f34d4-default-rtdb.firebaseio.com" crossorigin>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  *{ box-sizing:border-box; }
  html,body{ width:100%; max-width:100%; overflow-x:hidden; }
  body{
    margin:0;
    background:#18191A;
    font-family: Arial, sans-serif;
    color:#E4E6EB;
    padding-bottom: env(safe-area-inset-bottom);
  }
  :root{
    --fb-bg:#18191A;
    --fb-surface:#242526;
    --fb-surface-2:#2D2E30;
    --fb-border:rgba(255,255,255,.10);
    --fb-text:#E4E6EB;
    --fb-muted:rgba(228,230,235,.72);
    --fb-blue:#0866FF;
    --fb-green:#31A24C;
    --fb-red:#F02849;
    --fb-shadow:0 8px 18px rgba(0,0,0,.35);
    --fb-radius:16px;
  }

  /* topo */
  .topbar{
    position: sticky;
    top: 0;
    z-index: 9999;
    background: var(--fb-surface);
    border-bottom: 1px solid var(--fb-border);
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  /* ✅ Brand agora fica "no centro à esquerda" (centralizado no topo, puxado p/ esquerda) */
  .brand{
    display:flex; align-items:center; gap:10px;
    min-width:0;
    flex: 1;                 /* ocupa o espaço para permitir centralizar o título */
    justify-content:center;  /* centraliza dentro da área esquerda */
  }
  .brand i{ color: var(--fb-blue); font-size: 22px; }
  .brand .title{
    font-weight: 900;
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* ✅ Botão Voltar (sem deslogar) */
  .backBtn{
    border:none;
    background: transparent;
    color: rgba(228,230,235,.92);
    cursor:pointer;
    font-size:18px;
    width:40px; height:40px;
    border-radius: 12px;
    display:flex; align-items:center; justify-content:center;
    flex: 0 0 auto;
  }
  .backBtn:hover{ background: rgba(255,255,255,.06); }

  .userBadge{
    display:flex; align-items:center; gap:10px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 8px 16px rgba(0,0,0,.18);
    user-select:none;
    min-width:0;
  }
  .userAvatar{
    width:34px; height:34px;
    border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    background: #3A3B3C;
    border:1px solid rgba(255,255,255,.10);
    font-weight:900;
    overflow:hidden;
    flex:0 0 auto;
  }
  .userName{
    font-weight: 900;
    font-size: 13px;
    max-width: 44vw;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* ====== BUSCA (AGORA FICA ACIMA) ====== */
  .filters{
    margin: 12px 12px 10px 12px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 10px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 8px 16px rgba(0,0,0,.18);
    color: var(--fb-text);
    font-weight: 900;
    font-size: 13px;
    user-select:none;
  }
  .chip input{
    background: transparent;
    border: none;
    outline:none;
    color: var(--fb-text);
    font-weight: 900;
    width: min(320px, 62vw);
  }
  .chip input::placeholder{ color: rgba(228,230,235,.55); }

  .tabs{
    display:flex;
    gap:8px;
  }
  .tabBtn{
    border:none;
    cursor:pointer;
    padding: 10px 14px;
    border-radius: 999px;
    font-weight: 900;
    background: rgba(255,255,255,.06);
    color: var(--fb-text);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 8px 16px rgba(0,0,0,.18);
    user-select:none;
  }
  .tabBtn.active{
    background: var(--fb-blue);
    color:#fff;
  }

  /* ====== ANUNCIAR (AGORA FICA ABAIXO DA BUSCA) ====== */
  .createRow{
    margin: 0 12px 12px 12px;
    background: var(--fb-surface);
    border: 1px solid var(--fb-border);
    box-shadow: var(--fb-shadow);
    border-radius: var(--fb-radius);
    padding: 12px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .fakeInput{
    flex:1;
    min-width:0;
    background:#3A3B3C;
    padding: 12px 14px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.08);
    color: rgba(228,230,235,.85);
    font-size: 15px;
    font-weight: 900;
    user-select:none;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .plusBtn{
    width:44px; height:44px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    color: var(--fb-text);
    font-size: 22px;
    font-weight: 900;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    transition:.12s;
    user-select:none;
  }
  .plusBtn:hover{ background: rgba(255,255,255,.08); }
  .plusBtn:active{ transform: scale(.98); }

  /* feed */
  #adsFeed{ padding-bottom: 22px; }
  .adCard{
    margin: 10px 12px;
    background: var(--fb-surface);
    border:1px solid var(--fb-border);
    box-shadow: var(--fb-shadow);
    border-radius: var(--fb-radius);
    overflow:hidden;
    position:relative;
    content-visibility: auto;
    contain-intrinsic-size: 820px;
  }

  .adHead{
    padding: 12px;
    display:flex;
    align-items:center;
    gap:10px;
    padding-right: 56px;
  }
  .adAvatar{
    width:44px; height:44px;
    border-radius:50%;
    overflow:hidden;
    background:#3A3B3C;
    border: 1px solid rgba(255,255,255,.10);
    display:flex; align-items:center; justify-content:center;
    font-weight: 900;
    flex:0 0 auto;
  }
  .adHeadText{ min-width:0; }
  .adOwner{
    font-weight: 900;
    font-size: 14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 70vw;
  }
  .adWhen{
    margin-top:3px;
    font-size:12px;
    color: var(--fb-muted);
  }

  .menuBtn{
    position:absolute;
    top: 10px;
    right: 10px;
    width: 40px; height: 40px;
    border-radius: 12px;
    display:flex; align-items:center; justify-content:center;
    font-size: 18px;
    cursor:pointer;
    color: rgba(255,255,255,.92);
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.08);
    user-select:none;
  }
  .menuBtn:hover{ background: rgba(255,255,255,.08); }

  .menuBox{
    position:absolute;
    top: 54px;
    right: 10px;
    background:#fff;
    color:#111;
    border-radius: 14px;
    box-shadow: 0 14px 28px rgba(0,0,0,.40);
    padding: 8px;
    display:none;
    min-width: 170px;
    z-index: 20;
  }
  .menuItem{
    padding: 10px 10px;
    border-radius: 12px;
    font-weight: 900;
    cursor:pointer;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
  }
  .menuItem:hover{ background: rgba(0,0,0,.06); }

  .adBody{ padding: 0 12px 12px 12px; }

  .adTitle{
    font-weight: 900;
    font-size: 18px;
    margin: 2px 0 6px 0;
    line-height: 1.15;
  }

  /* ====== FOTO (DEPOIS DO TÍTULO) ====== */
  .photos{
    margin-top: 10px;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  .photo{
    width:100%;
    aspect-ratio: 1/1;
    border-radius: 14px;
    overflow:hidden;
    background:#000;
    border: 1px solid rgba(255,255,255,.10);
    cursor:pointer;
    position:relative;
  }
  .photo img{
    width:100%; height:100%;
    object-fit: cover;
    display:block;
  }
  @media(max-width:520px){
    .photos{ grid-template-columns: repeat(2, 1fr); }
  }

  /* ====== DESCRIÇÃO (ABAIXO DA FOTO) ====== */
  .adDesc{
    margin: 10px 0 10px 0;
    font-size: 14px;
    line-height: 1.35;
    color: rgba(228,230,235,.95);
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* ====== ENDEREÇO / TELEFONE / LINK (ABAIXO) ====== */
  .metaCol{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin: 10px 0 10px 0;
  }
  .metaRow{
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    padding: 10px 12px;
  }
  .metaLabel{
    font-size: 11px;
    letter-spacing: .3px;
    text-transform: uppercase;
    color: rgba(228,230,235,.70);
    font-weight: 900;
    margin-bottom: 6px;
    display:flex; align-items:center; gap:8px;
  }
  .metaValue{
    font-size: 14px;
    font-weight: 900;
    color: rgba(228,230,235,.95);
    word-break: break-word;
  }
  .metaValue a{ color: #cfe0ff; text-decoration:none; }
  .metaValue a:hover{ text-decoration:underline; }

  /* botões */
  .actions{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top: 10px;
  }
  .actBtn{
    flex: 1 1 160px;
    min-width: 160px;
    border:none;
    border-radius: 14px;
    padding: 12px 12px;
    font-weight: 900;
    cursor:pointer;
    background: rgba(255,255,255,.06);
    color: var(--fb-text);
    border: 1px solid rgba(255,255,255,.10);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    user-select:none;
  }
  .actBtn:hover{ background: rgba(255,255,255,.08); }
  .actBtn.primary{
    background: var(--fb-blue);
    border-color: rgba(255,255,255,.10);
    color:#fff;
  }

  /* modal */
  .modal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.88);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 999999;
    padding: 14px;
  }
  .modalCard{
    width: min(860px, 96vw);
    max-height: min(90vh, 860px);
    overflow:auto;
    background: var(--fb-surface);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: var(--fb-shadow);
    border-radius: 18px;
  }
  .modalTop{
    position: sticky;
    top: 0;
    z-index: 5;
    background: rgba(36,37,38,.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255,255,255,.10);
    padding: 12px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .modalTitle{ font-weight: 900; display:flex; align-items:center; gap:10px; }
  .modalTitle i{ color: var(--fb-blue); }
  .closeBtn{
    border:none;
    border-radius: 12px;
    padding: 10px 12px;
    font-weight: 900;
    cursor:pointer;
    background: rgba(255,255,255,.06);
    color: var(--fb-text);
    border: 1px solid rgba(255,255,255,.10);
  }
  .closeBtn:hover{ background: rgba(255,255,255,.08); }

  .form{
    padding: 12px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media(max-width:720px){ .form{ grid-template-columns: 1fr; } }

  .field{
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    padding: 12px;
  }
  .field.full{ grid-column: 1 / -1; }
  .label{
    font-size: 11px;
    letter-spacing:.35px;
    text-transform: uppercase;
    color: rgba(228,230,235,.70);
    font-weight: 900;
    margin-bottom: 8px;
    display:flex; align-items:center; gap:8px;
  }
  .input, .textarea{
    width:100%;
    border: 1px solid rgba(255,255,255,.10);
    background:#3A3B3C;
    color: var(--fb-text);
    border-radius: 14px;
    padding: 12px 12px;
    outline:none;
    font-size: 14px;
    font-weight: 700;
  }
  .textarea{ min-height: 120px; resize: vertical; white-space: pre-wrap; }
  .hint{ margin-top: 8px; font-size: 12px; color: rgba(228,230,235,.70); line-height: 1.25; }

  .photoPicker{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 10px;
  }
  .pickBox{
    width: 120px;
    aspect-ratio: 1/1;
    border-radius: 16px;
    border: 1px dashed rgba(255,255,255,.22);
    background: rgba(255,255,255,.03);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    gap:8px;
    cursor:pointer;
    user-select:none;
    position:relative;
    overflow:hidden;
  }
  .pickBox:hover{ background: rgba(255,255,255,.05); }
  .pickBox img{ width:100%; height:100%; object-fit: cover; display:block; }
  .pickBox .cap{
    position:absolute;
    left:10px; right:10px; bottom:10px;
    background: rgba(0,0,0,.45);
    border: 1px solid rgba(255,255,255,.14);
    color:#fff;
    padding: 6px 8px;
    border-radius: 999px;
    font-weight: 900;
    font-size: 12px;
    text-align:center;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }
  .pickBox .x{
    position:absolute;
    top: 8px;
    right: 8px;
    width: 32px; height:32px;
    border-radius: 12px;
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(255,255,255,.18);
    display:flex; align-items:center; justify-content:center;
    color:#fff;
    font-weight: 900;
    cursor:pointer;
  }

  .modalFooter{
    padding: 12px;
    display:flex;
    gap: 10px;
    flex-wrap:wrap;
    border-top: 1px solid rgba(255,255,255,.10);
  }
  .bigBtn{
    flex: 1 1 220px;
    border:none;
    border-radius: 16px;
    padding: 14px 14px;
    font-weight: 900;
    cursor:pointer;
    background: rgba(255,255,255,.06);
    color: var(--fb-text);
    border: 1px solid rgba(255,255,255,.10);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .bigBtn.primary{ background: var(--fb-blue); color:#fff; }
  .bigBtn.danger{ background: var(--fb-red); color:#fff; }

  /* viewer */
  .viewer{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.92);
    display:none;
    z-index: 9999999;
    align-items:center;
    justify-content:center;
    padding: 16px;
  }
  .viewer img{
    width: min(980px, 100%);
    max-height: min(92vh, 860px);
    object-fit: contain;
    border-radius: 18px;
    background:#000;
    border: 1px solid rgba(255,255,255,.10);
  }
  .viewerClose{
    position:absolute;
    top: 14px;
    right: 14px;
    width: 46px; height:46px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color:#fff;
    font-size: 20px;
    cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }

  .empty{
    margin: 12px;
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    padding: 14px;
    color: rgba(228,230,235,.85);
    font-weight: 800;
    box-shadow: 0 10px 18px rgba(0,0,0,.18);
  }

  /* loading */
  .loadingOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.78);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 99999999;
    padding: 18px;
  }
  .loadingCard{
    width: min(520px, 92vw);
    background: var(--fb-surface);
    border:1px solid var(--fb-border);
    border-radius: 18px;
    box-shadow: var(--fb-shadow);
    padding:18px;
    text-align:center;
  }
  .spinner{
    width:46px;height:46px;border-radius:50%;
    border:4px solid rgba(255,255,255,.14);
    border-top-color: var(--fb-blue);
    margin:0 auto 10px auto;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg);} }
  .loadingText{ color: var(--fb-text); font-weight:900; letter-spacing:.4px; }
  .loadingSub{ margin-top:6px; color: var(--fb-text); opacity:.85; font-size:14px; }
</style>
</head>

<body>

<!-- LOADING -->
<div class="loadingOverlay" id="loadingOverlay">
  <div class="loadingCard">
    <div class="spinner"></div>
    <div class="loadingText" id="loadingText">Salvando...</div>
    <div class="loadingSub" id="loadingSub">Aguarde um instante</div>
  </div>
</div>

<!-- TOP -->
<div class="topbar">
  <!-- ✅ Botão VOLTAR (sem deslogar) -->
  <button class="backBtn" title="Voltar" aria-label="Voltar" onclick="goBackNoLogout()">
    <i class="fa-solid fa-arrow-left"></i>
  </button>

  <div class="brand">
    <i class="fa-solid fa-shop"></i>
    <div class="title">Lojas & Serviços</div>
  </div>

  <div style="display:flex;align-items:center;gap:10px;min-width:0;">
    <div class="userBadge" title="Usuário logado">
      <div class="userAvatar" id="userAvatar">U</div>
      <div class="userName" id="userName">Carregando...</div>
    </div>

    <!-- ✅ Removido botão SAIR / opção logout -->
  </div>
</div>

<!-- BUSCA (ACIMA) + TABS (TODOS / MEUS) -->
<div class="filters">
  <div class="chip" title="Buscar por título, descrição, endereço, telefone ou site">
    <i class="fa-solid fa-magnifying-glass"></i>
    <input id="searchInput" placeholder="Buscar anúncios…" />
  </div>

  <div class="tabs">
    <button class="tabBtn active" id="tabAll" type="button">Todos</button>
    <button class="tabBtn" id="tabMine" type="button">Meus</button>
  </div>
</div>

<!-- ANUNCIAR (ABAIXO DA BUSCA) -->
<div class="createRow">
  <div class="fakeInput">Anunciar</div>
  <div class="plusBtn" id="btnPlus" title="Criar anúncio" aria-label="Criar anúncio">+</div>
</div>

<!-- FEED -->
<div id="adsFeed"></div>

<!-- MODAL CREATE/EDIT -->
<div class="modal" id="adModal">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="Formulário de anúncio">
    <div class="modalTop">
      <div class="modalTitle" id="modalTitle"><i class="fa-solid fa-circle-plus"></i> Novo anúncio</div>
      <button class="closeBtn" onclick="closeModal()">Fechar</button>
    </div>

    <div class="form">
      <div class="field full">
        <div class="label"><i class="fa-solid fa-tag"></i> Título (Nome do serviço/loja)</div>
        <input class="input" id="fTitle" maxlength="60" placeholder="Ex: Pai Márcio" />
        <div class="hint">Máx. 60 caracteres.</div>
      </div>

      <div class="field full">
        <div class="label"><i class="fa-solid fa-align-left"></i> Descrição</div>
        <textarea class="textarea" id="fDesc" maxlength="900" placeholder="Explique seu serviço, horários, promoções…"></textarea>
        <div class="hint">Máx. 900 caracteres.</div>
      </div>

      <div class="field">
        <div class="label"><i class="fa-solid fa-location-dot"></i> Endereço</div>
        <input class="input" id="fAddress" maxlength="140" placeholder="Rua, número, bairro, cidade…" />
      </div>

      <div class="field">
        <div class="label"><i class="fa-solid fa-phone"></i> Telefone / WhatsApp</div>
        <input class="input" id="fPhone" maxlength="30" placeholder="Ex: 85984368057" />
      </div>

      <div class="field full">
        <div class="label"><i class="fa-solid fa-link"></i> Link do site (opcional)</div>
        <input class="input" id="fWebsite" maxlength="220" placeholder="https://seusite.com" />
        <div class="hint">Dica: se você digitar sem https://, o sistema adiciona automaticamente.</div>
      </div>

      <div class="field full">
        <div class="label"><i class="fa-solid fa-images"></i> Fotos (até 3)</div>
        <div class="photoPicker" id="photoPicker"></div>
        <div class="hint">✅ Você pode adicionar até <b>3 fotos</b>.</div>
      </div>
    </div>

    <div class="modalFooter">
      <button class="bigBtn danger" id="btnDelete" style="display:none;" onclick="deleteCurrentAd()">
        <i class="fa-solid fa-trash"></i> Excluir anúncio
      </button>

      <button class="bigBtn" onclick="closeModal()">
        <i class="fa-solid fa-xmark"></i> Cancelar
      </button>

      <button class="bigBtn primary" id="btnSave" onclick="saveAd()">
        <i class="fa-solid fa-floppy-disk"></i> Salvar anúncio
      </button>
    </div>
  </div>
</div>

<!-- IMAGE VIEWER -->
<div class="viewer" id="imgViewer" onclick="closeViewer(event)">
  <button class="viewerClose" aria-label="Fechar" title="Fechar"><i class="fa-solid fa-xmark"></i></button>
  <img id="viewerImg" alt="Foto do anúncio" />
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
/* ====================== ✅ VINCULAR AO LOGIN DO OUTRO SITE ====================== */
const LOGIN_URL = "https://marcio2307.github.io/terreiro/entrar.html";
const BACK_URL  = "https://marcio2307.github.io/terreiro/site.html";

function goBackNoLogout(){
  // ✅ só volta, sem remover nada do localStorage (sem deslogar)
  location.href = BACK_URL;
}

function normalizeNameKey(name){
  return (name || "")
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9\s]/g, "")
    .replace(/\s+/g, " ")
    .trim()
    .replace(/\s/g, "_");
}
function mustBeLogged(){
  const u = (localStorage.getItem("nome_passageiro") || "").trim();
  if(!u){
    location.replace(LOGIN_URL);
    return null;
  }
  return u;
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function escapeHTML(str){
  str = (str == null ? "" : String(str));
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function safeUrl(u){
  u = (u||"").trim();
  if(!u) return "";
  if(!/^https?:\/\//i.test(u)) u = "https://" + u;
  return u;
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}

/* ====================== FIREBASE ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();
const ST = firebase.storage();

/* ====================== ✅ LOGIN EXTERNO + UID FIXO POR USUÁRIO ====================== */
function getOrCreateDeviceUID(){
  let uid = localStorage.getItem("uid_passageiro");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem("uid_passageiro", uid);
  }
  sessionStorage.setItem("uid_passageiro", uid);
  return uid;
}

let USER_NAME = mustBeLogged();
if(!USER_NAME){ throw new Error("Not logged"); }

const nameKey = normalizeNameKey(USER_NAME);
let UID = localStorage.getItem("uid_user_" + nameKey) || localStorage.getItem("uid_passageiro") || getOrCreateDeviceUID();
localStorage.setItem("uid_user_" + nameKey, UID);
localStorage.setItem("uid_passageiro", UID);
sessionStorage.setItem("uid_passageiro", UID);

// sincroniza uid (mesmo padrão do seu site)
(async function syncUidWithFirebase(){
  try{
    const ref = DB.ref("usernames/" + nameKey);
    const snap = await ref.once("value");
    const remoteUid = snap.val();

    if(remoteUid && typeof remoteUid === "string" && remoteUid.length > 5){
      if(remoteUid !== UID){
        UID = remoteUid;
        localStorage.setItem("uid_user_" + nameKey, UID);
        localStorage.setItem("uid_passageiro", UID);
        sessionStorage.setItem("uid_passageiro", UID);
        location.reload();
        return;
      }
    }else{
      await ref.set(UID);
    }
  }catch(e){}
})();

/* UI do usuário */
(function paintUser(){
  document.getElementById("userName").textContent = USER_NAME;
  document.getElementById("userAvatar").textContent = initials(USER_NAME);
})();

/* ====================== LOADING ====================== */
const loadingOverlay = document.getElementById("loadingOverlay");
const loadingText = document.getElementById("loadingText");
const loadingSub  = document.getElementById("loadingSub");
function showLoading(title, sub){
  loadingText.textContent = title || "Salvando...";
  loadingSub.textContent = sub || "Aguarde um instante";
  loadingOverlay.style.display = "flex";
}
function hideLoading(){ loadingOverlay.style.display = "none"; }

/* ====================== REGRAS / LIMITES ====================== */
const MAX_PHOTOS = 3;
const MAX_IMG_MB = 15;
function checkSize(file){
  const mb = file.size/(1024*1024);
  if(file.type.startsWith("image/") && mb>MAX_IMG_MB){
    alert(`Imagem muito grande (${mb.toFixed(1)}MB). Envie até ${MAX_IMG_MB}MB.`);
    return false;
  }
  return true;
}

/* ====================== MODAL STATE ====================== */
const adModal = document.getElementById("adModal");
const modalTitle = document.getElementById("modalTitle");
const btnPlus = document.getElementById("btnPlus");
const btnDelete = document.getElementById("btnDelete");

const fTitle = document.getElementById("fTitle");
const fDesc = document.getElementById("fDesc");
const fAddress = document.getElementById("fAddress");
const fPhone = document.getElementById("fPhone");
const fWebsite = document.getElementById("fWebsite");
const photoPicker = document.getElementById("photoPicker");

let editingAdId = null;
let editingAdData = null;

let pickedFiles = [null,null,null];
let pickedPreviews = ["","",""];
let existingPhotos = [null,null,null];

function openModalCreate(){
  editingAdId = null;
  editingAdData = null;
  modalTitle.innerHTML = `<i class="fa-solid fa-circle-plus"></i> Novo anúncio`;
  btnDelete.style.display = "none";

  fTitle.value = "";
  fDesc.value = "";
  fAddress.value = "";
  fPhone.value = "";
  fWebsite.value = "";

  pickedFiles = [null,null,null];
  cleanupPreviews();
  pickedPreviews = ["","",""];
  existingPhotos = [null,null,null];

  renderPhotoPicker();
  adModal.style.display = "flex";
  document.body.style.overflow = "hidden";
}
function openModalEdit(adId, adData){
  if(!adData || adData.uid !== UID){
    alert("Você só pode editar seus próprios anúncios.");
    return;
  }
  editingAdId = adId;
  editingAdData = adData;

  modalTitle.innerHTML = `<i class="fa-solid fa-pen-to-square"></i> Editar anúncio`;
  btnDelete.style.display = "flex";

  fTitle.value = adData.title || "";
  fDesc.value = adData.desc || "";
  fAddress.value = adData.address || "";
  fPhone.value = adData.phone || "";
  fWebsite.value = adData.website || "";

  pickedFiles = [null,null,null];
  cleanupPreviews();
  pickedPreviews = ["","",""];

  const photos = Array.isArray(adData.photos) ? adData.photos : [];
  existingPhotos = [photos[0]||null, photos[1]||null, photos[2]||null];

  renderPhotoPicker();
  adModal.style.display = "flex";
  document.body.style.overflow = "hidden";
}
function closeModal(){
  adModal.style.display = "none";
  document.body.style.overflow = "";
}
adModal.addEventListener("click", (e)=>{
  if(e.target === adModal) closeModal();
});

function cleanupPreviews(){
  try{
    pickedPreviews.forEach(u=>{ if(u) URL.revokeObjectURL(u); });
  }catch(e){}
}

function renderPhotoPicker(){
  photoPicker.innerHTML = "";

  for(let i=0;i<MAX_PHOTOS;i++){
    const box = document.createElement("div");
    box.className = "pickBox";
    box.dataset.idx = String(i);

    const hasNew = !!pickedPreviews[i];
    const hasOld = !hasNew && existingPhotos[i] && existingPhotos[i].url;

    if(hasNew){
      box.innerHTML = `
        <img src="${pickedPreviews[i]}" alt="Foto ${i+1}">
        <div class="cap">Foto ${i+1}</div>
        <div class="x" title="Remover" aria-label="Remover">×</div>
      `;
    }else if(hasOld){
      box.innerHTML = `
        <img src="${existingPhotos[i].url}" alt="Foto ${i+1}">
        <div class="cap">Foto ${i+1}</div>
        <div class="x" title="Remover" aria-label="Remover">×</div>
      `;
    }else{
      box.innerHTML = `
        <i class="fa-solid fa-camera" style="font-size:22px;opacity:.9;"></i>
        <div style="font-weight:900;opacity:.9;">Adicionar</div>
        <div class="cap">Foto ${i+1}</div>
      `;
    }

    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "image/*";
    inp.style.display = "none";

    inp.addEventListener("change", (e)=>{
      const file = e.target.files[0];
      inp.value = "";
      if(!file) return;
      if(!checkSize(file)) return;

      if(pickedPreviews[i]){
        try{ URL.revokeObjectURL(pickedPreviews[i]); }catch(err){}
      }
      pickedFiles[i] = file;
      pickedPreviews[i] = URL.createObjectURL(file);
      renderPhotoPicker();
    });

    box.addEventListener("click", (e)=>{
      const target = e.target;
      if(target && target.classList && target.classList.contains("x")){
        e.preventDefault(); e.stopPropagation();
        removePhotoSlot(i);
        return;
      }
      inp.click();
    });

    photoPicker.appendChild(box);
    photoPicker.appendChild(inp);
  }
}
function removePhotoSlot(i){
  if(pickedPreviews[i]){
    try{ URL.revokeObjectURL(pickedPreviews[i]); }catch(e){}
  }
  pickedPreviews[i] = "";
  pickedFiles[i] = null;
  existingPhotos[i] = null;
  renderPhotoPicker();
}

/* ====================== IMAGE VIEWER ====================== */
const imgViewer = document.getElementById("imgViewer");
const viewerImg = document.getElementById("viewerImg");
function openViewer(url){
  if(!url) return;
  viewerImg.src = url;
  imgViewer.style.display = "flex";
  document.body.style.overflow = "hidden";
}
function closeViewer(e){
  const closeClicked = e && (e.target && (e.target.classList?.contains("viewerClose") || e.target.closest?.(".viewerClose")));
  const bgClicked = e && (e.target === imgViewer);
  if(!e || closeClicked || bgClicked){
    imgViewer.style.display = "none";
    viewerImg.src = "";
    document.body.style.overflow = "";
  }
}
document.querySelector(".viewerClose").addEventListener("click", (e)=>{
  e.preventDefault(); e.stopPropagation();
  closeViewer();
});

/* ====================== DB PATHS ====================== */
const ADS_PATH = "marketAds";

/* ====================== SAVE / DELETE ====================== */
async function saveAd(){
  const title = (fTitle.value || "").trim();
  const desc = (fDesc.value || "").trim();
  const address = (fAddress.value || "").trim();
  const phone = (fPhone.value || "").trim();
  const website = safeUrl(fWebsite.value || "");

  if(!title || title.length < 3){
    alert("Digite um título (mín. 3 caracteres).");
    return;
  }
  if(!desc || desc.length < 10){
    alert("Digite uma descrição (mín. 10 caracteres).");
    return;
  }

  showLoading(editingAdId ? "Atualizando anúncio..." : "Criando anúncio...", "Enviando fotos e salvando dados");

  try{
    const isEdit = !!editingAdId;
    const adId = editingAdId || ("ad_" + Date.now() + "_" + Math.random().toString(36).slice(2));

    let base = null;
    if(isEdit){
      const snap = await DB.ref(`${ADS_PATH}/${adId}`).once("value");
      base = snap.val() || null;
      if(!base || base.uid !== UID){
        alert("Você só pode editar seu próprio anúncio.");
        hideLoading();
        return;
      }
    }

    const finalPhotos = [null,null,null];

    async function tryDeleteOld(storagePath){
      if(!storagePath) return;
      try{ await ST.ref().child(storagePath).delete(); }catch(e){}
    }

    for(let i=0;i<MAX_PHOTOS;i++){
      const newFile = pickedFiles[i];
      const keepOld = existingPhotos[i];

      if(newFile){
        const storagePath = `marketAds/${UID}/${adId}/photo_${i+1}_${Date.now()}`;
        const ref = ST.ref().child(storagePath);
        await ref.put(newFile, { contentType: newFile.type || "image/jpeg" });
        const url = await ref.getDownloadURL();

        if(isEdit && base && Array.isArray(base.photos) && base.photos[i] && base.photos[i].storagePath){
          await tryDeleteOld(base.photos[i].storagePath);
        }
        finalPhotos[i] = { url, storagePath };
      }else if(keepOld && keepOld.url){
        finalPhotos[i] = keepOld;
      }else{
        if(isEdit && base && Array.isArray(base.photos) && base.photos[i] && base.photos[i].storagePath){
          await tryDeleteOld(base.photos[i].storagePath);
        }
        finalPhotos[i] = null;
      }
    }

    const cleanedPhotos = finalPhotos.filter(Boolean);

    const payload = {
      uid: UID,
      userName: USER_NAME,
      title,
      desc,
      address,
      phone,
      website,
      photos: cleanedPhotos,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    };

    if(!isEdit){
      payload.createdAt = firebase.database.ServerValue.TIMESTAMP;
    }else{
      payload.createdAt = base && base.createdAt ? base.createdAt : firebase.database.ServerValue.TIMESTAMP;
    }

    await DB.ref(`${ADS_PATH}/${adId}`).set(payload);

    closeModal();
    cleanupPreviews();
    pickedFiles = [null,null,null];
    pickedPreviews = ["","",""];
    existingPhotos = [null,null,null];
  }catch(err){
    console.log(err);
    alert("Erro ao salvar anúncio. Tente novamente.");
  }finally{
    hideLoading();
  }
}

async function deleteCurrentAd(){
  if(!editingAdId) return;
  if(!confirm("Deseja excluir este anúncio?")) return;

  showLoading("Excluindo anúncio...", "Removendo dados e fotos");
  try{
    const adId = editingAdId;
    const snap = await DB.ref(`${ADS_PATH}/${adId}`).once("value");
    const data = snap.val() || null;

    if(!data || data.uid !== UID){
      alert("Você só pode excluir seu próprio anúncio.");
      hideLoading();
      return;
    }

    await DB.ref(`${ADS_PATH}/${adId}`).remove();

    if(Array.isArray(data.photos)){
      for(const ph of data.photos){
        if(ph && ph.storagePath){
          try{ await ST.ref().child(ph.storagePath).delete(); }catch(e){}
        }
      }
    }

    closeModal();
  }catch(err){
    console.log(err);
    alert("Erro ao excluir anúncio.");
  }finally{
    hideLoading();
  }
}

/* ====================== FEED RENDER ====================== */
const adsFeed = document.getElementById("adsFeed");
const searchInput = document.getElementById("searchInput");

const tabAll  = document.getElementById("tabAll");
const tabMine = document.getElementById("tabMine");

let showOnlyMine = false;

let adsAll = [];
let adsFiltered = [];

function normalizeText(s){
  return (s||"")
    .toString()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function setTab(active){
  if(active === "mine"){
    showOnlyMine = true;
    tabMine.classList.add("active");
    tabAll.classList.remove("active");
  }else{
    showOnlyMine = false;
    tabAll.classList.add("active");
    tabMine.classList.remove("active");
  }
  applyFilters();
}

tabAll.addEventListener("click", ()=>setTab("all"));
tabMine.addEventListener("click", ()=>setTab("mine"));

function applyFilters(){
  const q = normalizeText(searchInput.value || "");

  adsFiltered = adsAll.filter(a=>{
    if(!a) return false;
    if(showOnlyMine && a.uid !== UID) return false;

    if(!q) return true;

    const blob = [a.title, a.desc, a.address, a.phone, a.website, a.userName].join(" • ");
    return normalizeText(blob).includes(q);
  });

  renderAds();
}

function toggleMenu(adId){
  const box = document.getElementById("menu_" + adId);
  if(!box) return;
  box.style.display = (box.style.display === "block" ? "none" : "block");
}

function closeAllMenus(exceptId){
  document.querySelectorAll(".menuBox").forEach(m=>{
    if(!exceptId || m.id !== ("menu_" + exceptId)) m.style.display = "none";
  });
}
document.addEventListener("click", (e)=>{
  const clickedMenu = e.target.closest(".menuBtn") || e.target.closest(".menuBox");
  if(!clickedMenu) closeAllMenus();
});

function adCardHTML(adId, a){
  const isMine = (a.uid === UID);
  const when = fmtDate(a.createdAt || a.updatedAt || Date.now());
  const photos = Array.isArray(a.photos) ? a.photos : [];
  const purls = photos.map(x=>x && x.url).filter(Boolean).slice(0,3);

  const address = (a.address||"").trim();
  const phone = (a.phone||"").trim();
  const website = (a.website||"").trim();

  const photosHTML = purls.length ? `
    <div class="photos">
      ${purls.map(u=>`
        <div class="photo" onclick="openViewer('${escapeHTML(u)}')" title="Ver foto">
          <img src="${escapeHTML(u)}" loading="lazy" alt="Foto do anúncio">
        </div>
      `).join("")}
    </div>
  ` : ``;

  const metaHTML = `
    <div class="metaCol">
      ${address ? `
        <div class="metaRow">
          <div class="metaLabel"><i class="fa-solid fa-location-dot"></i> Endereço</div>
          <div class="metaValue">${escapeHTML(address)}</div>
        </div>
      ` : ``}

      ${phone ? `
        <div class="metaRow">
          <div class="metaLabel"><i class="fa-solid fa-phone"></i> Telefone</div>
          <div class="metaValue">${escapeHTML(phone)}</div>
        </div>
      ` : ``}

      ${website ? `
        <div class="metaRow">
          <div class="metaLabel"><i class="fa-solid fa-link"></i> Link</div>
          <div class="metaValue"><a href="${escapeHTML(website)}" target="_blank" rel="noopener noreferrer">${escapeHTML(website)}</a></div>
        </div>
      ` : ``}
    </div>
  `;

  const waPhone = phone ? phone.replace(/[^\d+]/g,"") : "";
  const waLink = waPhone ? `https://wa.me/${waPhone.replace(/^\+/, "")}?text=${encodeURIComponent("Olá! Vi seu anúncio em Lojas & Serviços. Ainda está disponível?")}` : "";

  const waBtn = waLink ? `
    <button class="actBtn primary" onclick="window.open('${escapeHTML(waLink)}','_blank')">
      <i class="fa-brands fa-whatsapp"></i> WhatsApp
    </button>
  ` : ``;

  const callBtn = phone ? `
    <button class="actBtn" onclick="window.location.href='tel:${escapeHTML(waPhone || phone)}'">
      <i class="fa-solid fa-phone"></i> Ligar
    </button>
  ` : ``;

  const menu = isMine ? `
    <div class="menuBtn" onclick="toggleMenu('${adId}')">⋮</div>
    <div class="menuBox" id="menu_${adId}">
      <div class="menuItem" onclick="startEdit('${adId}')">
        <span><i class="fa-solid fa-pen-to-square"></i> Editar</span>
        <i class="fa-solid fa-chevron-right" style="opacity:.6;"></i>
      </div>
      <div class="menuItem" onclick="quickDelete('${adId}')" style="color:#b10015;">
        <span><i class="fa-solid fa-trash"></i> Excluir</span>
        <i class="fa-solid fa-chevron-right" style="opacity:.6;"></i>
      </div>
    </div>
  ` : ``;

  return `
    <div class="adCard" id="${escapeHTML(adId)}">
      ${menu}

      <div class="adHead">
        <div class="adAvatar">${escapeHTML(initials(a.userName || "Usuário"))}</div>
        <div class="adHeadText">
          <div class="adOwner">${escapeHTML(a.userName || "Usuário")}</div>
          <div class="adWhen">${escapeHTML(when)}</div>
        </div>
      </div>

      <div class="adBody">
        <div class="adTitle">${escapeHTML(a.title || "")}</div>

        ${photosHTML}

        <div class="adDesc">${escapeHTML(a.desc || "")}</div>

        ${metaHTML}

        <div class="actions">
          ${waBtn}
          ${callBtn}
        </div>
      </div>
    </div>
  `;
}

function renderAds(){
  if(!adsFiltered.length){
    adsFeed.innerHTML = `<div class="empty"><i class="fa-solid fa-circle-info"></i> Nenhum anúncio encontrado. Clique no <b>+</b> para anunciar.</div>`;
    return;
  }
  const sorted = adsFiltered.slice().sort((a,b)=>(b.createdAt||b.updatedAt||0)-(a.createdAt||a.updatedAt||0));
  adsFeed.innerHTML = sorted.map(a => adCardHTML(a.id, a)).join("");
}

async function startEdit(adId){
  closeAllMenus();
  const ad = adsAll.find(x=>x.id === adId);
  if(!ad) return;
  if(ad.uid !== UID){
    alert("Você só pode editar seus próprios anúncios.");
    return;
  }
  openModalEdit(adId, ad);
}

async function quickDelete(adId){
  closeAllMenus();
  const ad = adsAll.find(x=>x.id === adId);
  if(!ad) return;
  if(ad.uid !== UID){
    alert("Você só pode excluir seus próprios anúncios.");
    return;
  }
  if(!confirm("Deseja excluir este anúncio?")) return;

  showLoading("Excluindo anúncio...", "Removendo dados e fotos");
  try{
    const snap = await DB.ref(`${ADS_PATH}/${adId}`).once("value");
    const data = snap.val() || null;
    if(!data || data.uid !== UID){
      alert("Você só pode excluir seu próprio anúncio.");
      hideLoading();
      return;
    }
    await DB.ref(`${ADS_PATH}/${adId}`).remove();

    if(Array.isArray(data.photos)){
      for(const ph of data.photos){
        if(ph && ph.storagePath){
          try{ await ST.ref().child(ph.storagePath).delete(); }catch(e){}
        }
      }
    }
  }catch(err){
    console.log(err);
    alert("Erro ao excluir anúncio.");
  }finally{
    hideLoading();
  }
}

/* ====================== LISTENER ====================== */
(function listenAds(){
  const ref = DB.ref(ADS_PATH).limitToLast(300);

  ref.on("child_added", snap=>{
    const id = snap.key;
    const data = snap.val() || {};
    upsertAd(id, data);
  });
  ref.on("child_changed", snap=>{
    const id = snap.key;
    const data = snap.val() || {};
    upsertAd(id, data);
  });
  ref.on("child_removed", snap=>{
    const id = snap.key;
    adsAll = adsAll.filter(x=>x.id !== id);
    applyFilters();
  });
})();

function upsertAd(id, data){
  if(!id) return;
  const idx = adsAll.findIndex(x=>x.id === id);
  const item = { id, ...(data||{}) };
  if(idx >= 0) adsAll[idx] = item;
  else adsAll.push(item);
  applyFilters();
}

/* ====================== UI EVENTS ====================== */
btnPlus.addEventListener("click", openModalCreate);
searchInput.addEventListener("input", ()=>applyFilters());
</script>

</body>
</html>
