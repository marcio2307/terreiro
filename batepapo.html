<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Bate-papo (Grupo) ‚Ä¢ Facebook 2025 (Escuro)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --bg:#18191a;
    --surface:#242526;
    --surface2:#2d2e30;
    --text:#e4e6eb;
    --muted:#b0b3b8;
    --line:#3a3b3c;

    --primary:#0866ff;
    --primary2:#0b5cff;
    --primarySoft: rgba(8,102,255,.16);

    --good:#31a24c;
    --danger:#ff5b5b;

    --shadow:0 10px 22px rgba(0,0,0,.35);
  }

  *{ box-sizing:border-box; }
  html,body{ width:100%; height:100%; margin:0; overflow-x:hidden; }
  body{
    background: var(--bg);
    font-family: Arial, sans-serif;
    color: var(--text);
    padding-bottom: env(safe-area-inset-bottom);
    overscroll-behavior: none;
  }

  /* LOGIN */
  .login-overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.72);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 9999999;
    padding: 16px;
  }
  .login-card{
    width: min(520px, 94vw);
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 18px;
    text-align:center;
  }
  .login-title{
    font-size: clamp(18px, 6vw, 24px);
    font-weight: 900;
    color: var(--primary);
    letter-spacing:.3px;
    margin: 4px 0 14px 0;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .login-input{
    width: 100%;
    background: var(--surface2);
    border:1px solid var(--line);
    border-radius: 999px;
    padding: 14px 18px;
    color: var(--text);
    outline:none;
    font-size: 16px;
  }
  .login-input:focus{
    border-color: rgba(8,102,255,.65);
    box-shadow: 0 0 0 4px var(--primarySoft);
  }
  .login-btn{
    width: 100%;
    margin-top: 12px;
    border:none;
    border-radius: 999px;
    padding: 14px 12px;
    font-weight: 900;
    cursor:pointer;
    font-size: 16px;
    transition:.18s;
    background: var(--primary);
    color:#fff;
  }
  .login-btn:hover{ background: var(--primary2); }
  .login-btn:active{ transform: scale(.99); }

  /* LOADING */
  .loadingOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 99999999;
    padding: 18px;
  }
  .loadingCard{
    width: min(520px, 92vw);
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding:18px;
    text-align:center;
  }
  .spinner{
    width:42px;height:42px;border-radius:50%;
    border:4px solid rgba(8,102,255,.22);
    border-top-color: var(--primary);
    margin:0 auto 10px auto;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg);} }
  .loadingText{ color: var(--primary); font-weight:900; letter-spacing:.2px; }
  .loadingSub{ margin-top:6px; color: var(--muted); font-size:14px; }

  /* APP */
  .app{
    height: 100vh;
    height: 100dvh;
    display:flex;
    flex-direction:column;
    width:100%;
    overflow:hidden;
  }

  /* TOPBAR */
  .topbar{
    position: sticky;
    top:0;
    z-index: 9999;
    background: var(--surface);
    border-bottom: 1px solid var(--line);
    box-shadow: 0 2px 14px rgba(0,0,0,.35);
    padding-top: env(safe-area-inset-top);
  }
  .topbarInner{
    display:flex;
    flex-direction:column;
    justify-content:center;
    position:relative;
    padding: 10px;
    gap: 10px;
  }
  .topRow{
    height: 40px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }
  .backBtn{
    position:absolute;
    left: 0px;
    top: 50%;
    transform: translateY(-50%);
    display:flex;
    align-items:center;
    gap:10px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    cursor:pointer;
    user-select:none;
    text-decoration:none;
    font-weight:900;
  }
  .backBtn i{ font-size:16px; color: var(--primary); }
  .title{ font-weight:900; color: var(--text); letter-spacing:.2px; font-size: 18px; text-align:center; }
  .subtitle{ text-align:center; margin-top:-6px; color: var(--muted); font-size: 12px; font-weight: 800; }

  /* ONLINE BAR */
  .onlineBar{
    width:100%;
    overflow-x:auto;
    overflow-y:hidden;
    -webkit-overflow-scrolling: touch;
    display:flex;
    gap: 10px;
    padding: 0 2px 2px 2px;
  }
  .onlineBar::-webkit-scrollbar{ height:6px; }
  .onlineBar::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius:999px; }
  .oItem{ flex:0 0 auto; width: 56px; display:flex; flex-direction:column; align-items:center; gap:6px; user-select:none; }
  .oAvatar{
    width: 52px; height: 52px; border-radius: 50%;
    overflow:hidden; background:#3a3b3c; border: 2px solid var(--surface);
    box-shadow: 0 1px 10px rgba(0,0,0,.35);
    position:relative; display:flex; align-items:center; justify-content:center;
  }
  .oAvatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .oAvatar .init{ font-weight:900; color: var(--text); font-size: 14px; }
  .oDot{
    position:absolute; right: 3px; bottom: 3px;
    width: 12px; height: 12px; border-radius: 50%;
    background: var(--good); border: 2px solid var(--surface);
    box-shadow: 0 0 0 2px rgba(49,162,76,.18);
  }
  .oName{
    font-size: 10px; color: var(--muted);
    max-width: 56px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    text-align:center; font-weight: 800;
  }

  /* MESSAGES */
  .messages{
    flex:1;
    overflow-y:auto;
    overflow-x:hidden;
    padding: 12px 12px 14px 12px;
    background: var(--bg);
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  .msgRow{ display:flex; gap:10px; align-items:flex-end; margin-bottom: 12px; max-width: 100%; }
  .msgRow.me{ flex-direction: row-reverse; }

  .msgAvatar{
    width:38px;height:38px;border-radius:50%;
    overflow:hidden;
    background:#3a3b3c;
    border: 2px solid var(--surface);
    box-shadow: 0 1px 10px rgba(0,0,0,.35);
    flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;
  }
  .msgAvatar img{ width:100%;height:100%;object-fit:cover;display:block; }
  .msgAvatar .init{ font-weight:900; color: var(--text); }

  .msgBubbleWrap{ position:relative; display:inline-flex; flex-direction:column; max-width: min(78vw, 560px); }

  .msgBubble{
    position:relative;
    display:inline-block;
    width: fit-content;
    max-width: min(78vw, 560px);
    min-width: 86px;
    padding: 10px 44px 10px 12px;
    border-radius: 18px;
    box-shadow: 0 3px 14px rgba(0,0,0,.30);
    border: 1px solid rgba(255,255,255,.06);
    background: var(--surface);
    cursor:pointer;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .msgBubble.mediaOnly{ width: min(78vw, 560px); }
  .msgRow.me .msgBubble{
    background: var(--primary);
    color:#fff;
    border-color: rgba(8,102,255,.25);
  }

  .msgTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 6px; min-width:0; }
  .msgName{
    font-weight:900; color: var(--muted);
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    max-width: 55vw; font-size: 13px;
  }
  .msgRow.me .msgName{ color: rgba(255,255,255,.92); }
  .msgTime{ font-size:11px; color: var(--muted); white-space:nowrap; flex:0 0 auto; opacity:.95; }
  .msgRow.me .msgTime{ color: rgba(255,255,255,.90); }

  .msgText{
    white-space: pre-wrap;
    word-break: break-word;
    overflow-wrap:anywhere;
    opacity: .98;
    font-size: 15px;
    line-height: 1.25;
    display:inline;
  }

  .msgMedia{ margin-top: 8px; width:100%; }
  .msgMedia img{
    width: 100%;
    max-width: 520px;
    border-radius: 12px;
    display:block;
    background:#000;
    border: 1px solid rgba(255,255,255,.18);
  }
  .msgRow.me .msgMedia img{ border-color: rgba(255,255,255,.22); }

  .msgAudio{ margin-top: 8px; width:100%; }
  .msgAudio audio{ width: 100%; height: 36px; }

  .reactionBadge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    margin-top: 6px;
    width: fit-content;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.28);
    box-shadow: 0 10px 20px rgba(0,0,0,.25);
    font-weight: 900;
    font-size: 13px;
    color: var(--text);
  }
  .reactionBadge.like i{ color: #4e8cff; }
  .reactionBadge.love i{ color: #ff4d6d; }

  .msgMenuBtn{
    position:absolute;
    top: 8px;
    right: 8px;
    width: 36px;
    height: 30px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 22px;
    font-weight: 900;
    letter-spacing: 1px;
    cursor:pointer;
    user-select:none;
    line-height:1;
    color: rgba(255,255,255,.98);
    background: rgba(0,0,0,.42);
    border: 1px solid rgba(255,255,255,.22);
    border-radius: 12px;
    box-shadow: 0 8px 18px rgba(0,0,0,.38);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }
  .msgMenuBtn:active{ transform: scale(.96); }

  .msgMenuBox{
    position:absolute;
    top: 44px;
    right: 10px;
    z-index: 999;
    cursor:pointer;
    user-select:none;
    background: var(--surface2);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    font-weight: 900;
    font-size: 14px;
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
    white-space: nowrap;
    min-width: 140px;
    display:none;
    align-items:center;
    gap: 10px;
    justify-content:center;
  }
  .msgMenuBox i{ font-size: 16px; color: var(--danger); }

  /* COMPOSER */
  .composer{
    position: sticky;
    bottom: 0;
    z-index: 9998;
    background: var(--bg);
    padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px;
    border-top: 1px solid var(--line);
  }

  .composerBar{
    width: 100%;
    display:grid;
    grid-template-columns: auto 1fr auto;
    align-items:end;
    gap: 10px;
  }

  .leftTools{
    display:flex;
    align-items:center;
    gap: 8px;
    min-width: 0;
  }

  .toolBtn{
    width: 42px; height: 42px;
    border-radius: 50%;
    display:flex;
    align-items:center;
    justify-content:center;
    border: 1px solid rgba(255,255,255,.08);
    background: transparent;
    color: var(--primary);
    cursor:pointer;
    user-select:none;
    font-size: 19px;
    -webkit-tap-highlight-color: transparent;
  }
  .toolBtn:active{ transform: scale(.98); }

  .inputPill{
    min-width: 0;
    background: #3a3b3c;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.08);
    padding: 10px 10px;
    display:flex;
    align-items:center;
    gap: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,.25);
  }

  .pillTextarea{
    flex:1;
    min-width: 0;
    resize:none;
    border:none;
    outline:none;
    background: transparent;
    color: var(--text);
    font-size: 17px;
    line-height: 1.2;
    max-height: 140px;
    padding: 4px 2px;
  }
  .pillTextarea::placeholder{ color: rgba(255,255,255,.65); font-weight: 800; }

  .rightAction{
    display:flex;
    align-items:center;
    gap: 8px;
    min-width: 0;
  }

  .sendBtn{
    width: 42px; height: 42px;
    border-radius: 50%;
    display:flex; align-items:center; justify-content:center;
    border: none;
    background: var(--primary);
    color: #fff;
    cursor:pointer;
    user-select:none;
    box-shadow: 0 10px 18px rgba(8,102,255,.28);
    font-size: 18px;
    -webkit-tap-highlight-color: transparent;
  }
  .sendBtn:hover{ background: var(--primary2); }
  .sendBtn:active{ transform: scale(.98); }

  input[type="file"]{ display:none; }

  /* EMOJI PANEL */
  .emojiPanel{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(86px + env(safe-area-inset-bottom));
    width: min(520px, 94vw);
    background: var(--surface);
    border:1px solid var(--line);
    box-shadow: var(--shadow);
    border-radius: 16px;
    padding: 10px;
    display:none;
    z-index: 999999;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }
  .emojiGrid{ display:grid; grid-template-columns: repeat(8, 1fr); gap: 8px; }
  .emojiBtn{
    font-size: 22px;
    padding: 8px 0;
    border-radius: 12px;
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.08);
    cursor:pointer;
    user-select:none;
    text-align:center;
  }
  .emojiBtn:active{ transform: scale(.98); }
  .emojiTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 8px; }
  .emojiTop .ttl{ color: var(--text); font-weight: 900; }
  .emojiClose{
    width:36px;height:36px;border-radius: 12px;
    display:flex;align-items:center;justify-content:center;
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    color: var(--muted);
    cursor:pointer;
    user-select:none;
  }

  /* REC overlay */
  .recPill{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(92px + env(safe-area-inset-bottom));
    width: min(520px, 94vw);
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    padding: 10px 12px;
    display:none;
    z-index: 999999;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: var(--shadow);
  }
  .recRow{ display:flex; align-items:center; justify-content:space-between; gap: 10px; }
  .recLeft{ display:flex; align-items:center; gap: 10px; font-weight: 900; }
  .recDot{
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #ff2d55;
    box-shadow: 0 0 0 6px rgba(255,45,85,.15);
    animation: blink 1s infinite;
  }
  @keyframes blink{ 0%,50%{ opacity: 1; } 51%,100%{ opacity: .35; } }
  .recTime{ color: rgba(255,255,255,.9); }
  .recBtns{ display:flex; gap: 8px; align-items:center; }
  .miniBtn{
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.08);
    color: #fff;
    cursor:pointer;
    font-weight: 900;
    user-select:none;
  }
  .miniBtn.danger{
    background: rgba(255, 91, 91, .20);
    border-color: rgba(255, 91, 91, .35);
  }
  .miniBtn:active{ transform: scale(.99); }

  @media (max-width: 360px){
    .composerBar{ gap:8px; }
    .toolBtn,.sendBtn{ width:40px;height:40px; }
    .leftTools{ gap:6px; }
    .rightAction{ gap:6px; }
  }
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-title"><i class="fa-solid fa-user"></i> ENTRAR</div>
    <input id="loginName" class="login-input" maxlength="24" placeholder="Digite seu nome" autocomplete="off">
    <button class="login-btn" onclick="confirmarNome()">Entrar</button>
  </div>
</div>

<!-- LOADING -->
<div class="loadingOverlay" id="loadingOverlay">
  <div class="loadingCard">
    <div class="spinner"></div>
    <div class="loadingText" id="loadingText">Enviando...</div>
    <div class="loadingSub" id="loadingSub">Aguarde um instante</div>
  </div>
</div>

<div class="app">

  <!-- TOPO -->
  <div class="topbar">
    <div class="topbarInner">
      <div class="topRow">
        <a class="backBtn" href="#" onclick="goBackSite(event)">
          <i class="fa-solid fa-arrow-left"></i>
          <span>Voltar</span>
        </a>
        <div class="title">Grupo do terreiro</div>
      </div>

      <div class="subtitle">Online agora</div>
      <div class="onlineBar" id="onlineBar" aria-label="Usu√°rios online"></div>
    </div>
  </div>

  <!-- MENSAGENS -->
  <div class="messages" id="messages"></div>

  <!-- COMPOSER -->
  <div class="composer">
    <div class="composerBar">

      <!-- ‚úÖ esquerda: foto + emoji (emoji ao lado da foto) -->
      <div class="leftTools">
        <button class="toolBtn" title="Galeria" aria-label="Galeria" onclick="openFile()">
          <i class="fa-regular fa-image"></i>
        </button>

        <button class="toolBtn" title="Emojis" aria-label="Emojis" onclick="toggleEmojiPanel()">
          <i class="fa-regular fa-face-smile"></i>
        </button>
      </div>

      <!-- ‚úÖ meio: input SEM emoji dentro -->
      <div class="inputPill">
        <textarea id="msgInput" class="pillTextarea" rows="1" placeholder="Mensagem"></textarea>
      </div>

      <!-- ‚úÖ direita: enviar + gravar √°udio (√°udio no lugar do curtir) -->
      <div class="rightAction">
        <button class="sendBtn" title="Enviar" aria-label="Enviar" onclick="sendText()">
          <i class="fa-solid fa-paper-plane"></i>
        </button>

        <button class="toolBtn" title="√Åudio" aria-label="√Åudio" onclick="toggleRecord()">
          <i class="fa-solid fa-microphone"></i>
        </button>
      </div>

      <input type="file" id="imgInput" accept="image/*">
    </div>
  </div>

</div>

<!-- Emoji Panel -->
<div class="emojiPanel" id="emojiPanel">
  <div class="emojiTop">
    <div class="ttl">Emojis</div>
    <div class="emojiClose" onclick="toggleEmojiPanel(false)"><i class="fa-solid fa-xmark"></i></div>
  </div>
  <div class="emojiGrid" id="emojiGrid"></div>
</div>

<!-- REC overlay -->
<div class="recPill" id="recPill">
  <div class="recRow">
    <div class="recLeft">
      <span class="recDot"></span>
      <span>Gravando</span>
      <span class="recTime" id="recTime">00:00</span>
    </div>
    <div class="recBtns">
      <div class="miniBtn danger" onclick="cancelRecord()">Cancelar</div>
      <div class="miniBtn" onclick="stopRecord(true)">Enviar</div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
/* ====================== VOLTAR PARA O SITE ====================== */
const BACK_URL = "https://marcio2307.github.io/terreiro/site.html";
function goBackSite(ev){
  ev.preventDefault();
  window.location.href = BACK_URL;
}

/* ====================== FIREBASE ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();
const ST = firebase.storage();

/* ====================== SOM ====================== */
const CHAT_SOUND_URL = "somm.mp3";
const chatSfx = new Audio(CHAT_SOUND_URL);
chatSfx.preload = "auto";
chatSfx.volume = 1.0;

let audioUnlocked = false;
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  try{
    chatSfx.muted = false;
    const p = chatSfx.play();
    if(p && p.then){
      p.then(()=>{ chatSfx.pause(); chatSfx.currentTime = 0; }).catch(()=>{});
    }else{
      chatSfx.pause(); chatSfx.currentTime = 0;
    }
  }catch(e){}
}
document.addEventListener("touchstart", unlockAudioOnce, { once:true, passive:true });
document.addEventListener("click", unlockAudioOnce, { once:true });
document.addEventListener("pointerdown", unlockAudioOnce, { once:true });

function playChatSound(){
  if(!CHAT_SOUND_URL) return;
  try{
    chatSfx.pause();
    chatSfx.currentTime = 0;
    chatSfx.play().catch(()=>{});
  }catch(e){}
}

/* ====================== LOGIN + UID ====================== */
function getOrCreateUID(){
  let uid = localStorage.getItem("uid_passageiro");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem("uid_passageiro", uid);
  }
  sessionStorage.setItem("uid_passageiro", uid);
  return uid;
}
let UID = getOrCreateUID();

function getNomeSalvo(){
  return (localStorage.getItem("nome_passageiro") || "").trim();
}
let USER_NAME = getNomeSalvo();

const loginOverlay = document.getElementById("loginOverlay");
const loginName = document.getElementById("loginName");

function abrirLogin(){
  loginOverlay.style.display = "flex";
  document.body.style.overflow = "hidden";
  setTimeout(()=>{ try{ loginName.focus(); }catch(e){} }, 50);
}
function fecharLogin(){
  loginOverlay.style.display = "none";
  document.body.style.overflow = "";
}
function confirmarNome(){
  let nome = (loginName.value || "").trim();
  if(nome.length < 2){
    alert("Digite um nome com pelo menos 2 letras.");
    try{ loginName.focus(); }catch(e){}
    return;
  }
  localStorage.setItem("nome_passageiro", nome);
  USER_NAME = nome;
  UID = getOrCreateUID();
  fecharLogin();
  startPresence();
  setTimeout(()=>{ location.reload(); }, 80);
}
(function exigirLogin(){
  if(!USER_NAME) abrirLogin();
})();

function precisaLogin(){
  if(!USER_NAME){ abrirLogin(); return true; }
  return false;
}
document.addEventListener("keydown", (e)=>{
  if(loginOverlay.style.display === "flex" && e.key === "Enter"){ confirmarNome(); }
});

/* Helpers */
function escapeHTML(str){
  str = (str == null ? "" : String(str));
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}

/* ====================== LOADING ====================== */
const loadingOverlay = document.getElementById("loadingOverlay");
const loadingText = document.getElementById("loadingText");
const loadingSub  = document.getElementById("loadingSub");
function showLoading(title, sub){
  loadingText.textContent = title || "Enviando...";
  loadingSub.textContent = sub || "Aguarde um instante";
  loadingOverlay.style.display = "flex";
}
function hideLoading(){ loadingOverlay.style.display = "none"; }

/* ====================== PRESEN√áA ONLINE ====================== */
let presenceRef = null;
let presenceTimer = null;

function startPresence(){
  try{
    if(!USER_NAME || !UID) return;
    if(presenceTimer) return;

    presenceRef = DB.ref("presence/" + UID);

    const connectedRef = DB.ref(".info/connected");
    connectedRef.on("value", (snap)=>{
      if(snap.val() === true){
        presenceRef.onDisconnect().remove().catch(()=>{});
        presenceRef.set({
          uid: UID,
          userName: USER_NAME,
          online: true,
          onlineAt: firebase.database.ServerValue.TIMESTAMP,
          lastActive: firebase.database.ServerValue.TIMESTAMP
        }).catch(()=>{});
      }
    });

    presenceTimer = setInterval(()=>{
      if(!presenceRef) return;
      presenceRef.update({
        online: true,
        lastActive: firebase.database.ServerValue.TIMESTAMP
      }).catch(()=>{});
    }, 25000);

    window.addEventListener("beforeunload", ()=>{
      try{ stopPresence(true); }catch(e){}
    });
  }catch(e){}
}
function stopPresence(){
  try{
    if(presenceTimer){ clearInterval(presenceTimer); presenceTimer = null; }
    if(presenceRef){ presenceRef.remove().catch(()=>{}); presenceRef = null; }
  }catch(e){}
}
if(USER_NAME && UID){ startPresence(); }
</script>

<script>
/* ===================== PERFIS ===================== */
const profileCache = new Map();
function PROFILE_REF(uid){ return DB.ref("profiles/" + uid); }

async function getAvatarForUID(uid, fallbackName){
  if(!uid) return { url:"", name: fallbackName || "Usu√°rio" };
  if(profileCache.has(uid)) return profileCache.get(uid);

  try{
    const snap = await PROFILE_REF(uid).once("value");
    const p = snap.val() || {};
    const name = p.name || fallbackName || "Usu√°rio";
    const url = p.avatarDataUrl || p.avatarUrl || "";
    const obj = { url, name };
    profileCache.set(uid, obj);

    PROFILE_REF(uid).on("value", s=>{
      const px = s.val() || {};
      const nn = px.name || name;
      const uu = px.avatarDataUrl || px.avatarUrl || "";
      profileCache.set(uid, { url: uu, name: nn });

      document.querySelectorAll(`[data-avatar-uid="${uid}"]`).forEach(el=>{
        if(uu) el.innerHTML = `<img src="${uu}" alt="avatar">`;
        else el.innerHTML = `<div class="init">${escapeHTML(initials(nn||"U"))}</div>`;
      });
      document.querySelectorAll(`[data-name-uid="${uid}"]`).forEach(el=>{
        el.textContent = nn || "Usu√°rio";
      });

      const oAva = document.querySelector(`[data-online-avatar-uid="${uid}"]`);
      if(oAva){
        if(uu) oAva.innerHTML = `<img src="${uu}" alt="avatar"><span class="oDot"></span>`;
        else oAva.innerHTML = `<div class="init">${escapeHTML(initials(nn||"U"))}</div><span class="oDot"></span>`;
      }
      const oName = document.querySelector(`[data-online-name-uid="${uid}"]`);
      if(oName) oName.textContent = nn || "Usu√°rio";
    });

    return obj;
  }catch(e){
    const obj = { url:"", name: fallbackName || "Usu√°rio" };
    profileCache.set(uid, obj);
    return obj;
  }
}
</script>

<script>
/* ===================== ONLINE BAR ===================== */
const onlineBar = document.getElementById("onlineBar");

function onlineItemHTML(uid, name, avatarUrl){
  const ava = avatarUrl
    ? `<div class="oAvatar" data-online-avatar-uid="${escapeHTML(uid)}"><img src="${avatarUrl}" alt="avatar"><span class="oDot"></span></div>`
    : `<div class="oAvatar" data-online-avatar-uid="${escapeHTML(uid)}"><div class="init">${escapeHTML(initials(name||"U"))}</div><span class="oDot"></span></div>`;

  return `
    <div class="oItem" title="${escapeHTML(name||'Usu√°rio')}">
      ${ava}
      <div class="oName" data-online-name-uid="${escapeHTML(uid)}">${escapeHTML(name||"Usu√°rio")}</div>
    </div>
  `;
}

DB.ref("presence").on("value", async (snap)=>{
  const obj = snap.val() || {};
  const users = Object.values(obj).filter(Boolean)
    .sort((a,b)=>(b.lastActive||0)-(a.lastActive||0));

  const first = users.slice(0, 80);

  const htmls = await Promise.all(first.map(async u=>{
    const uid = u.uid || "";
    const nm  = u.userName || "Usu√°rio";
    const prof = await getAvatarForUID(uid, nm);
    return onlineItemHTML(uid, prof.name || nm, prof.url || "");
  }));

  onlineBar.innerHTML = htmls.join("");
});
</script>

<script>
/* ===================== CHAT (GRUPO) ===================== */
const ROOM_ID = "global";
const MSG_PATH = `groupChat/${ROOM_ID}/messages`;

const messagesEl = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const imgInput = document.getElementById("imgInput");

/* EMOJIS */
const emojiPanel = document.getElementById("emojiPanel");
const emojiGrid  = document.getElementById("emojiGrid");
const EMOJIS = ["üòÄ","üòÅ","üòÇ","ü§£","üòä","üòç","üòò","üòé",
                "üò¢","üò≠","üò°","üò±","üôè","‚ú®","üî•","üíñ",
                "üëç","üëé","üëè","üôå","ü§ù","üí¨","üéâ","üí•",
                "üåô","‚≠ê","üåü","üåà","üçÄ","üßø","üîÆ","üïØÔ∏è",
                "‚ù§Ô∏è","üíõ","üíö","üíô","üíú","ü§ç","üñ§","üíó"];
emojiGrid.innerHTML = EMOJIS.map(e=>`<div class="emojiBtn" onclick="insertEmoji('${e.replace(/'/g,"\\'")}')">${e}</div>`).join("");

function toggleEmojiPanel(force){
  const show = (typeof force === "boolean") ? force : (emojiPanel.style.display !== "block");
  emojiPanel.style.display = show ? "block" : "none";
}
function insertEmoji(e){
  msgInput.focus();
  const start = msgInput.selectionStart || 0;
  const end   = msgInput.selectionEnd || 0;
  const v = msgInput.value || "";
  msgInput.value = v.slice(0,start) + e + v.slice(end);
  const pos = start + e.length;
  msgInput.setSelectionRange(pos,pos);
}
document.addEventListener("click", (ev)=>{
  const inside = emojiPanel.contains(ev.target);
  const clickedEmojiBtn = ev.target.closest('[aria-label="Emojis"]');
  if(!inside && !clickedEmojiBtn && emojiPanel.style.display === "block"){
    if(!ev.target.closest(".composerBar")) toggleEmojiPanel(false);
  }
});

/* Auto-grow */
function autoGrow(){
  msgInput.style.height = "auto";
  msgInput.style.height = Math.min(msgInput.scrollHeight, 140) + "px";
}
msgInput.addEventListener("input", autoGrow);
autoGrow();

/* Enter envia */
msgInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendText();
  }
});

/* GALERIA */
function openFile(){
  if(precisaLogin()) return;
  imgInput.click();
}
imgInput.addEventListener("change", async ()=>{
  if(precisaLogin()) return;
  const file = imgInput.files && imgInput.files[0];
  if(!file) return;

  if(!file.type.startsWith("image/")){
    alert("Envie apenas imagem.");
    imgInput.value = "";
    return;
  }
  const mb = file.size/(1024*1024);
  if(mb > 15){
    alert(`Imagem muito grande (${mb.toFixed(1)}MB). Envie at√© 15MB.`);
    imgInput.value = "";
    return;
  }
  await sendImage(file);
  imgInput.value = "";
});

/* ENVIAR TEXTO */
async function sendText(){
  if(precisaLogin()) return;
  const text = (msgInput.value || "").trim();
  if(!text) return;

  toggleEmojiPanel(false);
  showLoading("Enviando...", "Publicando no chat");
  try{
    await pushMessage({ text, mediaUrl:null, mediaType:null, storagePath:null, kind:"text" });
    playChatSound();
    msgInput.value = "";
    autoGrow();
  }catch(err){
    console.log(err);
    alert("Erro ao enviar mensagem.");
  }finally{
    hideLoading();
  }
}

/* ENVIAR IMAGEM */
async function sendImage(file){
  if(precisaLogin()) return;
  const text = (msgInput.value || "").trim();
  toggleEmojiPanel(false);

  showLoading("Enviando imagem...", "No celular pode demorar um pouco");
  try{
    const msgId = "msg_" + Date.now() + "_" + Math.random().toString(36).slice(2);
    const storagePath = `groupChat/${ROOM_ID}/${UID}/${msgId}_img`;
    const ref = ST.ref().child(storagePath);

    await ref.put(file, { contentType: file.type });
    const url = await ref.getDownloadURL();

    await DB.ref(`${MSG_PATH}/${msgId}`).set({
      id: msgId,
      uid: UID,
      userName: USER_NAME,
      text: text || "",
      mediaUrl: url,
      mediaType: file.type,
      storagePath,
      kind: "image",
      createdAt: firebase.database.ServerValue.TIMESTAMP
    });

    playChatSound();
    msgInput.value = "";
    autoGrow();
  }catch(err){
    console.log(err);
    alert("Erro ao enviar imagem.");
  }finally{
    hideLoading();
  }
}

/* PUSH MSG */
async function pushMessage({text, mediaUrl, mediaType, storagePath, kind}){
  const msgId = "msg_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  await DB.ref(`${MSG_PATH}/${msgId}`).set({
    id: msgId,
    uid: UID,
    userName: USER_NAME,
    text: (text || "").toString(),
    mediaUrl: mediaUrl || null,
    mediaType: mediaType || null,
    storagePath: storagePath || null,
    kind: kind || "text",
    createdAt: firebase.database.ServerValue.TIMESTAMP
  });
}

/* ===================== √ÅUDIO: PEDIR PERMISS√ÉO NA 1¬™ VEZ ===================== */
let micPermissionAsked = (localStorage.getItem("mic_perm_ok") === "1");
async function ensureMicPermission(){
  if(micPermissionAsked) return true;
  try{
    const s = await navigator.mediaDevices.getUserMedia({ audio:true });
    s.getTracks().forEach(t=>t.stop());
    micPermissionAsked = true;
    localStorage.setItem("mic_perm_ok","1");
    return true;
  }catch(e){
    micPermissionAsked = false;
    localStorage.setItem("mic_perm_ok","0");
    alert("Permiss√£o do microfone negada. Ative o microfone nas permiss√µes do navegador.");
    return false;
  }
}

/* GRAVA√á√ÉO */
let recStream = null;
let recRecorder = null;
let recChunks = [];
let recTimer = null;
let recStartAt = 0;

const recPill = document.getElementById("recPill");
const recTimeEl = document.getElementById("recTime");

function fmtMMSS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}

async function toggleRecord(){
  if(precisaLogin()) return;

  const ok = await ensureMicPermission();
  if(!ok) return;

  if(recRecorder && recRecorder.state === "recording"){
    stopRecord(true);
    return;
  }

  try{
    toggleEmojiPanel(false);

    recStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    recChunks = [];

    let mime = "";
    if(window.MediaRecorder){
      if(MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) mime = "audio/webm;codecs=opus";
      else if(MediaRecorder.isTypeSupported("audio/webm")) mime = "audio/webm";
      else if(MediaRecorder.isTypeSupported("audio/mp4")) mime = "audio/mp4";
    }

    recRecorder = new MediaRecorder(recStream, mime ? { mimeType: mime } : undefined);

    recRecorder.ondataavailable = (e)=>{
      if(e.data && e.data.size > 0) recChunks.push(e.data);
    };

    recRecorder.onstop = async ()=>{
      try{
        if(recStream){
          recStream.getTracks().forEach(t=>t.stop());
          recStream = null;
        }
      }catch(e){}

      if(!recChunks.length) return;

      const blob = new Blob(recChunks, { type: recRecorder.mimeType || "audio/webm" });
      recChunks = [];

      if(window.__recCancelled){
        window.__recCancelled = false;
        return;
      }

      await sendAudioBlob(blob);
    };

    recStartAt = Date.now();
    recTimeEl.textContent = "00:00";
    recPill.style.display = "block";

    if(recTimer) clearInterval(recTimer);
    recTimer = setInterval(()=>{
      recTimeEl.textContent = fmtMMSS(Date.now() - recStartAt);
    }, 250);

    recRecorder.start(200);
    playChatSound();
  }catch(err){
    console.log(err);
    alert("N√£o consegui iniciar a grava√ß√£o. Verifique as permiss√µes do microfone.");
    try{
      if(recStream){ recStream.getTracks().forEach(t=>t.stop()); recStream=null; }
    }catch(e){}
    recPill.style.display = "none";
    if(recTimer){ clearInterval(recTimer); recTimer=null; }
  }
}

function cancelRecord(){
  if(recRecorder && recRecorder.state === "recording"){
    window.__recCancelled = true;
    stopRecord(false);
  }else{
    recPill.style.display = "none";
  }
}

function stopRecord(send){
  try{
    if(recTimer){ clearInterval(recTimer); recTimer=null; }
    recPill.style.display = "none";
    if(!send) window.__recCancelled = true;

    if(recRecorder && recRecorder.state === "recording"){
      recRecorder.stop();
    }
  }catch(e){}
}

async function sendAudioBlob(blob){
  showLoading("Enviando √°udio...", "No celular pode demorar um pouco");
  try{
    const msgId = "msg_" + Date.now() + "_" + Math.random().toString(36).slice(2);
    const ext = (blob.type.includes("mp4") ? "m4a" : "webm");
    const storagePath = `groupChat/${ROOM_ID}/${UID}/${msgId}_audio.${ext}`;
    const ref = ST.ref().child(storagePath);

    await ref.put(blob, { contentType: blob.type || "audio/webm" });
    const url = await ref.getDownloadURL();

    await DB.ref(`${MSG_PATH}/${msgId}`).set({
      id: msgId,
      uid: UID,
      userName: USER_NAME,
      text: "",
      mediaUrl: url,
      mediaType: blob.type || "audio/webm",
      storagePath,
      kind: "audio",
      createdAt: firebase.database.ServerValue.TIMESTAMP
    });

    playChatSound();
  }catch(err){
    console.log(err);
    alert("Erro ao enviar √°udio.");
  }finally{
    hideLoading();
  }
}

/* ===================== REA√á√ÉO: clique = curti | pressionou = amei ===================== */
function REACTION_REF(msgId){ return DB.ref(`${MSG_PATH}/${msgId}/reactions/${UID}`); }

async function setReaction(msgId, type){
  if(precisaLogin()) return;
  if(!msgId) return;

  try{
    const snap = await REACTION_REF(msgId).once("value");
    const cur = snap.val() || null;
    if(cur === type) await REACTION_REF(msgId).remove();
    else await REACTION_REF(msgId).set(type);
    playChatSound();
  }catch(e){ console.log(e); }
}

function reactionBadgeHTML(type){
  if(!type) return "";
  if(type === "like") return `<div class="reactionBadge like"><i class="fa-solid fa-thumbs-up"></i><span>Curti</span></div>`;
  if(type === "love") return `<div class="reactionBadge love"><i class="fa-solid fa-heart"></i><span>Amei</span></div>`;
  return "";
}

/* Menu ‚ãÆ e excluir */
function toggleMsgMenu(id){
  const box = document.getElementById("menu_"+id);
  if(!box) return;
  box.style.display = (box.style.display === "flex" ? "none" : "flex");
}
async function deleteMessage(id){
  try{
    const snap = await DB.ref(`${MSG_PATH}/${id}`).once("value");
    const data = snap.val();

    await DB.ref(`${MSG_PATH}/${id}`).remove();
    if(data && data.storagePath){
      await ST.ref().child(data.storagePath).delete().catch(()=>{});
    }
    playChatSound();
  }catch(err){
    console.log(err);
    alert("Erro ao excluir.");
  }
}

/* clique/hold */
let pressTimer = null;
let pressFired = false;
function onBubbleDown(ev, msgId){
  pressFired = false;
  clearTimeout(pressTimer);
  pressTimer = setTimeout(()=>{
    pressFired = true;
    setReaction(msgId, "love");
  }, 520);
}
function onBubbleUp(){ clearTimeout(pressTimer); }
function onBubbleCancel(){ clearTimeout(pressTimer); }
function onBubbleClick(ev, msgId){
  if(pressFired) return;
  setReaction(msgId, "like");
}
function bindMyReaction(msgId){
  REACTION_REF(msgId).on("value", (snap)=>{
    const type = snap.val() || null;
    const el = document.getElementById("react_"+msgId);
    if(el) el.innerHTML = reactionBadgeHTML(type);
  });
}

/* Render */
function messageHTML(m, avatarUrl, displayName, myReaction){
  const uid = m.uid || "";
  const name = displayName || m.userName || "Usu√°rio";
  const when = m.createdAt ? fmtDate(m.createdAt) : "";
  const text = escapeHTML(m.text || "");
  const isMe = uid === UID;

  const avatar = avatarUrl
    ? `<div class="msgAvatar" data-avatar-uid="${escapeHTML(uid)}" title="${escapeHTML(name)}"><img src="${avatarUrl}" alt="avatar"></div>`
    : `<div class="msgAvatar" data-avatar-uid="${escapeHTML(uid)}" title="${escapeHTML(name)}"><div class="init">${escapeHTML(initials(name))}</div></div>`;

  const media = (m.kind === "image" && m.mediaUrl)
    ? `<div class="msgMedia"><img src="${m.mediaUrl}" alt="imagem" loading="lazy"></div>`
    : "";

  const audio = (m.kind === "audio" && m.mediaUrl)
    ? `<div class="msgAudio"><audio controls preload="none" src="${m.mediaUrl}"></audio></div>`
    : "";

  const bubbleClass = (!text && (media || audio)) ? "msgBubble mediaOnly" : "msgBubble";

  return `
    <div class="msgRow ${isMe ? "me" : ""}" id="${escapeHTML(m.id)}">
      ${avatar}
      <div class="msgBubbleWrap">
        <div class="${bubbleClass}"
          onpointerdown="onBubbleDown(event, '${escapeHTML(m.id)}')"
          onpointerup="onBubbleUp(event)"
          onpointercancel="onBubbleCancel(event)"
          onclick="onBubbleClick(event, '${escapeHTML(m.id)}')"
        >
          <div class="msgMenuBtn" title="Op√ß√µes" aria-label="Op√ß√µes" onclick="event.stopPropagation(); toggleMsgMenu('${escapeHTML(m.id)}')">‚ãÆ</div>
          <div class="msgMenuBox" id="menu_${escapeHTML(m.id)}" onclick="event.stopPropagation(); deleteMessage('${escapeHTML(m.id)}')">
            <i class="fa-solid fa-trash"></i> Excluir
          </div>

          <div class="msgTop">
            <div class="msgName" data-name-uid="${escapeHTML(uid)}">${escapeHTML(name)}</div>
            <div class="msgTime">${escapeHTML(when)}</div>
          </div>

          ${text ? `<div class="msgText">${text}</div>` : ``}
          ${media}
          ${audio}
        </div>
        <div id="react_${escapeHTML(m.id)}">${reactionBadgeHTML(myReaction)}</div>
      </div>
    </div>
  `;
}

function scrollToBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }

/* Listener + som */
const rendered = new Set();
let firstLoadDone = false;

DB.ref(MSG_PATH).orderByChild("createdAt").limitToLast(200).on("child_added", async (snap)=>{
  const m = snap.val() || {};
  if(!m.id) m.id = snap.key;

  if(rendered.has(m.id)) return;
  rendered.add(m.id);

  const prof = await getAvatarForUID(m.uid, m.userName || "Usu√°rio");

  let myReaction = null;
  try{
    const rSnap = await REACTION_REF(m.id).once("value");
    myReaction = rSnap.val() || null;
  }catch(e){}

  const wrapper = document.createElement("div");
  wrapper.innerHTML = messageHTML(m, prof.url, prof.name, myReaction).trim();
  messagesEl.appendChild(wrapper.firstChild);

  bindMyReaction(m.id);

  if(firstLoadDone && m.uid && m.uid !== UID) playChatSound();
  setTimeout(()=>{ scrollToBottom(); }, 20);

  if(!firstLoadDone){
    clearTimeout(window.__firstLoadTimer);
    window.__firstLoadTimer = setTimeout(()=>{ firstLoadDone = true; }, 900);
  }
});

DB.ref(MSG_PATH).on("child_removed", (snap)=>{
  const id = snap.key;
  rendered.delete(id);
  const el = document.getElementById(id);
  if(el) el.remove();
});

/* Fecha menus ‚ãÆ ao clicar fora */
document.addEventListener("click", (e)=>{
  const clickedBtn = e.target.closest(".msgMenuBtn");
  const clickedBox = e.target.closest(".msgMenuBox");
  if(clickedBtn || clickedBox) return;
  document.querySelectorAll(".msgMenuBox").forEach(b=> b.style.display = "none");
});
</script>

</body>
</html>
