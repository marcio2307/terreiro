<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Entrar • Facecumba</title>

<link rel="preconnect" href="https://i.ibb.co" crossorigin>

<style>
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: Helvetica, Arial, sans-serif;
  background:#242526;
  color:#E4E6EB;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
}
.page{
  width:min(600px,100%);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:24px;
}
.brand{display:flex;align-items:center;justify-content:center;}
.brandLogo{
  width:320px;
  height:320px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.brandLogo img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
}
.card{
  width:100%;
  background:#18191A;
  border-radius:20px;
  padding:20px;
  box-shadow:0 20px 50px rgba(0,0,0,.6);
}
.input{
  width:100%;
  padding:15px;
  font-size:16px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:#3A3B3C;
  color:#E4E6EB;
  outline:none;
}
.input:focus{
  border-color:#0866FF;
  box-shadow:0 0 0 3px rgba(8,102,255,.25);
}
.btn{
  width:100%;
  margin-top:14px;
  padding:15px;
  font-size:17px;
  font-weight:900;
  border:none;
  border-radius:14px;
  cursor:pointer;
}
.btnPrimary{background:#0866FF;color:#fff;}
.btnGreen{background:#31A24C;color:#fff;}
.link{
  display:block;
  margin-top:14px;
  text-align:center;
  font-size:14px;
  font-weight:700;
  color:#86B7FF;
  text-decoration:none;
}
.link:hover{text-decoration:underline}
.divider{
  height:1px;
  background:rgba(255,255,255,.12);
  margin:16px 0;
}
.msg{
  display:none;
  margin-top:14px;
  padding:10px;
  border-radius:12px;
  font-weight:700;
}
.msg.ok{background:rgba(49,162,76,.2)}
.msg.err{background:rgba(240,40,73,.2)}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal{
  width:100%;
  max-width:440px;
  background:#18191A;
  padding:20px;
  border-radius:20px;
  position:relative;
  box-shadow:0 20px 50px rgba(0,0,0,.7);
}
.closeBtn{
  position:absolute;
  top:12px;
  right:12px;
  width:38px;
  height:38px;
  border-radius:50%;
  background:#3A3B3C;
  color:#E4E6EB;
  border:none;
  font-size:22px;
  font-weight:900;
  cursor:pointer;
}
.closeBtn:hover{ background:#4A4B4C; }

@media(max-width:420px){
  .brandLogo{width:240px;height:240px}
}
</style>
</head>

<body>

<div class="page">
  <div class="brand">
    <div class="brandLogo">
      <img src="https://i.ibb.co/5ggFxcG7/Design-sem-nome.png" alt="Facecumba">
    </div>
  </div>

  <div class="card">
    <input class="input" id="loginUser" placeholder="Usuário">
    <div style="height:12px"></div>
    <input class="input" id="loginPass" type="password" placeholder="Senha">

    <button class="btn btnPrimary" id="btnLogin">Entrar</button>

    <!-- ✅ AGORA VAI PARA A PÁGINA recuperar.html -->
    <a class="link" id="recoverLink" href="https://marcio2307.github.io/terreiro/recuperar.html">
      Esqueceu a senha?
    </a>

    <div class="divider"></div>

    <button class="btn btnGreen" id="btnOpenRegister">Criar nova conta</button>

    <div class="msg" id="msg"></div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <button class="closeBtn" id="btnCloseRegister">×</button>

    <input class="input" id="regUser" placeholder="Novo usuário">
    <div style="height:12px"></div>
    <input class="input" id="regPass" type="password" placeholder="Nova senha">

    <button class="btn btnGreen" id="btnRegister">Cadastrar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const SITE_URL = "https://marcio2307.github.io/terreiro/site.html";
const RECOVER_URL = "https://marcio2307.github.io/terreiro/recuperar.html";

/* ✅ COLE AQUI O SEU FIREBASE CONFIG (o mesmo do recuperar.html) */
const firebaseConfig = {
  apiKey: "COLE_AQUI",
  authDomain: "COLE_AQUI",
  projectId: "COLE_AQUI",
  storageBucket: "COLE_AQUI",
  messagingSenderId: "COLE_AQUI",
  appId: "COLE_AQUI"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = (id) => document.getElementById(id);
function showMsg(t, ok){
  const m = $("msg");
  m.className = "msg " + (ok ? "ok" : "err");
  m.textContent = t;
  m.style.display = "block";
}

async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const hashBuf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(hashBuf)].map(b => b.toString(16).padStart(2,"0")).join("");
}

/* ✅ Se já estiver logado neste navegador, pula */
(function autoSkipLogin(){
  const u = (localStorage.getItem("nome_passageiro") || "").trim();
  if(u){
    location.replace(SITE_URL);
  }
})();

/* ✅ Ao clicar em "Esqueceu a senha?", manda com usuário preenchido (opcional) */
$("recoverLink").addEventListener("click", (e) => {
  e.preventDefault();
  const u = ($("loginUser").value || "").trim();
  location.href = RECOVER_URL + (u ? ("?user=" + encodeURIComponent(u)) : "");
});

$("btnLogin").addEventListener("click", login);

$("btnOpenRegister").addEventListener("click", () => $("overlay").style.display = "flex");
$("btnCloseRegister").addEventListener("click", () => $("overlay").style.display = "none");
$("btnRegister").addEventListener("click", register);

async function login(){
  const u = $("loginUser").value.trim();
  const p = $("loginPass").value.trim();

  if(!u || !p) return showMsg("Preencha usuário e senha", false);

  try{
    const ref = doc(db, "facecumba_users", u);
    const snap = await getDoc(ref);

    if(!snap.exists()) return showMsg("Usuário não encontrado", false);

    const data = snap.data() || {};
    const passHash = data.passHash || "";

    const typedHash = await sha256(p);

    if(!passHash || typedHash !== passHash){
      return showMsg("Senha incorreta", false);
    }

    // "Logado" no navegador atual
    localStorage.setItem("nome_passageiro", u);

    location.href = SITE_URL;

  }catch(err){
    console.error(err);
    showMsg("Erro ao entrar. Verifique Firebase config e regras do Firestore.", false);
  }
}

async function register(){
  const u = $("regUser").value.trim();
  const p = $("regPass").value.trim();

  if(u.length < 3 || p.length < 4) return alert("Dados inválidos (usuário min 3, senha min 4).");

  try{
    const ref = doc(db, "facecumba_users", u);
    const snap = await getDoc(ref);

    if(snap.exists()) return alert("Esse usuário já existe.");

    const passHash = await sha256(p);

    await setDoc(ref, {
      passHash,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });

    $("overlay").style.display = "none";
    $("loginUser").value = u;
    $("loginPass").value = "";
    showMsg("Conta criada! Agora entre com sua senha.", true);

  }catch(err){
    console.error(err);
    alert("Erro ao cadastrar. Verifique Firebase config e regras do Firestore.");
  }
}
</script>

</body>
</html>
