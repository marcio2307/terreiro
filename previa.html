<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Pr√©via do Perfil</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  *{ box-sizing:border-box; }
  html,body{ width:100%; max-width:100%; overflow-x:hidden; }
  body{
    margin:0;
    background:#000;
    color:#fff;
    font-family: Arial, sans-serif;
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* TOPBAR */
  .topbar{
    position: sticky; top:0; z-index:9999;
    background:#0d0d0d;
    border-bottom:2px solid #00ff8c;
    box-shadow:0 0 15px #00ff8c;
    padding: 12px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .topbar .left{ display:flex; align-items:center; gap:10px; min-width:0; }
  .topbar .center{ flex:1; display:flex; justify-content:center; align-items:center; }
  .brand{
    font-weight:900;
    color:#00ff8c;
    letter-spacing:1px;
    text-shadow:0 0 10px #00ff8c, 0 0 20px #00ff8c;
    white-space:nowrap;
  }
  .btn{
    border:none;
    cursor:pointer;
    font-weight:900;
    padding:10px 12px;
    border-radius:999px;
    background:#00ff8c;
    color:#003b23;
    box-shadow:0 0 14px rgba(0,255,140,.55);
    user-select:none;
    display:inline-flex;
    align-items:center;
    gap:8px;
    justify-content:center;
    text-decoration:none;
  }
  .btn:active{ transform:scale(.99); }
  .btn.ghost{
    background:rgba(0,255,140,.10);
    color:#00ff8c;
    border:1px solid rgba(0,255,140,.35);
    box-shadow:0 0 12px rgba(0,255,140,.18);
  }
  .btn.icon{ width:44px; height:44px; padding:0; }
  .backLabel{
    font-weight:900;
    color:#00ff8c;
    text-shadow:0 0 10px rgba(0,255,140,.35);
    white-space:nowrap;
  }

  .wrap{ width:min(980px, 100%); margin:0 auto; }

  /* CAPA */
  .cover{
    position:relative;
    width:100%;
    height: clamp(190px, 36vw, 340px);
    background:#111;
    overflow:hidden;
    border-bottom:1px solid rgba(0,255,140,.22);
    cursor:pointer;
  }
  .cover img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    background:#000;
    filter: contrast(1.05) saturate(1.05);
  }
  .coverShade{
    position:absolute; inset:auto 0 0 0;
    height:55%;
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 35%, rgba(0,0,0,.85) 100%);
    pointer-events:none;
  }

  .avatarRow{
    position:relative;
    padding: 0 12px 12px 12px;
    margin-top: -58px;
    display:flex;
    gap:12px;
    align-items:flex-end;
    flex-wrap:wrap;
  }
  .avatar{
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow:hidden;
    background:#0d0d0d;
    border:4px solid #000;
    box-shadow: 0 0 0 3px rgba(0,255,140,.22), 0 10px 28px rgba(0,0,0,.55);
    flex:0 0 auto;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .avatar img{
    width:100%;
    height:100%;
    object-fit:cover;
    object-position:center;
    display:block;
  }
  .avatarInitial{
    font-weight:900; font-size:34px;
    color:#00ff8c;
    text-shadow:0 0 14px rgba(0,255,140,.45);
  }

  .identity{ min-width: 220px; flex:1; }
  .identity h1{
    margin:0;
    font-size: clamp(22px, 6vw, 34px);
    font-weight: 900;
    letter-spacing:.2px;
    color:#00ff8c;
    text-shadow:0 0 10px rgba(0,255,140,.35);
  }
  .sub{
    margin-top:8px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    opacity:.95;
  }
  .pill{
    display:inline-flex;
    gap:8px;
    align-items:center;
    padding:7px 12px;
    border-radius:999px;
    background: rgba(0,255,140,.10);
    border:1px solid rgba(0,255,140,.25);
    color:#00ff8c;
    font-weight:900;
    font-size:13px;
  }
  .dot{
    width:10px; height:10px; border-radius:50%;
    box-shadow:0 0 14px rgba(0,0,0,.35);
  }
  .dot.online{ background:#00ff4c; box-shadow:0 0 14px rgba(0,255,76,.9); animation: blinkDot .9s infinite; }
  .dot.offline{ background:#ffd000; box-shadow:0 0 14px rgba(255,208,0,.75); }
  @keyframes blinkDot{
    0%,100%{ transform:scale(1); opacity:1; }
    50%{ transform:scale(1.35); opacity:.25; }
  }
  .pill.offline{
    background: rgba(255,208,0,.10);
    border:1px solid rgba(255,208,0,.35);
    color:#ffd000;
  }

  .card{
    background:#0d0d0d;
    border:1px solid rgba(0,255,140,.25);
    border-radius:18px;
    padding:12px;
    box-shadow:0 0 14px rgba(0,255,140,.14);
    margin: 12px;
  }

  /* BIO acima do feed */
  .bioBox{
    border:1px solid rgba(255,255,255,.06);
    background: rgba(255,255,255,.03);
    border-radius:14px;
    padding:12px;
    margin-top:10px;
  }
  .bioTitle{
    font-weight:900;
    color:#00ff8c;
    letter-spacing:.4px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .bioText{
    margin-top:10px;
    opacity:.92;
    line-height:1.45;
    word-break:break-word;
  }

  /* POSTS */
  .post{
    background:#0d0d0d;
    margin: 12px 0;
    padding: 15px;
    border-radius:16px;
    border:1px solid #00ff9d;
    box-shadow:0 0 10px rgba(0,255,157,.25);
    position:relative;
  }
  .postHead{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .postAvatar{
    width:52px;
    height:52px;
    border-radius:50%;
    overflow:hidden;
    background:#000;
    border:2px solid rgba(0,255,157,.55);
    box-shadow:0 0 14px rgba(0,255,157,.22);
    flex:0 0 auto;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .postAvatar img{
    width:100%;
    height:100%;
    object-fit:cover;
    object-position:center;
    display:block;
  }
  .postAvatar .init{ font-weight:900; color:#00ff9d; }
  .postName{
    font-weight:900;
    font-size:22px;
    color:#7bffb5;
    text-shadow: 0 0 10px rgba(0,255,157,.25);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 62vw;
  }
  .when{
    font-size:12px;
    color:#00ff9d;
    opacity:.85;
    margin-top:4px;
  }
  .post p{ margin:12px 0 0 0; opacity:.96; }

  .mediaWrap img, .mediaWrap video{
    width:100%;
    border-radius:12px;
    margin-top:10px;
    background:#000;
    display:block;
  }

  /* A√á√ïES (curtir/comentar) */
  .post-actions{
    display:flex;
    justify-content:space-around;
    margin-top:14px;
    flex-wrap:wrap;
    gap:10px;
  }
  .btn-action{
    color:#00ff9d;
    padding:10px 12px;
    border-radius:12px;
    font-weight:900;
    cursor:pointer;
    transition:0.2s;
    text-align:center;
    border: 1px solid rgba(0,255,157,.25);
    background: rgba(0,0,0,.15);
    user-select:none;
    min-width:160px;
  }
  .contador{
    margin-top:6px;
    font-size:13px;
    color:#00ff9d;
    text-align:center;
    opacity:.95;
    line-height:1.35;
    word-break: break-word;
  }

  .coment-area{
    background:#111;
    padding:10px;
    margin-top:10px;
    border-radius:12px;
    display:none;
    border:1px solid rgba(0,255,140,.22);
  }

  .cRow{
    background:#000;
    border:1px solid rgba(0,255,157,.35);
    padding:10px;
    border-radius:10px;
    margin-bottom:8px;
  }
  .cHead{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:6px;
    min-width:0;
  }
  .cAvatar{
    width:34px; height:34px;
    border-radius:50%;
    overflow:hidden;
    background:#000;
    border:1px solid rgba(0,255,157,.45);
    flex:0 0 auto;
    display:flex; align-items:center; justify-content:center;
  }
  .cAvatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .cAvatar .init{ font-weight:900; color:#00ff9d; }
  .cName{
    font-weight:900;
    color:#00ff9d;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 62vw;
  }
  .cText{ opacity:.95; }

  .empty{
    opacity:.85;
    padding:12px;
    border:1px solid rgba(255,255,255,.06);
    background: rgba(255,255,255,.03);
    border-radius:14px;
    margin-top:12px;
  }

  /* LOGIN (pra curtir/comentar) */
  .login-overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.94);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 9999999;
    padding: 16px;
  }
  .login-card{
    width: min(520px, 94vw);
    max-width: 94vw;
    background:#0d0d0d;
    border:2px solid #00ff8c;
    border-radius:22px;
    box-shadow:0 0 28px rgba(0,255,140,.45);
    padding: 18px;
    text-align:center;
  }
  .login-title{
    font-size: clamp(18px, 6vw, 26px);
    font-weight: 900;
    color:#00ff8c;
    text-transform:uppercase;
    letter-spacing:1.2px;
    text-shadow: 0 0 10px #00ff8c, 0 0 22px #00ff8c;
    margin: 4px 0 14px 0;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .login-input{
    width: 100%;
    display:block;
    background:#111;
    border:1px solid #00ff9d;
    border-radius: 999px;
    padding: 14px 18px;
    color:#fff;
    outline:none;
    font-size: 16px;
    box-shadow: inset 0 0 10px rgba(0,255,157,.22);
  }
  .login-btn{
    width: 100%;
    margin-top: 12px;
    border:none;
    border-radius: 999px;
    padding: 16px 12px;
    font-weight: 900;
    cursor:pointer;
    font-size: 18px;
    transition:.18s;
    background:#00ff8c;
    color:#003b23;
    box-shadow:0 0 18px rgba(0,255,140,.55);
  }

  /* TOAST STATUS */
  .toastStatus{
    position: fixed;
    left: 50%;
    bottom: calc(16px + env(safe-area-inset-bottom));
    transform: translateX(-50%);
    background: rgba(0,0,0,.82);
    border: 1px solid rgba(0,255,140,.35);
    box-shadow: 0 0 18px rgba(0,255,140,.22);
    color: #fff;
    padding: 10px 14px;
    border-radius: 999px;
    font-weight: 900;
    display:none;
    align-items:center;
    gap:10px;
    z-index: 99999999;
    max-width: 92vw;
    text-align:center;
  }
  .toastDot{
    width:10px; height:10px; border-radius:50%;
  }
  .toastDot.on{ background:#00ff4c; box-shadow:0 0 14px rgba(0,255,76,.9); }
  .toastDot.off{ background:#ffd000; box-shadow:0 0 14px rgba(255,208,0,.75); }
</style>
</head>

<body>

<!-- LOGIN (pra curtir/comentar) -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-title"><i class="fa-solid fa-user"></i> ENTRAR</div>
    <input id="loginName" class="login-input" maxlength="24" placeholder="Digite seu nome" autocomplete="off">
    <button class="login-btn" onclick="confirmarNome()">Entrar</button>
  </div>
</div>

<!-- TOAST STATUS -->
<div class="toastStatus" id="toastStatus" aria-live="polite">
  <span class="toastDot on" id="toastDot"></span>
  <span id="toastText">Online</span>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="left">
    <button class="btn ghost icon" title="Voltar" aria-label="Voltar" onclick="goBack()">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <div class="backLabel">Voltar</div>
  </div>
  <div class="center">
    <div class="brand"></div>
  </div>
  <div style="width:44px;"></div>
</div>

<div class="wrap">

  <!-- CAPA -->
  <div class="cover" id="previewClickableCover" title="Toque para ver o status">
    <img id="coverImg" alt="Capa do perfil">
    <div class="coverShade"></div>
  </div>

  <!-- FOTO PERFIL + IDENTIDADE -->
  <div class="avatarRow">
    <div class="avatar" id="previewClickableAvatar" title="Toque para ver o status">
      <img id="avatarImg" alt="Foto do perfil" style="display:none;">
      <div id="avatarInitial" class="avatarInitial">U</div>
    </div>

    <div class="identity">
      <h1 id="profileName">Carregando...</h1>
      <div class="sub">
        <span class="pill" id="statusPill">
          <span class="dot online" id="statusDot"></span>
          <span id="statusText">Online</span>
        </span>
        <span class="pill"><i class="fa-solid fa-location-dot"></i> <span id="cityText">‚Äî</span></span>
      </div>
    </div>
  </div>

  <!-- BIO + FEED -->
  <div class="card">
    <div class="bioTitle"><i class="fa-solid fa-circle-info"></i> Biografia</div>

    <div class="bioBox">
      <div class="bioText" id="bioText">Carregando...</div>
    </div>

    <div style="margin-top:14px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight:900; color:#00ff8c; letter-spacing:.4px;">
        <i class="fa-solid fa-list"></i> Feed do usu√°rio
      </div>
      <div style="opacity:.85; font-size:13px;" id="postsCount">0 postagens</div>
    </div>

    <div id="feed" style="margin-top:10px;"></div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ====================== FIREBASE (MESMO DO SEU SITE) ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();

/* ====================== PARAMS: uid do perfil e back (voltar) ====================== */
function getParams(){
  const u = new URLSearchParams(location.search);
  return {
    uid: (u.get("uid") || "").trim(),
    back: (u.get("back") || "").trim()
  };
}
const PARAMS = getParams();
const TARGET_UID = PARAMS.uid;

function goBack(){
  if(PARAMS.back){
    window.location.href = PARAMS.back;
  }else{
    history.back();
  }
}

/* ====================== LOGIN (pra curtir/comentar) ====================== */
function getOrCreateUID(){
  let uid = localStorage.getItem("uid_passageiro");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem("uid_passageiro", uid);
  }
  return uid;
}
let UID = getOrCreateUID();
let USER_NAME = (localStorage.getItem("nome_passageiro") || "").trim();

function abrirLogin(){
  loginOverlay.style.display = "flex";
  document.body.style.overflow = "hidden";
  setTimeout(()=>{ try{ loginName.focus(); }catch(e){} }, 50);
}
function fecharLogin(){
  loginOverlay.style.display = "none";
  document.body.style.overflow = "";
}
function confirmarNome(){
  let nome = (loginName.value || "").trim();
  if(nome.length < 2){
    alert("Digite um nome com pelo menos 2 letras.");
    try{ loginName.focus(); }catch(e){}
    return;
  }
  localStorage.setItem("nome_passageiro", nome);
  USER_NAME = nome;
  UID = getOrCreateUID();
  fecharLogin();
}
function precisaLogin(){
  if(!USER_NAME){
    abrirLogin();
    return true;
  }
  return false;
}
document.addEventListener("keydown", (e)=>{
  if(loginOverlay.style.display === "flex" && e.key === "Enter"){ confirmarNome(); }
});

/* Helpers */
function escapeHTML(str){
  return (str || "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}

/* ====================== UI: AVATAR / CAPA / STATUS ====================== */
function setAvatar(url, name){
  if(url){
    avatarImg.src = url;
    avatarImg.style.display = "block";
    avatarInitial.style.display = "none";
  }else{
    avatarImg.style.display = "none";
    avatarInitial.style.display = "block";
    avatarInitial.textContent = initials(name || "U");
  }
}
function setCover(url){
  coverImg.src = url || "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="520">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#0d0d0d"/>
          <stop offset="1" stop-color="#111"/>
        </linearGradient>
      </defs>
      <rect width="100%" height="100%" fill="url(#g)"/>
      <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle"
            fill="rgba(0,255,140,.35)" font-size="52" font-family="Arial" font-weight="900">
        PERFIL
      </text>
    </svg>
  `);
}

/* ‚úÖ status do perfil que est√° aberto (TARGET_UID) */
let CURRENT_TARGET_ONLINE = false;

/* ‚úÖ status do PR√ìPRIO usu√°rio (UID local: uid_passageiro) */
let CURRENT_SELF_ONLINE = true; // se est√° navegando aqui, consideramos online (e atualizamos presen√ßa)

function setStatus(isOnline){
  CURRENT_TARGET_ONLINE = !!isOnline;
  if(isOnline){
    statusText.textContent = "Online";
    statusDot.classList.remove("offline");
    statusDot.classList.add("online");
    statusPill.classList.remove("offline");
    statusPill.classList.add("pill");
  }else{
    statusText.textContent = "Offline";
    statusDot.classList.remove("online");
    statusDot.classList.add("offline");
    statusPill.classList.add("offline");
  }
}

/* ‚úÖ marca presen√ßa do PR√ìPRIO usu√°rio na tabela presence/{UID} */
function startSelfPresence(){
  const ref = DB.ref("presence/" + UID);
  function ping(){
    ref.update({
      online: true,
      lastActive: firebase.database.ServerValue.TIMESTAMP
    }).catch(()=>{});
  }
  ping();
  setInterval(ping, 25000);

  // tenta ficar offline ao sair
  try{
    window.addEventListener("beforeunload", ()=>{
      ref.update({ online:false, lastActive: Date.now() }).catch(()=>{});
    });
  }catch(e){}
}

/* ‚úÖ escuta presen√ßa do PR√ìPRIO usu√°rio */
function listenSelfPresence(){
  DB.ref("presence/" + UID).on("value", snap=>{
    const u = snap.val() || {};
    const last = u.lastActive || 0;
    const now = Date.now();
    CURRENT_SELF_ONLINE = (u.online === true) && (now - last < 65000);
  });
}

/* ‚úÖ mostrar status ao clicar na pr√©via
   - se estou vendo meu pr√≥prio perfil (TARGET_UID === UID): mostra "VOC√ä est√° Online/Offline"
   - se √© outro perfil: mostra status do perfil alvo */
let toastTimer = null;
function showStatusToast(){
  const isSelfProfile = (TARGET_UID && UID && TARGET_UID === UID);
  const on = isSelfProfile ? (CURRENT_SELF_ONLINE === true) : (CURRENT_TARGET_ONLINE === true);
  const label = isSelfProfile ? (on ? "Voc√™ est√° Online" : "Voc√™ est√° Offline") : (on ? "Online agora" : "Offline agora");

  toastDot.classList.toggle("on", on);
  toastDot.classList.toggle("off", !on);
  toastText.textContent = label;

  toastStatus.style.display = "inline-flex";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ toastStatus.style.display = "none"; }, 1600);
}
previewClickableCover.addEventListener("click", showStatusToast);
previewClickableAvatar.addEventListener("click", showStatusToast);

/* ====================== CARREGAR PERFIL ====================== */
async function loadProfile(){
  if(!TARGET_UID){
    profileName.textContent = "Perfil inv√°lido";
    bioText.textContent = "Nenhum UID informado na URL. Use: ?uid=XXXX";
    setCover("");
    setAvatar("", "U");
    setStatus(false);
    cityText.textContent = "‚Äî";
    return;
  }

  DB.ref("profiles/" + TARGET_UID).on("value", snap=>{
    const p = snap.val() || {};
    const name = p.name || "Usu√°rio";
    const city = p.city || "Sem cidade";
    const bio  = p.bio  || "Sem biografia.";

    profileName.textContent = name;
    cityText.textContent = city;
    bioText.textContent = bio;

    setCover(p.coverDataUrl || p.coverUrl || "");
    setAvatar(p.avatarDataUrl || p.avatarUrl || "", name);
  });

  // status do perfil alvo
  DB.ref("presence/" + TARGET_UID).on("value", snap=>{
    const u = snap.val() || {};
    const last = u.lastActive || 0;
    const now = Date.now();
    const online = (u.online === true) && (now - last < 65000);
    setStatus(online);
  });
}

/* ====================== FEED DO USU√ÅRIO (com curtir e comentar) ====================== */
let cachedName = "Usu√°rio";
let cachedAvatar = "";

/* fotos nos coment√°rios */
const avatarCache = {};
function getAvatarUrlFromProfile(p){
  return (p && (p.avatarDataUrl || p.avatarUrl || "")) || "";
}
function fetchAvatarUrl(uid){
  return new Promise((resolve)=>{
    if(!uid){ resolve(""); return; }
    if(avatarCache[uid] !== undefined){ resolve(avatarCache[uid]); return; }
    DB.ref("profiles/" + uid).once("value").then(s=>{
      const p = s.val() || {};
      const url = getAvatarUrlFromProfile(p) || "";
      avatarCache[uid] = url;
      resolve(url);
    }).catch(()=>{ avatarCache[uid]=""; resolve(""); });
  });
}

function postHTML(postId, d){
  let midia = "";
  if(d.mediaUrl){
    const isImg = (d.mediaType || "").startsWith("image/");
    midia = isImg
      ? `<img src="${d.mediaUrl}" loading="lazy" alt="imagem">`
      : `<video src="${d.mediaUrl}" controls preload="metadata" playsinline></video>`;
  }

  const texto = escapeHTML(d.text || "");
  const quando = d.createdAt ? fmtDate(d.createdAt) : "";

  const av = cachedAvatar
    ? `<img src="${cachedAvatar}" alt="avatar">`
    : `<div class="init">${escapeHTML(initials(cachedName))}</div>`;

  return `
    <div class="post" id="${postId}">
      <div class="postHead">
        <div class="postAvatar">${av}</div>
        <div style="min-width:0;">
          <div class="postName">${escapeHTML(cachedName)}</div>
          <div class="when">${escapeHTML(quando)}</div>
        </div>
      </div>

      ${texto ? `<p>${texto}</p>` : ""}

      <div class="mediaWrap">
        ${midia}
      </div>

      <div class="post-actions">
        <div style="text-align:center;">
          <div class="btn-action" id="btnLike_${postId}" onclick="curtir('${postId}')">üëç Curtir</div>
          <div class="contador" id="likesCount_${postId}"></div>
        </div>

        <div style="text-align:center;">
          <div class="btn-action" onclick="toggleComentarios('${postId}')">üí¨ Comentar</div>
          <div class="contador" id="commentsCount_${postId}"></div>
        </div>
      </div>

      <div class="coment-area" id="comentBox_${postId}">
        <div id="commentsList_${postId}" style="margin-bottom:12px;"></div>

        <input type="text" id="commentInput_${postId}"
          placeholder="Escreva um coment√°rio..."
          style="width:100%;padding:10px;border-radius:8px;border:1px solid #00ff9d;background:#000;color:#fff;">

        <button class="btn" style="margin-top:10px;width:100%;" onclick="enviarComentario('${postId}')">
          Enviar coment√°rio
        </button>
      </div>
    </div>
  `;
}

function toggleComentarios(postId){
  const box = document.getElementById("comentBox_"+postId);
  if(!box) return;
  box.style.display = (box.style.display === "block") ? "none" : "block";
}

async function curtir(postId){
  if(precisaLogin()) return;
  const likeRef = DB.ref(`likes/${postId}/${UID}`);
  const snap = await likeRef.once("value");
  const cur = snap.val();
  if(cur) await likeRef.remove();
  else await likeRef.set({
    type:"like",
    uid: UID,
    userName: USER_NAME,
    createdAt: firebase.database.ServerValue.TIMESTAMP
  });
}

async function enviarComentario(postId){
  if(precisaLogin()) return;
  const input = document.getElementById("commentInput_"+postId);
  if(!input) return;
  const texto = (input.value || "").trim();
  if(!texto) return;

  const commentId = "cmt_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  const myAvatarUrl = await fetchAvatarUrl(UID);

  await DB.ref(`comments/${postId}/${commentId}`).set({
    uid: UID,
    userName: USER_NAME,
    avatarUrl: myAvatarUrl || "",
    text: texto,
    createdAt: firebase.database.ServerValue.TIMESTAMP
  });
  input.value = "";
}

function listenLikes(postId){
  DB.ref("likes/" + postId).on("value", snap=>{
    const obj = snap.val() || {};
    const total = Object.values(obj).length;
    const mine = obj[UID];

    const btn = document.getElementById("btnLike_"+postId);
    const cont = document.getElementById("likesCount_"+postId);
    if(!btn || !cont) return;

    if(mine){
      btn.textContent = "üëç Voc√™ curtiu";
      btn.style.opacity = "1";
    }else{
      btn.textContent = "üëç Curtir";
      btn.style.opacity = ".95";
    }

    cont.textContent = total ? `${total} curtida${total>1?"s":""}` : "";
  });
}

function listenComments(postId){
  DB.ref("comments/" + postId).orderByChild("createdAt").on("value", async snap=>{
    const obj = snap.val() || {};
    const arr = Object.keys(obj).map(id=>({ id, ...obj[id] }))
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    const cont = document.getElementById("commentsCount_"+postId);
    const list = document.getElementById("commentsList_"+postId);
    if(!cont || !list) return;

    const total = arr.length;
    cont.textContent = total ? `${total} coment√°rio${total>1?"s":""}` : "";

    if(total === 0){
      list.innerHTML = `<div class="empty">Nenhum coment√°rio ainda.</div>`;
      return;
    }

    const htmlParts = await Promise.all(arr.map(async (c)=>{
      const nome = c.userName || "Usu√°rio";
      const txt = escapeHTML(c.text || "");
      const uid = c.uid || "";
      let url = (c.avatarUrl || "").trim();
      if(!url && uid) url = await fetchAvatarUrl(uid);

      const avatarHTML = url
        ? `<img src="${url}" alt="foto">`
        : `<div class="init">${escapeHTML(initials(nome))}</div>`;

      return `
        <div class="cRow">
          <div class="cHead">
            <div class="cAvatar">${avatarHTML}</div>
            <div class="cName">${escapeHTML(nome)}</div>
          </div>
          <div class="cText">üí¨ ${txt}</div>
        </div>
      `;
    }));

    list.innerHTML = htmlParts.join("");
  });
}

function listenFeed(){
  if(!TARGET_UID) return;

  DB.ref("profiles/" + TARGET_UID).on("value", snap=>{
    const p = snap.val() || {};
    cachedName = p.name || "Usu√°rio";
    cachedAvatar = p.avatarDataUrl || p.avatarUrl || "";
  });

  const ref = DB.ref("posts").limitToLast(300);
  ref.on("value", snap=>{
    const obj = snap.val() || {};
    const entries = Object.keys(obj)
      .map(id=>({ id, ...obj[id] }))
      .filter(p => (p.uid || "") === TARGET_UID)
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    postsCount.textContent = `${entries.length} postagens`;

    if(entries.length === 0){
      feed.innerHTML = `<div class="empty">Este usu√°rio ainda n√£o postou nada.</div>`;
      return;
    }

    feed.innerHTML = entries.slice().reverse().map(p=> postHTML(p.id, p)).join("");

    entries.forEach(p=>{
      listenLikes(p.id);
      listenComments(p.id);
    });
  });
}

/* ====================== BOOT ====================== */
(async function boot(){
  setCover("");
  setAvatar("", "U");
  setStatus(false);

  // ‚úÖ presen√ßa do pr√≥prio usu√°rio + escuta do pr√≥prio status
  startSelfPresence();
  listenSelfPresence();

  await loadProfile();
  listenFeed();
})();
</script>

</body>
</html>
