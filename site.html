<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mural Unificado Neon</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    body {
        margin: 0;
        background: #000;
        font-family: Arial, sans-serif;
        color: white;
    }

    /* ================= LOGIN ================= */

    #loginScreen {
        position: fixed;
        inset: 0;
        background: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 30px;
        z-index: 999999;
        text-align: center;
    }

    #loginScreen h1 {
        font-size: 32px;
        text-shadow: 0 0 22px #00ff9d;
        color: #00ff9d;
    }

    /* ================= MENU ================= */

    .top-menu {
        width: 100%;
        background: #0d0d0d;
        padding: 18px 0;
        display: flex;
        justify-content: center;
        gap: 50px;
        align-items: center;
        border-bottom: 2px solid #00ff8c;
        box-shadow: 0 0 15px #00ff8c;
        position: sticky;
        top: 0;
        z-index: 9999;
    }

    .top-menu.hide { display: none !important; }

    .top-menu a {
        color: #00ff8c;
        text-decoration: none;
        font-size: 22px;
        font-weight: bold;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: 0.3s;
        letter-spacing: 1.2px;
        text-shadow: 0 0 10px #00ff8c, 0 0 20px #00ff8c;
    }

    .top-menu a:hover { transform: scale(1.12); }

    /* ================= STORIES ================= */

    .stories-wrapper { padding: 15px 10px 5px 10px; }

    .stories-row {
        display: flex;
        gap: 10px;
        overflow-x: auto;
    }

    .stories-row::-webkit-scrollbar { height: 5px; }
    .stories-row::-webkit-scrollbar-thumb {
        background: #00ff8c;
        border-radius: 10px;
    }

    .card {
        width: 110px;
        height: 180px;
        background: #1a1c1e;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        transition: 0.3s;
        flex-shrink: 0;
        border: 2px solid transparent;
    }

    /* FOTO DO PERFIL NO CARD 1 */
    #avatarPreview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.25;
        border-radius: 15px;
        display: none;
    }

    #card2 { display: none; }

    .plus {
        width: 55px;
        height: 55px;
        background: #00ff8c;
        border-radius: 50%;
        font-size: 38px;
        border: 4px solid #0e0f10;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #003b23;
        text-shadow: 0 0 10px #00ff8c;
        box-shadow: 0 0 25px #00ff8c;
    }

    #thumb img,
    #thumb video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .neonEffect {
        animation: neonGlow 1.7s ease-out;
        background-image: linear-gradient(#1a1c1e,#1a1c1e),
            linear-gradient(90deg,#00ff8c,#00ffaa,#00ff8c);
        background-origin: border-box;
        background-clip: padding-box, border-box;
        box-shadow: 0 0 25px #00ff8c;
    }

    @keyframes neonGlow {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* VIEWER */

    #viewer {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.92);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 99999;
    }
</style>
</head>
<body>

<!-- ================= LOGIN GOOGLE ================= -->
<div id="loginScreen">
    <h1>Autentique-se para entrar</h1>
    <div id="g_id_onload"
         data-client_id="627442405379-srqriainr8okj7ldg96njd1va5bvt7oi.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleGoogleLogin">
    </div>

    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="signin_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- ================= MENU ================= -->
<nav class="top-menu" id="menuTop" style="display:none;">
    <a href="#"><i class="fa-solid fa-comments"></i> BATE PAPO</a>
    <a href="#"><i class="fa-solid fa-book"></i> ESTUDO</a>
    <a href="#"><i class="fa-solid fa-video"></i> REUNI√ÉO</a>
    <a href="#" onclick="logoutGoogle()"><i class="fa-solid fa-right-from-bracket"></i> SAIR</a>
</nav>

<!-- ================= STORIES ================= -->

<div class="stories-wrapper">
    <div class="stories-row" id="storiesRow">

        <!-- CARD 1 = Criar Story -->
        <div class="card" id="card1">
            <img id="avatarPreview">
            <label for="uploadStory"><div class="plus">+</div></label>
            <input id="uploadStory" type="file" accept="image/*,video/*" style="display:none;">
            <span style="margin-top:10px;">Criar Story</span>
        </div>

        <!-- CARD 2 = Pr√©via do √∫ltimo story pessoal -->
        <div class="card" id="card2">
            <div id="thumb"></div>
        </div>

    </div>
</div>

<!-- VIEWER -->
<div id="viewer">
    <div class="topBars" id="bars"></div>
    <div class="dots" id="dots">‚ãÆ</div>
    <div class="deleteBtn" id="deleteBtn">Excluir</div>
    <div class="tapLeft" id="tapLeft"></div>
    <div class="tapRight" id="tapRight"></div>
    <div id="viewerMedia"></div>
</div>

<!-- FEED -->
<div id="feed"></div>

<!-- PREVIEW POST -->
<div class="preview" id="previewBox">
    <h3>Pr√©via da m√≠dia</h3>
    <div id="previewContent"></div>
</div>

<!-- CREATE POST -->
<div class="create-post" id="createPostArea" style="display:none;">
    <input type="text" id="postText" class="input-box"
           placeholder="No que voc√™ est√° pensando?" oninput="updateButton()">

    <div class="add-btn" id="btnMain" onclick="buttonAction()">+</div>
    <input type="file" id="fileInput" accept="image/*,video/*">
</div>

<script type="module">

/* ============================================================
   1. LOGIN GOOGLE + IDENTIDADE DO USU√ÅRIO
============================================================ */

let usuarioNome = null;
let usuarioFoto = null;
let usuarioUID = null;

/* Decodifica token JWT do Google */
function decodeJwt(token) {
    return JSON.parse(atob(token.split('.')[1]));
}

/* Callback do Google Login */
window.handleGoogleLogin = function (response) {
    const data = decodeJwt(response.credential);

    usuarioNome = data.given_name;     // primeiro nome
    usuarioFoto = data.picture;
    usuarioUID  = data.sub;            // UID √∫nico do Google

    localStorage.setItem("usuarioUID", usuarioUID);
    localStorage.setItem("usuarioNome", usuarioNome);
    localStorage.setItem("usuarioFoto", usuarioFoto);

    // Esconde login e mostra o mural
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("menuTop").style.display = "flex";
    document.getElementById("createPostArea").style.display = "flex";

    // Avatar no card de story
    const avatar = document.getElementById("avatarPreview");
    avatar.src = usuarioFoto;
    avatar.style.display = "block";

    carregarStoriesFirebase();
    carregarFeedFirebase();
};


/* Logout */
window.logoutGoogle = function () {
    localStorage.clear();

    google.accounts.id.disableAutoSelect();
    location.reload();
};


/* ============================================================
   2. FIREBASE ‚Äî CONFIGURA√á√ÉO COMPLETA
============================================================ */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove } 
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.firebasestorage.app",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);


/* ============================================================
   3. STORIES ‚Äî UPLOAD E CARREGAMENTO
============================================================ */

let storiesFirebase = [];
let storyAtual = 0;

const uploadStory = document.getElementById("uploadStory");
const card2 = document.getElementById("card2");
const thumb = document.getElementById("thumb");


/* Quando seleciona um arquivo */
uploadStory.onchange = e => {
    let file = e.target.files[0];
    if (!file) return;

    enviarStoryFirebase(file);
};


/* Envia story para o Firebase */
function enviarStoryFirebase(file) {
    const reader = new FileReader();

    reader.onload = function (ev) {
        const base64 = ev.target.result;

        const data = {
            autorUID: usuarioUID,
            autorNome: usuarioNome,
            autorFoto: usuarioFoto,
            tipo: file.type,
            midia: base64,
            timestamp: Date.now()
        };

        push(ref(db, "coletivo_mural/stories"), data);

        card2.classList.add("neonEffect");
        setTimeout(() => card2.classList.remove("neonEffect"), 1500);
    };

    reader.readAsDataURL(file);
}


/* Carrega stories do Firebase de TODOS os usu√°rios */
function carregarStoriesFirebase() {
    const stRef = ref(db, "coletivo_mural/stories");

    onValue(stRef, snapshot => {

        storiesFirebase = [];

        snapshot.forEach(item => {
            const obj = item.val();
            obj.key = item.key;
            storiesFirebase.push(obj);
        });

        atualizarStoriesUI();
    });
}


/* Atualiza o carrossel de Cards */
function atualizarStoriesUI() {

    storiesRow.innerHTML = "";

    // CARD 1 (criar)
    storiesRow.appendChild(document.getElementById("card1"));

    // CARD 2 (√∫ltimo story do usu√°rio)
    let meuUltimo = storiesFirebase
        .filter(s => s.autorUID === usuarioUID)
        .sort((a,b) => b.timestamp - a.timestamp)[0];

    if (meuUltimo) {
        card2.style.display = "flex";
        thumb.innerHTML =
            meuUltimo.tipo.includes("image")
            ? `<img src="${meuUltimo.midia}">`
            : `<video src="${meuUltimo.midia}" autoplay muted loop></video>`;
        storiesRow.appendChild(card2);
    }

    // Stories dos outros usu√°rios
    storiesFirebase
        .filter(s => s.autorUID !== usuarioUID)
        .sort((a,b)=>b.timestamp-a.timestamp)
        .forEach(st => {

            const c = document.createElement("div");
            c.className = "card";

            c.innerHTML =
                st.tipo.includes("image")
                ? `<img src="${st.midia}" style="width:100%;height:100%;object-fit:cover;">`
                : `<video src="${st.midia}" autoplay muted loop style="width:100%;height:100%;object-fit:cover;"></video>`;

            c.onclick = () => abrirViewer(storiesFirebase.indexOf(st));

            storiesRow.appendChild(c);
        });
}


/* ============================================================
   4. VIEWER DE STORIES (GRANDE)
============================================================ */

const viewer      = document.getElementById("viewer");
const viewerMedia = document.getElementById("viewerMedia");
const bars        = document.getElementById("bars");
const deleteBtn   = document.getElementById("deleteBtn");


function abrirViewer(idx) {
    storyAtual = idx;
    viewer.style.display = "flex";
    menuTop.classList.add("hide");

    exibirStoryAtual();
}

function fecharViewer() {
    viewer.style.display = "none";
    deleteBtn.style.display = "none";
    viewerMedia.innerHTML = "";
    menuTop.classList.remove("hide");
}


/* Exibe o story selecionado */
function exibirStoryAtual() {

    const st = storiesFirebase[storyAtual];

    viewerMedia.innerHTML = "";

    // Criar barras de progresso
    bars.innerHTML = "";
    for (let i = 0; i < storiesFirebase.length; i++) {
        const bar = document.createElement("div");
        bar.className = "bar";

        const fill = document.createElement("div");
        fill.className = "barFill";

        bar.appendChild(fill);
        bars.appendChild(bar);
    }

    // Mostrar m√≠dia
    if (st.tipo.includes("image")) {
        viewerMedia.innerHTML = `<img src="${st.midia}">`;
    } else {
        viewerMedia.innerHTML = `<video src="${st.midia}" autoplay muted></video>`;
    }

    // Bot√£o de excluir apenas se for do usu√°rio
    if (st.autorUID === usuarioUID) {
        deleteBtn.style.display = "block";
        deleteBtn.onclick = () => {
            remove(ref(db, "coletivo_mural/stories/" + st.key));
            fecharViewer();
        };
    } else {
        deleteBtn.style.display = "none";
    }
}


/* Avan√ßar e voltar stories */
tapRight.onclick = () => {
    storyAtual++;
    if (storyAtual >= storiesFirebase.length) {
        fecharViewer();
    } else {
        exibirStoryAtual();
    }
};

tapLeft.onclick = () => {
    storyAtual--;
    if (storyAtual < 0) storyAtual = 0;
    exibirStoryAtual();
};

dots.onclick = () => {
    if (deleteBtn.style.display === "block") {
        deleteBtn.style.display = "none";
    } else {
        const st = storiesFirebase[storyAtual];
        if (st.autorUID === usuarioUID) deleteBtn.style.display = "block";
    }
};

</script>
<script type="module">

/* ============================================================
   FEED ‚Äî BANCO DE DADOS
============================================================ */

import { ref, push, set, onValue, update, remove }
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const feedRef = ref(db, "coletivo_mural/posts");

let selectedFile = null;
let mode = "add";

/* ============================================================
   BOT√ÉO DO POST (Whatsapp / +)
============================================================ */

window.updateButton = function () {
    let t = postText.value.trim();
    if (t.length > 0) {
        btnMain.className = "whatsapp-send";
        btnMain.innerHTML = "‚û§";
        mode = "postar";
    } else {
        btnMain.className = "add-btn";
        btnMain.innerHTML = "+";
        mode = "add";
    }
};

window.buttonAction = function () {
    mode === "add" ? fileInput.click() : postarTexto();
};


/* ============================================================
   SELE√á√ÉO DE M√çDIA
============================================================ */

fileInput.onchange = e => {
    selectedFile = e.target.files[0];
    if (!selectedFile) return;

    let reader = new FileReader();
    reader.onload = ev => {
        previewContent.innerHTML =
            selectedFile.type.startsWith("image/")
            ? `<img src="${ev.target.result}" style="width:100%; border-radius:10px;">`
            : `<video src="${ev.target.result}" controls style="width:100%; border-radius:10px;"></video>`;
        previewBox.style.display = "block";
    };

    reader.readAsDataURL(selectedFile);
};


/* ============================================================
   APENAS TEXTO
============================================================ */

function postarTexto() {
    let texto = postText.value.trim();
    if (texto === "") return;

    enviarPost(texto, null, null);

    postText.value = "";
    updateButton();
}


/* ============================================================
   POSTAR COM IMAGEM/V√çDEO
============================================================ */

window.postar = function () {
    if (!selectedFile) return;

    const reader = new FileReader();

    reader.onload = ev => {
        enviarPost(postText.value, ev.target.result, selectedFile.type);
        previewBox.style.display = "none";
        previewContent.innerHTML = "";
        postText.value = "";
        selectedFile = null;
        updateButton();
    };

    reader.readAsDataURL(selectedFile);
};


/* ============================================================
   ENVIAR POST PARA O FIREBASE
============================================================ */

function enviarPost(texto, midiaBase64, tipoMidia) {
    const id = "post_" + Date.now();

    const data = {
        id: id,
        autorUID: usuarioUID,
        autorNome: usuarioNome,
        autorFoto: usuarioFoto,
        texto: texto,
        midia: midiaBase64 || null,
        tipoMidia: tipoMidia || null,
        timestamp: Date.now(),
        curtidas: {},
        comentarios: {}
    };

    set(ref(db, "coletivo_mural/posts/" + id), data);
}


/* ============================================================
   CARREGAR FEED EM TEMPO REAL
============================================================ */

function carregarFeedFirebase() {
    onValue(feedRef, snap => {
        feed.innerHTML = "";

        let lista = [];

        snap.forEach(item => lista.push(item.val()));

        lista.sort((a,b)=>b.timestamp - a.timestamp);

        lista.forEach(post => renderPost(post));
    });
}


/* ============================================================
   EXIBIR UM POST NO FEED
============================================================ */

function renderPost(post) {

    const wrapper = document.createElement("div");
    wrapper.className = "post";
    wrapper.id = post.id;

    let midiaHTML = "";
    if (post.midia) {
        midiaHTML =
            post.tipoMidia.startsWith("image/")
            ? `<img src="${post.midia}">`
            : `<video src="${post.midia}" controls></video>`;
    }

    wrapper.innerHTML = `
        <div class="menu-btn" onclick="toggleMenu('${post.id}')">‚ãÆ</div>
        <div class="menu-box" id="menu_${post.id}">
            ${
                post.autorUID === usuarioUID
                ? `<div onclick="excluirPost('${post.id}')">Excluir</div>`
                : `<div style="opacity:0.4;">Somente o autor pode excluir</div>`
            }
        </div>

        <h3>
            <img src="${post.autorFoto}" 
                 style="width:40px;height:40px;border-radius:50%;vertical-align:middle;margin-right:8px;">
            ${post.autorNome}
        </h3>

        <p>${post.texto || ""}</p>

        ${midiaHTML}

        <div class="post-actions">

            <div style="text-align:center;">
                <div class="btn-action"
                     onclick="curtir('${post.id}')">
                     üëç Curtir
                </div>
                <div class="contador" id="contadorCurtidas_${post.id}"></div>
            </div>

            <div style="text-align:center;">
                <div class="btn-action" onclick="abrirComentarios('${post.id}')">
                    üí¨ Comentar
                </div>
                <div class="contador" id="contadorComentarios_${post.id}"></div>
            </div>

            <div class="btn-action">‚ÜóÔ∏è Compartilhar</div>

        </div>

        <div class="coment-area" id="comentarios_${post.id}">
            <div id="listaComentarios_${post.id}" style="margin-bottom:15px;"></div>

            <input type="text" id="comentarioInput_${post.id}"
                   placeholder="Escreva um coment√°rio..."
                   style="width:100%;padding:10px;border-radius:8px;
                   border:1px solid #00ff9d;background:#000;color:#fff;">

            <button onclick="enviarComentario('${post.id}')"
                    style="margin-top:8px;background:#00ff9d;border:none;
                    padding:8px 15px;border-radius:8px;cursor:pointer;">
                Enviar
            </button>
        </div>
    `;

    feed.appendChild(wrapper);

    atualizarContadores(post);
}


/* ============================================================
   MENU EXCLUIR
============================================================ */

window.toggleMenu = function (id) {
    const box = document.getElementById("menu_"+id);
    box.style.display = box.style.display==="block" ? "none" : "block";
};

window.excluirPost = function (id) {
    remove(ref(db, "coletivo_mural/posts/" + id));
};


/* ============================================================
   CURTIR POST
============================================================ */

window.curtir = function (postId) {
    const refCurtidas = ref(db, `coletivo_mural/posts/${postId}/curtidas`);

    update(refCurtidas, {
        [usuarioUID]: usuarioNome
    });
};


/* ============================================================
   ATUALIZAR CONTADORES DE CURTIDA E COMENT√ÅRIOS
============================================================ */

function atualizarContadores(post) {

    const curtidas = post.curtidas ? Object.keys(post.curtidas).length : 0;

    const contC = document.getElementById("contadorCurtidas_"+post.id);

    if (curtidas === 0) contC.innerHTML = "";
    else if (curtidas === 1) contC.innerHTML = "1 pessoa curtiu";
    else contC.innerHTML = `${curtidas} pessoas curtiram`;


    /* Coment√°rios */
    const totalComentarios = post.comentarios
        ? Object.keys(post.comentarios).length
        : 0;

    const contCom = document.getElementById("contadorComentarios_"+post.id);

    if (totalComentarios === 0) contCom.innerHTML = "";
    else if (totalComentarios === 1) contCom.innerHTML = "1 coment√°rio";
    else contCom.innerHTML = `${totalComentarios} coment√°rios`;

    atualizarComentarios(post);
}


/* ============================================================
   ABRIR CAIXA DE COMENT√ÅRIOS
============================================================ */

window.abrirComentarios = function (postId) {
    const box = document.getElementById("comentarios_"+postId);
    box.style.display = "block";
};


/* ============================================================
   ENVIAR COMENT√ÅRIO
============================================================ */

window.enviarComentario = function (postId) {

    const input = document.getElementById("comentarioInput_"+postId);
    const texto = input.value.trim();
    if (texto === "") return;

    const cRef = ref(db, `coletivo_mural/posts/${postId}/comentarios`);

    const data = {
        autorUID: usuarioUID,
        autorNome: usuarioNome,
        autorFoto: usuarioFoto,
        texto: texto,
        timestamp: Date.now()
    };

    push(cRef, data);

    input.value = "";
};


/* ============================================================
   LISTAR COMENT√ÅRIOS
============================================================ */

function atualizarComentarios(post) {

    const lista = document.getElementById("listaComentarios_"+post.id);
    lista.innerHTML = "";

    if (!post.comentarios) return;

    Object.entries(post.comentarios).forEach(([key, c]) => {

        const el = document.createElement("div");

        el.style = `
            background:#000;
            border:1px solid #00ff9d;
            padding:8px;
            border-radius:8px;
            margin-bottom:5px;
            position:relative;
        `;

        el.innerHTML = `
            <img src="${c.autorFoto}" 
                 style="width:25px;height:25px;border-radius:50%;
                 vertical-align:middle;margin-right:6px;">
            <strong>${c.autorNome}:</strong> ${c.texto}

            ${
                c.autorUID === usuarioUID
                ? `
                  <span class="coment-menu-btn" onclick="toggleComentMenu('${post.id}','${key}')">‚ãÆ</span>
                  <div class="coment-menu-box" id="menu_${post.id}_${key}"
                       onclick="excluirComentario('${post.id}','${key}')">
                      Excluir
                  </div>`
                : ""
            }
        `;

        lista.appendChild(el);
    });
}


/* ============================================================
   MENU EXCLUIR COMENT√ÅRIO
============================================================ */

window.toggleComentMenu = function (postId, cid) {
    const box = document.getElementById(`menu_${postId}_${cid}`);
    box.style.display = box.style.display === "block" ? "none" : "block";
};

window.excluirComentario = function (postId, cid) {
    remove(ref(db, `coletivo_mural/posts/${postId}/comentarios/${cid}`));
};

</script>
</body>
</html>
