<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mural P√∫blico</title>

<!-- LOGIN COM GOOGLE -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>

html, body {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden !important;
}

* {
    box-sizing: border-box;
    overflow-x: hidden;
}

body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', sans-serif;

    background: url("https://i.pinimg.com/736x/66/fd/b6/66fdb6ca7dbf683dd3161325a9883510.jpg") no-repeat center center fixed !important;
    background-size: cover !important;

    color: #b9ffce;
    text-align: center;
}

.google-btn {
    width: 80%;
    max-width: 260px;
    margin-top: 12px;
}

#loginBox, #cadastroBox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.90);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 999999;
}
#loginBox img {
    height: 120px;
    margin-bottom: 20px;
}

#cadastroBox { display:none; }

#loginBox button {
    width: 80%;
    max-width: 260px;
    padding: 13px;
    background: #00ffaa;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    cursor: pointer;
    font-weight: bold;
}

.topbar {
    width: 100%;
    background: rgba(0,0,0,0.90);
    padding: 12px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 9999;
    box-shadow: 0 0 15px #00ffcc;
}

.radio-btn {
    background: #000;
    color: #fff;
    width: 55px;
    height: 55px;
    border-radius: 50%;
    font-size: 1.7rem;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 0 12px #00ffcc;
    cursor:pointer;
}

#menuIcon {
    font-size: 2.3rem;
    color: #00ffcc;
    cursor: pointer;
    font-weight: bold;
}

#sideMenu {
    position: fixed;
    top: 0;
    right: -260px;
    width: 240px;
    height: 100%;
    background: rgba(0,0,0,0.95);
    padding-top: 80px;
    padding-left: 25px;
    display: flex;
    flex-direction: column;
    gap: 25px;
    transition: 0.4s;
    z-index: 10000;
    box-shadow: -3px 0 18px #00ffcc;
}

#sideMenu a, #sideMenu div {
    color: #00ffcc;
    text-decoration: none;
    font-size: 1.3rem;
    font-weight: bold;
    cursor:pointer;
}

#sideMenu a:hover {
    color:#fff;
}
/* --------------------------------------------- */
/*  NOVO SISTEMA DE STORIES ESTILO FACEBOOK      */
/* --------------------------------------------- */

#storiesBar {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 15px;
    width: 96%;
    margin: 15px auto;
    align-items: center;
}

.story-user-box {
    text-align: center;
    flex-shrink: 0;
}

.story-circle {
    width: 78px;
    height: 78px;
    border-radius: 50%;
    border: 3px solid #00ffaa;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background:#000;
    cursor:pointer;
}

.story-circle img, 
.story-circle video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* BOT√ÉO DE ADICIONAR STORY - ESTILO NEON */
.add-story-btn {
    width: 78px;
    height: 78px;
    border-radius: 50%;
    border: 3px solid #00ff99;
    color: #00ff99;
    background: transparent;
    font-size: 55px;
    display: flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow: 0 0 12px #00ff99, inset 0 0 12px #00ff99;
    text-shadow: 0 0 10px #00ff99;
    animation: neonPulse 2s infinite ease-in-out;
}

@keyframes neonPulse {
    0%,100% { box-shadow: 0 0 12px #00ff99, inset 0 0 6px #00ff99; }
    50%     { box-shadow: 0 0 22px #00ff99, inset 0 0 12px #00ff99; }
}

.story-user-name {
    font-size: 0.8rem;
    margin-top: 6px;
    font-weight: bold;
    color: #00ffaa;
    max-width: 78px;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}

/* -------- VIEWER STYLO FACEBOOK ---------- */

#storyViewer {
    display: none;
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.92);
    z-index:999999;
    align-items: center;
    flex-direction: column;
    padding-top: 55px;
}

#viewerClose {
    position:absolute;
    top:20px;
    right:20px;
    font-size:2.1rem;
    cursor:pointer;
    color:white;
}

/* Barra superior de progresso */
#viewerProgress {
    position: absolute;
    top: 15px;
    left: 5%;
    width: 90%;
    height: 6px;
    display: flex;
    gap: 5px;
}

.progress-segment {
    flex:1;
    background: rgba(255,255,255,0.3);
    border-radius: 20px;
    overflow:hidden;
}

.progress-fill {
    width:0%;
    height:100%;
    background:white;
    transition: width linear;
}

/* Conte√∫do do story */
#viewerContent img,
#viewerContent video {
    max-width: 92%;
    max-height: 80%;
    border-radius: 12px;
    object-fit: contain !important;
}

/* Bot√£o de menu ‚ãÆ */
#storyMenuBtn {
    position:absolute;
    top:20px;
    left:20px;
    font-size: 28px;
    color:white;
    cursor:pointer;
    display:none;
}

#storyMenu {
    display:none;
    position:absolute;
    top:65px;
    left:20px;
    background:white;
    color:black;
    border-radius: 10px;
    padding: 12px 18px;
    font-weight:bold;
    cursor:pointer;
}

#viewerAuthor {
    color:#00ffaa;
    font-size:1.1rem;
    font-weight:bold;
    margin-bottom:15px;
}
</style>
</head>
<body>
<!-- LOGIN -->
<div id="loginBox">
    <img src="https://i.ibb.co/JRvgqKGM/5c081edd-21e9-48fb-9a91-834cfdd112fc-removebg-preview.png">

    <div id="googleLogin" class="google-btn"></div>
</div>

<!-- TOPO -->
<div class="topbar">
    <div class="radio-btn" id="playBtn" onclick="toggleRadio()">‚ñ∂</div>
    <div id="menuIcon" onclick="toggleMenu()">‚ò∞</div>
    <audio id="radioPlayer" src="https://stream.zeno.fm/l8ocj9i6ka2uv"></audio>
</div>

<!-- MENU LATERAL -->
<div id="sideMenu">

    <div style="text-align:center; margin-bottom:10px;">
        <label for="fotoPerfilUpload">
            <img id="perfilFoto" src="https://cdn-icons-png.flaticon.com/512/149/149071.png"
                 style="width:95px; height:95px; border-radius:50%; border:3px solid #00ffcc; cursor:pointer; object-fit:cover;">
        </label>
        <input type="file" id="fotoPerfilUpload" accept="image/*" style="display:none;">

        <div id="nomeUsuarioMenu" style="color:#00ffcc; font-weight:bold; margin-top:8px; font-size:1.1rem;"></div>
    </div>

    <a href="https://marcio2307.github.io/chatterreiro/chatterreiro.html" target="_blank">Bate Papo</a>
    <a href="https://marcio2307.github.io/terreiro/origens.html" target="_blank">Nossas Origens</a>
    <a href="https://marcio2307.github.io/terreiro/estudo.html" target="_blank">Estudo da Umbanda</a>
    <a href="https://marcio2307.github.io/terreiro/sala.html" target="_blank">Reuni√£o Online</a>

    <a onclick="logout()" style="cursor:pointer;">Sair da Conta</a>
</div>

<!-- ------------------------------------------------------- -->
<!--   NOVA BARRA DE STORIES ESTILO FACEBOOK                -->
<!-- ------------------------------------------------------- -->
<div id="storiesBar"></div>

<!-- ------------------------------------------------------- -->
<!--  MODAL PARA CRIAR STORY (TEXTO + IMAGEM/VIDEO)          -->
<!-- ------------------------------------------------------- -->
<div id="storyCreateModal" style="
display:none; position:fixed; top:0; left:0; width:100%; height:100%;
background:rgba(0,0,0,0.9); z-index:999999; justify-content:center; align-items:center;
flex-direction:column; color:white;">
    
    <textarea id="storyText" placeholder="Escreva algo..."
    style="width:80%;max-width:300px;height:80px;border-radius:10px;padding:10px;background:#222;color:white;"></textarea>

    <input type="file" id="storyMedia" accept="image/*,video/*" style="margin-top:15px;">

    <button onclick="postarNovoStory()" 
    style="margin-top:20px;background:#00ffaa;padding:10px 25px;border:none;border-radius:10px;font-weight:bold;">
        Postar Story
    </button>

    <button onclick="fecharStoryCreate()" 
    style="margin-top:15px;background:#ff5555;padding:10px 25px;border:none;border-radius:10px;">
        Cancelar
    </button>
</div>

<!-- ------------------------------------------------------- -->
<!--   VIEWER ESTILO FACEBOOK (TODOS STORIES EM SEQU√äNCIA)   -->
<!-- ------------------------------------------------------- -->
<div id="storyViewer">
    
    <div id="viewerProgress"></div>

    <span id="storyMenuBtn">‚ãÆ</span>
    <div id="storyMenu">Excluir</div>

    <span id="viewerClose" onclick="fecharViewer()">‚úñ</span>

    <div id="viewerAuthor"></div>

    <div id="viewerContent"></div>

</div>
<script type="module">
import { initializeApp } 
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

import { 
    getDatabase, ref, push, onValue, remove, set 
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

/* CONFIG FIREBASE */
const firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.firebasestorage.app",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* REFER√äNCIA DOS STORIES */
const storiesRef = ref(db, "coletivo_mural/stories");

let usuario = localStorage.getItem("usuarioLogado") || null;

/* ------ ABRIR MODAL DE CRIAR STORY ------ */
window.abrirCriarStory = function () {
    if (!usuario) return alert("Fa√ßa login!");
    storyCreateModal.style.display = "flex";
};

/* ------ FECHAR MODAL ------ */
window.fecharStoryCreate = function () {
    storyCreateModal.style.display = "none";
    storyText.value = "";
    storyMedia.value = "";
};

/* ------ POSTAR STORY ------ */
window.postarNovoStory = function () {
    if (!usuario) return alert("Fa√ßa login!");

    const texto = storyText.value.trim();
    const file = storyMedia.files[0];

    let base64 = null;
    let tipo = null;

    if (file) {
        const reader = new FileReader();
        reader.onload = e => {
            base64 = e.target.result;
            tipo = file.type.startsWith("video") ? "video" : "image";
            salvarStory(texto, base64, tipo);
        };
        reader.readAsDataURL(file);
    } else {
        salvarStory(texto, null, null);
    }
};

function salvarStory(texto, midia, tipo) {
    push(storiesRef, {
        usuario,
        texto,
        timestamp: Date.now(),
        imagem: tipo === "image" ? midia : null,
        video:  tipo === "video" ? midia : null
    });

    fecharStoryCreate();
}

/* ------------------------------------------------------- */
/*   CARREGAR STORIES DE TODOS USU√ÅRIOS PARA A BARRA      */
/* ------------------------------------------------------- */
onValue(storiesRef, snap => {
    const bar = document.getElementById("storiesBar");
    bar.innerHTML = "";

    /* -------- BOT√ÉO + NEON -------- */
    const addBtn = document.createElement("div");
    addBtn.className = "story-user-box";
    addBtn.innerHTML = `
        <div class="add-story-btn" onclick="abrirCriarStory()">+</div>
        <div class="story-user-name">Novo</div>
    `;
    bar.appendChild(addBtn);

    /* Agora organiza stories por usu√°rio */
    let storiesPorUsuario = {};

    snap.forEach(st => {
        const s = st.val();
        const id = st.key;

        if (!storiesPorUsuario[s.usuario]) storiesPorUsuario[s.usuario] = [];
        storiesPorUsuario[s.usuario].push({ id, ...s });
    });

    /* Criar os c√≠rculos dos usu√°rios */
    Object.keys(storiesPorUsuario).forEach(user => {
        const storiesUser = storiesPorUsuario[user];
        const ultimo = storiesUser[storiesUser.length - 1];

        const box = document.createElement("div");
        box.className = "story-user-box";

        let midia = "";
        if (ultimo.imagem) {
            midia = `<img src="${ultimo.imagem}">`;
        } else if (ultimo.video) {
            midia = `<video src="${ultimo.video}" muted></video>`;
        } else {
            midia = `<img src="https://cdn-icons-png.flaticon.com/512/149/149071.png">`;
        }

        box.innerHTML = `
            <div class="story-circle" onclick="abrirViewer('${user}')">
                ${midia}
            </div>
            <div class="story-user-name">${user}</div>
        `;

        bar.appendChild(box);
    });
});
/* ------------------------------------------------------------ */
/*                    VIEWER ‚Äì FACEBOOK STYLE                  */
/* ------------------------------------------------------------ */

let todosStories = [];
let indiceAtual = 0;
let progressoTimers = [];

window.abrirViewer = function (usuarioClicado) {

    /* Carrega todos os stories do Firebase em ordem */
    onValue(storiesRef, snap => {
        todosStories = [];

        snap.forEach(st => {
            const s = st.val();
            const id = st.key;

            todosStories.push({
                id,
                ...s
            });
        });

        /* Ordena por timestamp */
        todosStories.sort((a,b) => a.timestamp - b.timestamp);

        /* Encontra o primeiro story do usu√°rio clicado */
        indiceAtual = todosStories.findIndex(st => st.usuario === usuarioClicado);

        if (indiceAtual < 0) indiceAtual = 0;

        storyViewer.style.display = "flex";
        mostrarStoryAtual();
    }, { onlyOnce: true });
};


/* ---------------- MOSTRAR STORY NO VIEWER ---------------- */

function mostrarStoryAtual() {
    progressoTimers.forEach(t => clearTimeout(t));
    progressoTimers = [];

    const story = todosStories[indiceAtual];
    if (!story) return fecharViewer();

    /* Autor */
    viewerAuthor.textContent = story.usuario;

    /* Bot√£o Excluir s√≥ aparece se o dono for o usu√°rio */
    if (story.usuario === usuario) {
        storyMenuBtn.style.display = "block";
    } else {
        storyMenuBtn.style.display = "none";
    }

    /* Conte√∫do */
    viewerContent.innerHTML = "";

    let el;

    if (story.imagem) {
        el = document.createElement("img");
        el.src = story.imagem;
        iniciarProgresso(5000);

    } else if (story.video) {
        el = document.createElement("video");
        el.src = story.video;
        el.autoplay = true;
        el.onloadedmetadata = () => {
            const dur = Math.min(el.duration * 1000, 15000);
            iniciarProgresso(dur);
        };

    } else {
        el = document.createElement("p");
        el.style.color = "white";
        el.style.fontSize = "1.4rem";
        el.style.padding = "20px";
        el.textContent = story.texto || "Sem conte√∫do";
        iniciarProgresso(4000);
    }

    viewerContent.appendChild(el);

    montarBarraProgresso();
}

/* ---------- PROGRESS BAR ---------- */

function montarBarraProgresso() {
    viewerProgress.innerHTML = "";

    for (let i = 0; i < todosStories.length; i++) {
        const seg = document.createElement("div");
        seg.className = "progress-segment";

        const fill = document.createElement("div");
        fill.className = "progress-fill";

        if (i < indiceAtual) fill.style.width = "100%";

        seg.appendChild(fill);
        viewerProgress.appendChild(seg);
    }
}

function iniciarProgresso(dur) {
    const segmentos = viewerProgress.querySelectorAll(".progress-fill");
    const atual = segmentos[indiceAtual];

    atual.style.transition = "none";
    atual.style.width = "0px";

    atual.offsetWidth;

    atual.style.transition = `width ${dur}ms linear`;
    atual.style.width = "100%";

    progressoTimers.push(setTimeout(() => {
        avancarStory();
    }, dur));
}

/* ------------- AVAN√áAR STORY ------------- */
function avancarStory() {
    indiceAtual++;
    if (indiceAtual >= todosStories.length) {
        return fecharViewer();
    }
    mostrarStoryAtual();
}

/* Clicar na tela avan√ßa */
storyViewer.onclick = function (e) {
    if (e.target.id === "storyMenuBtn" || e.target.id === "storyMenu") return;
    avancarStory();
};

/* ------------- FECHAR VIEWER ------------- */
window.fecharViewer = function () {
    storyViewer.style.display = "none";
    viewerContent.innerHTML = "";
    viewerProgress.innerHTML = "";

    progressoTimers.forEach(t => clearTimeout(t));
    progressoTimers = [];
};

/* -------- MENU ‚ãÆ APENAS EXCLUIR -------- */
storyMenuBtn.onclick = function (e) {
    e.stopPropagation();
    storyMenu.style.display = storyMenu.style.display === "block" ? "none" : "block";
};

storyMenu.onclick = function () {
    const st = todosStories[indiceAtual];

    if (st.usuario !== usuario) {
        alert("Voc√™ n√£o pode excluir stories de outros usu√°rios!");
        return;
    }

    if (!confirm("Excluir este story?")) return;

    remove(ref(db, "coletivo_mural/stories/" + st.id));

    storyMenu.style.display = "none";
    avancarStory();
};
</script>
<!-- FEED -->
<div class="feed">

    <div class="post-box">
        <textarea id="texto" placeholder="No que voc√™ est√° pensando?"></textarea>

        <label for="imgUpload" class="img-icon">
            <img src="https://i.pinimg.com/736x/f9/c5/fa/f9c5fa9710cdf2b510d32915cd882330.jpg">
        </label>

        <input type="file" id="imgUpload" accept="image/*,video/*">
    </div>

    <div id="preview" class="preview"></div>

    <button onclick="postar()">Postar</button>

    <h2 style="color:#00ffcc; margin-top:25px;">Publica√ß√µes</h2>
    <div id="feed"></div>
</div>

<!-- MODAL DE IMAGEM/VIDEO -->
<div id="imgModal">
    <span id="closeModal" onclick="fechaModal()">‚úñ</span>
    <img id="modalImg">
</div>
<style>

/* --- FEED E POST BOX --- */

.feed {
    width: 95%;
    max-width: 650px;
    margin: 15px auto;
    padding: 5px;
}

.post-box {
    background: rgba(0,0,0,0.65);
    border-radius: 30px;
    padding: 16px;
    border: 1px solid rgba(0,255,150,0.25);
    display: flex;
    align-items: center;
    gap: 12px;
}

.post-box textarea {
    width: 100%;
    padding: 12px 15px;
    border-radius: 25px;
    border: none;
    background: rgba(255,255,255,0.10);
    color: #fff;
    resize: none;
    height: 40px;
}

.img-icon img {
    height: 26px;
    cursor: pointer;
}

#imgUpload { display:none; }

.preview img, .preview video {
    width: 100%;
    max-height: 150px;
    border-radius: 12px;
    margin-top: 12px;
    object-fit: cover;
}

.remove-preview {
    background: #ff5555;
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 5px;
}

/* --- BOT√ÉO POSTAR --- */

button {
    width: 100%;
    padding: 12px;
    background: #00ffaa;
    border: none;
    border-radius: 10px;
    margin-top: 10px;
    font-size: 1.05rem;
    font-weight: bold;
    cursor: pointer;
}

/* --- POST --- */

.post {
    background: rgba(0,0,0,0.65);
    padding: 16px;
    border-radius: 15px;
    border: 1px solid rgba(0,255,150,0.30);
    margin-bottom: 25px;
    text-align: left;
}

.post img, .post video {
    width: 100%;
    max-height: 400px;
    border-radius: 12px;
    cursor: pointer;
}

/* --- REA√á√ïES / COMENT√ÅRIOS --- */

.reaction-count, .comment-count {
    text-align: left;
    font-weight: bold;
    margin-bottom: 10px;
    cursor: pointer;
    color: #aaffcc;
}

.actions {
    display: flex;
    justify-content: space-around;
    margin-top: 5px;
    border-top: 1px solid #004422;
    padding-top: 10px;
}

.actions div {
    cursor: pointer;
    color: #00ffaa;
    font-weight: bold;
}

/* --- LISTA DE COMENT√ÅRIOS --- */

.comment-list {
    background: rgba(255,255,255,0.10);
    border-radius: 10px;
    margin-top: 10px;
    padding: 10px;
    display: none;
}

.comment-entry {
    padding: 10px;
    background: rgba(0,0,0,0.35);
    border-radius: 10px;
    margin-bottom: 8px;
    display:flex;
    justify-content: space-between;
    color:#ddffe8;
}

.comment-entry img {
    width: 40px;
    height: 40px;
    border-radius:50%;
    object-fit:cover;
    margin-right:10px;
    border:2px solid #00ffaa;
}

.comment-box textarea {
    width: 100%;
    resize: none;
    border-radius: 12px;
    padding: 10px;
    border: none;
    background: rgba(0,0,0,0.45);
    color: white;
}

/* --- MODAL DE IMAGEM --- */

#imgModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.90);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 99999;
}

#imgModal img {
    max-width: 95%;
    max-height: 90%;
    border-radius: 12px;
}

#closeModal {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 2.5rem;
    cursor:pointer;
}

/* --- RESPONSIVIDADE --- */

@media (max-width: 600px) {

    .feed {
        width: 96%;
        margin: 10px auto;
    }

    .post-box {
        padding: 14px;
        flex-direction: column;
        align-items: stretch;
    }

    .post-box textarea {
        height: 60px;
        font-size: 1rem;
    }

    .preview img, .preview video {
        max-height: 130px;
    }

    .post img, .post video {
        max-height: 280px;
    }

    .actions {
        flex-direction: column;
        gap: 12px;
        text-align:center;
    }

    .comment-entry {
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
    }
}

</style>
<script type="module">
import { getDatabase, ref, push, onValue, remove, update, set }
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

import { getApp } 
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

/* Recuperar app j√° inicializado */
const app = getApp();
const db = getDatabase(app);

/* ------------------------------ */
/*      Upload de imagem/v√≠deo    */
/* ------------------------------ */

let imagemTemp = null;
let tipoMidia = null;

document.getElementById("imgUpload").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    tipoMidia = file.type.startsWith("video/") ? "video" : "imagem";

    const reader = new FileReader();
    reader.onload = e => {
        imagemTemp = e.target.result;

        if (tipoMidia === "video") {
            preview.innerHTML = `
                <video controls autoplay muted playsinline>
                    <source src="${imagemTemp}">
                </video>
                <div class="remove-preview" onclick="removerPreview()">Excluir v√≠deo</div>
            `;
        } else {
            preview.innerHTML = `
                <img src="${imagemTemp}">
                <div class="remove-preview" onclick="removerPreview()">Excluir imagem</div>
            `;
        }
    };

    reader.readAsDataURL(file);
});

/* REMOVER PREVIEW */
window.removerPreview = function () {
    imagemTemp = null;
    tipoMidia = null;
    preview.innerHTML = "";
    imgUpload.value = "";
};

/* ------------------------------ */
/*         POSTAR PUBLICA√á√ÉO      */
/* ------------------------------ */

window.postar = function () {

    if (!usuario) {
        alert("Fa√ßa login para postar.");
        loginBox.style.display = "flex";
        document.body.style.overflow = "hidden";
        return;
    }

    const texto = document.getElementById("texto").value.trim();
    if (texto === "" && !imagemTemp) return;

    const postData = {
        usuario,
        texto,
        imagem: tipoMidia === "imagem" ? imagemTemp : null,
        video: tipoMidia === "video" ? imagemTemp : null,
        reacoes: {},
        comentarios: {}
    };

    push(ref(db, "coletivo_mural/posts"), postData);

    document.getElementById("texto").value = "";
    removerPreview();
};
<script type="module">
import { getDatabase, ref, onValue, push, remove, set }
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
import { getApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

const app2 = getApp();
const db2 = getDatabase(app2);

const postsRef = ref(db2, "coletivo_mural/posts");

const urlParams = new URLSearchParams(window.location.search);
const postID_URL = urlParams.get("post");

/* ---------------------------- */
/*      EXIBIR POSTS DO FEED    */
/* ---------------------------- */

onValue(postsRef, snap => {
    const feed = document.getElementById("feed");
    feed.innerHTML = "";

    if (postID_URL) {
        const p = snap.child(postID_URL).val();

        if (!p) {
            feed.innerHTML = "<p style='color:white;font-size:20px;'>Post n√£o encontrado.</p>";
            return;
        }

        mostrarPostIndividual(postID_URL, p);
        return;
    }

    snap.forEach(postSnap => {
        adicionarPostAoMural(postSnap.key, postSnap.val());
    });
});

/* ------------------------------- */
/*        EXIBIR POST INDIVIDUAL   */
/* ------------------------------- */

window.mostrarPostIndividual = function(id, p) {

    const feed = document.getElementById("feed");

    let midiaHTML = "";
    if (p.imagem) midiaHTML = `<img src="${p.imagem}" onclick="abreModal('${p.imagem}')">`;
    if (p.video) midiaHTML = `<video controls autoplay muted playsinline><source src="${p.video}"></video>`;

    const totalCurtidas = p.reacoes ? Object.keys(p.reacoes).length : 0;
    const numComentarios = p.comentarios ? Object.keys(p.comentarios).length : 0;
    const jaCurtiu = p.reacoes && p.reacoes[usuario];

    feed.innerHTML = `
        <div class="post">
            <strong style="color:#00ffcc;">${p.usuario}</strong><br><br>
            ${midiaHTML}
            <p>${p.texto}</p>

            <div class="reaction-count">üëç ${totalCurtidas} curtidas</div>
            <div class="comment-count">üí¨ ${numComentarios} coment√°rios</div>

            <div class="actions">
                <div onclick="toggleCurtir('${id}')">üëç ${jaCurtiu ? "Voc√™ curtiu" : "Curtir"}</div>
                <div onclick="toggleComentarioBox('${id}')">üí¨ Comentar</div>
                <div onclick="compartilhar('${id}')">üì§ Compartilhar</div>
                ${p.usuario === usuario ? `<div onclick="apagarPost('${id}')">üóë Excluir</div>` : ""}
            </div>

            <div class="comment-box" id="cb_${id}" style="display:none;">
                <textarea id="ct_${id}" rows="2" placeholder="Escreva um coment√°rio..."></textarea>
                <button onclick="comentar('${id}')">Enviar</button>
            </div>

            <div class="comment-list" id="cl_${id}"></div>

            <button onclick="window.location.href='site.html'"
                style="margin-top:25px;padding:12px 20px;background:#00ffaa;border:none;border-radius:10px;font-size:1rem;font-weight:bold;cursor:pointer;">
                ‚¨Ö Voltar ao mural
            </button>
        </div>
    `;

    carregarComentarios(id, p);
};

/* ---------------------------- */
/*     ADICIONAR POST AO FEED   */
/* ---------------------------- */

window.adicionarPostAoMural = function(id, p) {

    const feed = document.getElementById("feed");

    let midiaHTML = "";
    if (p.imagem) midiaHTML = `<img src="${p.imagem}" onclick="abreModal('${p.imagem}')">`;
    if (p.video) midiaHTML = `<video controls autoplay muted playsinline><source src="${p.video}"></video>`;

    const totalCurtidas = p.reacoes ? Object.keys(p.reacoes).length : 0;
    const numComentarios = p.comentarios ? Object.keys(p.comentarios).length : 0;
    const jaCurtiu = p.reacoes && p.reacoes[usuario];

    const div = document.createElement("div");
    div.className = "post";

    div.innerHTML = `
        <strong style="color:#00ffcc;">${p.usuario}</strong><br><br>
        ${midiaHTML}
        <p>${p.texto}</p>

        <div class="reaction-count" onclick="mostrarCurtidas('${id}')">üëç ${totalCurtidas} curtidas</div>
        <div class="comment-count" onclick="toggleComentarios('${id}')">üí¨ ${numComentarios} coment√°rios</div>

        <div class="actions">
            <div onclick="toggleCurtir('${id}')">üëç ${jaCurtiu ? "Voc√™ curtiu" : "Curtir"}</div>
            <div onclick="toggleComentarioBox('${id}')">üí¨ Comentar</div>
            <div onclick="compartilhar('${id}')">üì§ Compartilhar</div>
            ${p.usuario === usuario ? `<div onclick="apagarPost('${id}')">üóë Excluir</div>` : ""}
        </div>

        <div class="comment-box" id="cb_${id}" style="display:none;">
            <textarea id="ct_${id}" rows="2" placeholder="Escreva um coment√°rio..."></textarea>
            <button onclick="comentar('${id}')">Enviar</button>
        </div>

        <div class="comment-list" id="cl_${id}"></div>
        <div class="comment-list" id="likes_${id}" style="display:none;"></div>
    `;

    feed.prepend(div);

    carregarComentarios(id, p);
};

/* ---------------------------- */
/*       CARREGAR COMENT√ÅRIOS   */
/* ---------------------------- */

function carregarComentarios(id, p) {
    const lista = document.getElementById("cl_" + id);
    lista.innerHTML = "";

    if (p.comentarios) {
        Object.entries(p.comentarios).forEach(([cid, c]) => {
            const foto = c.fotoPerfil || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

            const div = document.createElement("div");
            div.className = "comment-entry";

            div.innerHTML = `
                <img src="${foto}">
                <div style="flex:1;">
                    <strong style="color:#00ffcc;">${c.usuario}:</strong> ${c.texto}
                </div>
                ${c.usuario === usuario ? `<span onclick="excluirComentario('${id}','${cid}')" style="cursor:pointer;">‚ùå</span>` : ""}
            `;

            lista.appendChild(div);
        });
    }
}

/* ---------------------------- */
/*     T√çTULOS: LIKE, COMMENT   */
/* ---------------------------- */

window.toggleCurtir = function (postId) {

    if (!usuario) {
        alert("Voc√™ precisa entrar para curtir.");
        return;
    }

    const likeRef = ref(db2, `coletivo_mural/posts/${postId}/reacoes/${usuario}`);

    onValue(likeRef, snap => {
        if (snap.exists()) remove(likeRef);
        else set(likeRef, true);
    }, { onlyOnce: true });
};

window.mostrarCurtidas = function(postId) {
    const box = document.getElementById("likes_" + postId);

    box.style.display = box.style.display === "block" ? "none" : "block";

    onValue(ref(db2, `coletivo_mural/posts/${postId}/reacoes`), snap => {
        box.innerHTML = "";

        if (!snap.exists()) {
            box.innerHTML = "<p>Ningu√©m curtiu ainda</p>";
            return;
        }

        snap.forEach(s => {
            const pessoa = s.key;
            const item = document.createElement("div");
            item.className = "comment-entry";
            item.innerHTML = `<strong>${pessoa}</strong> curtiu üëç`;
            box.appendChild(item);
        });
    });
};

window.toggleComentarios = function(id) {
    const lista = document.getElementById("cl_" + id);
    lista.style.display = lista.style.display === "block" ? "none" : "block";
};

window.toggleComentarioBox = function(id) {
    const box = document.getElementById("cb_" + id);
    box.style.display = box.style.display === "block" ? "none" : "block";
};

window.comentar = function (postId) {
    if (!usuario) return alert("Fa√ßa login!");

    const campo = document.getElementById("ct_" + postId);
    const texto = campo.value.trim();
    if (!texto) return;

    const foto = localStorage.getItem("fotoPerfil_" + usuario)
                 || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    push(ref(db2, `coletivo_mural/posts/${postId}/comentarios`), {
        usuario,
        texto,
        fotoPerfil: foto,
        hora: new Date().toLocaleString("pt-BR")
    });

    campo.value = "";
};

window.excluirComentario = function(postId, cid) {
    onValue(ref(db2, `coletivo_mural/posts/${postId}/comentarios/${cid}`), snap => {
        if (!snap.exists()) return;

        if (snap.val().usuario !== usuario) {
            alert("Voc√™ n√£o pode apagar coment√°rios de outras pessoas!");
            return;
        }

        if (confirm("Excluir coment√°rio?")) {
            remove(ref(db2, `coletivo_mural/posts/${postId}/comentarios/${cid}`));
        }
    }, { onlyOnce: true });
};

window.apagarPost = function(id) {
    onValue(ref(db2, `coletivo_mural/posts/${id}`), snap => {
        if (!snap.exists()) return;

        if (snap.val().usuario !== usuario) {
            alert("Voc√™ n√£o pode apagar posts de outras pessoas!");
            return;
        }

        if (confirm("Excluir post?")) {
            remove(ref(db2, `coletivo_mural/posts/${id}`));
        }
    }, { onlyOnce: true });
};

/* -------- MODAL ---------- */

window.abreModal = function(src) {
    modalImg.src = src;
    imgModal.style.display = "flex";
};

window.fechaModal = function () {
    imgModal.style.display = "none";
};
</script>
<script>
/* -------------------------------------------------- */
/*  COMPARTILHAR POST ‚Äì COPIAR LINK E ABRIR P√ÅGINA   */
/* -------------------------------------------------- */
window.compartilhar = function(postId) {

    const link = `https://marcio2307.github.io/terreiro/site.html?post=${postId}`;

    navigator.clipboard.writeText(link).then(() => {
        alert("üîó Link do post copiado!\nAgora voc√™ pode colar onde quiser.");

        setTimeout(() => {
            window.open(link, "_blank");
        }, 150);

    }).catch(() => {
        alert("‚ùå Seu navegador bloqueou o copiar, mas abrimos o post!");
        window.open(link, "_blank");
    });
};
</script>
<script>
/* ----------------------------- */
/*       LOGIN COM GOOGLE        */
/* ----------------------------- */

document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {

        google.accounts.id.initialize({
            client_id: "627442405379-srqriainr8okj7ldg96njd1va5bvt7oi.apps.googleusercontent.com",
            callback: handleGoogleLogin,
            auto_select: false,
            cancel_on_tap_outside: false
        });

        document.getElementById("googleLogin").style.display = "block";

        google.accounts.id.renderButton(
            document.getElementById("googleLogin"),
            { 
                theme: "filled_black",
                size: "large",
                width: 270,
                type: "standard"
            }
        );

    }, 250);
});

function handleGoogleLogin(response) {
    const data = decodeJwt(response.credential);

    const user = data.email.split("@")[0];
    usuario = user;

    localStorage.setItem("usuarioLogado", usuario);

    loginBox.style.display = "none";
    document.body.style.overflow = "auto";

    if (data.picture) {
        perfilFoto.src = data.picture;
        localStorage.setItem("fotoPerfil_" + usuario, data.picture);
    }

    nomeUsuarioMenu.textContent = usuario;

    }

function decodeJwt(token) {
    return JSON.parse(atob(token.split('.')[1]));
}
</script>
<script>
/* ------------------------------------------ */
/*       FOTO DE PERFIL DO USU√ÅRIO            */
/* ------------------------------------------ */

document.getElementById("fotoPerfilUpload").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        const imgBase64 = e.target.result;

        if (usuario) {
            localStorage.setItem("fotoPerfil_" + usuario, imgBase64);
        }

        perfilFoto.src = imgBase64;

        /* Atualiza foto no story (c√≠rculo do usu√°rio) caso exista */
        const meuStoryFoto = document.getElementById("meuStoryFoto");
        if (meuStoryFoto) meuStoryFoto.src = imgBase64;
    };

    reader.readAsDataURL(file);
});

/* ------------------------------------------ */
/*                R√ÅDIO PLAYER                */
/* ------------------------------------------ */

let tocando = false;

function toggleRadio() {
    const player = document.getElementById("radioPlayer");
    const btn = document.getElementById("playBtn");

    if (!tocando) {
        player.play();
        btn.textContent = "‚è∏";
        tocando = true;
    } else {
        player.pause();
        btn.textContent = "‚ñ∂";
        tocando = false;
    }
}

/* ------------------------------------------ */
/*              MENU HAMB√öRGUER               */
/* ------------------------------------------ */

function toggleMenu() {
    const menu = document.getElementById("sideMenu");
    menu.style.right = (menu.style.right === "0px") ? "-260px" : "0px";
}

document.addEventListener("click", function(e) {
    const menu = sideMenu;
    const icon = menuIcon;

    if (!menu.contains(e.target) && !icon.contains(e.target)) {
        menu.style.right = "-260px";
    }
});
</script>
<!-- üîî SOM DE NOTIFICA√á√ÉO 100% FUNCIONAL -->
<audio id="notificaChat" preload="none">
    <source src="https://marcio2307.github.io/terreiro/som.mp3" type="audio/mpeg">
</audio>

<script>
/* -------------------------------------------------- */
/*       LIBERAR SOM NO CELULAR (iPhone/Android)      */
/* -------------------------------------------------- */

(function(){
    const audio = document.getElementById("notificaChat");
    if (!audio) return;

    function liberarSom() {
        audio.volume = 1;

        audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
            console.log("üîì √Åudio liberado com sucesso");
        }).catch(()=>{});
    }

    ["click","touchstart","mousedown"].forEach(ev=>{
        document.addEventListener(ev, liberarSom, { once: true });
    });
})();
</script>

<!-- üî• PRESEN√áA + ONDISCONNECT + NOTIFICA√á√ïES -->
<script type="module">
import { 
    getApp, initializeApp 
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

import { 
    getDatabase, ref, set, onValue, onDisconnect 
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

/* üî• GARANTE APP INICIALIZADO (SEM DUPLICAR) */
let app;
try {
    app = getApp();
} catch {
    app = initializeApp({
        apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
        authDomain: "coletivo-f34d4.firebaseapp.com",
        databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
        projectId: "coletivo-f34d4",
        storageBucket: "coletivo-f34d4.firebasestorage.app",
        messagingSenderId: "296376447787",
        appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
    });
}

const db = getDatabase(app);

usuario = localStorage.getItem("usuarioLogado");

const foto = localStorage.getItem("fotoPerfil_" + usuario)
    || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

/* -------------------------------------------------- */
/*              PRESEN√áA ONLINE NO FIREBASE           */
/* -------------------------------------------------- */

function iniciarPresenca() {

    const userRef = ref(db, "chat/usuariosOnline/" + usuario);

    // Marca online
    set(userRef, { nome: usuario, foto, online: true });

    // Sai ao fechar aba
    onDisconnect(userRef).set({
        nome: usuario,
        foto,
        online: false
    });

    /* üî• SISTEMA DE INATIVIDADE - 2 MINUTOS */
    let ultimoToque = Date.now();

    function atividade() {
        ultimoToque = Date.now();
        set(userRef, { nome: usuario, foto, online: true });
    }

    ["click","mousemove","keydown","touchstart","touchmove","scroll"]
    .forEach(ev => {
        document.addEventListener(ev, atividade, { passive:true });
    });

    setInterval(() => {

        const tempoParado = Date.now() - ultimoToque;

        if (tempoParado >= 120000) {
            // offline por inatividade
            set(userRef, { nome: usuario, foto, online: false });
        } else {
            // voltou a mexer
            set(userRef, { nome: usuario, foto, online: true });
        }

    }, 4000);
}

/* -------------------------------------------------- */
/*              NOTIFICA√á√ïES DO CHAT                   */
/* -------------------------------------------------- */

function iniciarNotificacoes() {
    const convRef = ref(db, "chat/conversas");

    onValue(convRef, snap => {

        if (!snap.exists()) return;

        snap.forEach(roomSnap => {
            const roomId = roomSnap.key;

            if (!roomId.includes(usuario)) return;

            let ultima = null;
            roomSnap.forEach(m => ultima = m.val());

            if (!ultima) return;

            if (ultima.de !== usuario) {
                const som = document.getElementById("notificaChat");
                som.currentTime = 0;
                som.play().catch(()=>{});
            }
        });
    });
}

/* -------------------------------------------------- */
/*                 INICIAR SISTEMAS                   */
/* -------------------------------------------------- */

if (usuario) {
    iniciarPresenca();
    iniciarNotificacoes();
}
</script>

<!-- LOGOUT COMPLETO -->
<script>
function logout() {

    // remove login salvo
    localStorage.removeItem("usuarioLogado");

    if (usuario) {
        localStorage.removeItem("fotoPerfil_" + usuario);
    }

    // logout Google Identity
    try {
        google.accounts.id.disableAutoSelect();

        google.accounts.id.revoke(usuario, () => {
            console.log("Google desconectado.");
        });
    } catch(e){}

    // volta para login
    setTimeout(() => {
        window.location.reload();
    }, 300);
}
</script>

<!-- STORY DO USU√ÅRIO ‚Äì CARREGA FOTO NO C√çRCULO -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const usuarioLogado = localStorage.getItem("usuarioLogado");

    if (usuarioLogado) {
        const foto = localStorage.getItem("fotoPerfil_" + usuarioLogado);
        if (foto) {
            const meuStoryFoto = document.getElementById("meuStoryFoto");
            if (meuStoryFoto) meuStoryFoto.src = foto;
        }
    }
});
</script>
