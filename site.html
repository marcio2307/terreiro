<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Menu + Stories estilo Insta + Feed Completo</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  *{ box-sizing: border-box; }
  html, body{ width:100%; max-width:100%; overflow-x:hidden; }
  body{ margin:0; background:#000; font-family: Arial, sans-serif; color:#fff; padding-bottom: env(safe-area-inset-bottom); }

  /* ======================== LOGO (ACIMA DO MENU) ======================== */
  .logo-bar{
    width:100%;
    background:#000;
    display:flex;
    justify-content:space-between; /* ✅ logo esquerda + messenger direita */
    align-items:center;
    padding: 10px 12px 6px 12px;
    gap: 12px;
  }
  .logo-bar img{
    width: clamp(180px, 58vw, 420px);
    height: auto;
    max-height: 120px;
    object-fit: contain;
    display:block;
  }
  @media(max-width:480px){
    .logo-bar{ padding: 10px 10px 6px 10px; }
    .logo-bar img{ max-height: 86px; }
  }

  /* ✅ Botão Messenger */
  .messenger-btn{
    position:relative;
    width: 56px;
    height: 56px;
    border-radius: 16px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;
    text-decoration:none;

    background: rgba(13,13,13,.85);
    border: 2px solid #00ff8c;
    box-shadow: 0 0 15px rgba(0,255,140,.35);
    color:#00ff8c;
    transition: transform .15s ease, box-shadow .15s ease;
    flex: 0 0 auto;
  }
  .messenger-btn:hover{ transform: scale(1.04); box-shadow: 0 0 18px rgba(0,255,140,.55); }
  .messenger-btn i{
    font-size: 28px;
    text-shadow: 0 0 10px #00ff8c, 0 0 20px #00ff8c;
  }
  .messenger-dot{
    position:absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    border-radius:50%;
    background: #ffd400; /* ✅ amarelo */
    box-shadow: 0 0 14px rgba(255,212,0,.95);
    border: 2px solid #000;
    display:none;
    animation: blinkYellow .8s infinite;
  }
  @keyframes blinkYellow{
    0%,100%{ transform: scale(1); opacity: 1; }
    50%{ transform: scale(1.35); opacity: .25; }
  }
  @media(max-width:480px){
    .messenger-btn{ width: 50px; height:50px; border-radius: 14px; }
    .messenger-btn i{ font-size: 26px; }
    .messenger-dot{ top: 7px; right: 7px; width: 11px; height:11px; }
  }

  /* ======================== MENU NEON ======================== */
  .top-menu {
    width: 100%;
    background: #0d0d0d;
    padding: 18px 10px;
    display: flex;
    justify-content: center;
    gap: 50px;
    align-items: center;
    border-bottom: 2px solid #00ff8c;
    box-shadow: 0 0 15px #00ff8c;
    position: sticky;
    top: 0;
    z-index: 9999;
  }
  .top-menu.hide { display:none !important; }
  .top-menu a {
    color: #00ff8c;
    text-decoration: none;
    font-size: 22px;
    font-weight: bold;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.3s;
    letter-spacing: 1.2px;
    text-shadow: 0 0 10px #00ff8c, 0 0 20px #00ff8c, 0 0 35px #00ff8c;
    white-space: nowrap;
    padding: 10px 12px;
    border-radius: 16px;
    position: relative;
  }
  .top-menu a:hover { transform: scale(1.06); }
  .top-menu a i {
    font-size: 26px;
    text-shadow: 0 0 10px #00ff8c, 0 0 20px #00ff8c, 0 0 40px #00ff8c;
  }

  .menu-online-dot{
    position:absolute;
    top: 6px;
    right: 6px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #00ff4c;
    box-shadow: 0 0 14px rgba(0,255,76,.9);
    animation: blinkDot 0.9s infinite;
  }
  @keyframes blinkDot{
    0%, 100%{ transform: scale(1); opacity: 1; }
    50%{ transform: scale(1.35); opacity: .25; }
  }

  @media(max-width:480px){
    .top-menu { gap: 26px; padding: 14px 10px; }
    .top-menu a { font-size: 14px; letter-spacing:.8px; padding: 12px 14px; }
    .top-menu a i { font-size: 24px; }
    .menu-online-dot{ top: 7px; right: 7px; }
  }
  @media (max-width:360px){
    .top-menu{ gap: 20px; }
    .btn-action{ font-size:12px; padding:9px 10px; }
    .menu-btn{ font-size:26px; }
    .top-menu a i{ font-size: 22px; }
  }

  /* ======================== STORIES (ESTILO INSTA) ======================== */
  .stories-wrapper{ padding: 12px 10px 6px 10px; }
  .stories-row{
    display:flex;
    gap: 14px;
    overflow-x:auto;
    padding: 8px 4px 12px 4px;
    -webkit-overflow-scrolling: touch;
    align-items: stretch;
  }
  .stories-row::-webkit-scrollbar{ height:6px; }
  .stories-row::-webkit-scrollbar-thumb{ background:#00ff8c; border-radius:999px; }

  .storyCard{
    width: clamp(120px, 42vw, 160px);
    height: clamp(220px, 70vw, 290px);
    border-radius: 22px;
    overflow:hidden;
    position:relative;
    flex-shrink:0;
    cursor:pointer;
    background:#121314;
    box-shadow: 0 10px 28px rgba(0,0,0,.45);
    border: 1px solid rgba(255,255,255,.08);
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .storyCard:hover{ transform: translateY(-2px); box-shadow: 0 14px 32px rgba(0,0,0,.55); }

  .storyMedia{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover; display:block;
    filter: contrast(1.05) saturate(1.05);
    background:#000;
  }
  .storyShade{
    position:absolute; inset:auto 0 0 0;
    height: 48%;
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 35%, rgba(0,0,0,.78) 100%);
    pointer-events:none;
  }
  .segRow{
    position:absolute; top:10px; left:10px; right:10px;
    display:flex; gap:4px; z-index:5;
  }
  .seg{
    flex:1; height:3px;
    background: rgba(255,255,255,.35);
    border-radius:999px; overflow:hidden;
  }
  .avatarCircle{
    position:absolute; top:14px; left:14px;
    width:42px; height:42px;
    border-radius:50%;
    background:#0f1112;
    border:3px solid #2f6bff;
    box-shadow: 0 0 0 3px rgba(0,0,0,.25);
    overflow:hidden;
    z-index:6;
    display:flex; align-items:center; justify-content:center;
  }
  .avatarCircle img{ width:100%; height:100%; object-fit:cover; display:block; }
  .avatarInitials{
    font-weight:900; font-size:14px; color:#fff;
    text-shadow: 0 0 10px rgba(0,0,0,.6);
  }
  .storyName{
    position:absolute; left:14px; right:14px; bottom:14px;
    z-index:6;
    font-size:18px;
    font-weight:900;
    line-height:1.05;
    text-shadow: 0 2px 10px rgba(0,0,0,.75);
    display:-webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow:hidden;
  }
  .createCard{
    display:flex; align-items:center; justify-content:center;
    flex-direction:column; gap:10px;
    background: linear-gradient(180deg, #0f1112 0%, #0b0c0d 100%);
  }
  .plusBtn{
    width: 68px; height: 68px; border-radius: 50%;
    background:#00ff8c;
    border: 6px solid rgba(0,0,0,.55);
    display:flex; align-items:center; justify-content:center;
    color:#003b23; font-weight:900; font-size:42px;
    box-shadow:0 0 24px rgba(0,255,140,.55);
  }
  .createLabel{ font-weight:800; opacity:.95; }

  /* ======================== VIEWER ======================== */
  #viewer{
    position:fixed; inset:0;
    background: rgba(0,0,0,.92);
    display:none;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:99999;
  }

  #viewerMedia{
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding-top: 56px;
    padding-bottom: calc(96px + env(safe-area-inset-bottom));
  }

  #viewerMedia img, #viewerMedia video{
    width: min(100vw, 980px);
    max-width: 100vw;
    max-height: calc(100vh - 56px - 96px - env(safe-area-inset-bottom));
    object-fit: contain;
    border-radius: 16px;
    background:#000;
  }

  .topBars{
    position:absolute; top: 14px; left:0;
    width:100%;
    display:flex;
    gap:5px;
    padding: 0 10px;
    z-index:10;
  }
  .bar{
    flex:1; height:4px;
    background: rgba(255,255,255,.3);
    border-radius:999px;
    overflow:hidden;
  }
  .barFill{
    width:0%;
    height:100%;
    background:#00ff8c;
    box-shadow:0 0 15px #00ff8c;
    transition: width linear;
  }
  .tapLeft,.tapRight{
    position:absolute; top:0;
    height:100%; width:50%;
    z-index:5;
  }
  .tapLeft{ left:0; }
  .tapRight{ right:0; }

  .dots{
    position:absolute; top: 10px; right: 20px;
    font-size: 35px;
    cursor:pointer;
    z-index:20;
    user-select:none;
  }
  .deleteBtn{
    position:absolute; top: 55px; right: 20px;
    background:#00ff8c;
    color:#000;
    padding:10px 15px;
    border-radius:10px;
    cursor:pointer;
    display:none;
    font-weight:900;
    z-index:20;
    box-shadow:0 0 14px rgba(0,255,140,.6);
    user-select:none;
  }

  /* ✅ QUEM VIU */
  .viewerFooter{
    position:absolute;
    left:0; right:0; bottom:0;
    padding: 10px 12px calc(12px + env(safe-area-inset-bottom)) 12px;
    z-index: 30;
    pointer-events:none;
  }
  .viewerFooterInner{
    pointer-events:auto;
    width: min(560px, 96vw);
    margin: 0 auto;
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(0,255,140,.25);
    box-shadow: 0 0 18px rgba(0,255,140,.12);
    border-radius: 16px;
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    user-select:none;
    cursor:pointer;
  }
  .seenText{
    display:flex;
    align-items:center;
    gap: 10px;
    font-weight: 900;
    color:#fff;
    font-size: 14px;
    line-height:1.2;
    min-width:0;
  }
  .seenText i{
    color:#00ff8c;
    text-shadow: 0 0 12px rgba(0,255,140,.6);
    font-size: 16px;
    flex:0 0 auto;
  }
  .seenText span{
    display:block;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .seenArrow{
    width:36px; height:36px;
    border-radius: 12px;
    display:flex;
    align-items:center;
    justify-content:center;
    background: rgba(0,255,140,.12);
    border: 1px solid rgba(0,255,140,.25);
    color:#00ff8c;
    flex: 0 0 auto;
  }

  .viewersPanel{
    pointer-events:auto;
    width: min(560px, 96vw);
    margin: 10px auto 0 auto;
    background: rgba(0,0,0,.82);
    border: 1px solid rgba(0,255,140,.25);
    border-radius: 16px;
    padding: 10px 10px;
    max-height: 38vh;
    overflow:auto;
    display:none;
    box-shadow: 0 0 22px rgba(0,255,140,.18);
  }
  .viewerRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
    padding: 10px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.06);
    background: rgba(255,255,255,.03);
    margin-bottom: 8px;
  }
  .viewerRow:last-child{ margin-bottom:0; }
  .viewerName{
    font-weight: 900;
    color:#00ff8c;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 70%;
  }
  .viewerTime{
    font-size: 12px;
    opacity:.85;
    white-space:nowrap;
  }

  /* ====================== LOGIN ====================== */
  .login-overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.94);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 9999999;
    padding: 16px;
  }
  .login-card{
    width: min(520px, 94vw);
    max-width: 94vw;
    background:#0d0d0d;
    border:2px solid #00ff8c;
    border-radius:22px;
    box-shadow:0 0 28px rgba(0,255,140,.45);
    padding: 18px;
    text-align:center;
  }
  .login-title{
    font-size: clamp(18px, 6vw, 26px);
    font-weight: 900;
    color:#00ff8c;
    text-transform:uppercase;
    letter-spacing:1.2px;
    text-shadow: 0 0 10px #00ff8c, 0 0 22px #00ff8c;
    margin: 4px 0 14px 0;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .login-input{
    width: 100%;
    max-width: 100%;
    display:block;
    background:#111;
    border:1px solid #00ff9d;
    border-radius: 999px;
    padding: 14px 18px;
    color:#fff;
    outline:none;
    font-size: 16px;
    box-shadow: inset 0 0 10px rgba(0,255,157,.22);
  }
  .login-btn{
    width: 100%;
    margin-top: 12px;
    border:none;
    border-radius: 999px;
    padding: 16px 12px;
    font-weight: 900;
    cursor:pointer;
    font-size: 18px;
    transition:.18s;
    background:#00ff8c;
    color:#003b23;
    box-shadow:0 0 18px rgba(0,255,140,.55);
  }
  .login-btn:active{ transform: scale(.99); }

  /* ===================== FEED ===================== */
  .create-post{
    background:#0d0d0d;
    margin:10px 12px 15px 12px;
    padding:14px;
    border-radius:22px;
    border:1px solid #00ff9d;
    display:flex;
    gap:10px;
    align-items:center;
    box-shadow:0 0 10px rgba(0,255,157,.45);
  }
  .input-box{
    flex:1;
    min-width: 0;
    background:#111;
    padding:12px 18px;
    border-radius:999px;
    border:1px solid #00ff9d;
    color:#fff;
    font-size:16px;
    outline:none;
    box-shadow:inset 0 0 8px rgba(0,255,157,.35);
  }
  .add-btn{
    background:#111;
    border:2px solid #00ff9d;
    color:#00ff9d;
    width:46px;
    height:46px;
    border-radius:50%;
    font-size:22px;
    font-weight:bold;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow:0 0 10px rgba(0,255,157,.45);
    transition:.2s;
    flex: 0 0 auto;
  }
  .whatsapp-send{
    width:46px; height:46px;
    background:#00ff9d;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:26px;
    color:#003b23;
    cursor:pointer;
    box-shadow:0 0 15px rgba(0,255,157,.55);
    transition:.2s;
    border:2px solid #003b23;
    flex: 0 0 auto;
  }
  #fileInput{display:none;}

  .preview{
    margin:0 12px 15px 12px;
    padding:15px;
    background:#0d0d0d;
    border:1px solid #00ff9d;
    border-radius:15px;
    box-shadow:0 0 10px rgba(0,255,157,.45);
    display:none;
  }

  .post{
    background:#0d0d0d;
    margin:15px 12px;
    padding:15px;
    border-radius:16px;
    border:1px solid #00ff9d;
    box-shadow:0 0 10px rgba(0,255,157,.45);
    position:relative;
  }

  /* ✅ CABEÇALHO COM FOTO */
  .postHead{
    display:flex;
    align-items:center;
    gap:12px;
    padding-right:44px;
  }
  .postAvatar{
    width:56px;
    height:56px;
    border-radius:50%;
    overflow:hidden;
    background:#000;
    border:2px solid rgba(0,255,157,.55);
    box-shadow:0 0 14px rgba(0,255,157,.22);
    flex:0 0 auto;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .postAvatar img{
    width:100%;
    height:100%;
    object-fit: cover;
    object-position:center;
    display:block;
  }
  .postAvatar .init{
    font-weight:900;
    color:#00ff9d;
  }
  .postHeadText{ min-width:0; }
  .postNameLine{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }
  .postName{
    font-weight:900;
    font-size:22px;
    color:#7bffb5;
    text-shadow: 0 0 10px rgba(0,255,157,.25);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 62vw;
    cursor:pointer;
  }
  .postWhen{
    font-size:12px;
    color:#00ff9d;
    opacity:.85;
    margin-top:4px;
  }

  .post .mediaWrap img,
  .post .mediaWrap video{
    width:100%;
    border-radius:12px;
    margin-top:10px;
    background:#000;
    display:block;
  }

  .post-actions{
    display:flex;
    justify-content:space-around;
    margin-top:15px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .btn-action{
    color:#00ff9d;
    padding:10px 12px;
    border-radius:12px;
    font-weight:bold;
    cursor:pointer;
    transition:0.2s;
    text-align:center;
    border: 1px solid rgba(0,255,157,.25);
    background: rgba(0,0,0,.15);
    user-select:none;
  }

  .contador{
    margin-top:6px;
    font-size:13px;
    color:#00ff9d;
    text-align:center;
    opacity:.95;
    line-height:1.35;
    word-break: break-word;
  }

  .coment-area{
    background:#111;
    padding:10px;
    margin-top:10px;
    border-radius:12px;
    display:none;
    border:1px solid rgba(0,255,140,.22);
  }

  .menu-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 28px;
    cursor: pointer;
    color: #00ff9d;
    z-index: 10;
    user-select:none;
  }
  .menu-box {
    position: absolute;
    top: 45px;
    right: 10px;
    background: #00ff9d;
    color: #000;
    padding: 10px 15px;
    border-radius: 10px;
    display: none;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 0 12px rgba(0,255,157,.55);
    z-index: 15;
  }

  /* ✅ Comentários */
  .cRow{
    position:relative;
    background:#000;
    border:1px solid #00ff9d;
    padding:10px 44px 10px 10px;
    border-radius:10px;
    margin-bottom:8px;
  }
  .cHead{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:6px;
    min-width:0;
  }
  .cAvatar{
    width:34px; height:34px;
    border-radius:50%;
    overflow:hidden;
    background:#000;
    border:1px solid rgba(0,255,157,.45);
    flex:0 0 auto;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .cAvatar img{
    width:100%; height:100%;
    object-fit: cover;
    display:block;
  }
  .cName{
    font-weight:900;
    color:#00ff9d;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 62vw;
    cursor:pointer;
  }
  .cText{ opacity:.95; }

  .coment-menu-btn{
    position:absolute;
    top:10px;
    right:10px;
    font-size:20px;
    cursor:pointer;
    color:#00ff9d;
    user-select:none;
    line-height:1;
  }
  .coment-menu-box{
    position:absolute;
    top:34px;
    right:10px;
    background:#00ff9d;
    color:#000;
    padding:6px 10px;
    border-radius:8px;
    display:none;
    font-weight:900;
    cursor:pointer;
    box-shadow: 0 0 10px rgba(0,255,157,.55);
    z-index:5;
    line-height:1;
  }

  /* ===================== LOADING ===================== */
  .loadingOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.78);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 99999999;
    padding: 18px;
  }
  .loadingCard{
    width: min(520px, 92vw);
    background:#0d0d0d;
    border:2px solid #00ff8c;
    border-radius:18px;
    box-shadow:0 0 25px rgba(0,255,140,.45);
    padding:18px;
    text-align:center;
  }
  .spinner{
    width:46px;height:46px;border-radius:50%;
    border:4px solid rgba(0,255,140,.25);
    border-top-color:#00ff8c;
    margin:0 auto 10px auto;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg);} }
  .loadingText{ color:#00ff8c; font-weight:900; letter-spacing:.6px; }
  .loadingSub{ margin-top:6px; color:#fff; opacity:.85; font-size:14px; }

  .pendingBadge{
    display:inline-block;
    margin-left:8px;
    padding:4px 10px;
    border-radius:999px;
    background: rgba(0,255,140,.18);
    border:1px solid rgba(0,255,140,.35);
    color:#00ff8c;
    font-size:12px;
    font-weight:900;
  }
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-title"><i class="fa-solid fa-user"></i> ENTRAR</div>
    <input id="loginName" class="login-input" maxlength="24" placeholder="Digite seu nome" autocomplete="off">
    <button class="login-btn" onclick="confirmarNome()">Entrar</button>
  </div>
</div>

<!-- LOADING -->
<div class="loadingOverlay" id="loadingOverlay">
  <div class="loadingCard">
    <div class="spinner"></div>
    <div class="loadingText" id="loadingText">Enviando...</div>
    <div class="loadingSub" id="loadingSub">Aguarde um instante</div>
  </div>
</div>

<!-- ✅ LOGO ESQUERDA + MESSENGER DIREITA -->
<div class="logo-bar">
  <img src="https://i.ibb.co/h1RmgKSX/Chat-GPT-Image-17-12-2025-21-32-09.png" alt="Logo" loading="eager">

  <!-- ✅ Ícone estilo Messenger (abre o batepapo) -->
  <a class="messenger-btn" href="https://marcio2307.github.io/terreiro/batepapo.html" onclick="onOpenBatepapo(event)" title="Bate-papo" aria-label="Bate-papo">
    <i class="fa-brands fa-facebook-messenger"></i>
    <span class="messenger-dot" id="messengerDot" aria-hidden="true"></span>
  </a>
</div>

<!-- MENU (sem botão sair + com ícone perfil) -->
<nav class="top-menu">
  <a href="https://marcio2307.github.io/terreiro/estudo.html" title="Estudo" aria-label="Estudo">
    <i class="fa-solid fa-book"></i>
  </a>

  <a href="https://marcio2307.github.io/terreiro/chat.html" title="Usuários Online" aria-label="Usuários Online">
    <i class="fa-solid fa-users"></i>
    <span class="menu-online-dot" aria-hidden="true"></span>
  </a>

  <a href="https://marcio2307.github.io/terreiro/sala.html" title="Reunião Online" aria-label="Reunião Online">
    <i class="fa-solid fa-video"></i>
  </a>

  <a href="#" id="radioBtn" onclick="toggleRadio(); return false;" title="Rádio" aria-label="Rádio">
    <i class="fa-solid fa-play" id="radioIcon"></i>
  </a>

  <a href="https://marcio2307.github.io/terreiro/perfil.html" title="Perfil" aria-label="Perfil">
    <i class="fa-solid fa-user"></i>
  </a>
</nav>

<!-- STORIES -->
<div class="stories-wrapper">
  <div class="stories-row" id="storiesRow"></div>
</div>

<!-- VIEWER -->
<div id="viewer">
  <div class="topBars" id="bars"></div>
  <div class="dots" id="dots">⋮</div>
  <div class="deleteBtn" id="deleteBtn">Excluir</div>
  <div class="tapLeft" id="tapLeft"></div>
  <div class="tapRight" id="tapRight"></div>
  <div id="viewerMedia"></div>

  <!-- ✅ QUEM VIU -->
  <div class="viewerFooter" id="viewerFooter">
    <div class="viewerFooterInner" id="viewerFooterInner" onclick="toggleViewersPanel()">
      <div class="seenText">
        <i class="fa-solid fa-eye"></i>
        <span id="seenText">Ninguém viu ainda</span>
      </div>
      <div class="seenArrow" id="seenArrow">
        <i class="fa-solid fa-chevron-up" id="seenChevron"></i>
      </div>
    </div>
    <div class="viewersPanel" id="viewersPanel"></div>
  </div>
</div>

<!-- FEED / MURAL -->
<div class="create-post">
  <input type="text" id="postText" class="input-box" placeholder="No que você está pensando?" oninput="updateButton()">
  <div class="add-btn" id="btnMain" onclick="buttonAction()">+</div>
  <input type="file" id="fileInput" accept="image/*,video/*">
</div>

<div class="preview" id="previewBox">
  <h3>Prévia da mídia</h3>
  <div id="previewContent"></div>

  <div style="margin-top:15px; display:flex; flex-direction:column; gap:12px;">
    <button onclick="removerPreview()"
      style="width:100%;padding:15px;font-size:20px;font-weight:bold;border:none;border-radius:18px;background:#ff6b6b;color:#fff;cursor:pointer;">
      Excluir imagem
    </button>

    <button onclick="postar()"
      style="width:100%;padding:15px;font-size:22px;font-weight:bold;border:none;border-radius:18px;background:#7bffb5;color:#000;cursor:pointer;">
      Postar
    </button>
  </div>
</div>

<div id="feed"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
/* ====================== FIREBASE ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();
const ST = firebase.storage();

/* ====================== ✅ SOM (AÇÕES DO SITE) ====================== */
const ACTION_SOUND_URL = "som.mp3";
const actionSfx = new Audio(ACTION_SOUND_URL);
actionSfx.preload = "auto";
actionSfx.volume = 1.0;

/* ✅ SOM DO BATEPAPO (notificação) */
const CHAT_SOUND_URL = "somm.mp3"; // ✅ arquivo no GitHub na mesma pasta do site
const chatNotifySfx = new Audio(CHAT_SOUND_URL);
chatNotifySfx.preload = "auto";
chatNotifySfx.volume = 1.0;

let audioUnlocked = false;
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  try{
    actionSfx.muted = false;
    chatNotifySfx.muted = false;

    // "Destrava" em iOS/Android
    const p1 = actionSfx.play();
    if(p1 && p1.then){
      p1.then(()=>{ actionSfx.pause(); actionSfx.currentTime = 0; }).catch(()=>{});
    }else{
      actionSfx.pause(); actionSfx.currentTime = 0;
    }

    const p2 = chatNotifySfx.play();
    if(p2 && p2.then){
      p2.then(()=>{ chatNotifySfx.pause(); chatNotifySfx.currentTime = 0; }).catch(()=>{});
    }else{
      chatNotifySfx.pause(); chatNotifySfx.currentTime = 0;
    }
  }catch(e){}
}
document.addEventListener("touchstart", unlockAudioOnce, { once:true, passive:true });
document.addEventListener("click", unlockAudioOnce, { once:true });
document.addEventListener("pointerdown", unlockAudioOnce, { once:true });

function playActionSound(){
  if(!ACTION_SOUND_URL || ACTION_SOUND_URL.includes("COLE_AQUI")) return;
  try{
    actionSfx.pause();
    actionSfx.currentTime = 0;
    actionSfx.play().catch(()=>{});
  }catch(e){}
}
function playChatSound(){
  if(!CHAT_SOUND_URL) return;
  try{
    chatNotifySfx.pause();
    chatNotifySfx.currentTime = 0;
    chatNotifySfx.play().catch(()=>{});
  }catch(e){}
}

/* ====================== ✅ MESSENGER (abre batepapo + destrava áudio) ====================== */
const BATEPAPO_URL = "https://marcio2307.github.io/terreiro/batepapo.html";
const messengerDot = document.getElementById("messengerDot");
let dotTimer = null;

function showMessengerDotFor5s(){
  if(!messengerDot) return;
  messengerDot.style.display = "block";
  if(dotTimer) clearTimeout(dotTimer);
  dotTimer = setTimeout(()=>{ messengerDot.style.display = "none"; }, 5000);
}
function onOpenBatepapo(ev){
  // mantém o link, mas garante desbloqueio do áudio (mobile)
  unlockAudioOnce();
  // deixa seguir para o href normalmente
}

/* ====================== RADIO PLAYER (MENU) ====================== */
const RADIO_URL = "https://stream.zeno.fm/l8ocj9i6ka2uv";
let radio = null;
let radioPlaying = false;

function ensureRadio(){
  if(radio) return;
  radio = new Audio(RADIO_URL);
  radio.preload = "none";
  radio.crossOrigin = "anonymous";
  radio.volume = 1.0;

  radio.addEventListener("playing", ()=>{ setRadioUI(true); });
  radio.addEventListener("pause", ()=>{ setRadioUI(false); });
  radio.addEventListener("ended", ()=>{ setRadioUI(false); });
  radio.addEventListener("error", ()=>{ setRadioUI(false); });
}
function setRadioUI(isPlaying){
  radioPlaying = !!isPlaying;
  const icon = document.getElementById("radioIcon");
  if(!icon) return;
  icon.className = radioPlaying ? "fa-solid fa-pause" : "fa-solid fa-play";
}
function toggleRadio(){
  ensureRadio();
  unlockAudioOnce();
  if(!radioPlaying){
    radio.play().then(()=>setRadioUI(true)).catch(()=>setRadioUI(false));
  }else{
    try{ radio.pause(); }catch(e){}
    setRadioUI(false);
  }
}

/* ====================== LOGIN + UID persistente ====================== */
function getOrCreateUID(){
  let uid = localStorage.getItem("uid_passageiro");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem("uid_passageiro", uid);
  }
  sessionStorage.setItem("uid_passageiro", uid);
  return uid;
}
let UID = getOrCreateUID();

function getNomeSalvo(){
  return (localStorage.getItem("nome_passageiro") || "").trim();
}
let USER_NAME = getNomeSalvo();

const loginOverlay = document.getElementById("loginOverlay");
const loginName = document.getElementById("loginName");

function abrirLogin(){
  loginOverlay.style.display = "flex";
  document.body.style.overflow = "hidden";
  setTimeout(()=>{ try{ loginName.focus(); }catch(e){} }, 50);
}
function fecharLogin(){
  loginOverlay.style.display = "none";
  document.body.style.overflow = "";
}
function confirmarNome(){
  let nome = (loginName.value || "").trim();
  if(nome.length < 2){
    alert("Digite um nome com pelo menos 2 letras.");
    try{ loginName.focus(); }catch(e){}
    return;
  }
  localStorage.setItem("nome_passageiro", nome);
  USER_NAME = nome;
  UID = getOrCreateUID();
  fecharLogin();
  startPresence();
  setTimeout(()=>{ location.reload(); }, 80);
}
(function exigirLogin(){
  if(!USER_NAME) abrirLogin();
})();

function precisaLogin(){
  if(!USER_NAME){ abrirLogin(); return true; }
  return false;
}
document.addEventListener("keydown", (e)=>{
  if(loginOverlay.style.display === "flex" && e.key === "Enter"){ confirmarNome(); }
});

/* Helpers */
function escapeHTML(str){
  return (str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}

/* ====================== ✅ ABRIR PRÉVIA DO PERFIL ====================== */
const PREVIEW_URL = "https://marcio2307.github.io/terreiro/previa.html";
function abrirPrevia(uid){
  if(!uid) return;
  const back = encodeURIComponent(window.location.href);
  window.location.href = `${PREVIEW_URL}?uid=${encodeURIComponent(uid)}&back=${back}`;
}

/* limites */
const MAX_IMG_MB = 15;
const MAX_VID_MB = 120;
function checkSize(file){
  const mb = file.size/(1024*1024);
  if(file.type.startsWith("image/") && mb>MAX_IMG_MB){
    alert(`Imagem muito grande (${mb.toFixed(1)}MB). Envie até ${MAX_IMG_MB}MB.`);
    return false;
  }
  if(file.type.startsWith("video/") && mb>MAX_VID_MB){
    alert(`Vídeo muito grande (${mb.toFixed(1)}MB). Envie até ${MAX_VID_MB}MB.`);
    return false;
  }
  return true;
}

/* Loading */
const loadingOverlay = document.getElementById("loadingOverlay");
const loadingText = document.getElementById("loadingText");
const loadingSub  = document.getElementById("loadingSub");
function showLoading(title, sub){
  loadingText.textContent = title || "Enviando...";
  loadingSub.textContent = sub || "Aguarde um instante";
  loadingOverlay.style.display = "flex";
}
function hideLoading(){
  loadingOverlay.style.display = "none";
}

/* ====================== ✅ PRESENÇA ONLINE ====================== */
let presenceRef = null;
let presenceTimer = null;

function startPresence(){
  try{
    if(!USER_NAME || !UID) return;
    if(presenceTimer) return;

    presenceRef = DB.ref("presence/" + UID);

    const connectedRef = DB.ref(".info/connected");
    connectedRef.on("value", (snap)=>{
      if(snap.val() === true){
        presenceRef.onDisconnect().remove().catch(()=>{});
        presenceRef.set({
          uid: UID,
          userName: USER_NAME,
          online: true,
          onlineAt: firebase.database.ServerValue.TIMESTAMP,
          lastActive: firebase.database.ServerValue.TIMESTAMP
        }).catch(()=>{});
      }
    });

    presenceTimer = setInterval(()=>{
      if(!presenceRef) return;
      presenceRef.update({
        online: true,
        lastActive: firebase.database.ServerValue.TIMESTAMP
      }).catch(()=>{});
    }, 25000);

    window.addEventListener("beforeunload", ()=>{
      try{ stopPresence(true); }catch(e){}
    });
  }catch(e){}
}
function stopPresence(silent){
  try{
    if(presenceTimer){ clearInterval(presenceTimer); presenceTimer = null; }
    if(presenceRef){ presenceRef.remove().catch(()=>{}); presenceRef = null; }
  }catch(e){}
  if(!silent){}
}
if(USER_NAME && UID){ startPresence(); }
</script>

<script>
/* ===================== ✅ NOTIFICAÇÃO DO BATEPAPO (som + bolinha 5s) ===================== */
const ROOM_ID = "global";
const MSG_PATH = `groupChat/${ROOM_ID}/messages`;

const seenMsgIds = new Set();
let chatFirstLoadDone = false;

// ouvimos os últimos 200 (para montar o "primeiro carregamento") e depois só notificamos novas
DB.ref(MSG_PATH).orderByChild("createdAt").limitToLast(200).on("child_added", (snap)=>{
  const m = snap.val() || {};
  const id = m.id || snap.key;
  if(!id) return;

  if(seenMsgIds.has(id)) return;
  seenMsgIds.add(id);

  if(chatFirstLoadDone){
    // ✅ toca som + bolinha amarela 5s
    unlockAudioOnce();
    playChatSound();
    showMessengerDotFor5s();
  }else{
    // termina o "first load" depois de um curtinho
    clearTimeout(window.__chatFirstLoadTimer);
    window.__chatFirstLoadTimer = setTimeout(()=>{ chatFirstLoadDone = true; }, 900);
  }
});
</script>

<script>
/* ===================== PERFIS (avatar sincroniza com perfil.html) ===================== */
const profileCache = new Map();
function PROFILE_REF(uid){ return DB.ref("profiles/" + uid); }

async function getAvatarForUID(uid, fallbackName){
  if(!uid) return { url:"", name: fallbackName || "Usuário" };
  if(profileCache.has(uid)) return profileCache.get(uid);

  try{
    const snap = await PROFILE_REF(uid).once("value");
    const p = snap.val() || {};
    const name = p.name || fallbackName || "Usuário";
    const url = p.avatarDataUrl || p.avatarUrl || "";
    const obj = { url, name };
    profileCache.set(uid, obj);

    PROFILE_REF(uid).on("value", s=>{
      const px = s.val() || {};
      const nn = px.name || name;
      const uu = px.avatarDataUrl || px.avatarUrl || "";
      profileCache.set(uid, { url: uu, name: nn });
      updateAvatarsInDOM(uid, uu, nn);
      updateStoryAvatarsInDOM(uid, uu, nn);
      updateViewerAvatarsInDOM(uid, uu, nn);
    });

    return obj;
  }catch(e){
    const obj = { url:"", name: fallbackName || "Usuário" };
    profileCache.set(uid, obj);
    return obj;
  }
}

function updateAvatarsInDOM(uid, url, name){
  document.querySelectorAll(`[data-avatar-uid="${uid}"]`).forEach(el=>{
    if(url){
      el.innerHTML = `<img src="${url}" alt="avatar">`;
    }else{
      el.innerHTML = `<div class="init">${escapeHTML(initials(name||"U"))}</div>`;
    }
  });
  document.querySelectorAll(`[data-name-uid="${uid}"]`).forEach(el=>{
    el.textContent = name || "Usuário";
  });
}

function updateStoryAvatarsInDOM(uid, url, name){
  document.querySelectorAll(`[data-story-avatar-uid="${escapeHTML(uid)}"]`).forEach(el=>{
    if(url){
      el.innerHTML = `<img src="${url}" alt="avatar">`;
    }else{
      el.innerHTML = `<div class="avatarInitials">${escapeHTML(initials(name||"U"))}</div>`;
    }
  });
  document.querySelectorAll(`[data-story-name-uid="${escapeHTML(uid)}"]`).forEach(el=>{
    el.textContent = name || "Usuário";
  });
}

function updateViewerAvatarsInDOM(uid, url, name){
  document.querySelectorAll(`[data-viewer-avatar-uid="${escapeHTML(uid)}"]`).forEach(el=>{
    if(url){
      el.innerHTML = `<img src="${url}" alt="avatar">`;
    }else{
      el.textContent = escapeHTML(initials(name||"U"));
    }
  });
}
</script>

<script>
/* ===================== STORIES estilo Insta ===================== */
const menuTop = document.querySelector('.top-menu');

let allStories = [];
let groupedStories = [];
let activeStories = [];
let current = 0;
let viewerTimer = null;

let viewersPanelOpen = false;
let viewersRef = null;
let CAN_SEE_VIEWERS = false;

function renderCreateCard(){
  const card = document.createElement("div");
  card.className = "storyCard createCard";
  const inputId = "uploadStoryInput";
  card.innerHTML = `
    <div class="plusBtn">+</div>
    <div class="createLabel">Criar História</div>
    <input id="${inputId}" type="file" accept="image/*,video/*" style="display:none;">
  `;
  card.onclick = ()=>{
    if(precisaLogin()) return;
    document.getElementById(inputId).click();
  };
  setTimeout(()=>{
    const upload = document.getElementById(inputId);
    upload.onchange = e=>{
      if(precisaLogin()) return;
      const file = e.target.files[0];
      if(!file) return;
      if(!checkSize(file)) { upload.value=""; return; }
      addStory(file);
      upload.value = "";
    };
  }, 0);
  return card;
}

function buildSegRow(count){
  const max = Math.min(count, 12);
  return `
    <div class="segRow">
      ${Array.from({length:max}).map(()=>`<div class="seg"></div>`).join("")}
    </div>
  `;
}

function renderUserCard(group){
  const card = document.createElement("div");
  card.className = "storyCard";
  card.dataset.uid = group.uid;

  const cover = group.last;
  const uname = group.userName || "Usuário";
  const segs = buildSegRow(group.items.length);

  let mediaHTML = "";
  if((cover.type||"").includes("image")){
    mediaHTML = `<img class="storyMedia" src="${cover.url}" alt="story" loading="lazy">`;
  }else{
    mediaHTML = `
      <video class="storyMedia"
        src="${cover.url}"
        autoplay muted loop playsinline
        preload="metadata">
      </video>
    `;
  }

  const avatarHTML = `
    <div class="avatarCircle"
         data-story-avatar-uid="${escapeHTML(group.uid)}"
         onclick="event.stopPropagation(); abrirPrevia('${escapeHTML(group.uid)}')">
      <div class="avatarInitials">${escapeHTML(initials(uname))}</div>
    </div>
  `;

  card.innerHTML = `
    ${mediaHTML}
    <div class="storyShade"></div>
    ${segs}
    ${avatarHTML}
    <div class="storyName" data-story-name-uid="${escapeHTML(group.uid)}">${escapeHTML(uname)}</div>
  `;

  getAvatarForUID(group.uid, uname).then(({url, name})=>{
    updateStoryAvatarsInDOM(group.uid, url, name);
  });

  card.onclick = ()=>{
    if(group.items.length === 0) return;
    activeStories = group.items.slice().sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
    openViewer(0);
  };

  return card;
}

function renderStoriesRow(){
  const row = document.getElementById("storiesRow");
  row.innerHTML = "";

  row.appendChild(renderCreateCard());

  const myGroup = groupedStories.find(g => g.uid === UID);
  if(myGroup) row.appendChild(renderUserCard(myGroup));

  groupedStories
    .filter(g => g.uid !== UID)
    .sort((a,b)=>(b.last?.createdAt||0)-(a.last?.createdAt||0))
    .forEach(g => row.appendChild(renderUserCard(g)));
}

async function addStory(file){
  if(precisaLogin()) return;
  try{
    showLoading("Enviando story...", "Seu vídeo/foto vai aparecer já já");
    const storyId = "story_" + Date.now() + "_" + Math.random().toString(36).slice(2);
    const path = `stories/${UID}/${storyId}`;
    const ref = ST.ref().child(path);

    await ref.put(file, { contentType: file.type });
    const url = await ref.getDownloadURL();

    const data = {
      url,
      type: file.type,
      uid: UID,
      userName: USER_NAME,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      storagePath: path
    };

    await DB.ref("stories/" + storyId).set(data);
    playActionSound();
  }catch(err){
    console.log(err);
    alert("Erro ao enviar story.");
  }finally{
    hideLoading();
  }
}

/* ===================== ✅ QUEM VIU (com nome + foto) ===================== */
function closeViewersPanel(){
  viewersPanelOpen = false;
  viewersPanel.style.display = "none";
  const ch = document.getElementById("seenChevron");
  if(ch) ch.className = "fa-solid fa-chevron-up";
}
function toggleViewersPanel(){
  if(!CAN_SEE_VIEWERS) return;
  viewersPanelOpen = !viewersPanelOpen;
  viewersPanel.style.display = viewersPanelOpen ? "block" : "none";
  const ch = document.getElementById("seenChevron");
  if(ch) ch.className = viewersPanelOpen ? "fa-solid fa-chevron-down" : "fa-solid fa-chevron-up";
}
function detachViewersListener(){
  try{
    if(viewersRef){
      viewersRef.off();
      viewersRef = null;
    }
  }catch(e){}
}
async function updateViewersUI(viewsObj){
  const obj = viewsObj || {};
  const arr = Object.keys(obj).map(uid=>obj[uid]).filter(Boolean);
  arr.sort((a,b)=>(a.viewedAt||0)-(b.viewedAt||0));
  const total = arr.length;

  if(total === 0){
    seenText.textContent = "Ninguém viu ainda";
    viewersPanel.innerHTML = `<div style="padding:10px;opacity:.9;">Ninguém viu ainda.</div>`;
    return;
  }

  const first = arr[0]?.userName || "Alguém";
  if(total === 1) seenText.textContent = `${first} viu este story`;
  else seenText.textContent = `${first} e mais ${total-1} viram este story`;

  const rows = await Promise.all(arr.map(async v=>{
    const nome = (v.userName || "Usuário");
    const quando = v.viewedAt ? fmtDate(v.viewedAt) : "";
    const prof = await getAvatarForUID(v.uid, nome);
    const ava = prof.url
      ? `<div style="width:34px;height:34px;border-radius:50%;overflow:hidden;border:1px solid rgba(0,255,140,.25);flex:0 0 auto;cursor:pointer;"
              onclick="abrirPrevia('${escapeHTML(v.uid)}')">
           <img src="${prof.url}" style="width:100%;height:100%;object-fit:cover;display:block;" alt="avatar">
         </div>`
      : `<div style="width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid rgba(0,255,140,.25);color:#00ff8c;font-weight:900;flex:0 0 auto;cursor:pointer;"
              onclick="abrirPrevia('${escapeHTML(v.uid)}')">
           ${escapeHTML(initials(nome))}
         </div>`;

    return `
      <div class="viewerRow">
        <div style="display:flex;align-items:center;gap:10px;min-width:0;">
          ${ava}
          <div class="viewerName" style="max-width: 58vw;">${escapeHTML(nome)}</div>
        </div>
        <div class="viewerTime">${escapeHTML(quando)}</div>
      </div>
    `;
  }));

  viewersPanel.innerHTML = rows.join("");
}
async function markStoryView(story){
  try{
    if(!story || !story.id) return;
    if(precisaLogin()) return;
    if(story.uid === UID) return;
    await DB.ref(`storyViews/${story.id}/${UID}`).set({
      uid: UID,
      userName: USER_NAME,
      viewedAt: firebase.database.ServerValue.TIMESTAMP
    });
  }catch(e){}
}
function attachViewersListener(story){
  detachViewersListener();
  closeViewersPanel();
  viewersPanel.innerHTML = "";
  seenText.textContent = "Carregando visualizações...";
  if(!story || !story.id) return;

  viewersRef = DB.ref(`storyViews/${story.id}`);
  viewersRef.on("value", snap=>{
    updateViewersUI(snap.val() || {});
  });
}

/* VIEWER */
function openViewer(idx){
  current = idx;
  viewer.style.display = "flex";
  menuTop.classList.add("hide");
  showStory();
}
function closeViewer(){
  stopVideo();
  viewer.style.display = "none";
  deleteBtn.style.display = "none";
  menuTop.classList.remove("hide");
  clearTimeout(viewerTimer);
  viewerTimer = null;

  detachViewersListener();
  closeViewersPanel();
}
function showStory(){
  clearTimeout(viewerTimer);
  viewerTimer = null;

  viewerMedia.innerHTML = "";
  bars.innerHTML = "";

  const total = activeStories.length;
  for(let i=0;i<total;i++){
    const bar = document.createElement("div");
    bar.className = "bar";
    const fill = document.createElement("div");
    fill.className = "barFill";
    bar.appendChild(fill);
    bars.appendChild(bar);
    if(i<current) fill.style.width="100%";
    if(i===current) fill.id="currentFill";
  }

  const s = activeStories[current];
  if(!s){ closeViewer(); return; }

  deleteBtn.style.display = "none";

  CAN_SEE_VIEWERS = (s.uid === UID);
  if(CAN_SEE_VIEWERS){
    viewerFooter.style.display = "block";
    attachViewersListener(s);
  }else{
    viewerFooter.style.display = "none";
    detachViewersListener();
    closeViewersPanel();
  }

  markStoryView(s);

  if((s.type||"").includes("image")){
    const el = document.createElement("img");
    el.src = s.url;
    viewerMedia.appendChild(el);
    runProgress(120000);
    viewerTimer = setTimeout(()=>nextStory(), 120000);
  }else{
    const el = document.createElement("video");
    el.src = s.url;
    el.autoplay = true;
    el.muted = false;
    el.volume = 1;
    el.controls = true;
    el.playsInline = true;
    el.preload = "metadata";

    el.onloadedmetadata = ()=>{
      const realDur = (el.duration||0)*1000;
      const dur = Math.min(realDur||6000, 120000);
      runProgress(dur);
      viewerTimer = setTimeout(()=>nextStory(), dur);
    };

    viewerMedia.appendChild(el);
    el.play().catch(()=>{});
  }
}
function runProgress(ms){
  const fill = document.getElementById("currentFill");
  if(!fill) return;
  fill.style.transition="none";
  fill.style.width="0";
  setTimeout(()=>{
    fill.style.transition = `width ${ms}ms linear`;
    fill.style.width="100%";
  }, 40);
}
function stopVideo(){
  const vid = viewerMedia.querySelector("video");
  if(vid){
    try{ vid.pause(); }catch(e){}
    try{ vid.currentTime = 0; }catch(e){}
    try{ vid.src = ""; }catch(e){}
  }
}
function nextStory(){
  stopVideo();
  current++;
  if(current >= activeStories.length) closeViewer();
  else showStory();
}
function prevStory(){
  if(current<=0) return;
  stopVideo();
  current--;
  showStory();
}
tapRight.onclick = nextStory;
tapLeft.onclick = prevStory;

dots.onclick = ()=>{ deleteBtn.style.display = (deleteBtn.style.display==="block" ? "none" : "block"); };
deleteBtn.onclick = async ()=>{
  const s = activeStories[current];
  if(!s) return;
  try{
    stopVideo();
    await DB.ref("stories/" + s.id).remove();
    await DB.ref("storyViews/" + s.id).remove().catch(()=>{});
    if(s.storagePath){
      await ST.ref().child(s.storagePath).delete().catch(()=>{});
    }
    playActionSound();
    if(current>0) current--;
    closeViewer();
  }catch(err){
    console.log(err);
    alert("Erro ao excluir story.");
  }
};

(function listenStories(){
  const ref = DB.ref("stories").orderByChild("createdAt").limitToLast(500);
  ref.on("value", snap=>{
    const obj = snap.val() || {};
    allStories = Object.keys(obj).map(id=>({id, ...obj[id]}))
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    const map = {};
    allStories.forEach(s=>{
      if(!s.uid) return;
      if(!map[s.uid]) map[s.uid] = { uid:s.uid, userName:s.userName||"Usuário", items:[] };
      map[s.uid].items.push(s);
      map[s.uid].userName = s.userName || map[s.uid].userName;
    });

    groupedStories = Object.values(map).map(g=>{
      const items = g.items.slice().sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
      return { uid:g.uid, userName:g.userName, items, last: items[items.length-1] };
    });

    renderStoriesRow();
  });
})();
</script>

<script>
/* ===================== FEED / MURAL ===================== */
let selectedFile = null;
let mode = "add";
let longPress = {};
let holdTimer = null;

const postsCache = new Set();
let renderQueue = [];
let pumping = false;

function updateButton(){
  let t = postText.value.trim();
  if(t.length > 0){
    btnMain.className = "whatsapp-send";
    btnMain.innerHTML = "➤";
    mode = "postar";
  } else {
    btnMain.className = "add-btn";
    btnMain.innerHTML = "+";
    mode = "add";
  }
}
function buttonAction(){
  if(precisaLogin()) return;
  mode === "add" ? fileInput.click() : postarTexto();
}

let previewUrlToRevoke = null;

fileInput.onchange = e=>{
  if(precisaLogin()) return;
  selectedFile = e.target.files[0];
  if(!selectedFile) return;
  if(!checkSize(selectedFile)){ selectedFile=null; fileInput.value=""; return; }

  if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
  const url = URL.createObjectURL(selectedFile);
  previewUrlToRevoke = url;

  previewContent.innerHTML =
    selectedFile.type.startsWith("image/")
      ? `<img src="${url}" style="width:100%;border-radius:10px;display:block;" loading="lazy">`
      : `<video src="${url}" controls preload="metadata" playsinline style="width:100%;border-radius:10px;background:#000;display:block;"></video>`;
  previewBox.style.display = "block";
};

async function postarTexto(){
  if(precisaLogin()) return;
  const t = postText.value.trim();
  if(!t) return;
  showLoading("Postando...", "Publicando no mural");
  try{
    await criarPostFirebase(t, null, null, null);
    playActionSound();
    postText.value = "";
    updateButton();
  }finally{
    hideLoading();
  }
}

async function postar(){
  if(precisaLogin()) return;
  if(!selectedFile){
    alert("Selecione uma mídia primeiro.");
    return;
  }

  const texto = postText.value || "";
  const file = selectedFile;

  const postId = "post_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  const localUrl = URL.createObjectURL(file);

  criarPostOptimista(postId, {
    text: texto,
    mediaUrl: localUrl,
    mediaType: file.type,
    uid: UID,
    userName: USER_NAME,
    createdAt: Date.now(),
    _pending: true
  });

  showLoading("Enviando mídia...", "No celular pode demorar um pouco dependendo da internet");

  try{
    await criarPostFirebase(texto, file, file.type, postId);
    playActionSound();
  }catch(err){
    console.log(err);
    alert("Erro ao postar.");
    const el = document.getElementById(postId);
    if(el) el.remove();
    postsCache.delete(postId);
  }finally{
    hideLoading();

    selectedFile = null;
    postText.value = "";
    previewBox.style.display = "none";
    previewContent.innerHTML = "";
    if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
    updateButton();
  }
}

function removerPreview(){
  selectedFile = null;
  previewBox.style.display = "none";
  previewContent.innerHTML = "";
  if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
}

async function criarPostFirebase(texto, fileOrNull, fileTypeOrNull, forcedPostId){
  const postId = forcedPostId || ("post_" + Date.now() + "_" + Math.random().toString(36).slice(2));
  let mediaUrl = null;
  let mediaType = null;
  let storagePath = null;

  if(fileOrNull){
    mediaType = fileTypeOrNull || fileOrNull.type || "";
    storagePath = `posts/${UID}/${postId}`;
    const ref = ST.ref().child(storagePath);
    await ref.put(fileOrNull, { contentType: mediaType });
    mediaUrl = await ref.getDownloadURL();
  }

  const data = {
    text: (texto || "").toString(),
    mediaUrl,
    mediaType,
    uid: UID,
    userName: USER_NAME,
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    storagePath
  };

  await DB.ref("posts/" + postId).set(data);
  return postId;
}

function pressionarCurtir(id){
  longPress[id] = false;
  holdTimer = setTimeout(()=>{
    longPress[id] = true;
    amei(id);
  }, 500);
}
function soltarCurtir(){
  if(holdTimer) clearTimeout(holdTimer);
}

async function curtir(id){
  if(precisaLogin()) return;
  if(longPress[id]){ longPress[id] = false; return; }
  const likeRef = DB.ref(`likes/${id}/${UID}`);
  const snap = await likeRef.once("value");
  const cur = snap.val();
  if(cur) await likeRef.remove();
  else await likeRef.set({ type:"like", uid:UID, userName:USER_NAME, createdAt: firebase.database.ServerValue.TIMESTAMP });
  playActionSound();
}
async function amei(id){
  if(precisaLogin()) return;
  const likeRef = DB.ref(`likes/${id}/${UID}`);
  const snap = await likeRef.once("value");
  const cur = snap.val();
  if(cur && cur.type === "love") await likeRef.remove();
  else await likeRef.set({ type:"love", uid:UID, userName:USER_NAME, createdAt: firebase.database.ServerValue.TIMESTAMP });
  playActionSound();
}

function atualizarCurtidasUI(postId, likesObj){
  const btn = document.getElementById("curtir_"+postId);
  const cont = document.getElementById("contadorCurtidas_"+postId);
  if(!btn || !cont) return;

  const likes = likesObj || {};
  const entries = Object.values(likes);
  const total = entries.length;
  const my = likes[UID];

  if(my){
    if(my.type === "love"){
      btn.textContent = "❤️ Você amou";
      btn.style.color = "#ff008c";
    }else{
      btn.textContent = "👍 Você curtiu";
      btn.style.color = "#00ff9d";
    }
  }else{
    btn.textContent = "👍 Curtir";
    btn.style.color = "#00ff9d";
  }

  if(total === 0){ cont.innerHTML = ""; return; }

  const sorted = entries.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
  const nomes = sorted.map(x => (x.uid === UID ? "Você" : escapeHTML(x.userName || "Usuário")));
  cont.innerHTML = `Curtidas (${total}): <b>${nomes.join(", ")}</b>`;
}

/* ✅✅✅ TOGGLE COMENTÁRIOS: 1 clique abre, 2º clique fecha */
const commentCloseHandlers = {};
function fecharComentarios(id){
  const box = document.getElementById("comentarios_"+id);
  if(!box) return;
  box.style.display = "none";
  if(commentCloseHandlers[id]){
    document.removeEventListener("click", commentCloseHandlers[id]);
    delete commentCloseHandlers[id];
  }
}
function abrirComentarios(id){
  const box = document.getElementById("comentarios_"+id);
  if(!box) return;

  if(box.style.display === "block"){
    fecharComentarios(id);
    return;
  }

  box.style.display = "block";

  if(commentCloseHandlers[id]){
    document.removeEventListener("click", commentCloseHandlers[id]);
    delete commentCloseHandlers[id];
  }

  const handler = (e)=>{
    const insideBox = box.contains(e.target);
    const clickedButton = e.target.closest(".btn-action");
    const clickedMenu = e.target.closest(".coment-menu-btn") || e.target.closest(".coment-menu-box");
    if(!insideBox && !clickedButton && !clickedMenu){
      fecharComentarios(id);
    }
  };
  commentCloseHandlers[id] = handler;

  setTimeout(()=> document.addEventListener("click", handler), 50);
}

async function enviarComentario(id){
  if(precisaLogin()) return;
  const input = document.getElementById("comentarioInput_"+id);
  if(!input) return;
  const texto = input.value.trim();
  if(!texto) return;

  const commentId = "cmt_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  await DB.ref(`comments/${id}/${commentId}`).set({
    uid: UID,
    userName: USER_NAME,
    text: texto,
    createdAt: firebase.database.ServerValue.TIMESTAMP
  });
  input.value = "";
  playActionSound();
}

function toggleComentMenu(cid){
  const menu = document.getElementById("menu_"+cid);
  if(!menu) return;
  menu.style.display = (menu.style.display==="block" ? "none" : "block");
}

async function excluirComentario(cid, postId){
  await DB.ref(`comments/${postId}/${cid}`).remove();
  playActionSound();
}

function toggleMenu(id){
  let m = document.getElementById("menu_"+id);
  if(!m) return;
  m.style.display = (m.style.display==="block" ? "none" : "block");
}

async function excluirPost(id){
  const snap = await DB.ref("posts/" + id).once("value");
  const data = snap.val();

  await DB.ref("posts/" + id).remove();
  await DB.ref("likes/" + id).remove().catch(()=>{});
  await DB.ref("comments/" + id).remove().catch(()=>{});

  if(data && data.storagePath){
    await ST.ref().child(data.storagePath).delete().catch(()=>{});
  }

  const el = document.getElementById(id);
  if(el) el.remove();
  postsCache.delete(id);
  playActionSound();
}

/* ✅ post HTML: avatar e nome abrem a PRÉVIA DO DONO DO POST */
function postHTML(id, postData, avatarUrl){
  let midia = "";
  if(postData.mediaUrl){
    const isImg = (postData.mediaType || "").startsWith("image/");
    midia = isImg
      ? `<img src="${postData.mediaUrl}" loading="lazy">`
      : `<video src="${postData.mediaUrl}" controls preload="metadata" playsinline></video>`;
  }

  const texto = escapeHTML(postData.text || "");
  const when = postData.createdAt ? fmtDate(postData.createdAt) : "";
  const pending = postData._pending ? `<span class="pendingBadge">ENVIANDO…</span>` : "";

  const uid = postData.uid || "";
  const uname = postData.userName || "Usuário";

  const avatarHTML = `
    <div class="postAvatar" data-avatar-uid="${escapeHTML(uid)}" onclick="abrirPrevia('${escapeHTML(uid)}')">
      ${avatarUrl
        ? `<img src="${avatarUrl}" alt="avatar">`
        : `<div class="init">${escapeHTML(initials(uname))}</div>`}
    </div>
  `;

  return `
  <div class="post" id="${id}" ${postData._pending ? 'data-pending="1"' : ''}>
    <div class="menu-btn" onclick="toggleMenu('${id}')">⋮</div>
    <div class="menu-box" id="menu_${id}">
      <div onclick="excluirPost('${id}')">Excluir</div>
    </div>

    <div class="postHead">
      ${avatarHTML}
      <div class="postHeadText">
        <div class="postNameLine">
          <div class="postName" data-name-uid="${escapeHTML(uid)}" onclick="abrirPrevia('${escapeHTML(uid)}')">${escapeHTML(uname)}</div>
          ${pending}
        </div>
        <div class="postWhen">${escapeHTML(when)}</div>
      </div>
    </div>

    <p style="margin:12px 0 0 0;">${texto}</p>

    <div class="mediaWrap" id="mediaWrap_${id}">
      ${midia}
    </div>

    <div class="post-actions">
      <div style="text-align:center; min-width:160px;">
        <div class="btn-action"
          id="curtir_${id}"
          onmousedown="pressionarCurtir('${id}')"
          onmouseup="soltarCurtir()"
          ontouchstart="pressionarCurtir('${id}')"
          ontouchend="soltarCurtir()"
          onclick="curtir('${id}')">
          👍 Curtir
        </div>
        <div class="contador" id="contadorCurtidas_${id}"></div>
      </div>

      <div style="text-align:center; min-width:160px;">
        <div class="btn-action" onclick="abrirComentarios('${id}')">💬 Comentar</div>
        <div class="contador" id="contadorComentarios_${id}"></div>
      </div>
    </div>

    <div class="coment-area" id="comentarios_${id}">
      <div id="listaComentarios_${id}" style="margin-bottom:15px;"></div>

      <input type="text" id="comentarioInput_${id}"
        placeholder="Escreva um comentário..."
        style="width:100%;padding:10px;border-radius:8px;border:1px solid #00ff9d;background:#000;color:#fff;">

      <button onclick="enviarComentario('${id}')"
        style="margin-top:8px;background:#00ff9d;border:none;padding:8px 15px;border-radius:8px;cursor:pointer;">
        Enviar
      </button>
    </div>
  </div>
  `;
}

function criarPostOptimista(id, postData){
  if(postsCache.has(id)) return;
  postsCache.add(id);
  longPress[id] = false;

  const feed = document.getElementById("feed");
  const temp = document.createElement("div");

  const uid = postData.uid || "";
  getAvatarForUID(uid, postData.userName || "Usuário").then(({url, name})=>{
    temp.innerHTML = postHTML(id, postData, url).trim();
    feed.prepend(temp.firstChild);
    listenLikes(id);
    listenComments(id);
    updateAvatarsInDOM(uid, url, name);
  });
}

function atualizarPostDoServidor(id, data){
  const el = document.getElementById(id);
  if(!el) return;

  const nameEl = el.querySelector(`[data-name-uid]`);
  if(nameEl) nameEl.textContent = data.userName || "Usuário";

  const whenEl = el.querySelector(".postWhen");
  if(whenEl && data.createdAt) whenEl.textContent = fmtDate(data.createdAt);

  const p = el.querySelector("p");
  if(p) p.textContent = (data.text || "");

  const wrap = document.getElementById("mediaWrap_"+id);
  if(wrap){
    if(data.mediaUrl){
      const isImg = (data.mediaType||"").startsWith("image/");
      wrap.innerHTML = isImg
        ? `<img src="${data.mediaUrl}" loading="lazy">`
        : `<video src="${data.mediaUrl}" controls preload="metadata" playsinline></video>`;
    }else{
      wrap.innerHTML = "";
    }
  }

  el.removeAttribute("data-pending");
}

function listenLikes(postId){
  DB.ref("likes/" + postId).on("value", snap=>{
    atualizarCurtidasUI(postId, snap.val() || {});
  });
}

function listenComments(postId){
  DB.ref("comments/" + postId).orderByChild("createdAt").on("value", async snap=>{
    const lista = document.getElementById("listaComentarios_"+postId);
    const contador = document.getElementById("contadorComentarios_"+postId);
    if(!lista || !contador) return;

    const obj = snap.val() || {};
    const arr = Object.keys(obj).map(cid=>({ cid, ...obj[cid] }))
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    const htmls = await Promise.all(arr.map(async c=>{
      const nome = (c.userName || "Usuário");
      const txt = escapeHTML(c.text || "");
      const prof = await getAvatarForUID(c.uid, nome);

      const ava = prof.url
        ? `<div class="cAvatar" data-avatar-uid="${escapeHTML(c.uid)}" onclick="abrirPrevia('${escapeHTML(c.uid)}')"><img src="${prof.url}" alt="avatar"></div>`
        : `<div class="cAvatar" data-avatar-uid="${escapeHTML(c.uid)}" onclick="abrirPrevia('${escapeHTML(c.uid)}')"><div class="init">${escapeHTML(initials(nome))}</div></div>`;

      return `
        <div id="${c.cid}" class="cRow">
          <div class="cHead">
            ${ava}
            <div class="cName" data-name-uid="${escapeHTML(c.uid)}" onclick="abrirPrevia('${escapeHTML(c.uid)}')">${escapeHTML(nome)}</div>
          </div>
          <div class="cText">💬 ${txt}</div>

          <span class="coment-menu-btn" onclick="toggleComentMenu('${c.cid}')">⋮</span>
          <div class="coment-menu-box" id="menu_${c.cid}"
            onclick="excluirComentario('${c.cid}','${postId}')">
            Excluir
          </div>
        </div>
      `;
    }));

    lista.innerHTML = htmls.join("");

    const total = arr.length;
    if(total === 0) contador.innerHTML = "";
    else if(total === 1) contador.innerHTML = "1 comentário";
    else contador.innerHTML = `${total} comentários`;
  });
}

(function listenPostsFast(){
  const ref = DB.ref("posts").orderByChild("createdAt").limitToLast(200);

  ref.on("child_added", async snap=>{
    const id = snap.key;
    const data = snap.val() || {};

    const existing = document.getElementById(id);
    if(existing){
      atualizarPostDoServidor(id, data);
      const prof = await getAvatarForUID(data.uid, data.userName);
      updateAvatarsInDOM(data.uid, prof.url, prof.name);
      return;
    }

    if(postsCache.has(id)) return;
    renderQueue.push({ id, data });
    pumpRenderQueue();
  });

  ref.on("child_removed", snap=>{
    const id = snap.key;
    postsCache.delete(id);
    const el = document.getElementById(id);
    if(el) el.remove();
  });
})();

function pumpRenderQueue(){
  if(pumping) return;
  pumping = true;

  const step = async ()=>{
    let n = 0;
    while(renderQueue.length && n < 6){
      const it = renderQueue.shift();
      if(!postsCache.has(it.id)){
        postsCache.add(it.id);

        const prof = await getAvatarForUID(it.data.uid, it.data.userName || "Usuário");

        const feed = document.getElementById("feed");
        const temp = document.createElement("div");
        temp.innerHTML = postHTML(it.id, it.data, prof.url).trim();
        feed.prepend(temp.firstChild);

        listenLikes(it.id);
        listenComments(it.id);

        updateAvatarsInDOM(it.data.uid, prof.url, prof.name);
      }
      n++;
    }
    if(renderQueue.length){
      requestAnimationFrame(()=>step());
    }else{
      pumping = false;
    }
  };
  requestAnimationFrame(()=>step());
}

updateButton();
</script>

</body>
</html>
