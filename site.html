<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mural Neon ‚Äì Social</title>

<!-- √çcones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Google Login -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- ================== FIREBASE CONFIG ================== -->
<script type="module">
import { initializeApp } 
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

window.firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.firebasestorage.app",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

window.app = initializeApp(window.firebaseConfig);
</script>

<!-- ================== ESTILO BASE (RESTANTE NA PARTE 2) ================== -->
<style>
body {
    margin: 0;
    background: #000;
    color: white;
    font-family: Arial, sans-serif;
    overflow-x: hidden;
}

/* TELA DE LOGIN */
#loginBox {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 999999;
}

#loginBox img {
    height: 150px;
    margin-bottom: 30px;
}

.google-btn {
    width: 260px;
}

/* MENU NEON */
.top-menu {
    width: 100%;
    background: #0d0d0d;
    padding: 18px 0;
    display: flex;
    justify-content: center;
    gap: 50px;
    align-items: center;
    border-bottom: 2px solid #00ff8c;
    box-shadow: 0 0 15px #00ff8c;
    position: sticky;
    top: 0;
    z-index: 9999;
}

.top-menu a {
    color: #00ff8c;
    text-decoration: none;
    font-size: 22px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.3s;
    text-shadow: 0 0 10px #00ff8c;
}

.top-menu a:hover {
    transform: scale(1.12);
}

@media(max-width:480px){
    .top-menu { gap: 25px; padding: 15px 0; }
    .top-menu a { font-size: 16px; }
}
</style>

</head>
<body>

<!-- ========================= LOGIN GOOGLE ========================= -->
<div id="loginBox">
    <img src="https://i.ibb.co/r28TNTmK/5c081edd-21e9-48fb-9a91-834cfdd112fc-removebg-preview.png">
    <div id="googleLogin" class="google-btn"></div>
</div>

<!-- ========================= MENU NEON ========================= -->
<nav class="top-menu">
    <a href="https://marcio2307.github.io/chatterreiro/chatterreiro.html">
        <i class="fa-solid fa-comments"></i> BATE PAPO
    </a>

    <a href="https://marcio2307.github.io/terreiro/estudo.html">
        <i class="fa-solid fa-book"></i> ESTUDO
    </a>

    <a href="https://marcio2307.github.io/terreiro/sala.html">
        <i class="fa-solid fa-video"></i> REUNI√ÉO ONLINE
    </a>

    <a href="#" onclick="logoutGoogle()">
        <i class="fa-solid fa-right-from-bracket"></i> SAIR
    </a>
</nav>

<!-- FOTO + NOME DO USU√ÅRIO -->
<div id="userHeader" style="text-align:center; margin-top:15px; display:none;">
    <img id="userPhoto" 
         style="width:95px;height:95px;border-radius:50%;border:3px solid #00ff8c;object-fit:cover;">
    <div id="userName" 
         style="margin-top:10px;font-size:1.2rem;color:#00ff8c;font-weight:bold;"></div>
</div>
<style>

/* ==============================
      BASE GERAL
============================== */

html, body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
}

/* ==============================
      MENU NEON (j√° iniciado na parte 1)
============================== */
.top-menu a i {
    font-size: 22px;
    text-shadow: 
        0 0 10px #00ff8c,
        0 0 20px #00ff8c;
}

/* ==============================
      √ÅREA DA FOTO E NOME DO USU√ÅRIO
============================== */

#userHeader img:hover {
    transform: scale(1.05);
    transition: 0.3s;
}

/* ==============================
      STORIES ‚Äî LAYOUT PRINCIPAL
============================== */

.stories-wrapper {
    padding: 15px 10px 5px 10px;
}

.stories-row {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 10px;
}

.stories-row::-webkit-scrollbar {
    height: 5px;
}
.stories-row::-webkit-scrollbar-thumb {
    background: #00ff8c;
    border-radius: 10px;
}

/* CARD (tamanho padr√£o) */
.story-card {
    width: 95px;
    height: 150px;
    background: #141414;
    border-radius: 15px;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #00ff8c;
    box-shadow: 0 0 12px #00ff8c;
    cursor: pointer;
    flex-shrink: 0;
    position: relative;
    transition: .3s;
}

.story-card:hover {
    transform: scale(1.03);
}

/* CRIAR STORY */
.create-story-btn {
    width: 55px;
    height: 55px;
    background: #00ff8c;
    border-radius: 50%;
    font-size: 36px;
    font-weight: bold;
    color: #003b23;
    border: 4px solid #000;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 
        0 0 15px #00ff8c,
        0 0 35px #00ff8c inset;
}

/* THUMB DA M√çDIA */
.story-card img,
.story-card video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Segunda bolinha = SEUS STORIES */
.meus-stories-borda {
    border: 3px solid #ffaa00 !important;
    box-shadow: 0 0 25px #ffaa00 !important;
}

/* ==============================
      VIEWER DOS STORIES
============================== */

#viewer {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    display: none;
    z-index: 999999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

#viewerMedia img,
#viewerMedia video {
    max-width: 92%;
    max-height: 82%;
    border-radius: 15px;
}

/* Barras superiores */
.topBars {
    position: absolute;
    top: 15px;
    left: 0;
    width: 100%;
    display: flex;
    gap: 6px;
    padding: 0 15px;
}

.bar {
    flex: 1;
    height: 4px;
    background: rgba(255,255,255,0.3);
    border-radius: 3px;
    overflow: hidden;
}
.barFill {
    height: 100%;
    width: 0%;
    background: #00ff8c;
    box-shadow: 0 0 12px #00ff8c;
    transition: width linear;
}

/* 3 pontinhos */
#dots {
    position: absolute;
    top: 15px;
    right: 25px;
    font-size: 36px;
    cursor: pointer;
    z-index: 20;
}

/* Bot√£o excluir */
#deleteBtn {
    position: absolute;
    top: 65px;
    right: 25px;
    background: #00ff8c;
    padding: 10px 14px;
    border-radius: 10px;
    color: #000;
    font-weight: bold;
    display: none;
    cursor: pointer;
    z-index: 20;
}

/* ==============================
      MODAL DE CRIA√á√ÉO DE STORY
============================== */

#storyModal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    display: none;
    z-index: 99999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

#storyModal textarea {
    width: 80%;
    max-width: 300px;
    height: 80px;
    border-radius: 10px;
    background: #121212;
    border: 2px solid #00ff8c;
    padding: 12px;
    color: #fff;
    outline: none;
}

/* ==============================
      FEED ‚Äî √ÅREA DE POSTAGEM
============================== */

.create-post {
    background:#0d0d0d;
    margin:15px;
    padding:15px;
    border-radius:20px;
    border:1px solid #00ff9d;
    display:flex;
    gap:10px;
    align-items:center;
    box-shadow:0 0 12px #00ff9d;
    position: relative;
}

/* INPUT DE TEXTO */
.input-box {
    flex:1;
    background:#111;
    padding:12px 20px;
    border-radius:30px;
    color:#fff;
    border:1px solid #00ff9d;
    outline:none;
    font-size:16px;
    box-shadow: inset 0 0 12px #00ff9d;
}

/* BOT√ÉO + (galeria) */
.add-btn {
    background:#111;
    border:2px solid #00ff9d;
    color:#00ff9d;
    width:45px;
    height:45px;
    border-radius:50%;
    font-size:26px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow:0 0 15px #00ff9d;
    transition: .2s;
}

.add-btn:hover { transform: scale(1.1); }

/* BOT√ÉO ENVIAR (WHATSAPP STYLE) */
.send-btn {
    width:45px;
    height:45px;
    background:#00ff9d;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#003b23;
    font-size:26px;
    font-weight:bold;
    cursor:pointer;
    border:2px solid #004d34;
    box-shadow: 0 0 15px #00ff9d;
}

/* ==============================
      FEED ‚Äî PR√âVIA DA M√çDIA
============================== */

.preview {
    margin:10px 15px;
    padding:15px;
    background:#0d0d0d;
    border:1px solid #00ff9d;
    border-radius:15px;
    box-shadow:0 0 12px #00ff9d;
    display:none;
}

.preview img,
.preview video {
    width:100%;
    border-radius:12px;
}

/* ==============================
      FEED ‚Äî POSTS
============================== */

.post {
    background:#0d0d0d;
    margin:15px;
    padding:15px;
    border-radius:15px;
    border:1px solid #00ff9d;
    box-shadow:0 0 12px #00ff9d;
    position:relative;
}

.post img,
.post video {
    width:100%;
    border-radius:12px;
    margin-top:10px;
}

/* MENU DO POST (3 pontinhos) */
.menu-btn {
    position:absolute;
    top:10px;
    right:10px;
    font-size:28px;
    color:#00ff9d;
    cursor:pointer;
    z-index:10;
}

.menu-box {
    position:absolute;
    top:45px;
    right:10px;
    background:#00ff9d;
    color:#000;
    border-radius:10px;
    padding:8px 12px;
    display:none;
    font-weight:bold;
    cursor:pointer;
}

/* A√á√ïES DO POST */
.post-actions {
    margin-top:15px;
    display:flex;
    justify-content:space-around;
}

.btn-action {
    color:#00ff9d;
    font-size:16px;
    padding:8px 12px;
    cursor:pointer;
    border-radius:10px;
    font-weight:bold;
}

/* CONTADORES */
.contador {
    margin-top:8px;
    text-align:center;
    color:#00ff9d;
    font-size:14px;
}

/* COMENT√ÅRIOS */
.coment-area {
    background:#111;
    padding:12px;
    margin-top:15px;
    border-radius:12px;
    display:none;
}

.coment-area textarea {
    width:100%;
    background:#000;
    border:1px solid #00ff9d;
    color:#fff;
    padding:10px;
    border-radius:10px;
    resize:none;
}

/* ==============================
      MODAL DE IMAGEM DO FEED
============================== */

#imgModal {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.92);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:999999;
}

#modalImg {
    max-width:95%;
    max-height:90%;
    border-radius:12px;
}

#closeModal {
    position:absolute;
    top:20px;
    right:25px;
    font-size:2.5rem;
    cursor:pointer;
}

</style>
<!-- ========================= LOGIN GOOGLE + USU√ÅRIO ========================= -->

<script>
let usuario = null;
let fotoUsuario = null;

/* Decodifica token Google */
function decodeJwt(token) {
    return JSON.parse(atob(token.split('.')[1]));
}

/* Recebe retorno do Google */
function handleLoginGoogle(response) {
    const data = decodeJwt(response.credential);

    usuario = data.email.split("@")[0];
    fotoUsuario = data.picture;

    /* Salva localmente */
    localStorage.setItem("usuarioLogado", usuario);
    localStorage.setItem("fotoPerfil_" + usuario, fotoUsuario);

    mostrarUsuarioNaTela();
}

/* Mostra o usu√°rio logado */
function mostrarUsuarioNaTela() {
    if (!usuario) return;

    document.getElementById("userPhoto").src = fotoUsuario;
    document.getElementById("userName").textContent = usuario;
    document.getElementById("userHeader").style.display = "block";

    document.getElementById("loginBox").style.display = "none";
}

/* Logout completo */
function logoutGoogle() {
    google.accounts.id.disableAutoSelect();
    localStorage.removeItem("usuarioLogado");
    if (usuario) localStorage.removeItem("fotoPerfil_" + usuario);
    location.reload();
}

/* Renderiza bot√£o Google ao carregar */
window.onload = () => {

    google.accounts.id.initialize({
        client_id: "627442405379-srqriainr8okj7ldg96njd1va5bvt7oi.apps.googleusercontent.com",
        callback: handleLoginGoogle,
        auto_select: false
    });

    google.accounts.id.renderButton(
        document.getElementById("googleLogin"),
        { theme: "filled_black", size: "large", width: 260 }
    );

    /* Se j√° estava logado ‚Äî restaura */
    const salvo = localStorage.getItem("usuarioLogado");
    if (salvo) {
        usuario = salvo;
        fotoUsuario = localStorage.getItem("fotoPerfil_" + usuario) 
                       || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        mostrarUsuarioNaTela();
    }
};
</script>

<!-- ========================= STORIES ‚Äî ESTRUTURA INICIAL ========================= -->

<div class="stories-wrapper">
    <div class="stories-row" id="storiesRow">

        <!-- CARD 1 = CRIAR STORY -->
        <div class="story-card" onclick="abrirCriarStory()">
            <div class="create-story-btn">+</div>
        </div>

        <!-- CARD 2 = SEUS STORIES (ADICIONADO PELA PARTE 4) -->

        <!-- DEMAIS STORIES VIR√ÉO ABAIXO (PARTE 4) -->

    </div>
</div>

<!-- ========================= MODAL CRIAR STORY ========================= -->

<div id="storyModal" style="
    position:fixed; inset:0;
    background:rgba(0,0,0,0.92);
    display:none;
    z-index:99999;
    justify-content:center;
    align-items:center;
    flex-direction:column;
">
    <textarea id="storyTexto"
        placeholder="Escreva algo..."
        style="width:80%;max-width:300px;height:80px;
               border-radius:10px;background:#222;
               border:2px solid #00ff8c;color:white;
               padding:10px;outline:none;"></textarea>

    <input type="file" id="storyMedia" accept="image/*,video/*"
        style="margin-top:15px;color:white;">

    <button onclick="enviarStory()"
        style="margin-top:20px;background:#00ff8c;padding:12px 25px;
               border:none;border-radius:10px;font-weight:bold;">
        Postar Story
    </button>

    <button onclick="fecharCriarStory()"
        style="margin-top:12px;background:#ff4f4f;padding:10px 25px;
               border:none;border-radius:10px;">
        Cancelar
    </button>
</div>

<!-- ========================= VIEWER STORY (FULL SCREEN) ========================= -->

<div id="viewer">
    <div class="topBars" id="bars"></div>
    <div class="dots" id="dots">‚ãÆ</div>
    <div class="deleteBtn" id="deleteBtn">Excluir</div>
    <div id="viewerMedia"></div>
</div>
<script type="module">
import { 
    getDatabase, ref, push, onValue, remove, set 
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const db = getDatabase();

/* ===========================================================
        ABRIR / FECHAR MODAL DE CRIA√á√ÉO
=========================================================== */

window.abrirCriarStory = function () {
    if (!usuario) return alert("Fa√ßa login primeiro!");
    storyModal.style.display = "flex";
};

window.fecharCriarStory = function () {
    storyModal.style.display = "none";
    storyTexto.value = "";
    storyMedia.value = "";
};

/* ===========================================================
        ENVIAR STORY PARA O FIREBASE
=========================================================== */

window.enviarStory = function () {
    if (!usuario) return alert("Fa√ßa login!");

    const texto = storyTexto.value.trim();
    const file = storyMedia.files[0];

    let midia = null;
    let tipo = null;

    if (file) {
        const reader = new FileReader();
        reader.onload = e => {
            midia = e.target.result;
            tipo = file.type.startsWith("video") ? "video" : "imagem";
            salvarStory(texto, midia, tipo);
        };
        reader.readAsDataURL(file);
    } else {
        salvarStory(texto, null, null);
    }
};

function salvarStory(texto, midia, tipo) {
    push(ref(db, "coletivo_mural/stories"), {
        usuario,
        texto,
        imagem: tipo === "imagem" ? midia : null,
        video: tipo === "video" ? midia : null,
        timestamp: Date.now(),
        views: {}
    });

    fecharCriarStory();
}

/* ===========================================================
        CARREGAR STORIES EM TEMPO REAL
=========================================================== */

onValue(ref(db, "coletivo_mural/stories"), snap => {
    const row = document.getElementById("storiesRow");
    row.innerHTML = "";

    /* CARD 1 ‚Äì CRIAR STORY */
    row.innerHTML = `
        <div class="story-card" onclick="abrirCriarStory()">
            <div class="create-story-btn">+</div>
        </div>
    `;

    /* =============================
       PRIMEIRO ADICIONAMOS SEUS STORIES
    ============================== */
    let meusStories = [];
    let outrosStories = [];
    const agora = Date.now();

    snap.forEach(st => {
        const s = st.val();
        const id = st.key;

        if (agora - s.timestamp > 86400000) return; // expira em 24h

        if (s.usuario === usuario) {
            meusStories.push({id, ...s});
        } else {
            outrosStories.push({id, ...s});
        }
    });

    /* CARD 2 ‚Äì MEUS STORIES */
    if (meusStories.length > 0) {

        const thumb = meusStories[0].imagem ?? meusStories[0].video;
        const card2 = document.createElement("div");

        card2.className = "story-card meus-stories-borda";
        card2.innerHTML = meusStories[0].imagem
            ? `<img src="${meusStories[0].imagem}">`
            : meusStories[0].video
                ? `<video src="${meusStories[0].video}" muted></video>`
                : `<p style="padding:10px;">${meusStories[0].texto}</p>`;

        card2.onclick = () => abrirStory(0, meusStories, "meu");
        row.appendChild(card2);
    }

    /* =============================
       ADICIONAR STORIES DOS OUTROS
    ============================== */

    outrosStories.forEach((s, index) => {
        const card = document.createElement("div");
        card.className = "story-card";

        if (s.imagem)
            card.innerHTML = `<img src="${s.imagem}">`;
        else if (s.video)
            card.innerHTML = `<video src="${s.video}" muted></video>`;
        else
            card.innerHTML = `<p style="padding:10px;">${s.texto}</p>`;

        card.onclick = () => abrirStory(index, outrosStories, "outro");

        row.appendChild(card);
    });
});

/* ===========================================================
        VIEWER DOS STORIES
=========================================================== */

let storyListaAtual = [];
let storyIndexAtual = 0;
let storyTipoAtual = "";
let storyIDAtual = null;

window.abrirStory = function (index, lista, tipo) {
    storyListaAtual = lista;
    storyIndexAtual = index;
    storyTipoAtual = tipo;

    mostrarStoryAtual();
    viewer.style.display = "flex";

    document.querySelector(".top-menu").classList.add("hide");
};

function mostrarStoryAtual() {
    const s = storyListaAtual[storyIndexAtual];
    storyIDAtual = s.id;

    viewerMedia.innerHTML = "";

    /* Monta m√≠dia */
    if (s.imagem) {
        viewerMedia.innerHTML = `<img src="${s.imagem}">`;
        iniciarBarra(8000);
        setTimeout(nextStory, 8000);
    }
    else if (s.video) {
        const v = document.createElement("video");
        v.src = s.video;
        v.controls = true;
        v.autoplay = true;

        viewerMedia.appendChild(v);

        v.onloadedmetadata = () => {
            const dur = Math.min(v.duration * 1000, 15000);
            iniciarBarra(dur);
            setTimeout(nextStory, dur);
        };
    }
    else {
        viewerMedia.innerHTML = `
            <p style="font-size:1.4rem; padding:15px;">${s.texto}</p>
        `;
        iniciarBarra(5000);
        setTimeout(nextStory, 5000);
    }

    montarBarras();
    configurarMenuExcluir(s);
}

/* ===========================================================
        BARRAS DE PROGRESSO
=========================================================== */

function montarBarras() {
    bars.innerHTML = "";
    storyListaAtual.forEach((s, i) => {
        const bar = document.createElement("div");
        bar.className = "bar";

        const fill = document.createElement("div");
        fill.className = "barFill";

        if (i === storyIndexAtual) fill.id = "currentFill";
        if (i < storyIndexAtual) fill.style.width = "100%";

        bar.appendChild(fill);
        bars.appendChild(bar);
    });
}

function iniciarBarra(ms) {
    const fill = document.getElementById("currentFill");
    if (!fill) return;

    fill.style.transition = "none";
    fill.style.width = "0%";

    setTimeout(() => {
        fill.style.transition = `width ${ms}ms linear`;
        fill.style.width = "100%";
    }, 30);
}

/* ===========================================================
        NAVEGA√á√ÉO ENTRE STORIES
=========================================================== */

window.nextStory = function () {
    storyIndexAtual++;

    if (storyIndexAtual >= storyListaAtual.length) {
        fecharStory();
        return;
    }

    mostrarStoryAtual();
};

window.prevStory = function () {
    if (storyIndexAtual === 0) return;
    storyIndexAtual--;
    mostrarStoryAtual();
};

/* ===========================================================
        EXCLUS√ÉO DO STORY
=========================================================== */

function configurarMenuExcluir(s) {
    if (storyTipoAtual === "meu") {
        deleteBtn.style.display = "block";
        deleteBtn.onclick = excluirStoryAtual;
    } else {
        deleteBtn.style.display = "none";
    }

    dots.onclick = () => {
        deleteBtn.style.display =
            deleteBtn.style.display === "block"
                ? "none"
                : "block";
    };
}

function excluirStoryAtual() {
    if (!confirm("Excluir seu story?")) return;

    remove(ref(db, `coletivo_mural/stories/${storyIDAtual}`));
    fecharStory();
}

/* ===========================================================
        FECHAR STORY VIEWER
=========================================================== */

window.fecharStory = function () {
    viewer.style.display = "none";
    deleteBtn.style.display = "none";

    document.querySelector(".top-menu").classList.remove("hide");
};
</script>
<!-- ====================== FEED ‚Äì HTML PRINCIPAL ====================== -->

<div class="create-post">

    <input type="text" id="postText" class="input-box"
           placeholder="No que voc√™ est√° pensando?"
           oninput="mostrarBotaoEnviar()">

    <!-- Bot√£o + para abrir galeria -->
    <div class="add-btn" onclick="fileInput.click()">+</div>

    <!-- Bot√£o enviar ‚û§ (WhatsApp) -->
    <div class="send-btn" id="btnSend" onclick="postar()" style="display:none;">
        ‚û§
    </div>

    <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
</div>


<!-- Pr√©via da m√≠dia -->
<div class="preview" id="previewBox">
    <h3 style="margin-top:0;color:#00ff9d;">Pr√©via:</h3>
    <div id="previewContent"></div>

    <button onclick="removerPreview()" 
    style="margin-top:15px;background:#ff4444;padding:10px 15px;
           border:none;border-radius:12px;color:white;font-weight:bold;">
        Remover
    </button>
</div>

<!-- Feed -->
<div id="feed"></div>


<!-- ====================== FEED ‚Äì SCRIPT COMPLETO ====================== -->

<script type="module">
import { 
    getDatabase, ref, push, set, remove, onValue 
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const db = getDatabase();

/* ===========================================================
        BOT√ÉO ‚û§ APARECE APENAS QUANDO DIGITA TEXTO
=========================================================== */
window.mostrarBotaoEnviar = function () {
    const texto = postText.value.trim();

    if (texto.length > 0) {
        btnSend.style.display = "flex";
    } else {
        btnSend.style.display = "none";
    }
};

/* ===========================================================
        PR√âVIA DE M√çDIA
=========================================================== */

let midiaTemp = null;
let tipoMidia = null;

fileInput.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    tipoMidia = file.type.startsWith("video") ? "video" : "imagem";

    const reader = new FileReader();
    reader.onload = ev => {
        midiaTemp = ev.target.result;

        previewBox.style.display = "block";

        if (tipoMidia === "imagem") {
            previewContent.innerHTML =
                `<img src="${midiaTemp}" style="width:100%;border-radius:12px;">`;
        } else {
            previewContent.innerHTML =
                `<video src="${midiaTemp}" controls style="width:100%;border-radius:12px;"></video>`;
        }
    };
    reader.readAsDataURL(file);
};

window.removerPreview = function () {
    midiaTemp = null;
    tipoMidia = null;
    previewBox.style.display = "none";
    previewContent.innerHTML = "";
    fileInput.value = "";
};

/* ===========================================================
        POSTAR UM NOVO POST
=========================================================== */

window.postar = function () {
    const texto = postText.value.trim();
    if (!usuario) return alert("Fa√ßa login!");
    if (texto === "" && !midiaTemp) return;

    push(ref(db, "coletivo_mural/posts"), {
        usuario,
        texto,
        imagem: tipoMidia === "imagem" ? midiaTemp : null,
        video: tipoMidia === "video" ? midiaTemp : null,
        timestamp: Date.now(),
        reacoes: {},
        comentarios: {}
    });

    postText.value = "";
    btnSend.style.display = "none";

    removerPreview();
};

/* ===========================================================
        LISTAR POSTS EM TEMPO REAL
=========================================================== */

onValue(ref(db, "coletivo_mural/posts"), snap => {
    const feed = document.getElementById("feed");
    feed.innerHTML = "";

    let lista = [];

    snap.forEach(s => lista.push({ id: s.key, ...s.val() }));
    lista.reverse();

    lista.forEach(p => addPost(p.id, p));
});

/* ===========================================================
        GERAR HTML DO POST
=========================================================== */

function addPost(id, p) {
    const div = document.createElement("div");
    div.className = "post";

    let midia = "";
    if (p.imagem) midia = `<img src="${p.imagem}" onclick="abreModal('${p.imagem}')">`;
    if (p.video) midia = `<video src="${p.video}" controls></video>`;

    const totalCurtidas = p.reacoes ? Object.keys(p.reacoes).length : 0;
    const curtiu = p.reacoes && p.reacoes[usuario];

    div.innerHTML = `
        <div class="menu-btn" onclick="toggleMenu('${id}')">‚ãÆ</div>

        <div class="menu-box" id="menu_${id}">
            ${p.usuario === usuario ? `<div onclick="excluirPost('${id}')">Excluir</div>` : ""}
            <div onclick="compartilhar('${id}')">Compartilhar</div>
        </div>

        <h3 style="color:#00ff9d;">${p.usuario}</h3>
        <p>${p.texto}</p>
        ${midia}

        <div class="post-actions">
            <div class="btn-action" onclick="curtir('${id}')">
                üëç ${curtiu ? "Descurtir" : "Curtir"}
            </div>

            <div class="btn-action" onclick="abrirComentarios('${id}')">
                üí¨ Coment√°rios
            </div>

            <div class="btn-action" onclick="compartilhar('${id}')">
                ‚ÜóÔ∏è Compartilhar
            </div>
        </div>

        <div class="contador">
            üëç ${totalCurtidas} curtidas
        </div>

        <div class="coment-area" id="comentarios_${id}">
            <div id="listaComentarios_${id}"></div>

            <textarea id="comentInput_${id}"
                      placeholder="Escreva um coment√°rio..."></textarea>

            <button onclick="enviarComentario('${id}')"
                style="margin-top:6px;background:#00ff9d;padding:8px 12px;
                       border:none;border-radius:8px;font-weight:bold;">
                Enviar
            </button>
        </div>
    `;

    feed.appendChild(div);

    carregarComentarios(id, p);
}

/* ===========================================================
        CURTIR / DESCURTIR
=========================================================== */

window.curtir = function (id) {
    if (!usuario) return alert("Fa√ßa login!");

    const likeRef = ref(db, `coletivo_mural/posts/${id}/reacoes/${usuario}`);

    onValue(likeRef, snap => {
        if (snap.exists()) remove(likeRef);
        else set(likeRef, true);
    }, { onlyOnce: true });
};

/* ===========================================================
        COMENT√ÅRIOS
=========================================================== */

function carregarComentarios(id, p) {
    const lista = document.getElementById("listaComentarios_" + id);
    lista.innerHTML = "";

    if (p.comentarios) {
        Object.entries(p.comentarios).forEach(([cid, c]) => {
            const item = document.createElement("div");
            item.style = `
                background:#000;
                border:1px solid #00ff9d;
                padding:8px;
                margin:5px 0;
                border-radius:10px;
            `;
            item.innerHTML = `<b style="color:#00ff9d;">${c.usuario}:</b> ${c.texto}`;
            lista.appendChild(item);
        });
    }
}

window.abrirComentarios = function (id) {
    const box = document.getElementById("comentarios_" + id);
    box.style.display = box.style.display === "block" ? "none" : "block";
};

window.enviarComentario = function (id) {
    if (!usuario) return alert("Fa√ßa login!");

    const campo = document.getElementById("comentInput_" + id);
    const texto = campo.value.trim();
    if (!texto) return;

    push(ref(db, `coletivo_mural/posts/${id}/comentarios`), {
        usuario,
        texto,
        hora: Date.now()
    });

    campo.value = "";
};

/* ===========================================================
        EXCLUIR POST
=========================================================== */

window.excluirPost = function (id) {
    if (confirm("Excluir post?")) {
        remove(ref(db, "coletivo_mural/posts/" + id));
    }
};

/* ===========================================================
        MENU 3 PONTINHOS
=========================================================== */

window.toggleMenu = function (id) {
    const box = document.getElementById("menu_" + id);
    box.style.display = box.style.display === "block" ? "none" : "block";
};

/* ===========================================================
        COMPARTILHAR POST
=========================================================== */

window.compartilhar = function (id) {
    const link = `${location.origin}${location.pathname}?post=${id}`;
    navigator.clipboard.writeText(link);
    alert("Link copiado!");
};
</script>


<!-- ====================== MODAL FULLSCREEN DE IMAGEM ====================== -->

<div id="imgModal">
    <span id="closeModal" onclick="fechaModal()">‚úñ</span>
    <img id="modalImg">
</div>

<script>
window.abreModal = function (src) {
    modalImg.src = src;
    imgModal.style.display = "flex";
};

window.fechaModal = function () {
    imgModal.style.display = "none";
};
</script>


<!-- ====================== FECHAR MENUS CLICANDO FORA ====================== -->

<script>
document.addEventListener("click", function(e){
    document.querySelectorAll(".menu-box").forEach(box => {
        if (!box.contains(e.target) && 
            !box.previousElementSibling.contains(e.target)) {
            box.style.display = "none";
        }
    });
});
</script>
