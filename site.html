<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Menu + Stories + Feed (Estilo Facebook 2025)</title>

<!-- ‚úÖ OTIMIZA√á√ÉO: pr√©-conex√µes -->
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
<link rel="preconnect" href="https://coletivo-f34d4-default-rtdb.firebaseio.com" crossorigin>
<link rel="preconnect" href="https://i.ibb.co" crossorigin>
<link rel="dns-prefetch" href="//www.gstatic.com">
<link rel="dns-prefetch" href="//firebasestorage.googleapis.com">
<link rel="dns-prefetch" href="//coletivo-f34d4-default-rtdb.firebaseio.com">
<link rel="dns-prefetch" href="//i.ibb.co">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  *{ box-sizing: border-box; }
  html, body{ width:100%; max-width:100%; overflow-x:hidden; }
  body{
    margin:0;
    background:#18191A;
    font-family: Arial, sans-serif;
    color:#E4E6EB;
    padding-bottom: env(safe-area-inset-bottom);
  }

  :root{
    --fb-bg: #18191A;
    --fb-surface: #242526;
    --fb-surface-2: #2D2E30;
    --fb-border: rgba(255,255,255,.10);
    --fb-text: #E4E6EB;
    --fb-muted: rgba(228,230,235,.72);
    --fb-blue: #0866FF;
    --fb-blue-2:#1877F2;
    --fb-green:#31A24C;
    --fb-red:#F02849;
    --fb-shadow: 0 8px 18px rgba(0,0,0,.35);
    --fb-radius: 16px;
  }

  /* ======================== LOGO + MESSENGER (TOPO) ======================== */
  .logo-bar{
    width:100%;
    background: var(--fb-surface);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--fb-border);
    position: sticky;
    top: 0;
    z-index: 9999;
  }
  .logo-left{ display:flex; align-items:center; gap:12px; min-width:0; }
  .logo-left img{
    width: clamp(160px, 52vw, 360px);
    height:auto;
    max-height: 60px;
    object-fit: contain;
    display:block;
  }

  .msgBtn{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;
    width:44px;
    height:44px;
    background: var(--fb-surface-2);
    border: 1px solid var(--fb-border);
    border-radius: 999px;
    outline:none;
    padding:0;
    box-shadow: 0 6px 14px rgba(0,0,0,.25);
  }
  .msgBtn i{
    font-size: 20px;
    color: var(--fb-text);
    line-height:1;
  }
  .msgBadge{
    position:absolute;
    top: -6px;
    right: -6px;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    border-radius: 999px;
    background: var(--fb-red);
    color: #fff;
    font-weight: 900;
    font-size: 12px;
    display:none;
    align-items:center;
    justify-content:center;
    border: 2px solid var(--fb-surface);
  }

  @media(max-width:480px){
    .logo-left img{ max-height: 54px; }
  }

  /* ======================== MENU (BARRA COM √çCONE + TEXTO ABAIXO) ======================== */
  .top-menu{
    width: 100%;
    background: var(--fb-surface);
    padding: 8px 8px;
    display: flex;
    justify-content: center;
    gap: 10px;
    align-items: stretch;
    border-bottom: 1px solid var(--fb-border);
    position: sticky;
    top: 66px;
    z-index: 9998;
  }
  .top-menu.hide{ display:none !important; }

  .top-menu a{
    width: 66px;
    min-width: 66px;
    height: 58px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap: 6px;
    border-radius: 14px;
    background: transparent;
    border: 1px solid transparent;
    color: var(--fb-text);
    text-decoration:none;
    transition: .15s ease;
    position: relative;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .top-menu a:hover{
    background: rgba(255,255,255,.06);
    border-color: rgba(255,255,255,.08);
  }
  .top-menu a:active{ transform: scale(.98); }

  .top-menu a i{
    font-size: 24px;
    color: var(--fb-text);
    line-height:1;
  }

  .menuLabel{
    font-size: 11px;
    font-weight: 900;
    color: rgba(228,230,235,.88);
    line-height:1;
    letter-spacing:.2px;
    width: 100%;
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    padding: 0 2px;
  }

  .menu-online-dot{
    position:absolute;
    top: 8px;
    right: 10px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--fb-green);
    box-shadow: 0 0 0 3px rgba(49,162,76,.18);
    animation: blinkDot 1.2s infinite;
  }
  @keyframes blinkDot{
    0%, 100%{ transform: scale(1); opacity: 1; }
    50%{ transform: scale(1.25); opacity: .4; }
  }

  @media(max-width:380px){
    .top-menu{ gap: 8px; padding: 8px 6px; top: 64px; }
    .top-menu a{ width: 62px; min-width:62px; height: 56px; border-radius: 14px; }
    .top-menu a i{ font-size: 23px; }
    .menuLabel{ font-size: 10.5px; }
  }
  @media(max-width:330px){
    .top-menu a{ width: 58px; min-width:58px; }
    .top-menu a i{ font-size: 22px; }
    .menuLabel{ font-size: 10px; }
  }

  /* ===================== "NO QUE VOC√ä EST√Å PENSANDO" ===================== */
  .create-post{
    background: var(--fb-surface);
    margin: 12px 12px 10px 12px;
    padding: 12px;
    border-radius: var(--fb-radius);
    border: 1px solid var(--fb-border);
    display:flex;
    gap:10px;
    align-items:center;
    box-shadow: var(--fb-shadow);
  }
  .input-box{
    flex:1;
    min-width: 0;
    background: #3A3B3C;
    padding: 12px 14px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.08);
    color: var(--fb-text);
    font-size: 15px;
    outline:none;
  }
  .input-box::placeholder{ color: rgba(228,230,235,.65); }

  .add-btn{
    background: #3A3B3C;
    border: 1px solid rgba(255,255,255,.10);
    color: var(--fb-text);
    width:44px;
    height:44px;
    border-radius: 999px;
    font-size:22px;
    font-weight:bold;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:.15s;
    flex: 0 0 auto;
  }
  .add-btn:hover{ background: rgba(255,255,255,.08); }

  .whatsapp-send{
    width:44px; height:44px;
    background: var(--fb-blue);
    border-radius: 999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    color:#fff;
    cursor:pointer;
    transition:.15s;
    border: 1px solid rgba(255,255,255,.08);
    flex: 0 0 auto;
  }
  .whatsapp-send:hover{ filter: brightness(1.03); }

  #fileInput{display:none;}

  .preview{
    margin:0 12px 10px 12px;
    padding: 12px;
    background: var(--fb-surface);
    border: 1px solid var(--fb-border);
    border-radius: var(--fb-radius);
    box-shadow: var(--fb-shadow);
    display:none;
  }

  /* ======================== STORIES ======================== */
  .stories-wrapper{ padding: 2px 10px 6px 10px; }
  .stories-row{
    display:flex;
    gap: 12px;
    overflow-x:auto;
    padding: 8px 2px 10px 2px;
    -webkit-overflow-scrolling: touch;
    align-items: stretch;
  }
  .stories-row::-webkit-scrollbar{ height:6px; }
  .stories-row::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius:999px; }

  .storyCard{
    width: clamp(120px, 42vw, 160px);
    height: clamp(220px, 70vw, 290px);
    border-radius: 16px;
    overflow:hidden;
    position:relative;
    flex-shrink:0;
    cursor:pointer;
    background: var(--fb-surface);
    box-shadow: var(--fb-shadow);
    border: 1px solid var(--fb-border);
    transition: transform .12s ease, filter .12s ease;
  }
  .storyCard:hover{ transform: translateY(-1px); }
  .storyMedia{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover; display:block;
    background:#000;
    filter: contrast(1.02) saturate(1.03);
  }
  .storyShade{
    position:absolute; inset:auto 0 0 0;
    height: 50%;
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 35%, rgba(0,0,0,.78) 100%);
    pointer-events:none;
  }
  .segRow{
    position:absolute; top:10px; left:10px; right:10px;
    display:flex; gap:4px; z-index:5;
  }
  .seg{
    flex:1; height:3px;
    background: rgba(255,255,255,.35);
    border-radius:999px; overflow:hidden;
  }
  .avatarCircle{
    position:absolute; top:12px; left:12px;
    width:40px; height:40px;
    border-radius:50%;
    background:#111;
    border: 3px solid var(--fb-blue);
    box-shadow: 0 0 0 3px rgba(0,0,0,.22);
    overflow:hidden;
    z-index:6;
    display:flex; align-items:center; justify-content:center;
  }
  .avatarCircle img{ width:100%; height:100%; object-fit:cover; display:block; }
  .avatarInitials{ font-weight:900; font-size:14px; color:#fff; text-shadow: 0 0 10px rgba(0,0,0,.6); }
  .storyName{
    position:absolute; left:12px; right:12px; bottom:12px;
    z-index:6;
    font-size:16px;
    font-weight:900;
    line-height:1.08;
    text-shadow: 0 2px 10px rgba(0,0,0,.75);
    display:-webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow:hidden;
  }
  .createCard{
    display:flex; align-items:center; justify-content:center;
    flex-direction:column; gap:10px;
    background: linear-gradient(180deg, #242526 0%, #1f2021 100%);
  }
  .plusBtn{
    width: 64px; height: 64px; border-radius: 50%;
    background: var(--fb-blue);
    border: 6px solid rgba(0,0,0,.45);
    display:flex; align-items:center; justify-content:center;
    color:#fff; font-weight:900; font-size:38px;
    box-shadow: 0 10px 22px rgba(0,0,0,.25);
  }
  .createLabel{ font-weight:900; opacity:.95; }

  /* ======================== "CONECTADOS" ======================== */
  .connections{
    background: var(--fb-surface);
    margin: 12px 12px 15px 12px;
    padding: 14px;
    border-radius: var(--fb-radius);
    border: 1px solid var(--fb-border);
    box-shadow: var(--fb-shadow);
    position:relative;
  }
  .connectionsTitle{
    font-weight: 900;
    color: var(--fb-text);
    letter-spacing: .4px;
    text-transform: uppercase;
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom: 12px;
    opacity:.95;
  }
  .connectionsTitle i{ color: var(--fb-blue); }
  .connGrid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  @media(min-width:520px){
    .connGrid{ grid-template-columns: repeat(5, 1fr); }
  }
  .connCard{
    border-radius: 14px;
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
    box-shadow: 0 8px 16px rgba(0,0,0,.22);
    display:flex;
    flex-direction:column;
    min-width:0;
  }
  .connPhoto{
    width:100%;
    aspect-ratio: 1 / 1;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    border-bottom: 1px solid rgba(255,255,255,.08);
    overflow:hidden;
  }
  .connPhoto img{ width:100%; height:100%; object-fit: cover; display:block; }
  .connInit{ font-weight: 900; color: var(--fb-text); font-size: 18px; }
  .connName{
    padding: 10px 10px 8px 10px;
    font-weight: 900;
    color: var(--fb-text);
    font-size: 13px;
    line-height: 1.1;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .connBtn{
    margin: 0 10px 10px 10px;
    border:none;
    border-radius: 12px;
    padding: 10px 8px;
    font-weight: 900;
    cursor:pointer;
    background: var(--fb-blue);
    color: #fff;
    box-shadow: 0 10px 20px rgba(0,0,0,.22);
  }
  .connBtn:active{ transform: scale(.99); }
  .connEmpty{ padding: 10px; opacity: .85; font-weight: 700; }

  /* ======================== VIEWER ======================== */
  #viewer{
    position:fixed; inset:0;
    background: rgba(0,0,0,.92);
    display:none;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:99999;
  }
  #viewerMedia{
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding-top: 56px;
    padding-bottom: calc(96px + env(safe-area-inset-bottom));
  }
  #viewerMedia img, #viewerMedia video{
    width: min(100vw, 980px);
    max-width: 100vw;
    max-height: calc(100vh - 56px - 96px - env(safe-area-inset-bottom));
    object-fit: contain;
    border-radius: 16px;
    background:#000;
  }
  .topBars{
    position:absolute; top: 14px; left:0;
    width:100%;
    display:flex;
    gap:5px;
    padding: 0 10px;
    z-index:10;
  }
  .bar{
    flex:1; height:4px;
    background: rgba(255,255,255,.25);
    border-radius:999px;
    overflow:hidden;
  }
  .barFill{
    width:0%;
    height:100%;
    background: var(--fb-blue);
    transition: width linear;
  }
  .tapLeft,.tapRight{
    position:absolute; top:0;
    height:100%; width:50%;
    z-index:5;
  }
  .tapLeft{ left:0; }
  .tapRight{ right:0; }

  .dots{
    position:absolute; top: 10px; right: 18px;
    font-size: 28px;
    cursor:pointer;
    z-index:20;
    user-select:none;
    color: rgba(255,255,255,.9);
  }
  .deleteBtn{
    position:absolute; top: 50px; right: 18px;
    background: var(--fb-blue);
    color:#fff;
    padding:10px 14px;
    border-radius:12px;
    cursor:pointer;
    display:none;
    font-weight:900;
    z-index:20;
    box-shadow: 0 10px 20px rgba(0,0,0,.25);
    user-select:none;
  }

  /* ‚úÖ QUEM VIU */
  .viewerFooter{
    position:absolute;
    left:0; right:0; bottom:0;
    padding: 10px 12px calc(12px + env(safe-area-inset-bottom)) 12px;
    z-index: 30;
    pointer-events:none;
  }
  .viewerFooterInner{
    pointer-events:auto;
    width: min(560px, 96vw);
    margin: 0 auto;
    background: rgba(36,37,38,.75);
    border: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 10px 20px rgba(0,0,0,.25);
    border-radius: 16px;
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    user-select:none;
    cursor:pointer;
  }
  .seenText{
    display:flex;
    align-items:center;
    gap: 10px;
    font-weight: 900;
    color: var(--fb-text);
    font-size: 14px;
    line-height:1.2;
    min-width:0;
  }
  .seenText i{ color: var(--fb-blue); font-size: 16px; flex:0 0 auto; }
  .seenText span{ display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .seenArrow{
    width:36px; height:36px;
    border-radius: 12px;
    display:flex;
    align-items:center;
    justify-content:center;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    color: var(--fb-text);
    flex: 0 0 auto;
  }

  .viewersPanel{
    pointer-events:auto;
    width: min(560px, 96vw);
    margin: 10px auto 0 auto;
    background: rgba(36,37,38,.92);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 16px;
    padding: 10px 10px;
    max-height: 38vh;
    overflow:auto;
    display:none;
    box-shadow: 0 10px 20px rgba(0,0,0,.25);
  }
  .viewerRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
    padding: 10px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.04);
    margin-bottom: 8px;
  }
  .viewerRow:last-child{ margin-bottom:0; }
  .viewerName{
    font-weight: 900;
    color: var(--fb-text);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 70%;
  }

  /* ===================== ‚úÖ REA√á√ïES DO STORY ===================== */
  .reactionBar{
    position:absolute;
    right: 14px;
    bottom: calc(18px + env(safe-area-inset-bottom));
    z-index: 40;
    display:none;
    gap: 10px;
    align-items:center;
    padding: 10px 10px;
    border-radius: 999px;
    background: rgba(36,37,38,.70);
    border: 1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 10px 20px rgba(0,0,0,.25);
    user-select:none;
    pointer-events:auto;
  }
  .reactBtn{
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    transition: transform .12s ease, box-shadow .12s ease;
    position:relative;
  }
  .reactBtn:active{ transform: scale(.92); }
  .reactIcon{ font-size: 22px; line-height: 1; }
  .reactBtn.love .reactIcon{ color: var(--fb-red); }
  .reactBtn.like .reactIcon{ color: var(--fb-blue); }
  .reactBtn.haha .reactIcon{ color:#F7B928; }

  .reactBtn.selected{
    box-shadow: 0 0 0 3px rgba(8,102,255,.22);
    border-color: rgba(8,102,255,.30);
    transform: translateY(-1px);
  }

  .floatReaction{
    position:absolute;
    right: 0;
    bottom: 0;
    transform: translateY(0);
    opacity: 0;
    pointer-events:none;
    z-index: 60;
    font-size: 28px;
    will-change: transform, opacity;
    animation: floatUp 900ms ease-out forwards;
    filter: drop-shadow(0 0 14px rgba(0,0,0,.55));
  }
  .floatReaction.love{ color: var(--fb-red); }
  .floatReaction.like{ color: var(--fb-blue); }
  .floatReaction.haha{ color:#F7B928; }
  @keyframes floatUp{
    0%   { transform: translate(0, 0) scale(.85); opacity: 0; }
    10%  { opacity: 1; }
    55%  { transform: translate(-10px, -95px) scale(1.15); opacity: 1; }
    100% { transform: translate(-18px, -150px) scale(1.0); opacity: 0; }
  }

  /* ====================== LOGIN ====================== */
  .login-overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.94);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 9999999;
    padding: 16px;
  }
  .login-card{
    width: min(520px, 94vw);
    max-width: 94vw;
    background: var(--fb-surface);
    border:1px solid var(--fb-border);
    border-radius: 18px;
    box-shadow: var(--fb-shadow);
    padding: 18px;
    text-align:center;
  }
  .login-title{
    font-size: clamp(18px, 6vw, 24px);
    font-weight: 900;
    color: var(--fb-text);
    letter-spacing:.5px;
    margin: 4px 0 14px 0;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .login-title i{ color: var(--fb-blue); }
  .login-input{
    width: 100%;
    max-width: 100%;
    display:block;
    background:#3A3B3C;
    border:1px solid rgba(255,255,255,.10);
    border-radius: 999px;
    padding: 14px 18px;
    color: var(--fb-text);
    outline:none;
    font-size: 16px;
  }
  .login-btn{
    width: 100%;
    margin-top: 12px;
    border:none;
    border-radius: 999px;
    padding: 14px 12px;
    font-weight: 900;
    cursor:pointer;
    font-size: 16px;
    transition:.15s;
    background: var(--fb-blue);
    color:#fff;
    box-shadow: 0 10px 20px rgba(0,0,0,.22);
  }
  .login-btn:active{ transform: scale(.99); }

  /* ===================== FEED ===================== */
  .post{
    background: var(--fb-surface);
    margin: 10px 12px;
    padding: 12px;
    border-radius: var(--fb-radius);
    border:1px solid var(--fb-border);
    box-shadow: var(--fb-shadow);
    position:relative;
    content-visibility: auto;
    contain-intrinsic-size: 700px;
  }
  .postHead{
    display:flex;
    align-items:center;
    gap:10px;
    padding-right:44px;
  }
  .postAvatar{
    width:42px; height:42px;
    border-radius:50%;
    overflow:hidden;
    background:#3A3B3C;
    border: 1px solid rgba(255,255,255,.08);
    flex:0 0 auto;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .postAvatar img{ width:100%; height:100%; object-fit: cover; display:block; }
  .postAvatar .init{ font-weight:900; color: var(--fb-text); }

  .postHeadText{ min-width:0; }
  .postNameLine{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .postName{
    font-weight:900;
    font-size:15px;
    color: var(--fb-text);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 62vw;
    cursor:pointer;
  }
  .postWhen{
    font-size:12px;
    color: var(--fb-muted);
    margin-top:3px;
  }

  .post p{
    margin:10px 0 0 0;
    font-size:14px;
    line-height:1.35;
    color: rgba(228,230,235,.95);
  }

  .post .mediaWrap img{
    width:100%;
    border-radius: 14px;
    margin-top:10px;
    background:#000;
    display:block;
    border:1px solid rgba(255,255,255,.08);
  }

  /* ===================== ‚úÖ V√çDEOS DO FEED (ESTILO FACEBOOK) ===================== */
  .fbVideoShell{
    margin-top:10px;
    border-radius: 14px;
    overflow:hidden;
    background:#000;
    border:1px solid rgba(255,255,255,.08);
    position:relative;
  }
  video.fbFeedVideo{
    width:100%;
    display:block;
    background:#000;
    /* Facebook-like: ocupa o card e corta ‚Äúbonito‚Äù */
    aspect-ratio: 4 / 5;
    object-fit: cover;
  }
  /* remove controles nativos em alguns browsers */
  video.fbFeedVideo::-webkit-media-controls{ display:none !important; }
  video.fbFeedVideo::-webkit-media-controls-enclosure{ display:none !important; }

  .fbVidUI{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  .fbVidSoundBtn{
    position:absolute;
    right:10px;
    bottom:10px;
    width:38px;
    height:38px;
    border-radius:999px;
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(255,255,255,.22);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    box-shadow: 0 10px 18px rgba(0,0,0,.25);
    pointer-events:auto;
    cursor:pointer;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .fbVidSoundBtn:active{ transform: scale(.96); }

  .fbVidPlayBtn{
    position:absolute;
    left:50%;
    top:50%;
    transform: translate(-50%,-50%);
    width:62px;
    height:62px;
    border-radius:999px;
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(255,255,255,.22);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:22px;
    box-shadow: 0 10px 18px rgba(0,0,0,.25);
    pointer-events:auto;
    cursor:pointer;
    user-select:none;
    opacity:0;
    transition: opacity .15s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .fbVidPlayBtn.show{ opacity:1; }
  .fbVidPlayBtn:active{ transform: translate(-50%,-50%) scale(.96); }

  .fbVidProgress{
    position:absolute;
    left:0; right:0; bottom:0;
    height:3px;
    background: rgba(255,255,255,.25);
    pointer-events:none;
  }
  .fbVidProgressFill{
    height:100%;
    width:0%;
    background: var(--fb-blue);
    transition: width .08s linear;
  }

  /* ===================== A√á√ïES ===================== */
  .post-actions{
    display:flex;
    justify-content:space-around;
    margin-top:12px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .btn-action{
    color: var(--fb-text);
    padding: 10px 12px;
    border-radius: 10px;
    font-weight:900;
    cursor:pointer;
    transition:0.15s;
    text-align:center;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    user-select:none;
    font-size:14px;
    min-width: 150px;
  }
  .btn-action:hover{ background: rgba(255,255,255,.08); }
  .btn-action:active{ transform: scale(.99); }

  .contador{
    margin-top:6px;
    font-size:12px;
    color: var(--fb-muted);
    text-align:center;
    line-height:1.35;
    word-break: break-word;
  }

  .coment-area{
    background: rgba(255,255,255,.04);
    padding:10px;
    margin-top:10px;
    border-radius: 14px;
    display:none;
    border:1px solid rgba(255,255,255,.10);
  }

  .menu-btn{
    position: absolute;
    top: 10px;
    right: 10px;
    width: 36px; height: 36px;
    border-radius: 10px;
    display:flex; align-items:center; justify-content:center;
    font-size: 18px;
    cursor: pointer;
    color: rgba(255,255,255,.90);
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.08);
    user-select:none;
    z-index: 10;
  }
  .menu-btn:hover{ background: rgba(255,255,255,.08); }

  .menu-box{
    position: absolute;
    top: 52px;
    right: 10px;
    background: #FFFFFF;
    color: #111;
    padding: 8px 10px;
    border-radius: 12px;
    display: none;
    cursor: pointer;
    font-weight: 900;
    box-shadow: 0 12px 24px rgba(0,0,0,.35);
    z-index: 15;
    min-width: 120px;
  }
  .menu-box div{ padding: 8px 6px; border-radius: 10px; }
  .menu-box div:hover{ background: rgba(0,0,0,.06); }

  .cRow{
    position:relative;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.10);
    padding:10px 44px 10px 10px;
    border-radius: 14px;
    margin-bottom:8px;
  }
  .cHead{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:6px;
    min-width:0;
  }
  .cAvatar{
    width:30px; height:30px;
    border-radius:50%;
    overflow:hidden;
    background:#3A3B3C;
    border:1px solid rgba(255,255,255,.08);
    flex:0 0 auto;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .cAvatar img{ width:100%; height:100%; object-fit: cover; display:block; }
  .cName{
    font-weight:900;
    color: var(--fb-text);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 62vw;
    cursor:pointer;
    font-size:14px;
  }
  .cText{ opacity:.95; font-size:13px; color: rgba(228,230,235,.92); }

  .coment-menu-btn{
    position:absolute;
    top:10px;
    right:10px;
    width: 34px; height: 34px;
    border-radius: 10px;
    display:flex; align-items:center; justify-content:center;
    font-size:18px;
    cursor:pointer;
    color: rgba(255,255,255,.90);
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.08);
    user-select:none;
    line-height:1;
  }
  .coment-menu-box{
    position:absolute;
    top:46px;
    right:10px;
    background: #ffffff;
    color:#111;
    padding:8px 10px;
    border-radius:12px;
    display:none;
    font-weight:900;
    cursor:pointer;
    box-shadow: 0 12px 24px rgba(0,0,0,.35);
    z-index:5;
    line-height:1;
    min-width: 120px;
  }
  .coment-menu-box:hover{ background: rgba(0,0,0,.06); }

  /* ===================== LOADING ===================== */
  .loadingOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.78);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 99999999;
    padding: 18px;
  }
  .loadingCard{
    width: min(520px, 92vw);
    background: var(--fb-surface);
    border:1px solid var(--fb-border);
    border-radius: 18px;
    box-shadow: var(--fb-shadow);
    padding:18px;
    text-align:center;
  }
  .spinner{
    width:46px;height:46px;border-radius:50%;
    border:4px solid rgba(255,255,255,.14);
    border-top-color: var(--fb-blue);
    margin:0 auto 10px auto;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg);} }
  .loadingText{ color: var(--fb-text); font-weight:900; letter-spacing:.4px; }
  .loadingSub{ margin-top:6px; color: var(--fb-text); opacity:.85; font-size:14px; }

  .pendingBadge{
    display:inline-block;
    margin-left:8px;
    padding:4px 10px;
    border-radius:999px;
    background: rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.12);
    color: var(--fb-text);
    font-size:12px;
    font-weight:900;
  }

  /* ===================== MODAL PR√âVIA PERFIL ===================== */
  .profileModal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.90);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 999999999;
    padding: 14px;
  }
  .profileModalCard{
    width: min(820px, 96vw);
    height: min(86vh, 720px);
    background: var(--fb-surface);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: var(--fb-shadow);
    border-radius: 18px;
    overflow:hidden;
    position:relative;
  }
  .profileModalTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding: 12px 12px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.15);
  }
  .profileModalTitle{
    font-weight: 900;
    color: var(--fb-text);
    display:flex;
    align-items:center;
    gap:10px;
    letter-spacing:.4px;
  }
  .profileModalTitle i{ color: var(--fb-blue); }
  .profileModalClose{
    border:none;
    border-radius: 12px;
    padding: 10px 12px;
    font-weight: 900;
    cursor:pointer;
    background: var(--fb-blue);
    color:#fff;
    box-shadow: 0 10px 20px rgba(0,0,0,.22);
  }
  .profileModalFrame{
    width:100%;
    height: calc(100% - 54px);
    border:0;
    display:block;
    background:#000;
  }
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-title"><i class="fa-solid fa-user"></i> ENTRAR</div>
    <input id="loginName" class="login-input" maxlength="24" placeholder="Digite seu nome" autocomplete="off">
    <button class="login-btn" onclick="confirmarNome()">Entrar</button>
  </div>
</div>

<!-- LOADING -->
<div class="loadingOverlay" id="loadingOverlay">
  <div class="loadingCard">
    <div class="spinner"></div>
    <div class="loadingText" id="loadingText">Enviando...</div>
    <div class="loadingSub" id="loadingSub">Aguarde um instante</div>
  </div>
</div>

<!-- MODAL PR√âVIA PERFIL -->
<div class="profileModal" id="profileModal">
  <div class="profileModalCard">
    <div class="profileModalTop">
      <div class="profileModalTitle"><i class="fa-solid fa-id-card"></i> Pr√©via do Perfil</div>
      <button class="profileModalClose" onclick="closeProfileModal()">Fechar</button>
    </div>
    <iframe class="profileModalFrame" id="profileFrame" src="about:blank"></iframe>
  </div>
</div>

<!-- ‚úÖ TOPO: LOGO √Ä ESQUERDA + MESSENGER √Ä DIREITA -->
<div class="logo-bar">
  <div class="logo-left">
    <img src="https://i.ibb.co/h1RmgKSX/Chat-GPT-Image-17-12-2025-21-32-09.png" alt="Logo" loading="eager" fetchpriority="high">
  </div>

  <button class="msgBtn" id="msgBtn" title="Bate-papo" aria-label="Bate-papo">
    <i class="fa-brands fa-facebook-messenger"></i>
    <span class="msgBadge" id="msgBadge">0</span>
  </button>
</div>

<!-- ‚úÖ MENU (√çCONE + NOME ABAIXO) -->
<nav class="top-menu" aria-label="Menu principal">
  <a href="https://marcio2307.github.io/terreiro/estudo.html" title="Estudo" aria-label="Estudo">
    <i class="fa-solid fa-book"></i>
    <div class="menuLabel">Estudo</div>
  </a>

  <a href="https://marcio2307.github.io/terreiro/chat.html" title="Online" aria-label="Online">
    <i class="fa-solid fa-users"></i>
    <span class="menu-online-dot" aria-hidden="true"></span>
    <div class="menuLabel">Online</div>
  </a>

  <a href="https://marcio2307.github.io/terreiro/sala.html" title="Reuni√£o" aria-label="Reuni√£o">
    <i class="fa-solid fa-video"></i>
    <div class="menuLabel">Reuni√£o</div>
  </a>

  <a href="#" id="radioBtn" onclick="toggleRadio(); return false;" title="R√°dio" aria-label="R√°dio">
    <i class="fa-solid fa-radio" id="radioIcon"></i>
    <div class="menuLabel">R√°dio</div>
  </a>

  <a href="https://marcio2307.github.io/terreiro/perfil.html" title="Perfil" aria-label="Perfil">
    <i class="fa-solid fa-user"></i>
    <div class="menuLabel">Perfil</div>
  </a>
</nav>

<!-- ‚úÖ "NO QUE VOC√ä EST√Å PENSANDO?" -->
<div class="create-post">
  <input type="text" id="postText" class="input-box" placeholder="No que voc√™ est√° pensando?" oninput="updateButton()">
  <div class="add-btn" id="btnMain" onclick="buttonAction()">+</div>
  <input type="file" id="fileInput" accept="image/*,video/*">
</div>

<div class="preview" id="previewBox">
  <h3 style="margin:0 0 10px 0;">Pr√©via da m√≠dia</h3>
  <div id="previewContent"></div>

  <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
    <button onclick="removerPreview()"
      style="width:100%;padding:14px;font-size:16px;font-weight:900;border:none;border-radius:14px;background:var(--fb-red);color:#fff;cursor:pointer;">
      Excluir m√≠dia
    </button>

    <button onclick="postar()"
      style="width:100%;padding:14px;font-size:16px;font-weight:900;border:none;border-radius:14px;background:var(--fb-blue);color:#fff;cursor:pointer;">
      Publicar
    </button>
  </div>
</div>

<!-- STORIES -->
<div class="stories-wrapper">
  <div class="stories-row" id="storiesRow"></div>
</div>

<!-- VIEWER -->
<div id="viewer">
  <div class="topBars" id="bars"></div>
  <div class="dots" id="dots">‚ãÆ</div>
  <div class="deleteBtn" id="deleteBtn">Excluir</div>
  <div class="tapLeft" id="tapLeft"></div>
  <div class="tapRight" id="tapRight"></div>
  <div id="viewerMedia"></div>

  <!-- ‚úÖ REA√á√ïES -->
  <div class="reactionBar" id="reactionBar" aria-label="Reagir ao story">
    <div class="reactBtn love" id="reactLove" title="Cora√ß√£o" onclick="reactToStory('love')">
      <span class="reactIcon">‚ù§</span>
    </div>
    <div class="reactBtn like" id="reactLike" title="Curtir" onclick="reactToStory('like')">
      <span class="reactIcon">üëç</span>
    </div>
    <div class="reactBtn haha" id="reactHaha" title="Haha" onclick="reactToStory('haha')">
      <span class="reactIcon">üòÇ</span>
    </div>
  </div>

  <!-- ‚úÖ QUEM VIU -->
  <div class="viewerFooter" id="viewerFooter">
    <div class="viewerFooterInner" id="viewerFooterInner" onclick="toggleViewersPanel()">
      <div class="seenText">
        <i class="fa-solid fa-eye"></i>
        <span id="seenText">Ningu√©m viu ainda</span>
      </div>
      <div class="seenArrow" id="seenArrow">
        <i class="fa-solid fa-chevron-up" id="seenChevron"></i>
      </div>
    </div>
    <div class="viewersPanel" id="viewersPanel"></div>
  </div>
</div>

<!-- FEED / MURAL -->
<div id="feed"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
/* ====================== FIREBASE ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();
const ST = firebase.storage();

/* ====================== ‚úÖ SOM (A√á√ïES DO SITE) ====================== */
const ACTION_SOUND_URL = "som.mp3";
const actionSfx = new Audio(ACTION_SOUND_URL);
actionSfx.preload = "auto";
actionSfx.volume = 1.0;

/* ====================== ‚úÖ SOM DO CHAT (SOMM.MP3) ====================== */
const CHAT_SOUND_URL = "somm.mp3";
const chatSfx = new Audio(CHAT_SOUND_URL);
chatSfx.preload = "auto";
chatSfx.volume = 1.0;

let audioUnlocked = false;

/* ‚úÖ AJUSTE: desbloqueia √°udio com QUALQUER intera√ß√£o (inclui pointerdown/keydown) */
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  try{
    actionSfx.muted = false;
    chatSfx.muted = false;

    const p1 = actionSfx.play();
    if(p1 && p1.then) p1.then(()=>{ actionSfx.pause(); actionSfx.currentTime = 0; }).catch(()=>{});
    else { actionSfx.pause(); actionSfx.currentTime = 0; }

    const p2 = chatSfx.play();
    if(p2 && p2.then) p2.then(()=>{ chatSfx.pause(); chatSfx.currentTime = 0; }).catch(()=>{});
    else { chatSfx.pause(); chatSfx.currentTime = 0; }
  }catch(e){}
}
document.addEventListener("touchstart", unlockAudioOnce, { once:true, passive:true });
document.addEventListener("click", unlockAudioOnce, { once:true });
document.addEventListener("pointerdown", unlockAudioOnce, { once:true, passive:true });
document.addEventListener("keydown", unlockAudioOnce, { once:true });

function playActionSound(){
  if(!ACTION_SOUND_URL || ACTION_SOUND_URL.includes("COLE_AQUI")) return;
  try{
    actionSfx.pause();
    actionSfx.currentTime = 0;
    actionSfx.play().catch(()=>{});
  }catch(e){}
}
function playChatSound(){
  if(!CHAT_SOUND_URL) return;
  try{
    chatSfx.pause();
    chatSfx.currentTime = 0;
    chatSfx.play().catch(()=>{});
  }catch(e){}
}

/* ====================== ‚úÖ CONTROLE: R√ÅDIO x V√çDEOS DO FEED ====================== */
let __lastUnmutedFeedVideo = null;
let __radioLocksFeedAudio = false;

function rememberUnmutedFeedVideo(){
  __lastUnmutedFeedVideo = null;
  document.querySelectorAll("#feed video[data-feedvideo='1']").forEach(v=>{
    try{
      if(v.__userUnmuted && !v.muted){
        __lastUnmutedFeedVideo = v;
      }
    }catch(e){}
  });
}

function forceMuteAllFeedVideos(){
  document.querySelectorAll("#feed video[data-feedvideo='1']").forEach(v=>{
    try{
      v.__userUnmuted = false;
      v.muted = true;
      v.volume = 1.0;
      if(v.__ui && v.__ui.soundIcon){
        v.__ui.soundIcon.className = "fa-solid fa-volume-xmark";
      }
    }catch(e){}
  });
}

function restoreFeedVideoAudioIfPossible(){
  if(!__lastUnmutedFeedVideo) return;
  const v = __lastUnmutedFeedVideo;
  if(!document.body.contains(v)) return;

  const rect = v.getBoundingClientRect();
  const visible = rect.bottom > 0 && rect.top < (window.innerHeight || 0);
  if(!visible) return;

  try{
    unlockAudioOnce();
    if(__radioLocksFeedAudio || radioPlaying){
      v.__userUnmuted = false;
      v.muted = true;
      v.volume = 1.0;
      if(v.__ui && v.__ui.soundIcon){
        v.__ui.soundIcon.className = "fa-solid fa-volume-xmark";
      }
      return;
    }
    v.__userUnmuted = true;
    v.muted = false;
    v.volume = 1.0;
    if(v.__ui && v.__ui.soundIcon){
      v.__ui.soundIcon.className = "fa-solid fa-volume-high";
    }

    if(!v.__srcSet){
      const ds = v.getAttribute("data-src");
      if(ds){
        v.src = ds;
        v.__srcSet = true;
        v.preload = "metadata";
        v.setAttribute("preload","metadata");
        v.setAttribute("fetchpriority","high");
        try{ v.load(); }catch(e){}
      }
    }

    const p = v.play();
    if(p && p.catch) p.catch(()=>{});
  }catch(e){}
}

/* ====================== RADIO PLAYER (MENU) ====================== */
const RADIO_URL = "https://stream.zeno.fm/l8ocj9i6ka2uv";
let radio = null;
let radioPlaying = false;

function ensureRadio(){
  if(radio) return;
  radio = new Audio(RADIO_URL);
  radio.preload = "none";
  radio.crossOrigin = "anonymous";
  radio.volume = 1.0;

  radio.addEventListener("playing", ()=>{ setRadioUI(true); onRadioStateChange(true); });
  radio.addEventListener("pause", ()=>{ setRadioUI(false); onRadioStateChange(false); });
  radio.addEventListener("ended", ()=>{ setRadioUI(false); onRadioStateChange(false); });
  radio.addEventListener("error", ()=>{ setRadioUI(false); onRadioStateChange(false); });
}

function onRadioStateChange(isPlaying){
  radioPlaying = !!isPlaying;

  if(radioPlaying){
    __radioLocksFeedAudio = true;
    rememberUnmutedFeedVideo();
    forceMuteAllFeedVideos();
  }else{
    __radioLocksFeedAudio = false;
    restoreFeedVideoAudioIfPossible();
  }
}

function setRadioUI(isPlaying){
  radioPlaying = !!isPlaying;
  const icon = document.getElementById("radioIcon");
  if(!icon) return;
  icon.className = radioPlaying ? "fa-solid fa-pause" : "fa-solid fa-radio";
}

function toggleRadio(){
  ensureRadio();
  unlockAudioOnce();
  if(!radioPlaying){
    radio.play().then(()=>{ setRadioUI(true); onRadioStateChange(true); }).catch(()=>{ setRadioUI(false); onRadioStateChange(false); });
  }else{
    try{ radio.pause(); }catch(e){}
    setRadioUI(false);
    onRadioStateChange(false);
  }
}

/* ====================== LOGIN + UID persistente ====================== */
function getOrCreateUID(){
  let uid = localStorage.getItem("uid_passageiro");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem("uid_passageiro", uid);
  }
  sessionStorage.setItem("uid_passageiro", uid);
  return uid;
}
let UID = getOrCreateUID();

function getNomeSalvo(){
  return (localStorage.getItem("nome_passageiro") || "").trim();
}
let USER_NAME = getNomeSalvo();

const loginOverlay = document.getElementById("loginOverlay");
const loginName = document.getElementById("loginName");

function abrirLogin(){
  loginOverlay.style.display = "flex";
  document.body.style.overflow = "hidden";
  setTimeout(()=>{ try{ loginName.focus(); }catch(e){} }, 50);
}
function fecharLogin(){
  loginOverlay.style.display = "none";
  document.body.style.overflow = "";
}
function confirmarNome(){
  let nome = (loginName.value || "").trim();
  if(nome.length < 2){
    alert("Digite um nome com pelo menos 2 letras.");
    try{ loginName.focus(); }catch(e){}
    return;
  }
  localStorage.setItem("nome_passageiro", nome);
  USER_NAME = nome;
  UID = getOrCreateUID();
  fecharLogin();
  startPresence();
  setTimeout(()=>{ location.reload(); }, 80);
}
(function exigirLogin(){
  if(!USER_NAME) abrirLogin();
})();

function precisaLogin(){
  if(!USER_NAME){ abrirLogin(); return true; }
  return false;
}
document.addEventListener("keydown", (e)=>{
  if(loginOverlay.style.display === "flex" && e.key === "Enter"){ confirmarNome(); }
});

/* Helpers */
function escapeHTML(str){
  str = (str == null ? "" : String(str));
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}

/* ====================== ‚úÖ ABRIR PR√âVIA DO PERFIL ====================== */
const PREVIEW_URL = "https://marcio2307.github.io/terreiro/previa.html";
const profileModal = document.getElementById("profileModal");
const profileFrame = document.getElementById("profileFrame");
function openProfileModal(uid){
  if(!uid) return;
  const back = encodeURIComponent(window.location.href);
  profileFrame.src = `${PREVIEW_URL}?uid=${encodeURIComponent(uid)}&back=${back}`;
  profileModal.style.display = "flex";
  document.body.style.overflow = "hidden";
}
function closeProfileModal(){
  profileModal.style.display = "none";
  document.body.style.overflow = "";
  profileFrame.src = "about:blank";
}
profileModal.addEventListener("click", (e)=>{
  if(e.target === profileModal) closeProfileModal();
});

/* limites */
const MAX_IMG_MB = 15;
const MAX_VID_MB = 120;
function checkSize(file){
  const mb = file.size/(1024*1024);
  if(file.type.startsWith("image/") && mb>MAX_IMG_MB){
    alert(`Imagem muito grande (${mb.toFixed(1)}MB). Envie at√© ${MAX_IMG_MB}MB.`);
    return false;
  }
  if(file.type.startsWith("video/") && mb>MAX_VID_MB){
    alert(`V√≠deo muito grande (${mb.toFixed(1)}MB). Envie at√© ${MAX_VID_MB}MB.`);
    return false;
  }
  return true;
}

/* Loading */
const loadingOverlay = document.getElementById("loadingOverlay");
const loadingText = document.getElementById("loadingText");
const loadingSub  = document.getElementById("loadingSub");
function showLoading(title, sub){
  loadingText.textContent = title || "Enviando...";
  loadingSub.textContent = sub || "Aguarde um instante";
  loadingOverlay.style.display = "flex";
}
function hideLoading(){ loadingOverlay.style.display = "none"; }

/* ====================== ‚úÖ PRESEN√áA ONLINE ====================== */
let presenceRef = null;
let presenceTimer = null;

function startPresence(){
  try{
    if(!USER_NAME || !UID) return;
    if(presenceTimer) return;

    presenceRef = DB.ref("presence/" + UID);

    const connectedRef = DB.ref(".info/connected");
    connectedRef.on("value", (snap)=>{
      if(snap.val() === true){
        presenceRef.onDisconnect().remove().catch(()=>{});
        presenceRef.set({
          uid: UID,
          userName: USER_NAME,
          online: true,
          onlineAt: firebase.database.ServerValue.TIMESTAMP,
          lastActive: firebase.database.ServerValue.TIMESTAMP
        }).catch(()=>{});
      }
    });

    presenceTimer = setInterval(()=>{
      if(!presenceRef) return;
      presenceRef.update({
        online: true,
        lastActive: firebase.database.ServerValue.TIMESTAMP
      }).catch(()=>{});
    }, 25000);

    window.addEventListener("beforeunload", ()=>{
      try{ stopPresence(true); }catch(e){}
    });
  }catch(e){}
}
function stopPresence(silent){
  try{
    if(presenceTimer){ clearInterval(presenceTimer); presenceTimer = null; }
    if(presenceRef){ presenceRef.remove().catch(()=>{}); presenceRef = null; }
  }catch(e){}
  if(!silent){}
}
if(USER_NAME && UID){ startPresence(); }
</script>

<script>
/* ===================== PERFIS ===================== */
const profileCache = new Map();
function PROFILE_REF(uid){ return DB.ref("profiles/" + uid); }

async function getAvatarForUID(uid, fallbackName){
  if(!uid) return { url:"", name: fallbackName || "Usu√°rio" };
  if(profileCache.has(uid)) return profileCache.get(uid);

  try{
    const snap = await PROFILE_REF(uid).once("value");
    const p = snap.val() || {};
    const name = p.name || fallbackName || "Usu√°rio";
    const url = p.avatarDataUrl || p.avatarUrl || "";
    const obj = { url, name };
    profileCache.set(uid, obj);

    PROFILE_REF(uid).on("value", s=>{
      const px = s.val() || {};
      const nn = px.name || name;
      const uu = px.avatarDataUrl || px.avatarUrl || "";
      profileCache.set(uid, { url: uu, name: nn });
      updateAvatarsInDOM(uid, uu, nn);
      updateStoryAvatarsInDOM(uid, uu, nn);
      updateViewerAvatarsInDOM(uid, uu, nn);
      updateConnectionsAvatarsInDOM(uid, uu, nn);
    });

    return obj;
  }catch(e){
    const obj = { url:"", name: fallbackName || "Usu√°rio" };
    profileCache.set(uid, obj);
    return obj;
  }
}

function updateAvatarsInDOM(uid, url, name){
  document.querySelectorAll(`[data-avatar-uid="${uid}"]`).forEach(el=>{
    if(url){
      el.innerHTML = `<img src="${url}" alt="avatar" loading="lazy">`;
    }else{
      el.innerHTML = `<div class="init">${(initials(name||"U"))}</div>`;
    }
  });
  document.querySelectorAll(`[data-name-uid="${uid}"]`).forEach(el=>{
    el.textContent = name || "Usu√°rio";
  });
}
function updateStoryAvatarsInDOM(uid, url, name){
  document.querySelectorAll(`[data-story-avatar-uid="${uid}"]`).forEach(el=>{
    if(url){
      el.innerHTML = `<img src="${url}" alt="avatar" loading="lazy">`;
    }else{
      el.innerHTML = `<div class="avatarInitials">${initials(name||"U")}</div>`;
    }
  });
  document.querySelectorAll(`[data-story-name-uid="${uid}"]`).forEach(el=>{
    el.textContent = name || "Usu√°rio";
  });
}
function updateViewerAvatarsInDOM(uid, url, name){
  document.querySelectorAll(`[data-viewer-avatar-uid="${uid}"]`).forEach(el=>{
    if(url){
      el.innerHTML = `<img src="${url}" alt="avatar" loading="lazy">`;
    }else{
      el.textContent = initials(name||"U");
    }
  });
}
function updateConnectionsAvatarsInDOM(uid, url, name){
  document.querySelectorAll(`[data-conn-photo-uid="${uid}"]`).forEach(el=>{
    if(url){
      el.innerHTML = `<img src="${url}" alt="avatar" loading="lazy">`;
    }else{
      el.innerHTML = `<div class="connInit">${escapeHTML(initials(name||"U"))}</div>`;
    }
  });
  document.querySelectorAll(`[data-conn-name-uid="${uid}"]`).forEach(el=>{
    el.textContent = name || "Usu√°rio";
  });
}
</script>

<script>
/* ===================== ‚úÖ MESSENGER (BADGE + SOM DO CHAT) ===================== */
const CHAT_URL = "https://marcio2307.github.io/terreiro/batepapo.html";
const ROOM_ID = "global";
const CHAT_MSG_PATH = `groupChat/${ROOM_ID}/messages`;

const msgBtn = document.getElementById("msgBtn");
const msgBadge = document.getElementById("msgBadge");

let unread = 0;
let firstChatLoadDone = false;
const chatRendered = new Set();

function renderBadge(){
  if(unread <= 0){
    msgBadge.style.display = "none";
    msgBadge.textContent = "0";
    return;
  }
  msgBadge.style.display = "inline-flex";
  msgBadge.textContent = unread > 99 ? "99+" : String(unread);
}
function clearUnread(){
  unread = 0;
  renderBadge();
  try{ localStorage.setItem("chat_unread_count", "0"); }catch(e){}
}
function incUnread(){
  unread++;
  renderBadge();
  try{ localStorage.setItem("chat_unread_count", String(unread)); }catch(e){}
}
(function loadUnread(){
  try{
    const v = parseInt(localStorage.getItem("chat_unread_count")||"0", 10);
    unread = isNaN(v) ? 0 : v;
    renderBadge();
  }catch(e){}
})();
msgBtn.addEventListener("click", ()=>{
  unlockAudioOnce();
  clearUnread();
  window.location.href = CHAT_URL;
});

(function listenChatNotifications(){
  const ref = DB.ref(CHAT_MSG_PATH).orderByChild("createdAt").limitToLast(200);
  ref.on("child_added", (snap)=>{
    const m = snap.val() || {};
    const id = m.id || snap.key;
    if(!id) return;
    if(chatRendered.has(id)) return;
    chatRendered.add(id);

    if(firstChatLoadDone){
      if(m.uid && m.uid !== UID){
        incUnread();
        playChatSound();
      }
    }else{
      clearTimeout(window.__chatFirstLoadTimer);
      window.__chatFirstLoadTimer = setTimeout(()=>{ firstChatLoadDone = true; }, 900);
    }
  });
})();
</script>

<script>
/* ===================== ‚úÖ BLOCO "CONECTADOS" ===================== */
const CONNECTIONS_ID = "connectionsSection";
let connectionsUsers = [];

function ensureConnectionsSection(){
  const feed = document.getElementById("feed");
  if(!feed) return;

  let sec = document.getElementById(CONNECTIONS_ID);
  const firstPost = feed.querySelector(".post");

  if(!firstPost){
    if(sec) sec.remove();
    return;
  }

  if(!sec){
    sec = document.createElement("div");
    sec.id = CONNECTIONS_ID;
    sec.className = "connections";
  }

  const afterFirst = firstPost.nextSibling;
  if(afterFirst !== sec){
    feed.insertBefore(sec, afterFirst);
  }

  renderConnections();
}

async function renderConnections(){
  const sec = document.getElementById(CONNECTIONS_ID);
  if(!sec) return;

  const list = connectionsUsers
    .filter(u => u && u.uid && u.uid !== UID)
    .sort((a,b)=> (b.lastActive||b.onlineAt||0) - (a.lastActive||a.onlineAt||0))
    .slice(0, 10);

  sec.innerHTML = `
    <div class="connectionsTitle">
      <i class="fa-solid fa-users"></i>
      <span>CONECTADOS</span>
    </div>
    <div class="connGrid" id="connGrid"></div>
    <div id="connEmpty" class="connEmpty" style="display:none;">Ningu√©m online agora. Volte j√° j√° üôÇ</div>
  `;

  const grid = sec.querySelector("#connGrid");
  const empty = sec.querySelector("#connEmpty");

  if(!list.length){
    empty.style.display = "block";
    return;
  }

  const cards = await Promise.all(list.map(async u=>{
    const prof = await getAvatarForUID(u.uid, u.userName || "Usu√°rio");
    const name = prof.name || u.userName || "Usu√°rio";
    const photo = prof.url
      ? `<img src="${prof.url}" alt="avatar" loading="lazy">`
      : `<div class="connInit">${escapeHTML(initials(name))}</div>`;

    return `
      <div class="connCard">
        <div class="connPhoto" data-conn-photo-uid="${escapeHTML(u.uid)}">${photo}</div>
        <div class="connName" data-conn-name-uid="${escapeHTML(u.uid)}">${escapeHTML(name)}</div>
        <button class="connBtn" onclick="openProfileModal('${escapeHTML(u.uid)}')">Ver perfil</button>
      </div>
    `;
  }));

  grid.innerHTML = cards.join("");
}

(function listenConnectionsPresence(){
  const ref = DB.ref("presence").orderByChild("lastActive").limitToLast(80);
  ref.on("value", (snap)=>{
    const obj = snap.val() || {};
    const arr = Object.keys(obj).map(k => obj[k]).filter(Boolean);

    connectionsUsers = arr.map(x=>({
      uid: x.uid || "",
      userName: x.userName || "Usu√°rio",
      lastActive: x.lastActive || 0,
      onlineAt: x.onlineAt || 0
    }));

    ensureConnectionsSection();
  });
})();
</script>

<!-- ===================== STORIES (SEU C√ìDIGO ORIGINAL INTACTO) ===================== -->
<script>
/* ===================== STORIES ===================== */
const menuTop = document.querySelector('.top-menu');

let allStories = [];
let groupedStories = [];
let activeStories = [];
let current = 0;
let viewerTimer = null;

let viewersPanelOpen = false;
let viewersRef = null;
let CAN_SEE_VIEWERS = false;

const viewer = document.getElementById("viewer");
const viewerMedia = document.getElementById("viewerMedia");
const bars = document.getElementById("bars");
const dots = document.getElementById("dots");
const deleteBtn = document.getElementById("deleteBtn");
const tapLeft = document.getElementById("tapLeft");
const tapRight = document.getElementById("tapRight");
const viewerFooter = document.getElementById("viewerFooter");
const viewersPanel = document.getElementById("viewersPanel");
const seenText = document.getElementById("seenText");

const reactionBar = document.getElementById("reactionBar");
const reactLove = document.getElementById("reactLove");
const reactLike = document.getElementById("reactLike");
const reactHaha = document.getElementById("reactHaha");

let reactionsRef = null;
let _latestViewsObj = {};
let _latestReactsObj = {};

function reactionEmoji(type){
  if(type === "love") return "‚ù§Ô∏è";
  if(type === "like") return "üëç";
  if(type === "haha") return "üòÇ";
  return "üëç";
}
function resetReactionButtons(){
  reactLove.classList.remove("selected");
  reactLike.classList.remove("selected");
  reactHaha.classList.remove("selected");
}
function selectReactionButton(type){
  resetReactionButtons();
  if(type === "love") reactLove.classList.add("selected");
  if(type === "like") reactLike.classList.add("selected");
  if(type === "haha") reactHaha.classList.add("selected");
}
function floatingReactionAnim(type){
  try{
    const el = document.createElement("div");
    el.className = "floatReaction " + (type || "");
    el.textContent = reactionEmoji(type);

    const btn = type==="love" ? reactLove : (type==="like" ? reactLike : reactHaha);
    const rect = btn.getBoundingClientRect();
    const vr = viewer.getBoundingClientRect();

    el.style.right = (vr.right - rect.right + 10) + "px";
    el.style.bottom = (vr.bottom - rect.bottom + 12) + "px";

    viewer.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 1000);
  }catch(e){}
}

async function reactToStory(type){
  try{
    if(precisaLogin()) return;
    const s = activeStories[current];
    if(!s || !s.id) return;
    if(s.uid === UID) return;

    unlockAudioOnce();
    floatingReactionAnim(type);

    const ref = DB.ref(`storyReactions/${s.id}/${UID}`);
    const snap = await ref.once("value");
    const cur = snap.val();

    if(cur && cur.type === type){
      await ref.remove();
      resetReactionButtons();
    }else{
      await ref.set({
        uid: UID,
        userName: USER_NAME,
        type: type,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      });
      selectReactionButton(type);
    }

    playActionSound();
  }catch(e){}
}

function detachReactionsListener(){
  try{
    if(reactionsRef){
      reactionsRef.off();
      reactionsRef = null;
    }
  }catch(e){}
}

/* ‚úÖ QUEM VIU */
function closeViewersPanel(){
  viewersPanelOpen = false;
  viewersPanel.style.display = "none";
  const ch = document.getElementById("seenChevron");
  if(ch) ch.className = "fa-solid fa-chevron-up";
}
function toggleViewersPanel(){
  if(!CAN_SEE_VIEWERS) return;
  viewersPanelOpen = !viewersPanelOpen;
  viewersPanel.style.display = viewersPanelOpen ? "block" : "none";
  const ch = document.getElementById("seenChevron");
  if(ch) ch.className = viewersPanelOpen ? "fa-solid fa-chevron-down" : "fa-solid fa-chevron-up";
}
function detachViewersListener(){
  try{
    if(viewersRef){
      viewersRef.off();
      viewersRef = null;
    }
  }catch(e){}
}

async function renderOwnerPanel(viewsObj, reactsObj){
  const views = viewsObj || {};
  const reacts = reactsObj || {};
  const map = new Map();

  Object.keys(views).forEach(uid=>{
    const v = views[uid];
    if(!v || !uid) return;
    map.set(uid, { uid, userName: v.userName || "Usu√°rio", viewedAt: v.viewedAt || 0, reactionType: null, reactedAt: 0 });
  });

  Object.keys(reacts).forEach(uid=>{
    const r = reacts[uid];
    if(!r || !uid) return;
    const cur = map.get(uid) || { uid, userName: r.userName || "Usu√°rio", viewedAt: 0, reactionType: null, reactedAt: 0 };
    cur.userName = r.userName || cur.userName || "Usu√°rio";
    cur.reactionType = r.type || null;
    cur.reactedAt = r.createdAt || 0;
    map.set(uid, cur);
  });

  const arr = Array.from(map.values()).sort((a,b)=>{
    const ta = Math.max(a.viewedAt||0, a.reactedAt||0);
    const tb = Math.max(b.viewedAt||0, b.reactedAt||0);
    return tb - ta;
  });

  const totalViews = Object.keys(views).length;
  if(totalViews === 0){
    seenText.textContent = "Ningu√©m viu ainda";
  }else{
    const viewArr = Object.keys(views).map(uid=>views[uid]).filter(Boolean).sort((a,b)=>(a.viewedAt||0)-(b.viewedAt||0));
    const first = viewArr[0]?.userName || "Algu√©m";
    if(totalViews === 1) seenText.textContent = `${first} viu este story`;
    else seenText.textContent = `${first} e mais ${totalViews-1} viram este story`;
  }

  if(!arr.length){
    viewersPanel.innerHTML = `<div style="padding:10px;opacity:.9;">Ningu√©m ainda.</div>`;
    return;
  }

  const rows = await Promise.all(arr.map(async u=>{
    const nome = (u.userName || "Usu√°rio");
    const prof = await getAvatarForUID(u.uid, nome);

    const ava = prof.url
      ? `<div style="width:36px;height:36px;border-radius:50%;overflow:hidden;border:1px solid rgba(255,255,255,.10);flex:0 0 auto;cursor:pointer;"
              onclick="openProfileModal('${escapeHTML(u.uid)}')">
           <img src="${prof.url}" style="width:100%;height:100%;object-fit:cover;display:block;" alt="avatar" loading="lazy">
         </div>`
      : `<div style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.10);color:var(--fb-text);font-weight:900;flex:0 0 auto;cursor:pointer;"
              onclick="openProfileModal('${escapeHTML(u.uid)}')">
           ${escapeHTML(initials(nome))}
         </div>`;

    const type = u.reactionType;
    const icon = type ? reactionEmoji(type) : "";
    const color = type==="love" ? "var(--fb-red)" : (type==="like" ? "var(--fb-blue)" : (type==="haha" ? "#F7B928" : "var(--fb-text)"));

    return `
      <div class="viewerRow" style="justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:10px;min-width:0;">
          ${ava}
          <div class="viewerName" style="max-width: 64vw;" onclick="openProfileModal('${escapeHTML(u.uid)}')">${escapeHTML(nome)}</div>
        </div>

        <div style="min-width:40px;display:flex;align-items:center;justify-content:flex-end;">
          ${type ? `<div style="font-size:20px;color:${color};">${icon}</div>` : `<div style="width:20px;height:20px;opacity:.15;">&nbsp;</div>`}
        </div>
      </div>
    `;
  }));

  viewersPanel.innerHTML = rows.join("");
}

async function markStoryView(story){
  try{
    if(!story || !story.id) return;
    if(precisaLogin()) return;
    if(story.uid === UID) return;
    await DB.ref(`storyViews/${story.id}/${UID}`).set({
      uid: UID,
      userName: USER_NAME,
      viewedAt: firebase.database.ServerValue.TIMESTAMP
    });
  }catch(e){}
}

function attachOwnerListeners(story){
  detachViewersListener();
  detachReactionsListener();
  closeViewersPanel();

  viewersPanel.innerHTML = `<div style="padding:10px;opacity:.9;">Carregando...</div>`;
  seenText.textContent = "Carregando visualiza√ß√µes...";

  if(!story || !story.id) return;

  _latestViewsObj = {};
  _latestReactsObj = {};

  viewersRef = DB.ref(`storyViews/${story.id}`);
  viewersRef.on("value", snap=>{
    _latestViewsObj = snap.val() || {};
    renderOwnerPanel(_latestViewsObj, _latestReactsObj);
  });

  reactionsRef = DB.ref(`storyReactions/${story.id}`);
  reactionsRef.on("value", snap=>{
    _latestReactsObj = snap.val() || {};
    renderOwnerPanel(_latestViewsObj, _latestReactsObj);
  });
}

/* VIEWER */
function openViewer(idx){
  current = idx;
  viewer.style.display = "flex";
  menuTop.classList.add("hide");
  showStory();
}
function closeViewer(){
  stopVideo();
  viewer.style.display = "none";
  deleteBtn.style.display = "none";
  menuTop.classList.remove("hide");
  clearTimeout(viewerTimer);
  viewerTimer = null;

  detachViewersListener();
  detachReactionsListener();
  closeViewersPanel();

  reactionBar.style.display = "none";
  resetReactionButtons();
}
function showStory(){
  clearTimeout(viewerTimer);
  viewerTimer = null;

  viewerMedia.innerHTML = "";
  bars.innerHTML = "";

  const total = activeStories.length;
  for(let i=0;i<total;i++){
    const bar = document.createElement("div");
    bar.className = "bar";
    const fill = document.createElement("div");
    fill.className = "barFill";
    bar.appendChild(fill);
    bars.appendChild(bar);
    if(i<current) fill.style.width="100%";
    if(i===current) fill.id="currentFill";
  }

  const s = activeStories[current];
  if(!s){ closeViewer(); return; }

  deleteBtn.style.display = "none";
  CAN_SEE_VIEWERS = (s.uid === UID);

  if(s.uid !== UID){
    reactionBar.style.display = "flex";
    resetReactionButtons();

    markStoryView(s);

    DB.ref(`storyReactions/${s.id}/${UID}`).once("value").then(sn=>{
      const v = sn.val();
      if(v && v.type) selectReactionButton(v.type);
      else resetReactionButtons();
    }).catch(()=>{});
  }else{
    reactionBar.style.display = "none";
    resetReactionButtons();
  }

  if(CAN_SEE_VIEWERS){
    viewerFooter.style.display = "block";
    attachOwnerListeners(s);
  }else{
    viewerFooter.style.display = "none";
    detachViewersListener();
    detachReactionsListener();
    closeViewersPanel();
  }

  if((s.type||"").includes("image")){
    const el = document.createElement("img");
    el.src = s.url;
    viewerMedia.appendChild(el);
    runProgress(120000);
    viewerTimer = setTimeout(()=>nextStory(), 120000);
  }else{
    const el = document.createElement("video");
    el.src = s.url;
    el.autoplay = true;

    /* ‚úÖ STORIES: TOCA COM SOM (exceto se r√°dio estiver tocando) */
    el.muted = radioPlaying ? true : false;
    el.volume = 1.0;
    el.controls = true;
    el.playsInline = true;
    el.setAttribute("playsinline","");
    el.setAttribute("webkit-playsinline","");
    el.preload = "metadata";

    el.onloadedmetadata = ()=>{
      const realDur = (el.duration||0)*1000;
      const dur = Math.min(realDur||6000, 120000);
      runProgress(dur);
      viewerTimer = setTimeout(()=>nextStory(), dur);
    };

    viewerMedia.appendChild(el);

    try{
      unlockAudioOnce();
      const p = el.play();
      if(p && p.catch){
        p.catch(()=>{
          try{
            el.muted = true;
            el.play().catch(()=>{});
          }catch(e){}
        });
      }
    }catch(e){}
  }
}
function runProgress(ms){
  const fill = document.getElementById("currentFill");
  if(!fill) return;
  fill.style.transition="none";
  fill.style.width="0";
  setTimeout(()=>{
    fill.style.transition = `width ${ms}ms linear`;
    fill.style.width="100%";
  }, 40);
}
function stopVideo(){
  const vid = viewerMedia.querySelector("video");
  if(vid){
    try{ vid.pause(); }catch(e){}
    try{ vid.currentTime = 0; }catch(e){}
    try{ vid.src = ""; }catch(e){}
  }
}
function nextStory(){
  stopVideo();
  current++;
  if(current >= activeStories.length) closeViewer();
  else showStory();
}
function prevStory(){
  if(current<=0) return;
  stopVideo();
  current--;
  showStory();
}
tapRight.onclick = nextStory;
tapLeft.onclick = prevStory;

dots.onclick = ()=>{ deleteBtn.style.display = (deleteBtn.style.display==="block" ? "none" : "block"); };
deleteBtn.onclick = async ()=>{
  const s = activeStories[current];
  if(!s) return;
  try{
    stopVideo();
    await DB.ref("stories/" + s.id).remove();
    await DB.ref("storyViews/" + s.id).remove().catch(()=>{});
    await DB.ref("storyReactions/" + s.id).remove().catch(()=>{});
    if(s.storagePath){
      await ST.ref().child(s.storagePath).delete().catch(()=>{});
    }
    playActionSound();
    if(current>0) current--;
    closeViewer();
  }catch(err){
    console.log(err);
    alert("Erro ao excluir story.");
  }
};

/* cards */
function renderCreateCard(){
  const card = document.createElement("div");
  card.className = "storyCard createCard";
  const inputId = "uploadStoryInput";
  card.innerHTML = `
    <div class="plusBtn">+</div>
    <div class="createLabel">Criar story</div>
    <input id="${inputId}" type="file" accept="image/*,video/*" style="display:none;">
  `;
  card.onclick = ()=>{
    if(precisaLogin()) return;
    document.getElementById(inputId).click();
  };
  setTimeout(()=>{
    const upload = document.getElementById(inputId);
    upload.onchange = e=>{
      if(precisaLogin()) return;
      const file = e.target.files[0];
      if(!file) return;
      if(!checkSize(file)) { upload.value=""; return; }
      addStory(file);
      upload.value = "";
    };
  }, 0);
  return card;
}
function buildSegRow(count){
  const max = Math.min(count, 12);
  return `
    <div class="segRow">
      ${Array.from({length:max}).map(()=>`<div class="seg"></div>`).join("")}
    </div>
  `;
}
function renderUserCard(group){
  const card = document.createElement("div");
  card.className = "storyCard";
  card.dataset.uid = group.uid;

  const cover = group.last;
  const uname = group.userName || "Usu√°rio";
  const segs = buildSegRow(group.items.length);

  let mediaHTML = "";
  if((cover.type||"").includes("image")){
    mediaHTML = `<img class="storyMedia" src="${cover.url}" alt="story" loading="lazy">`;
  }else{
    mediaHTML = `<video class="storyMedia" src="${cover.url}" autoplay muted loop playsinline preload="metadata"></video>`;
  }

  const avatarHTML = `
    <div class="avatarCircle"
         data-story-avatar-uid="${escapeHTML(group.uid)}"
         onclick="event.stopPropagation(); openProfileModal('${escapeHTML(group.uid)}')">
      <div class="avatarInitials">${escapeHTML(initials(uname))}</div>
    </div>
  `;

  card.innerHTML = `
    ${mediaHTML}
    <div class="storyShade"></div>
    ${segs}
    ${avatarHTML}
    <div class="storyName" data-story-name-uid="${escapeHTML(group.uid)}">${escapeHTML(uname)}</div>
  `;

  getAvatarForUID(group.uid, uname).then(({url, name})=>{
    updateStoryAvatarsInDOM(group.uid, url, name);
  });

  card.onclick = ()=>{
    if(group.items.length === 0) return;
    activeStories = group.items.slice().sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
    openViewer(0);
  };

  return card;
}
function renderStoriesRow(){
  const row = document.getElementById("storiesRow");
  row.innerHTML = "";

  row.appendChild(renderCreateCard());

  const myGroup = groupedStories.find(g => g.uid === UID);
  if(myGroup) row.appendChild(renderUserCard(myGroup));

  groupedStories
    .filter(g => g.uid !== UID)
    .sort((a,b)=>(b.last?.createdAt||0)-(a.last?.createdAt||0))
    .forEach(g => row.appendChild(renderUserCard(g)));
}
async function addStory(file){
  if(precisaLogin()) return;
  try{
    showLoading("Enviando story...", "Seu v√≠deo/foto vai aparecer j√° j√°");
    const storyId = "story_" + Date.now() + "_" + Math.random().toString(36).slice(2);
    const path = `stories/${UID}/${storyId}`;
    const ref = ST.ref().child(path);

    await ref.put(file, { contentType: file.type });
    const url = await ref.getDownloadURL();

    const data = {
      url,
      type: file.type,
      uid: UID,
      userName: USER_NAME,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      storagePath: path
    };

    await DB.ref("stories/" + storyId).set(data);
    playActionSound();
  }catch(err){
    console.log(err);
    alert("Erro ao enviar story.");
  }finally{
    hideLoading();
  }
}
(function listenStories(){
  const ref = DB.ref("stories").orderByChild("createdAt").limitToLast(500);
  ref.on("value", snap=>{
    const obj = snap.val() || {};
    allStories = Object.keys(obj).map(id=>({id, ...obj[id]}))
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    const map = {};
    allStories.forEach(s=>{
      if(!s.uid) return;
      if(!map[s.uid]) map[s.uid] = { uid:s.uid, userName:s.userName||"Usu√°rio", items:[] };
      map[s.uid].items.push(s);
      map[s.uid].userName = s.userName || map[s.uid].userName;
    });

    groupedStories = Object.values(map).map(g=>{
      const items = g.items.slice().sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
      return { uid:g.uid, userName:g.userName, items, last: items[items.length-1] };
    });

    renderStoriesRow();
  });
})();
</script>

<script>
/* ===================== ‚úÖ FEED (AUTO PLAY + V√çDEO ESTILO FACEBOOK) ===================== */
let __feedObserver = null;

function ensureFeedObserver(){
  if(__feedObserver) return;

  __feedObserver = new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      const v = entry.target;
      if(!v || v.tagName !== "VIDEO") return;

      if(entry.isIntersecting){
        try{
          if(!v.__srcSet){
            const ds = v.getAttribute("data-src");
            if(ds){
              v.src = ds;
              v.__srcSet = true;
              v.preload = "metadata";
              v.setAttribute("preload","metadata");
              v.setAttribute("fetchpriority","high");
              try{ v.load(); }catch(e){}
            }
          }
        }catch(e){}

        if(entry.intersectionRatio >= 0.25){
          try{
            if(v.__userUnmuted && audioUnlocked && !__radioLocksFeedAudio && !radioPlaying){
              v.muted = false;
              v.volume = 1.0;
              __lastUnmutedFeedVideo = v;
              if(v.__ui && v.__ui.soundIcon){
                v.__ui.soundIcon.className = "fa-solid fa-volume-high";
              }
            }else{
              v.muted = true;
              v.volume = 1.0;
              if(v.__ui && v.__ui.soundIcon){
                v.__ui.soundIcon.className = "fa-solid fa-volume-xmark";
              }
            }

            const p = v.play();
            if(p && p.catch) p.catch(()=>{
              try{
                v.muted = true;
                v.__userUnmuted = false;
                if(v.__ui && v.__ui.soundIcon){
                  v.__ui.soundIcon.className = "fa-solid fa-volume-xmark";
                }
                v.play().catch(()=>{});
              }catch(e){}
            });

            if(v.__ui && v.__ui.playBtn){
              v.__ui.playBtn.classList.toggle("show", v.paused);
            }
          }catch(e){}
        }
      }else{
        try{ v.pause(); }catch(e){}
        if(v.__ui && v.__ui.playBtn){
          v.__ui.playBtn.classList.add("show");
        }
      }
    });
  }, {
    threshold: [0, 0.10, 0.25, 0.60, 1],
    rootMargin: "900px 0px 900px 0px"
  });
}

function muteAllFeedVideosExcept(exceptVideo){
  document.querySelectorAll("#feed video[data-feedvideo='1']").forEach(v=>{
    if(v !== exceptVideo){
      try{
        v.__userUnmuted = false;
        v.muted = true;
        if(v.__ui && v.__ui.soundIcon){
          v.__ui.soundIcon.className = "fa-solid fa-volume-xmark";
        }
      }catch(e){}
    }
  });
}

/* ‚úÖ cria UI estilo Facebook em cima do v√≠deo */
function ensureFacebookVideoUI(v){
  try{
    if(!v) return;
    if(v.__uiCreated) return;
    v.__uiCreated = true;

    const shell = v.closest(".fbVideoShell");
    if(!shell) return;

    const ui = shell.querySelector(".fbVidUI");
    const soundBtn = shell.querySelector(".fbVidSoundBtn");
    const soundIcon = soundBtn ? soundBtn.querySelector("i") : null;
    const playBtn = shell.querySelector(".fbVidPlayBtn");
    const playIcon = playBtn ? playBtn.querySelector("i") : null;
    const progFill = shell.querySelector(".fbVidProgressFill");

    v.__ui = { ui, soundBtn, soundIcon, playBtn, playIcon, progFill };

    // estado inicial
    v.muted = true;
    v.__userUnmuted = false;
    if(soundIcon) soundIcon.className = "fa-solid fa-volume-xmark";
    if(playBtn) playBtn.classList.add("show");

    // click no v√≠deo = play/pause (igual Facebook)
    v.addEventListener("click", ()=>{
      try{
        if(v.paused){
          const p = v.play();
          if(p && p.catch) p.catch(()=>{});
        }else{
          v.pause();
        }
        if(playBtn) playBtn.classList.toggle("show", v.paused);
      }catch(e){}
    });

    // bot√£o central play/pause
    if(playBtn){
      playBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        try{
          if(v.paused){
            const p = v.play();
            if(p && p.catch) p.catch(()=>{});
          }else{
            v.pause();
          }
          playBtn.classList.toggle("show", v.paused);
        }catch(err){}
      });
    }

    // bot√£o som = mute/unmute (igual Facebook)
    if(soundBtn){
      soundBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        try{
          unlockAudioOnce();

          if(__radioLocksFeedAudio || radioPlaying){
            v.__userUnmuted = false;
            v.muted = true;
            v.volume = 1.0;
            if(soundIcon) soundIcon.className = "fa-solid fa-volume-xmark";
            return;
          }

          if(v.muted){
            muteAllFeedVideosExcept(v);
            v.__userUnmuted = true;
            v.muted = false;
            v.volume = 1.0;
            __lastUnmutedFeedVideo = v;
            if(soundIcon) soundIcon.className = "fa-solid fa-volume-high";

            if(!v.__srcSet){
              const ds = v.getAttribute("data-src");
              if(ds){
                v.src = ds;
                v.__srcSet = true;
                v.preload = "metadata";
                v.setAttribute("preload","metadata");
                v.setAttribute("fetchpriority","high");
                try{ v.load(); }catch(e){}
              }
            }
            const p = v.play();
            if(p && p.catch) p.catch(()=>{});
          }else{
            v.__userUnmuted = false;
            v.muted = true;
            if(soundIcon) soundIcon.className = "fa-solid fa-volume-xmark";
          }
        }catch(err){}
      });
    }

    // progresso
    v.addEventListener("timeupdate", ()=>{
      try{
        if(!progFill) return;
        const d = v.duration || 0;
        if(!d || !isFinite(d)) { progFill.style.width = "0%"; return; }
        const pct = Math.max(0, Math.min(100, (v.currentTime / d) * 100));
        progFill.style.width = pct.toFixed(2) + "%";
      }catch(e){}
    });

    v.addEventListener("play", ()=>{
      if(playBtn) playBtn.classList.remove("show");
    });
    v.addEventListener("pause", ()=>{
      if(playBtn) playBtn.classList.add("show");
    });
    v.addEventListener("ended", ()=>{
      try{
        if(progFill) progFill.style.width = "0%";
        if(playBtn) playBtn.classList.add("show");
      }catch(e){}
    });
  }catch(e){}
}

function setupOneFeedVideo(v){
  if(!v || v.__feedHooked) return;
  v.__feedHooked = true;

  ensureFeedObserver();

  try{
    v.__userUnmuted = false;
    v.muted = true;
    v.volume = 1.0;
    v.playsInline = true;
    v.setAttribute("playsinline","");
    v.setAttribute("webkit-playsinline","");
    v.loop = true;
    v.preload = "none";
    v.setAttribute("preload","none");
    v.setAttribute("data-feedvideo","1");

    // ‚úÖ Facebook-like: sem controls nativos
    v.controls = false;
    v.removeAttribute("controls");
  }catch(e){}

  // ‚úÖ garante UI overlay estilo Facebook
  ensureFacebookVideoUI(v);

  try{ __feedObserver.observe(v); }catch(e){}
}

function setupAllFeedVideos(){
  document.querySelectorAll("#feed video").forEach(setupOneFeedVideo);
}
</script>

<script>
/* ===================== FEED / MURAL ===================== */
let selectedFile = null;
let mode = "add";
let longPress = {};
let holdTimer = null;

const postsCache = new Set();
let renderQueue = [];
let pumping = false;

const postText = document.getElementById("postText");
const btnMain = document.getElementById("btnMain");
const fileInput = document.getElementById("fileInput");
const previewBox = document.getElementById("previewBox");
const previewContent = document.getElementById("previewContent");

function updateButton(){
  let t = postText.value.trim();
  if(t.length > 0){
    btnMain.className = "whatsapp-send";
    btnMain.innerHTML = "‚û§";
    mode = "postar";
  } else {
    btnMain.className = "add-btn";
    btnMain.innerHTML = "+";
    mode = "add";
  }
}
function buttonAction(){
  if(precisaLogin()) return;
  mode === "add" ? fileInput.click() : postarTexto();
}

let previewUrlToRevoke = null;

fileInput.onchange = e=>{
  if(precisaLogin()) return;
  selectedFile = e.target.files[0];
  if(!selectedFile) return;
  if(!checkSize(selectedFile)){ selectedFile=null; fileInput.value=""; return; }

  if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
  const url = URL.createObjectURL(selectedFile);
  previewUrlToRevoke = url;

  previewContent.innerHTML =
    selectedFile.type.startsWith("image/")
      ? `<img src="${url}" style="width:100%;border-radius:14px;display:block;" loading="lazy">`
      : `<video src="${url}" controls preload="metadata" playsinline style="width:100%;border-radius:14px;background:#000;display:block;"></video>`;
  previewBox.style.display = "block";
};

async function postarTexto(){
  if(precisaLogin()) return;
  const t = postText.value.trim();
  if(!t) return;
  showLoading("Publicando...", "Enviando para o mural");
  try{
    await criarPostFirebase(t, null, null, null);
    playActionSound();
    postText.value = "";
    updateButton();
  }finally{
    hideLoading();
  }
}

async function postar(){
  if(precisaLogin()) return;
  if(!selectedFile){
    alert("Selecione uma m√≠dia primeiro.");
    return;
  }

  const texto = postText.value || "";
  const file = selectedFile;

  const postId = "post_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  const localUrl = URL.createObjectURL(file);

  criarPostOptimista(postId, {
    text: texto,
    mediaUrl: localUrl,
    mediaType: file.type,
    uid: UID,
    userName: USER_NAME,
    createdAt: Date.now(),
    _pending: true
  });

  showLoading("Enviando m√≠dia...", "No celular pode demorar dependendo da internet");

  try{
    await criarPostFirebase(texto, file, file.type, postId);
    playActionSound();
  }catch(err){
    console.log(err);
    alert("Erro ao postar.");
    const el = document.getElementById(postId);
    if(el) el.remove();
    postsCache.delete(postId);
  }finally{
    hideLoading();

    selectedFile = null;
    postText.value = "";
    previewBox.style.display = "none";
    previewContent.innerHTML = "";
    if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
    updateButton();
  }
}

function removerPreview(){
  selectedFile = null;
  previewBox.style.display = "none";
  previewContent.innerHTML = "";
  if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
}

async function criarPostFirebase(texto, fileOrNull, fileTypeOrNull, forcedPostId){
  const postId = forcedPostId || ("post_" + Date.now() + "_" + Math.random().toString(36).slice(2));
  let mediaUrl = null;
  let mediaType = null;
  let storagePath = null;

  if(fileOrNull){
    mediaType = fileTypeOrNull || fileOrNull.type || "";
    storagePath = `posts/${UID}/${postId}`;
    const ref = ST.ref().child(storagePath);
    await ref.put(fileOrNull, { contentType: mediaType });
    mediaUrl = await ref.getDownloadURL();
  }

  const data = {
    text: (texto || "").toString(),
    mediaUrl,
    mediaType,
    uid: UID,
    userName: USER_NAME,
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    storagePath
  };

  await DB.ref("posts/" + postId).set(data);
  return postId;
}

/* ======= CURTIR / AMEI ======= */
function pressionarCurtir(id){
  longPress[id] = false;
  holdTimer = setTimeout(()=>{
    longPress[id] = true;
    amei(id);
  }, 500);
}
function soltarCurtir(){
  if(holdTimer) clearTimeout(holdTimer);
}

async function curtir(id){
  if(precisaLogin()) return;
  if(longPress[id]){ longPress[id] = false; return; }
  const likeRef = DB.ref(`likes/${id}/${UID}`);
  const snap = await likeRef.once("value");
  const cur = snap.val();
  if(cur) await likeRef.remove();
  else await likeRef.set({ type:"like", uid:UID, userName:USER_NAME, createdAt: firebase.database.ServerValue.TIMESTAMP });
  playActionSound();
}
async function amei(id){
  if(precisaLogin()) return;
  const likeRef = DB.ref(`likes/${id}/${UID}`);
  const snap = await likeRef.once("value");
  const cur = snap.val();
  if(cur && cur.type === "love") await likeRef.remove();
  else await likeRef.set({ type:"love", uid:UID, userName:USER_NAME, createdAt: firebase.database.ServerValue.TIMESTAMP });
  playActionSound();
}

function atualizarCurtidasUI(postId, likesObj){
  const btn = document.getElementById("curtir_"+postId);
  const cont = document.getElementById("contadorCurtidas_"+postId);
  if(!btn || !cont) return;

  const likes = likesObj || {};
  const entries = Object.values(likes);
  const total = entries.length;
  const my = likes[UID];

  if(my){
    if(my.type === "love"){
      btn.textContent = "‚ù§Ô∏è Voc√™ amou";
      btn.style.color = "var(--fb-red)";
    }else{
      btn.textContent = "üëç Voc√™ curtiu";
      btn.style.color = "var(--fb-text)";
    }
  }else{
    btn.textContent = "üëç Curtir";
    btn.style.color = "var(--fb-text)";
  }

  if(total === 0){ cont.innerHTML = ""; return; }

  const sorted = entries.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
  const nomes = sorted.map(x => (x.uid === UID ? "Voc√™" : (x.userName || "Usu√°rio")));
  cont.innerHTML = `Curtidas (${total}): <b>${nomes.map(escapeHTML).join(", ")}</b>`;
}

/* ‚úÖ toggle coment√°rios */
const commentCloseHandlers = {};
function fecharComentarios(id){
  const box = document.getElementById("comentarios_"+id);
  if(!box) return;
  box.style.display = "none";
  if(commentCloseHandlers[id]){
    document.removeEventListener("click", commentCloseHandlers[id]);
    delete commentCloseHandlers[id];
  }
}
function abrirComentarios(id){
  const box = document.getElementById("comentarios_"+id);
  if(!box) return;

  if(box.style.display === "block"){
    fecharComentarios(id);
    return;
  }

  box.style.display = "block";

  if(commentCloseHandlers[id]){
    document.removeEventListener("click", commentCloseHandlers[id]);
    delete commentCloseHandlers[id];
  }

  const handler = (e)=>{
    const insideBox = box.contains(e.target);
    const clickedButton = e.target.closest(".btn-action");
    const clickedMenu = e.target.closest(".coment-menu-btn") || e.target.closest(".coment-menu-box");
    if(!insideBox && !clickedButton && !clickedMenu){
      fecharComentarios(id);
    }
  };
  commentCloseHandlers[id] = handler;
  setTimeout(()=> document.addEventListener("click", handler), 50);
}

async function enviarComentario(id){
  if(precisaLogin()) return;
  const input = document.getElementById("comentarioInput_"+id);
  if(!input) return;
  const texto = input.value.trim();
  if(!texto) return;

  const commentId = "cmt_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  await DB.ref(`comments/${id}/${commentId}`).set({
    uid: UID,
    userName: USER_NAME,
    text: texto,
    createdAt: firebase.database.ServerValue.TIMESTAMP
  });
  input.value = "";
  playActionSound();
}

function toggleComentMenu(cid){
  const menu = document.getElementById("menu_"+cid);
  if(!menu) return;
  menu.style.display = (menu.style.display==="block" ? "none" : "block");
}
async function excluirComentario(cid, postId){
  await DB.ref(`comments/${postId}/${cid}`).remove();
  playActionSound();
}

function toggleMenu(id){
  let m = document.getElementById("menu_"+id);
  if(!m) return;
  m.style.display = (m.style.display==="block" ? "none" : "block");
}

async function excluirPost(id){
  const snap = await DB.ref("posts/" + id).once("value");
  const data = snap.val();

  await DB.ref("posts/" + id).remove();
  await DB.ref("likes/" + id).remove().catch(()=>{});
  await DB.ref("comments/" + id).remove().catch(()=>{});

  if(data && data.storagePath){
    await ST.ref().child(data.storagePath).delete().catch(()=>{});
  }

  const el = document.getElementById(id);
  if(el) el.remove();
  postsCache.delete(id);

  ensureConnectionsSection();
  playActionSound();
}

/* ===================== HTML DO POST ===================== */
function postHTML(id, postData, avatarUrl){
  let midia = "";
  if(postData.mediaUrl){
    const isImg = (postData.mediaType || "").startsWith("image/");
    midia = isImg
      ? `<img src="${postData.mediaUrl}" loading="lazy">`
      : `
        <div class="fbVideoShell">
          <video
            class="fbFeedVideo"
            data-src="${escapeHTML(postData.mediaUrl)}"
            muted
            loop
            preload="none"
            playsinline
            webkit-playsinline></video>

          <div class="fbVidUI">
            <div class="fbVidProgress"><div class="fbVidProgressFill"></div></div>
            <button class="fbVidSoundBtn" type="button" aria-label="Som">
              <i class="fa-solid fa-volume-xmark"></i>
            </button>
            <button class="fbVidPlayBtn show" type="button" aria-label="Play/Pause">
              <i class="fa-solid fa-play"></i>
            </button>
          </div>
        </div>
      `;
  }

  const texto = escapeHTML(postData.text || "");
  const when = postData.createdAt ? fmtDate(postData.createdAt) : "";
  const pending = postData._pending ? `<span class="pendingBadge">ENVIANDO‚Ä¶</span>` : "";

  const uid = postData.uid || "";
  const uname = postData.userName || "Usu√°rio";

  const avatarHTML = `
    <div class="postAvatar" data-avatar-uid="${escapeHTML(uid)}" onclick="openProfileModal('${escapeHTML(uid)}')">
      ${avatarUrl
        ? `<img src="${avatarUrl}" alt="avatar" loading="lazy">`
        : `<div class="init">${escapeHTML(initials(uname))}</div>`}
    </div>
  `;

  return `
  <div class="post" id="${id}" ${postData._pending ? 'data-pending="1"' : ''}>
    <div class="menu-btn" onclick="toggleMenu('${id}')">‚ãÆ</div>
    <div class="menu-box" id="menu_${id}">
      <div onclick="excluirPost('${id}')">Excluir</div>
    </div>

    <div class="postHead">
      ${avatarHTML}
      <div class="postHeadText">
        <div class="postNameLine">
          <div class="postName" data-name-uid="${escapeHTML(uid)}" onclick="openProfileModal('${escapeHTML(uid)}')">${escapeHTML(uname)}</div>
          ${pending}
        </div>
        <div class="postWhen">${escapeHTML(when)}</div>
      </div>
    </div>

    <p>${texto}</p>

    <div class="mediaWrap" id="mediaWrap_${id}">
      ${midia}
    </div>

    <div class="post-actions">
      <div style="text-align:center; min-width:160px;">
        <div class="btn-action"
          id="curtir_${id}"
          onmousedown="pressionarCurtir('${id}')"
          onmouseup="soltarCurtir()"
          ontouchstart="pressionarCurtir('${id}')"
          ontouchend="soltarCurtir()"
          onclick="curtir('${id}')">
          üëç Curtir
        </div>
        <div class="contador" id="contadorCurtidas_${id}"></div>
      </div>

      <div style="text-align:center; min-width:160px;">
        <div class="btn-action" onclick="abrirComentarios('${id}')">üí¨ Comentar</div>
        <div class="contador" id="contadorComentarios_${id}"></div>
      </div>
    </div>

    <div class="coment-area" id="comentarios_${id}">
      <div id="listaComentarios_${id}" style="margin-bottom:12px;"></div>

      <input type="text" id="comentarioInput_${id}"
        placeholder="Escreva um coment√°rio..."
        style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#3A3B3C;color:var(--fb-text);outline:none;">

      <button onclick="enviarComentario('${id}')"
        style="margin-top:8px;background:var(--fb-blue);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:900;">
        Enviar
      </button>
    </div>
  </div>
  `;
}

/* ===================== RENDER OTIMISTA / LISTENERS ===================== */
function criarPostOptimista(id, postData){
  if(postsCache.has(id)) return;
  postsCache.add(id);
  longPress[id] = false;

  const feed = document.getElementById("feed");
  const temp = document.createElement("div");

  const uid = postData.uid || "";
  getAvatarForUID(uid, postData.userName || "Usu√°rio").then(({url, name})=>{
    temp.innerHTML = postHTML(id, postData, url).trim();
    feed.prepend(temp.firstChild);

    ensureConnectionsSection();

    listenLikes(id);
    listenComments(id);
    updateAvatarsInDOM(uid, url, name);

    setupAllFeedVideos();
  });
}

function atualizarPostDoServidor(id, data){
  const el = document.getElementById(id);
  if(!el) return;

  const nameEl = el.querySelector(`[data-name-uid]`);
  if(nameEl) nameEl.textContent = data.userName || "Usu√°rio";

  const whenEl = el.querySelector(".postWhen");
  if(whenEl && data.createdAt) whenEl.textContent = fmtDate(data.createdAt);

  const p = el.querySelector("p");
  if(p) p.textContent = (data.text || "");

  const wrap = document.getElementById("mediaWrap_"+id);
  if(wrap){
    if(data.mediaUrl){
      const isImg = (data.mediaType||"").startsWith("image/");
      wrap.innerHTML = isImg
        ? `<img src="${data.mediaUrl}" loading="lazy">`
        : `
          <div class="fbVideoShell">
            <video
              class="fbFeedVideo"
              data-src="${escapeHTML(data.mediaUrl)}"
              muted
              loop
              preload="none"
              playsinline
              webkit-playsinline></video>

            <div class="fbVidUI">
              <div class="fbVidProgress"><div class="fbVidProgressFill"></div></div>
              <button class="fbVidSoundBtn" type="button" aria-label="Som">
                <i class="fa-solid fa-volume-xmark"></i>
              </button>
              <button class="fbVidPlayBtn show" type="button" aria-label="Play/Pause">
                <i class="fa-solid fa-play"></i>
              </button>
            </div>
          </div>
        `;
    }else{
      wrap.innerHTML = "";
    }
  }

  el.removeAttribute("data-pending");
  ensureConnectionsSection();
  setupAllFeedVideos();
}

function listenLikes(postId){
  DB.ref("likes/" + postId).on("value", snap=>{
    atualizarCurtidasUI(postId, snap.val() || {});
  });
}
function listenComments(postId){
  DB.ref("comments/" + postId).orderByChild("createdAt").on("value", async snap=>{
    const lista = document.getElementById("listaComentarios_"+postId);
    const contador = document.getElementById("contadorComentarios_"+postId);
    if(!lista || !contador) return;

    const obj = snap.val() || {};
    const arr = Object.keys(obj).map(cid=>({ cid, ...obj[cid] }))
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    const htmls = await Promise.all(arr.map(async c=>{
      const nome = (c.userName || "Usu√°rio");
      const txt = escapeHTML(c.text || "");
      const prof = await getAvatarForUID(c.uid, nome);

      const ava = prof.url
        ? `<div class="cAvatar" data-avatar-uid="${escapeHTML(c.uid)}" onclick="openProfileModal('${escapeHTML(c.uid)}')"><img src="${prof.url}" alt="avatar" loading="lazy"></div>`
        : `<div class="cAvatar" data-avatar-uid="${escapeHTML(c.uid)}" onclick="openProfileModal('${escapeHTML(c.uid)}')"><div class="init">${escapeHTML(initials(nome))}</div></div>`;

      return `
        <div id="${c.cid}" class="cRow">
          <div class="cHead">
            ${ava}
            <div class="cName" data-name-uid="${escapeHTML(c.uid)}" onclick="openProfileModal('${escapeHTML(c.uid)}')">${escapeHTML(nome)}</div>
          </div>
          <div class="cText">üí¨ ${txt}</div>

          <span class="coment-menu-btn" onclick="toggleComentMenu('${c.cid}')">‚ãÆ</span>
          <div class="coment-menu-box" id="menu_${c.cid}"
            onclick="excluirComentario('${c.cid}','${postId}')">
            Excluir
          </div>
        </div>
      `;
    }));

    lista.innerHTML = htmls.join("");

    const total = arr.length;
    if(total === 0) contador.innerHTML = "";
    else if(total === 1) contador.innerHTML = "1 coment√°rio";
    else contador.innerHTML = `${total} coment√°rios`;
  });
}

(function listenPostsFast(){
  const ref = DB.ref("posts").orderByChild("createdAt").limitToLast(200);

  ref.on("child_added", async snap=>{
    const id = snap.key;
    const data = snap.val() || {};

    const existing = document.getElementById(id);
    if(existing){
      atualizarPostDoServidor(id, data);
      const prof = await getAvatarForUID(data.uid, data.userName);
      updateAvatarsInDOM(data.uid, prof.url, prof.name);
      return;
    }

    if(postsCache.has(id)) return;
    renderQueue.push({ id, data });
    pumpRenderQueue();
  });

  ref.on("child_removed", snap=>{
    const id = snap.key;
    postsCache.delete(id);
    const el = document.getElementById(id);
    if(el) el.remove();
    ensureConnectionsSection();
  });
})();

function pumpRenderQueue(){
  if(pumping) return;
  pumping = true;

  const step = async ()=>{
    let n = 0;
    while(renderQueue.length && n < 6){
      const it = renderQueue.shift();
      if(!postsCache.has(it.id)){
        postsCache.add(it.id);

        const prof = await getAvatarForUID(it.data.uid, it.data.userName || "Usu√°rio");

        const feed = document.getElementById("feed");
        const temp = document.createElement("div");
        temp.innerHTML = postHTML(it.id, it.data, prof.url).trim();
        feed.prepend(temp.firstChild);

        listenLikes(it.id);
        listenComments(it.id);

        updateAvatarsInDOM(it.data.uid, prof.url, prof.name);

        ensureConnectionsSection();
        setupAllFeedVideos();
      }
      n++;
    }
    if(renderQueue.length){
      requestAnimationFrame(()=>step());
    }else{
      pumping = false;
      ensureConnectionsSection();
      setupAllFeedVideos();
    }
  };
  requestAnimationFrame(()=>step());
}

updateButton();
setupAllFeedVideos();

/* ‚úÖ se r√°dio desligar e o usu√°rio rolar, tenta restaurar √°udio do v√≠deo que estava com som */
window.addEventListener("scroll", ()=>{
  if(!radioPlaying && !__radioLocksFeedAudio){
    restoreFeedVideoAudioIfPossible();
  }
}, { passive:true });
</script>

</body>
</html>
