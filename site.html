<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Menu + Stories + Feed (Estilo Facebook 2025)</title>

<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
<link rel="preconnect" href="https://coletivo-f34d4-default-rtdb.firebaseio.com" crossorigin>
<link rel="preconnect" href="https://i.ibb.co" crossorigin>

<link rel="preconnect" href="https://stream.zeno.fm" crossorigin>
<link rel="dns-prefetch" href="//stream.zeno.fm">

<link rel="dns-prefetch" href="//www.gstatic.com">
<link rel="dns-prefetch" href="//firebasestorage.googleapis.com">
<link rel="dns-prefetch" href="//coletivo-f34d4-default-rtdb.firebaseio.com">
<link rel="dns-prefetch" href="//i.ibb.co">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  *{ box-sizing: border-box; }
  html, body{ width:100%; max-width:100%; overflow-x:hidden; }
  body{
    margin:0;
    background:#18191A;
    font-family: Arial, sans-serif;
    color:#E4E6EB;
    padding-bottom: env(safe-area-inset-bottom);
  }

  :root{
    --fb-bg: #18191A;
    --fb-surface: #242526;
    --fb-surface-2: #2D2E30;
    --fb-border: rgba(255,255,255,.10);
    --fb-text: #E4E6EB;
    --fb-muted: rgba(228,230,235,.72);
    --fb-blue: #0866FF;
    --fb-blue-2:#1877F2;
    --fb-green:#31A24C;
    --fb-red:#F02849;
    --fb-shadow: 0 8px 18px rgba(0,0,0,.35);
    --fb-radius: 16px;
  }

  .logo-bar{
    width:100%;
    background: var(--fb-surface);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--fb-border);
    position: sticky;
    top: 0;
    z-index: 9999;
  }
  .logo-left{ display:flex; align-items:center; gap:12px; min-width:0; }
  .logo-left img{
    width: clamp(160px, 52vw, 360px);
    height:auto;
    max-height: 60px;
    object-fit: contain;
    display:block;
  }

  .msgBtn{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;
    width:44px;
    height:44px;
    background: var(--fb-surface-2);
    border: 1px solid var(--fb-border);
    border-radius: 999px;
    outline:none;
    padding:0;
    box-shadow: 0 6px 14px rgba(0,0,0,.25);
  }
  .msgBtn i{
    font-size: 20px;
    color: var(--fb-text);
    line-height:1;
  }
  .msgBadge{
    position:absolute;
    top: -6px;
    right: -6px;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    border-radius: 999px;
    background: var(--fb-red);
    color: #fff;
    font-weight: 900;
    font-size: 12px;
    display:none;
    align-items:center;
    justify-content:center;
    border: 2px solid var(--fb-surface);
  }

  @media(max-width:480px){
    .logo-left img{ max-height: 54px; }
  }

  .top-menu{
    width: 100%;
    background: var(--fb-surface);
    padding: 8px 8px;
    display: flex;
    justify-content: center;
    gap: 10px;
    align-items: stretch;
    border-bottom: 1px solid var(--fb-border);
    position: sticky;
    top: 66px;
    z-index: 9998;
  }
  .top-menu.hide{ display:none !important; }

  .top-menu a{
    width: 66px;
    min-width: 66px;
    height: 58px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap: 6px;
    border-radius: 14px;
    background: transparent;
    border: 1px solid transparent;
    color: var(--fb-text);
    text-decoration:none;
    transition: .15s ease;
    position: relative;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .top-menu a:hover{
    background: rgba(255,255,255,.06);
    border-color: rgba(255,255,255,.08);
  }
  .top-menu a:active{ transform: scale(.98); }
  .top-menu a i{ font-size: 24px; color: var(--fb-text); line-height:1; }

  .menuLabel{
    font-size: 11px;
    font-weight: 900;
    color: rgba(228,230,235,.88);
    line-height:1;
    letter-spacing:.2px;
    width: 100%;
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    padding: 0 2px;
  }

  @media(max-width:380px){
    .top-menu{ gap: 8px; padding: 8px 6px; top: 64px; }
    .top-menu a{ width: 62px; min-width:62px; height: 56px; border-radius: 14px; }
    .top-menu a i{ font-size: 23px; }
    .menuLabel{ font-size: 10.5px; }
  }
  @media(max-width:330px){
    .top-menu a{ width: 58px; min-width:58px; }
    .top-menu a i{ font-size: 22px; }
    .menuLabel{ font-size: 10px; }
  }

  .create-post{
    background: var(--fb-surface);
    margin: 12px 12px 10px 12px;
    padding: 12px;
    border-radius: var(--fb-radius);
    border: 1px solid var(--fb-border);
    display:flex;
    gap:10px;
    align-items:center;
    box-shadow: var(--fb-shadow);
  }
  .input-box{
    flex:1;
    min-width: 0;
    background: #3A3B3C;
    padding: 12px 14px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.08);
    color: var(--fb-text);
    font-size: 15px;
    outline:none;
  }
  .input-box::placeholder{ color: rgba(228,230,235,.65); }

  .add-btn{
    background: #3A3B3C;
    border: 1px solid rgba(255,255,255,.10);
    color: var(--fb-text);
    width:44px;
    height:44px;
    border-radius: 999px;
    font-size:22px;
    font-weight:bold;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:.15s;
    flex: 0 0 auto;
  }
  .add-btn:hover{ background: rgba(255,255,255,.08); }

  .whatsapp-send{
    width:44px; height:44px;
    background: var(--fb-blue);
    border-radius: 999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    color:#fff;
    cursor:pointer;
    transition:.15s;
    border: 1px solid rgba(255,255,255,.08);
    flex: 0 0 auto;
  }
  .whatsapp-send:hover{ filter: brightness(1.03); }

  #fileInput{display:none;}

  .preview{
    margin:0 12px 10px 12px;
    padding: 12px;
    background: var(--fb-surface);
    border: 1px solid var(--fb-border);
    border-radius: var(--fb-radius);
    box-shadow: var(--fb-shadow);
    display:none;
  }

  .stories-wrapper{ padding: 2px 10px 6px 10px; }
  .stories-row{
    display:flex;
    gap: 12px;
    overflow-x:auto;
    padding: 8px 2px 10px 2px;
    -webkit-overflow-scrolling: touch;
    align-items: stretch;
  }
  .stories-row::-webkit-scrollbar{ height:6px; }
  .stories-row::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius:999px; }

  .post{
    background: var(--fb-surface);
    margin: 10px 12px;
    padding: 12px;
    border-radius: var(--fb-radius);
    border:1px solid var(--fb-border);
    box-shadow: var(--fb-shadow);
    position:relative;
    content-visibility: auto;
    contain-intrinsic-size: 700px;
  }
  .postHead{ display:flex; align-items:center; gap:10px; padding-right:44px; }
  .postAvatar{
    width:42px; height:42px;
    border-radius:50%;
    overflow:hidden;
    background:#3A3B3C;
    border: 1px solid rgba(255,255,255,.08);
    flex:0 0 auto;
    display:flex; align-items:center; justify-content:center;
  }
  .postAvatar img{ width:100%; height:100%; object-fit: cover; display:block; }
  .postAvatar .init{ font-weight:900; color: var(--fb-text); }

  .postHeadText{ min-width:0; }
  .postNameLine{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .postName{
    font-weight:900;
    font-size:15px;
    color: var(--fb-text);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 62vw;
    cursor:pointer;
  }
  .postWhen{ font-size:12px; color: var(--fb-muted); margin-top:3px; }
  .post p{ margin:10px 0 0 0; font-size:14px; line-height:1.35; color: rgba(228,230,235,.95); }

  .post .mediaWrap{ position:relative; }
  .post .mediaWrap img,
  .post .mediaWrap video{
    width:100%;
    border-radius: 14px;
    margin-top:10px;
    background:#000;
    display:block;
    border:1px solid rgba(255,255,255,.08);
  }

  .menu-btn{
    position: absolute;
    top: 10px;
    right: 10px;
    width: 36px; height: 36px;
    border-radius: 10px;
    display:flex; align-items:center; justify-content:center;
    font-size: 18px;
    cursor: pointer;
    color: rgba(255,255,255,.90);
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.08);
    user-select:none;
    z-index: 10;
  }
  .menu-box{
    position: absolute;
    top: 52px;
    right: 10px;
    background: #FFFFFF;
    color: #111;
    padding: 8px 10px;
    border-radius: 12px;
    display: none;
    cursor: pointer;
    font-weight: 900;
    box-shadow: 0 12px 24px rgba(0,0,0,.35);
    z-index: 15;
    min-width: 120px;
  }
  .menu-box div{ padding: 8px 6px; border-radius: 10px; }
  .menu-box div:hover{ background: rgba(0,0,0,.06); }

  .loadingOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.78);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 99999999;
    padding: 18px;
  }
  .loadingCard{
    width: min(520px, 92vw);
    background: var(--fb-surface);
    border:1px solid var(--fb-border);
    border-radius: 18px;
    box-shadow: var(--fb-shadow);
    padding:18px;
    text-align:center;
  }
  .spinner{
    width:46px;height:46px;border-radius:50%;
    border:4px solid rgba(255,255,255,.14);
    border-top-color: var(--fb-blue);
    margin:0 auto 10px auto;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg);} }
  .loadingText{ color: var(--fb-text); font-weight:900; letter-spacing:.4px; }
  .loadingSub{ margin-top:6px; color: var(--fb-text); opacity:.85; font-size:14px; }

  .pendingBadge{
    display:inline-block;
    margin-left:8px;
    padding:4px 10px;
    border-radius:999px;
    background: rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.12);
    color: var(--fb-text);
    font-size:12px;
    font-weight:900;
  }

  .profileModal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.90);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 999999999;
    padding: 14px;
  }
  .profileModalCard{
    width: min(820px, 96vw);
    height: min(86vh, 720px);
    background: var(--fb-surface);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: var(--fb-shadow);
    border-radius: 18px;
    overflow:hidden;
    position:relative;
  }
  .profileModalTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding: 12px 12px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.15);
  }
  .profileModalTitle{
    font-weight: 900;
    color: var(--fb-text);
    display:flex;
    align-items:center;
    gap:10px;
    letter-spacing:.4px;
  }
  .profileModalTitle i{ color: var(--fb-blue); }
  .profileModalClose{
    border:none;
    border-radius: 12px;
    padding: 10px 12px;
    font-weight: 900;
    cursor:pointer;
    background: var(--fb-blue);
    color:#fff;
    box-shadow: 0 10px 20px rgba(0,0,0,.22);
  }
  .profileModalFrame{
    width:100%;
    height: calc(100% - 54px);
    border:0;
    display:block;
    background:#000;
  }

  .actionsRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding: 10px 12px;
    margin-top: 10px;
    border-top: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.02);
    border-radius: 14px;
  }
  .leftActions{
    display:flex;
    align-items:center;
    gap: 14px;
    min-width:0;
  }
  .actionBtn{
    display:flex;
    align-items:center;
    gap:10px;
    cursor:pointer;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
    padding: 10px 10px;
    border-radius: 12px;
    transition:.12s ease;
    border: 1px solid transparent;
    background: transparent;
    color: var(--fb-text);
    min-width: 90px;
    justify-content:flex-start;
  }
  .actionBtn:hover{
    background: rgba(255,255,255,.06);
    border-color: rgba(255,255,255,.06);
  }
  .actionBtn:active{ transform: scale(.99); }
  .actionIcon{
    font-size: 22px;
    width: 26px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .count{
    font-size: 16px;
    font-weight: 900;
    color: rgba(228,230,235,.92);
    min-width: 22px;
  }
  .actionBtn.liked,
  .actionBtn.liked .count{
    color: var(--fb-blue);
  }

  .rightReacts{
    display:flex;
    align-items:center;
    gap: 8px;
    cursor:pointer;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
  }
  .reactBubble{
    width:26px;height:26px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    font-size:16px;
    background:#111;
    border:1px solid rgba(255,255,255,.10);
  }
  .reactBubble.like{ background: rgba(8,102,255,.18); }
  .reactBubble.love{ background: rgba(240,40,73,.16); }
  .reactBubble.haha{ background: rgba(247,185,40,.14); }

  .reactMenu{
    position: fixed;
    left: 0; top: 0;
    transform: translate(-9999px, -9999px);
    display:flex;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 999px;
    background: rgba(36,37,38,.96);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: 0 16px 30px rgba(0,0,0,.45);
    z-index: 999999;
    opacity: 0;
    pointer-events:none;
    transition: opacity .10s ease;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .reactMenu.show{
    opacity: 1;
    pointer-events:auto;
  }
  .reactPick{
    width:44px;height:44px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    cursor:pointer;
    font-size: 22px;
    transition: transform .10s ease;
    user-select:none;
  }
  .reactPick:active{ transform: scale(.92); }
  .reactPick:hover{ transform: translateY(-2px); }

  @media(max-width:420px){
    .actionBtn{ min-width: 82px; padding: 10px 8px; }
    .count{ font-size: 15px; }
    .actionIcon{ font-size: 21px; }
    .rightReacts{ padding: 8px 8px; }
    .reactBubble{ width:24px;height:24px; font-size:15px; }
  }
</style>
</head>

<body>

<div class="loadingOverlay" id="loadingOverlay">
  <div class="loadingCard">
    <div class="spinner"></div>
    <div class="loadingText" id="loadingText">Enviando...</div>
    <div class="loadingSub" id="loadingSub">Aguarde um instante</div>
  </div>
</div>

<div class="profileModal" id="profileModal">
  <div class="profileModalCard">
    <div class="profileModalTop">
      <div class="profileModalTitle"><i class="fa-solid fa-id-card"></i> Pr√©via do Perfil</div>
      <button class="profileModalClose" onclick="closeProfileModal()">Fechar</button>
    </div>
    <iframe class="profileModalFrame" id="profileFrame" src="about:blank"></iframe>
  </div>
</div>

<div class="logo-bar">
  <div class="logo-left">
    <img src="https://i.ibb.co/hxk9T5FC/Design-sem-nome.png" alt="Logo" loading="eager" fetchpriority="high">
  </div>

  <button class="msgBtn" id="msgBtn" title="Bate-papo" aria-label="Bate-papo">
    <i class="fa-brands fa-facebook-messenger"></i>
    <span class="msgBadge" id="msgBadge">0</span>
  </button>
</div>

<nav class="top-menu" aria-label="Menu principal">
  <a href="https://marcio2307.github.io/terreiro/estudo.html" title="Estudo" aria-label="Estudo">
    <i class="fa-solid fa-book"></i>
    <div class="menuLabel">Estudo</div>
  </a>

  <a href="https://marcio2307.github.io/terreiro/chat.html" title="Servi√ßos" aria-label="Servi√ßos">
    <i class="fa-solid fa-store"></i>
    <div class="menuLabel">Servi√ßos</div>
  </a>

  <a href="https://marcio2307.github.io/terreiro/sala.html" title="Mem√≥rias" aria-label="Mem√≥rias">
    <i class="fa-solid fa-images"></i>
    <div class="menuLabel">Mem√≥rias</div>
  </a>

  <a href="#" id="radioBtn" title="R√°dio" aria-label="R√°dio">
    <i class="fa-solid fa-radio" id="radioIcon"></i>
    <div class="menuLabel">R√°dio</div>
  </a>

  <a href="https://marcio2307.github.io/terreiro/perfil.html" title="Perfil" aria-label="Perfil">
    <i class="fa-solid fa-user"></i>
    <div class="menuLabel">Perfil</div>
  </a>
</nav>

<div class="create-post">
  <input type="text" id="postText" class="input-box" placeholder="No que voc√™ est√° pensando?" oninput="updateButton()">
  <div class="add-btn" id="btnMain" onclick="buttonAction()">+</div>
  <input type="file" id="fileInput" accept="image/*,video/*">
</div>

<div class="preview" id="previewBox">
  <h3 style="margin:0 0 10px 0;">Pr√©via da m√≠dia</h3>
  <div id="previewContent"></div>

  <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
    <button onclick="removerPreview()"
      style="width:100%;padding:14px;font-size:16px;font-weight:900;border:none;border-radius:14px;background:var(--fb-red);color:#fff;cursor:pointer;">
      Excluir m√≠dia
    </button>

    <button onclick="postar()"
      style="width:100%;padding:14px;font-size:16px;font-weight:900;border:none;border-radius:14px;background:var(--fb-blue);color:#fff;cursor:pointer;">
      Publicar
    </button>
  </div>
</div>

<div class="stories-wrapper">
  <div class="stories-row" id="storiesRow"></div>
</div>

<div id="feed"></div>

<div class="reactMenu" id="reactMenu" aria-label="Rea√ß√µes">
  <div class="reactPick" data-react="like"  title="Curtir">üëç</div>
  <div class="reactPick" data-react="love"  title="Amei">‚ù§Ô∏è</div>
  <div class="reactPick" data-react="haha"  title="Haha">üòÇ</div>
  <div class="reactPick" data-react="sad"   title="Choro">üò¢</div>
  <div class="reactPick" data-react="angry" title="Raiva">üò°</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
const LOGIN_URL = "https://marcio2307.github.io/terreiro/entrar.html";
const SITE_URL  = "https://marcio2307.github.io/terreiro/site.html";
const PREVIEW_URL = "https://marcio2307.github.io/terreiro/previa.html";
const CHAT_URL = "https://marcio2307.github.io/terreiro/batepapo.html";

const COMMENTS_URL = "https://marcio2307.github.io/terreiro/comentarios.html";
const REACTS_URL   = "https://marcio2307.github.io/terreiro/rea√ß√£o.html";

function normalizeNameKey(name){
  return (name || "")
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9\s]/g, "")
    .replace(/\s+/g, " ")
    .trim()
    .replace(/\s/g, "_");
}
function mustBeLogged(){
  const u = (localStorage.getItem("nome_passageiro") || "").trim();
  if(!u){
    location.replace(LOGIN_URL);
    return null;
  }
  return u;
}

const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();
const ST = firebase.storage();

const ACTION_SOUND_URL = "som.mp3";
const actionSfx = new Audio(ACTION_SOUND_URL);
actionSfx.preload = "auto";
actionSfx.volume = 1.0;

const CHAT_SOUND_URL = "somm.mp3";
const chatSfx = new Audio(CHAT_SOUND_URL);
chatSfx.preload = "auto";
chatSfx.volume = 1.0;

let audioUnlocked = false;
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  try{
    actionSfx.muted = false;
    chatSfx.muted = false;

    const p1 = actionSfx.play();
    if(p1 && p1.then) p1.then(()=>{ actionSfx.pause(); actionSfx.currentTime = 0; }).catch(()=>{});
    else { actionSfx.pause(); actionSfx.currentTime = 0; }

    const p2 = chatSfx.play();
    if(p2 && p2.then) p2.then(()=>{ chatSfx.pause(); chatSfx.currentTime = 0; }).catch(()=>{});
    else { chatSfx.pause(); chatSfx.currentTime = 0; }
  }catch(e){}
}
document.addEventListener("touchstart", unlockAudioOnce, { once:true, passive:true });
document.addEventListener("click", unlockAudioOnce, { once:true });
document.addEventListener("pointerdown", unlockAudioOnce, { once:true, passive:true });
document.addEventListener("keydown", unlockAudioOnce, { once:true });

function playActionSound(){
  try{ actionSfx.pause(); actionSfx.currentTime = 0; actionSfx.play().catch(()=>{}); }catch(e){}
}
function playChatSound(){
  try{ chatSfx.pause(); chatSfx.currentTime = 0; chatSfx.play().catch(()=>{}); }catch(e){}
}
</script>

<script>
function getOrCreateDeviceUID(){
  let uid = localStorage.getItem("uid_passageiro");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem("uid_passageiro", uid);
  }
  sessionStorage.setItem("uid_passageiro", uid);
  return uid;
}

let USER_NAME = mustBeLogged();
if(!USER_NAME){ throw new Error("Not logged"); }

const nameKey = normalizeNameKey(USER_NAME);
let UID = localStorage.getItem("uid_user_" + nameKey) || localStorage.getItem("uid_passageiro") || getOrCreateDeviceUID();
localStorage.setItem("uid_user_" + nameKey, UID);
localStorage.setItem("uid_passageiro", UID);
sessionStorage.setItem("uid_passageiro", UID);

(async function syncUidWithFirebase(){
  try{
    const ref = DB.ref("usernames/" + nameKey);
    const snap = await ref.once("value");
    const remoteUid = snap.val();
    if(remoteUid && typeof remoteUid === "string" && remoteUid.length > 5){
      if(remoteUid !== UID){
        UID = remoteUid;
        localStorage.setItem("uid_user_" + nameKey, UID);
        localStorage.setItem("uid_passageiro", UID);
        sessionStorage.setItem("uid_passageiro", UID);
        location.reload();
        return;
      }
    }else{
      await ref.set(UID);
    }
  }catch(e){}
})();

function escapeHTML(str){
  str = (str == null ? "" : String(str));
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}

const profileModal = document.getElementById("profileModal");
const profileFrame = document.getElementById("profileFrame");
function openProfileModal(uid){
  if(!uid) return;
  const back = encodeURIComponent(window.location.href);
  profileFrame.src = `${PREVIEW_URL}?uid=${encodeURIComponent(uid)}&back=${back}`;
  profileModal.style.display = "flex";
  document.body.style.overflow = "hidden";
}
function closeProfileModal(){
  profileModal.style.display = "none";
  document.body.style.overflow = "";
  profileFrame.src = "about:blank";
}
profileModal.addEventListener("click", (e)=>{
  if(e.target === profileModal) closeProfileModal();
});

const MAX_IMG_MB = 15;
const MAX_VID_MB = 120;
function checkSize(file){
  const mb = file.size/(1024*1024);
  if(file.type.startsWith("image/") && mb>MAX_IMG_MB){
    alert(`Imagem muito grande (${mb.toFixed(1)}MB). Envie at√© ${MAX_IMG_MB}MB.`);
    return false;
  }
  if(file.type.startsWith("video/") && mb>MAX_VID_MB){
    alert(`V√≠deo muito grande (${mb.toFixed(1)}MB). Envie at√© ${MAX_VID_MB}MB.`);
    return false;
  }
  return true;
}

const loadingOverlay = document.getElementById("loadingOverlay");
const loadingText = document.getElementById("loadingText");
const loadingSub  = document.getElementById("loadingSub");
function showLoading(title, sub){
  loadingText.textContent = title || "Enviando...";
  loadingSub.textContent = sub || "Aguarde um instante";
  loadingOverlay.style.display = "flex";
}
function hideLoading(){ loadingOverlay.style.display = "none"; }
</script>

<script>
const profileCache = new Map();
function PROFILE_REF(uid){ return DB.ref("profiles/" + uid); }

async function getAvatarForUID(uid, fallbackName){
  if(!uid) return { url:"", name: fallbackName || "Usu√°rio" };
  if(profileCache.has(uid)) return profileCache.get(uid);

  try{
    const snap = await PROFILE_REF(uid).once("value");
    const p = snap.val() || {};
    const name = p.name || fallbackName || "Usu√°rio";
    const url = p.avatarDataUrl || p.avatarUrl || "";
    const obj = { url, name };
    profileCache.set(uid, obj);

    PROFILE_REF(uid).on("value", s=>{
      const px = s.val() || {};
      const nn = px.name || name;
      const uu = px.avatarDataUrl || px.avatarUrl || "";
      profileCache.set(uid, { url: uu, name: nn });
      updateAvatarsInDOM(uid, uu, nn);
    });

    return obj;
  }catch(e){
    const obj = { url:"", name: fallbackName || "Usu√°rio" };
    profileCache.set(uid, obj);
    return obj;
  }
}
function updateAvatarsInDOM(uid, url, name){
  document.querySelectorAll(`[data-avatar-uid="${uid}"]`).forEach(el=>{
    if(url) el.innerHTML = `<img src="${url}" alt="avatar" loading="lazy">`;
    else el.innerHTML = `<div class="init">${(initials(name||"U"))}</div>`;
  });
  document.querySelectorAll(`[data-name-uid="${uid}"]`).forEach(el=>{
    el.textContent = name || "Usu√°rio";
  });
}
</script>

<script>
const ROOM_ID = "global";
const CHAT_MSG_PATH = `groupChat/${ROOM_ID}/messages`;

const msgBtn = document.getElementById("msgBtn");
const msgBadge = document.getElementById("msgBadge");

let unread = 0;
let firstChatLoadDone = false;
const chatRendered = new Set();

function renderBadge(){
  if(unread <= 0){
    msgBadge.style.display = "none";
    msgBadge.textContent = "0";
    return;
  }
  msgBadge.style.display = "inline-flex";
  msgBadge.textContent = unread > 99 ? "99+" : String(unread);
}
function clearUnread(){
  unread = 0;
  renderBadge();
  try{ localStorage.setItem("chat_unread_count", "0"); }catch(e){}
}
function incUnread(){
  unread++;
  renderBadge();
  try{ localStorage.setItem("chat_unread_count", String(unread)); }catch(e){}
}
(function loadUnread(){
  try{
    const v = parseInt(localStorage.getItem("chat_unread_count")||"0", 10);
    unread = isNaN(v) ? 0 : v;
    renderBadge();
  }catch(e){}
})();
msgBtn.addEventListener("click", ()=>{
  unlockAudioOnce();
  clearUnread();
  window.location.href = CHAT_URL;
});
(function listenChatNotifications(){
  const ref = DB.ref(CHAT_MSG_PATH).orderByChild("createdAt").limitToLast(200);
  ref.on("child_added", (snap)=>{
    const m = snap.val() || {};
    const id = m.id || snap.key;
    if(!id) return;
    if(chatRendered.has(id)) return;
    chatRendered.add(id);

    if(firstChatLoadDone){
      if(m.uid && m.uid !== UID){
        incUnread();
        playChatSound();
      }
    }else{
      clearTimeout(window.__chatFirstLoadTimer);
      window.__chatFirstLoadTimer = setTimeout(()=>{ firstChatLoadDone = true; }, 900);
    }
  });
})();
</script>

<script>
let selectedFile = null;
let mode = "add";

const postsCache = new Set();
let renderQueue = [];
let pumping = false;

const postText = document.getElementById("postText");
const btnMain = document.getElementById("btnMain");
const fileInput = document.getElementById("fileInput");
const previewBox = document.getElementById("previewBox");
const previewContent = document.getElementById("previewContent");

function updateButton(){
  let t = postText.value.trim();
  if(t.length > 0){
    btnMain.className = "whatsapp-send";
    btnMain.innerHTML = "‚û§";
    mode = "postar";
  } else {
    btnMain.className = "add-btn";
    btnMain.innerHTML = "+";
    mode = "add";
  }
}
function buttonAction(){
  mode === "add" ? fileInput.click() : postarTexto();
}

let previewUrlToRevoke = null;

fileInput.onchange = e=>{
  selectedFile = e.target.files[0];
  if(!selectedFile) return;
  if(!checkSize(selectedFile)){ selectedFile=null; fileInput.value=""; return; }

  if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
  const url = URL.createObjectURL(selectedFile);
  previewUrlToRevoke = url;

  previewContent.innerHTML =
    selectedFile.type.startsWith("image/")
      ? `<img src="${url}" style="width:100%;border-radius:14px;display:block;" loading="lazy">`
      : `<video src="${url}" controls preload="metadata" playsinline style="width:100%;border-radius:14px;background:#000;display:block;"></video>`;
  previewBox.style.display = "block";
};

async function postarTexto(){
  const t = postText.value.trim();
  if(!t) return;
  showLoading("Publicando...", "Enviando para o mural");
  try{
    await criarPostFirebase(t, null, null, null);
    playActionSound();
    postText.value = "";
    updateButton();
  }finally{
    hideLoading();
  }
}

async function postar(){
  if(!selectedFile){
    alert("Selecione uma m√≠dia primeiro.");
    return;
  }

  const texto = postText.value || "";
  const file = selectedFile;

  const postId = "post_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  const localUrl = URL.createObjectURL(file);

  criarPostOptimista(postId, {
    postId,
    text: texto,
    mediaUrl: localUrl,
    mediaType: file.type,
    uid: UID,
    userName: USER_NAME,
    createdAt: Date.now(),
    _pending: true
  });

  showLoading("Enviando m√≠dia...", "No celular pode demorar dependendo da internet");

  try{
    await criarPostFirebase(texto, file, file.type, postId);
    playActionSound();
  }catch(err){
    console.log(err);
    alert("Erro ao postar.");
    const el = document.getElementById(postId);
    if(el) el.remove();
    postsCache.delete(postId);
  }finally{
    hideLoading();
    selectedFile = null;
    postText.value = "";
    previewBox.style.display = "none";
    previewContent.innerHTML = "";
    if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
    updateButton();
  }
}

function removerPreview(){
  selectedFile = null;
  previewBox.style.display = "none";
  previewContent.innerHTML = "";
  if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
}

/* ‚úÖ AQUI: salva postId dentro do post */
async function criarPostFirebase(texto, fileOrNull, fileTypeOrNull, forcedPostId){
  const postId = forcedPostId || ("post_" + Date.now() + "_" + Math.random().toString(36).slice(2));
  let mediaUrl = null;
  let mediaType = null;
  let storagePath = null;

  if(fileOrNull){
    mediaType = fileTypeOrNull || fileOrNull.type || "";
    storagePath = `posts/${UID}/${postId}`;
    const ref = ST.ref().child(storagePath);
    await ref.put(fileOrNull, { contentType: mediaType });
    mediaUrl = await ref.getDownloadURL();
  }

  const data = {
    postId, /* ‚úÖ ID dentro do post */
    text: (texto || "").toString(),
    mediaUrl,
    mediaType,
    uid: UID,
    userName: USER_NAME,
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    storagePath
  };

  await DB.ref("posts/" + postId).set(data);
  return postId;
}

function toggleMenu(id){
  let m = document.getElementById("menu_"+id);
  if(!m) return;
  m.style.display = (m.style.display==="block" ? "none" : "block");
}

async function excluirPost(id){
  const snap = await DB.ref("posts/" + id).once("value");
  const data = snap.val();

  if(data && data.uid && data.uid !== UID){
    alert("Voc√™ s√≥ pode excluir suas pr√≥prias postagens.");
    return;
  }

  await DB.ref("posts/" + id).remove();
  await DB.ref("likes/" + id).remove().catch(()=>{});
  await DB.ref("comments/" + id).remove().catch(()=>{});

  if(data && data.storagePath){
    await ST.ref().child(data.storagePath).delete().catch(()=>{});
  }

  const el = document.getElementById(id);
  if(el) el.remove();
  postsCache.delete(id);
  playActionSound();
}

function postHTML(id, postData, avatarUrl){
  let midia = "";
  if(postData.mediaUrl){
    const isImg = (postData.mediaType || "").startsWith("image/");
    midia = isImg
      ? `<img src="${postData.mediaUrl}" loading="lazy">`
      : `<video src="${escapeHTML(postData.mediaUrl)}" controls muted playsinline webkit-playsinline></video>`;
  }

  const texto = escapeHTML(postData.text || "");
  const when = postData.createdAt ? fmtDate(postData.createdAt) : "";
  const pending = postData._pending ? `<span class="pendingBadge">ENVIANDO‚Ä¶</span>` : "";

  const uid = postData.uid || "";
  const uname = postData.userName || "Usu√°rio";

  const isMine = (uid === UID);

  const avatarHTML = `
    <div class="postAvatar" data-avatar-uid="${escapeHTML(uid)}" onclick="openProfileModal('${escapeHTML(uid)}')">
      ${avatarUrl
        ? `<img src="${avatarUrl}" alt="avatar" loading="lazy">`
        : `<div class="init">${escapeHTML(initials(uname))}</div>`}
    </div>
  `;

  const postMenuHTML = isMine ? `
    <div class="menu-btn" onclick="toggleMenu('${id}')">‚ãÆ</div>
    <div class="menu-box" id="menu_${id}">
      <div onclick="excluirPost('${id}')">Excluir</div>
    </div>
  ` : "";

  return `
  <div class="post" id="${id}" ${postData._pending ? 'data-pending="1"' : ''}>
    ${postMenuHTML}

    <div class="postHead">
      ${avatarHTML}
      <div class="postHeadText">
        <div class="postNameLine">
          <div class="postName" data-name-uid="${escapeHTML(uid)}" onclick="openProfileModal('${escapeHTML(uid)}')">${escapeHTML(uname)}</div>
          ${pending}
        </div>
        <div class="postWhen">${escapeHTML(when)}</div>
      </div>
    </div>

    <p>${texto}</p>

    <div class="mediaWrap" id="mediaWrap_${id}">
      ${midia}
    </div>

    <div class="actionsRow">
      <div class="leftActions">
        <button class="actionBtn" type="button" data-like-btn="1" data-post="${id}">
          <span class="actionIcon">üëç</span>
          <span class="count" id="likeCount_${id}">0</span>
        </button>

        <button class="actionBtn" type="button" data-comment-btn="1" data-post="${id}">
          <span class="actionIcon"><i class="fa-regular fa-comment"></i></span>
          <span class="count" id="commentCount_${id}">0</span>
        </button>
      </div>

      <div class="rightReacts" data-reacts-open="1" data-post="${id}" title="Ver rea√ß√µes">
        <div class="reactBubble like">üëç</div>
        <div class="reactBubble love">‚ù§Ô∏è</div>
        <div class="reactBubble haha">üòÇ</div>
      </div>
    </div>
  </div>
  `;
}

function criarPostOptimista(id, postData){
  if(postsCache.has(id)) return;
  postsCache.add(id);

  const feed = document.getElementById("feed");
  const temp = document.createElement("div");

  const uid = postData.uid || "";
  getAvatarForUID(uid, postData.userName || "Usu√°rio").then(({url, name})=>{
    temp.innerHTML = postHTML(id, postData, url).trim();
    feed.prepend(temp.firstChild);

    listenLikes(id);
    listenComments(id);
    updateAvatarsInDOM(uid, url, name);
  });
}

function atualizarPostDoServidor(id, data){
  const el = document.getElementById(id);
  if(!el) return;

  const nameEl = el.querySelector(`[data-name-uid]`);
  if(nameEl) nameEl.textContent = data.userName || "Usu√°rio";

  const whenEl = el.querySelector(".postWhen");
  if(whenEl && data.createdAt) whenEl.textContent = fmtDate(data.createdAt);

  const p = el.querySelector("p");
  if(p) p.textContent = (data.text || "");

  const wrap = document.getElementById("mediaWrap_"+id);
  if(wrap){
    if(data.mediaUrl){
      const isImg = (data.mediaType||"").startsWith("image/");
      wrap.innerHTML = isImg
        ? `<img src="${data.mediaUrl}" loading="lazy">`
        : `<video src="${escapeHTML(data.mediaUrl)}" controls muted playsinline webkit-playsinline></video>`;
    }else{
      wrap.innerHTML = "";
    }
  }

  el.removeAttribute("data-pending");
}

const reactMenu = document.getElementById("reactMenu");
let holdTimer2 = null;
let holdingPostId = null;
let holdingBtnEl = null;

/* ‚úÖ Amei = ‚ù§Ô∏è (cora√ß√£o) */
function reactionToEmoji(type){
  if(type === "love") return "‚ù§Ô∏è";
  if(type === "haha") return "üòÇ";
  if(type === "sad")  return "üò¢";
  if(type === "angry")return "üò°";
  return "üëç";
}

function closeReactMenu(){
  reactMenu.classList.remove("show");
  reactMenu.style.transform = "translate(-9999px, -9999px)";
  holdingPostId = null;
  holdingBtnEl = null;
}
function openReactMenuNearButton(btnEl, postId){
  holdingPostId = postId;
  holdingBtnEl = btnEl;

  const r = btnEl.getBoundingClientRect();
  const menuW = reactMenu.offsetWidth || 320;

  let x = Math.max(10, Math.min(window.innerWidth - menuW - 10, r.left + (r.width/2) - (menuW/2)));
  let y = r.top - 64;
  if(y < 10) y = r.bottom + 12;

  reactMenu.style.transform = `translate(${x}px, ${y}px)`;
  reactMenu.classList.add("show");
}

async function setReaction(postId, type){
  try{
    unlockAudioOnce();
    const likeRef = DB.ref(`likes/${postId}/${UID}`);
    const snap = await likeRef.once("value");
    const cur = snap.val();
    if(cur && cur.type === type){
      await likeRef.remove();
    }else{
      await likeRef.set({
        type,
        uid: UID,
        userName: USER_NAME,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      });
    }
    playActionSound();
  }catch(e){}
}
async function toggleLike(postId){ await setReaction(postId, "like"); }

function updateActionsUI(postId, likesObj){
  const btn = document.querySelector(`[data-like-btn="1"][data-post="${postId}"]`);
  const countEl = document.getElementById("likeCount_" + postId);
  if(!btn || !countEl) return;

  const likes = likesObj || {};
  const entries = Object.values(likes).filter(Boolean);
  const total = entries.length;
  const mine = likes[UID];

  countEl.textContent = String(total);

  if(mine){
    btn.classList.add("liked");
    btn.querySelector(".actionIcon").textContent = reactionToEmoji(mine.type || "like");
    /* ‚úÖ tooltip pra mostrar Amei */
    const t = mine.type === "love" ? "Amei" : mine.type === "haha" ? "Haha" : mine.type === "sad" ? "Triste" : mine.type === "angry" ? "Grr" : "Curtir";
    btn.title = t;
    btn.setAttribute("aria-label", t);
  }else{
    btn.classList.remove("liked");
    btn.querySelector(".actionIcon").textContent = "üëç";
    btn.title = "Curtir";
    btn.setAttribute("aria-label", "Curtir");
  }

  const freq = {};
  entries.forEach(x=>{
    const t = (x.type || "like");
    freq[t] = (freq[t] || 0) + 1;
  });
  const order = Object.keys(freq).sort((a,b)=>freq[b]-freq[a]).slice(0,3);
  const bubbles = document.querySelector(`[data-reacts-open="1"][data-post="${postId}"]`);
  if(bubbles){
    const base = order.length ? order : ["like","love","haha"];
    bubbles.innerHTML = base.slice(0,3).map(t=>{
      const cls = t==="love"?"love":t==="haha"?"haha":"like";
      const em = reactionToEmoji(t);
      return `<div class="reactBubble ${cls}">${em}</div>`;
    }).join("");
  }
}

function updateCommentCountUI(postId, commentsObj){
  const countEl = document.getElementById("commentCount_" + postId);
  if(!countEl) return;
  const obj = commentsObj || {};
  countEl.textContent = String(Object.keys(obj).length);
}

function listenLikes(postId){
  DB.ref("likes/" + postId).on("value", snap=>{
    updateActionsUI(postId, snap.val() || {});
  });
}
function listenComments(postId){
  DB.ref("comments/" + postId).on("value", snap=>{
    updateCommentCountUI(postId, snap.val() || {});
  });
}

document.addEventListener("click", (e)=>{
  const likeBtn = e.target.closest('[data-like-btn="1"]');
  if(likeBtn){
    if(likeBtn.__skipNextClick){
      likeBtn.__skipNextClick = false;
      return;
    }
    const postId = likeBtn.getAttribute("data-post");
    toggleLike(postId);
    return;
  }

  const cBtn = e.target.closest('[data-comment-btn="1"]');
  if(cBtn){
    const postId = cBtn.getAttribute("data-post");
    window.location.href = COMMENTS_URL + "?post=" + encodeURIComponent(postId);
    return;
  }

  const rOpen = e.target.closest('[data-reacts-open="1"]');
  if(rOpen){
    const postId = rOpen.getAttribute("data-post");
    window.location.href = REACTS_URL + "?post=" + encodeURIComponent(postId);
    return;
  }

  if(!e.target.closest("#reactMenu")) closeReactMenu();
});

document.addEventListener("pointerdown", (e)=>{
  const likeBtn = e.target.closest('[data-like-btn="1"]');
  if(!likeBtn) return;
  const postId = likeBtn.getAttribute("data-post");

  clearTimeout(holdTimer2);
  holdTimer2 = setTimeout(()=>{
    likeBtn.__skipNextClick = true;
    openReactMenuNearButton(likeBtn, postId);
  }, 420);
}, { passive:true });

function endHold2(){
  clearTimeout(holdTimer2);
  holdTimer2 = null;
}
document.addEventListener("pointerup", endHold2, { passive:true });
document.addEventListener("pointercancel", endHold2, { passive:true });
document.addEventListener("touchend", endHold2, { passive:true });

reactMenu.addEventListener("click", async (e)=>{
  const pick = e.target.closest(".reactPick");
  if(!pick || !holdingPostId) return;
  const type = pick.getAttribute("data-react");
  await setReaction(holdingPostId, type);
  closeReactMenu();
});

document.addEventListener("scroll", closeReactMenu, { passive:true });
window.addEventListener("resize", closeReactMenu);

(function listenPostsFast(){
  const ref = DB.ref("posts").orderByChild("createdAt").limitToLast(200);

  ref.on("child_added", async snap=>{
    const id = snap.key;
    const data = snap.val() || {};
    const postId = data.postId || id; /* ‚úÖ garante */

    const existing = document.getElementById(id);
    if(existing){
      atualizarPostDoServidor(id, data);
      const prof = await getAvatarForUID(data.uid, data.userName);
      updateAvatarsInDOM(data.uid, prof.url, prof.name);
      return;
    }

    if(postsCache.has(id)) return;

    /* ‚úÖ garante que a UI use postId correto */
    data.postId = postId;

    renderQueue.push({ id, data });
    pumpRenderQueue();
  });

  ref.on("child_removed", snap=>{
    const id = snap.key;
    postsCache.delete(id);
    const el = document.getElementById(id);
    if(el) el.remove();
  });
})();

function pumpRenderQueue(){
  if(pumping) return;
  pumping = true;

  const step = async ()=>{
    let n = 0;
    while(renderQueue.length && n < 6){
      const it = renderQueue.shift();
      if(!postsCache.has(it.id)){
        postsCache.add(it.id);

        const prof = await getAvatarForUID(it.data.uid, it.data.userName || "Usu√°rio");

        const feed = document.getElementById("feed");
        const temp = document.createElement("div");
        temp.innerHTML = postHTML(it.id, it.data, prof.url).trim();
        feed.prepend(temp.firstChild);

        listenLikes(it.id);
        listenComments(it.id);

        updateAvatarsInDOM(it.data.uid, prof.url, prof.name);
      }
      n++;
    }
    if(renderQueue.length){
      requestAnimationFrame(()=>step());
    }else{
      pumping = false;
    }
  };
  requestAnimationFrame(()=>step());
}

updateButton();
</script>

</body>
</html>
