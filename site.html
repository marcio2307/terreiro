<!DOCTYPE html>  
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mural Público</title>

<style>

html, body {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden !important;
}

* {
    box-sizing: border-box;
    overflow-x: hidden;
}

body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', sans-serif;

    background: url("https://i.pinimg.com/736x/66/fd/b6/66fdb6ca7dbf683dd3161325a9883510.jpg") no-repeat center center fixed !important;
    background-size: cover !important;

    color: #b9ffce;
    text-align: center;
}

@media (max-width: 600px) {
    #loginBox img,
    #cadastroBox img {
        height: 95px;
    }

    #loginBox input,
    #cadastroBox input {
        max-width: 92%;
        padding: 11px;
        font-size: 0.95rem;
    }

    #loginBox button,
    #cadastroBox button {
        max-width: 92%;
        padding: 12px;
        font-size: 1rem;
    }

    .topbar {
        padding: 10px;
        flex-direction: row;
        justify-content: space-between;
    }

    .radio-btn {
        width: 48px;
        height: 48px;
        font-size: 1.4rem;
    }

    #menuIcon {
        font-size: 2rem;
    }

    #sideMenu {
        width: 200px;
        padding-left: 15px;
    }

    .main-logo img {
        height: 85px;
        margin-top: 10px;
    }

    .feed {
        width: 96%;
        margin: 10px auto;
    }

    .post-box {
        padding: 14px;
        flex-direction: column;
        align-items: stretch;
    }

    .post-box textarea {
        height: 60px;
        font-size: 1rem;
    }

    .img-icon img {
        height: 32px;
        margin-top: 10px;
    }

    .preview img,
    .preview video {
        max-height: 130px;
    }

    .post {
        padding: 14px;
    }

    .post img,
    .post video {
        max-height: 280px;
    }

    .actions {
        flex-direction: column;
        gap: 12px;
        text-align: center;
    }

    .comment-entry {
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
    }

    button {
        font-size: 1rem;
        padding: 12px;
    }
}

#loginBox,
#cadastroBox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.90);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 999999;
}

#cadastroBox {
    display: none;
}

#loginBox img,
#cadastroBox img {
    height: 120px;
    margin-bottom: 20px;
}

#loginBox input,
#cadastroBox input {
    width: 80%;
    max-width: 260px;
    padding: 12px;
    border-radius: 10px;
    border: none;
    outline: none;
    font-size: 1rem;
    margin-bottom: 10px;
}

#loginBox button,
#cadastroBox button {
    width: 80%;
    max-width: 260px;
    padding: 13px;
    background: #00ffaa;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    cursor: pointer;
    font-weight: bold;
}

#cadastroLink,
#voltarLogin {
    color: #00ffaa;
    margin-top: 15px;
    cursor: pointer;
    font-weight: bold;
}

.topbar {
    width: 100%;
    background: rgba(0, 0, 0, 0.90);
    padding: 12px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 9999;
    box-shadow: 0 0 15px #00ffcc;
}

.radio-btn {
    background: #000;
    color: #fff;
    width: 55px;
    height: 55px;
    border-radius: 50%;
    font-size: 1.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 12px #00ffcc;
    cursor: pointer;
}

#menuIcon {
    font-size: 2.3rem;
    color: #00ffcc;
    cursor: pointer;
    font-weight: bold;
    margin-right: 5px;
}

#sideMenu {
    position: fixed;
    top: 0;
    right: -260px;
    width: 240px;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    padding-top: 80px;
    padding-left: 25px;
    display: flex;
    flex-direction: column;
    gap: 25px;
    transition: 0.4s;
    z-index: 10000;
    box-shadow: -3px 0 18px #00ffcc;
}

#sideMenu a,
#sideMenu div {
    color: #00ffcc;
    text-decoration: none;
    font-size: 1.3rem;
    font-weight: bold;
    cursor: pointer;
}

#sideMenu a:hover,
#sideMenu div:hover {
    color: #ffffff;
}

.main-logo img {
    height: 110px;
}

.feed {
    width: 95%;
    max-width: 650px;
    margin: 15px auto;
    padding: 5px;
}

.post-box {
    background: rgba(0, 0, 0, 0.65);
    border-radius: 30px;
    padding: 16px;
    border: 1px solid rgba(0, 255, 150, 0.25);
    display: flex;
    align-items: center;
    gap: 12px;
}

.post-box textarea {
    width: 100%;
    padding: 12px 15px;
    border-radius: 25px;
    border: none;
    background: rgba(255, 255, 255, 0.10);
    color: #fff;
    resize: none;
    height: 40px;
}

.img-icon img {
    height: 26px;
    cursor: pointer;
}

#imgUpload {
    display: none;
}

.preview img,
.preview video {
    width: 100%;
    max-height: 150px;
    border-radius: 12px;
    margin-top: 12px;
    object-fit: cover;
}

.remove-preview {
    background: #ff5555;
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 5px;
}

button {
    width: 100%;
    padding: 12px;
    background: #00ffaa;
    border: none;
    border-radius: 10px;
    margin-top: 10px;
    font-size: 1.05rem;
    font-weight: bold;
    cursor: pointer;
}

.post {
    background: rgba(0, 0, 0, 0.65);
    padding: 16px;
    border-radius: 15px;
    border: 1px solid rgba(0, 255, 150, 0.30);
    margin-bottom: 25px;
    text-align: left;
}

.post img,
.post video {
    width: 100%;
    max-height: 400px;
    border-radius: 12px;
    cursor: pointer;
}

.reaction-count,
.comment-count {
    text-align: left;
    font-weight: bold;
    margin-bottom: 10px;
    cursor: pointer;
    color: #aaffcc;
}

.actions {
    display: flex;
    justify-content: space-around;
    margin-top: 5px;
    border-top: 1px solid #004422;
    padding-top: 10px;
}

.actions div {
    cursor: pointer;
    color: #00ffaa;
    font-weight: bold;
}

.comment-list {
    background: rgba(255, 255, 255, 0.10);
    border-radius: 10px;
    margin-top: 10px;
    padding: 10px;
    display: none;
}

.comment-entry {
    padding: 10px;
    background: rgba(0, 0, 0, 0.35);
    border-radius: 10px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    color: #ddffe8;
}

.comment-box textarea {
    width: 100%;
    resize: none;
    border-radius: 12px;
    padding: 10px;
    border: none;
    background: rgba(0, 0, 0, 0.45);
    color: white;
}

#imgModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.90);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 99999;
}

#imgModal img {
    max-width: 95%;
    max-height: 90%;
    border-radius: 12px;
}

#closeModal {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 2.5rem;
    cursor: pointer;
}

</style>
</head>
<body>
<script type="module">

/* --------------------------
       IMPORTS FIREBASE
--------------------------- */
import { initializeApp }
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

import { getDatabase, ref, get, set }
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

import { getStorage, ref as sRef, uploadBytes, getDownloadURL }
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

/* --------------------------
      CONFIGURAÇÃO FIREBASE
--------------------------- */
const firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.appspot.com",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

/* --------------------------
      VARIÁVEL GLOBAL
--------------------------- */
let usuario = null;

/* --------------------------
      VERIFICAR LOGIN
--------------------------- */
window.addEventListener("DOMContentLoaded", async () => {

    const logado = localStorage.getItem("usuarioLogado");

    if (!logado) {
        loginBox.style.display = "flex";
        document.body.style.overflow = "hidden";
        return;
    }

    usuario = logado;

    // CARREGAR DADOS DO USUÁRIO NO FIREBASE
    const userRef = ref(db, "usuarios/" + usuario);
    const snap = await get(userRef);

    if (!snap.exists()) {
        localStorage.removeItem("usuarioLogado");
        loginBox.style.display = "flex";
        return;
    }

    const dados = snap.val();

    // FOTO DO STORAGE
    perfilFoto.src = dados.foto || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    nomeUsuarioMenu.textContent = usuario;

    loginBox.style.display = "none";
    document.body.style.overflow = "auto";
});

/* --------------------------
      ABRIR E FECHAR CADASTRO
--------------------------- */
window.abrirCadastro = function () {
    loginBox.style.display = "none";
    cadastroBox.style.display = "flex";
};

window.fecharCadastro = function () {
    cadastroBox.style.display = "none";
    loginBox.style.display = "flex";
};

/* --------------------------
         CADASTRAR
--------------------------- */
window.cadastrar = async function () {

    const user = cadUser.value.trim();
    const pass = cadPass.value.trim();

    if (user.length < 2 || pass.length < 2) {
        alert("Preencha usuário e senha.");
        return;
    }

    const userRef = ref(db, "usuarios/" + user);
    const snap = await get(userRef);

    if (snap.exists()) {
        alert("Usuário já existe.");
        return;
    }

    await set(userRef, {
        senha: pass,
        foto: "https://cdn-icons-png.flaticon.com/512/149/149071.png"
    });

    alert("Cadastro realizado!");
    fecharCadastro();
};

/* --------------------------
            LOGIN
--------------------------- */
window.login = async function () {

    const user = loginUser.value.trim();
    const pass = loginPass.value.trim();

    const userRef = ref(db, "usuarios/" + user);
    const snap = await get(userRef);

    if (!snap.exists()) {
        alert("Usuário não encontrado.");
        return;
    }

    const dados = snap.val();

    if (dados.senha !== pass) {
        alert("Senha incorreta.");
        return;
    }

    usuario = user;
    localStorage.setItem("usuarioLogado", user);

    perfilFoto.src = dados.foto;
    nomeUsuarioMenu.textContent = user;

    loginBox.style.display = "none";
    document.body.style.overflow = "auto";
};

/* --------------------------
            LOGOUT
--------------------------- */
window.logout = function () {
    localStorage.removeItem("usuarioLogado");
    location.reload();
};

/* --------------------------
     FOTO DO PERFIL (STORAGE)
--------------------------- */
document.getElementById("fotoPerfilUpload").addEventListener("change", async function () {

    if (!usuario) return alert("Faça login.");

    const file = this.files[0];
    if (!file) return;

    const caminho = "fotos_perfil/" + usuario + ".jpg";
    const storageRef = sRef(storage, caminho);

    await uploadBytes(storageRef, file);

    const url = await getDownloadURL(storageRef);

    // Salvar no database
    await set(ref(db, "usuarios/" + usuario + "/foto"), url);

    perfilFoto.src = url;

    alert("Foto atualizada!");
});

</script>
<script type="module">

/* --------------------------
       IMPORTS FIREBASE
--------------------------- */
import { initializeApp }
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

import { getDatabase, ref, get, push, set }
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

import { getStorage, ref as sRef, uploadBytes, getDownloadURL }
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

/* --------------------------
      CONFIGURAÇÃO FIREBASE
--------------------------- */
const firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.appspot.com",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

let usuario = localStorage.getItem("usuarioLogado");

/* ----------------------------------------------------------------------
    FUNÇÃO: CARREGAR POSTS GLOBAIS (todos os usuários — modelo A2)
---------------------------------------------------------------------- */
async function carregarFeed() {

    mural.innerHTML = `<p style="text-align:center;color:#888">Carregando...</p>`;

    const postsRef = ref(db, "posts");
    const snap = await get(postsRef);

    if (!snap.exists()) {
        mural.innerHTML = `<p style="text-align:center;color:#888">Nenhum post ainda.</p>`;
        return;
    }

    let lista = [];

    snap.forEach(userFolder => {
        const userName = userFolder.key;
        userFolder.forEach(postSnap => {
            let item = postSnap.val();
            item.id = postSnap.key;
            item.autor = userName;
            lista.push(item);
        });
    });

    // Ordenar do mais novo para o mais antigo
    lista.sort((a, b) => b.timestamp - a.timestamp);

    mural.innerHTML = "";

    lista.forEach(post => {
        mural.innerHTML += criarPostHTML(post);
    });
}

/* --------------------------
  GERAR HTML DO POST
--------------------------- */
function criarPostHTML(post) {
    return `
    <div class="post">
        <div class="post-topo">
            <img src="${post.fotoAutor}" class="post-foto">
            <span class="post-autor">@${post.autor}</span>
        </div>

        <div class="post-conteudo">
            <p>${post.texto}</p>
            ${post.imagem ? `<img src="${post.imagem}" class="post-imagem">` : ""}
        </div>

        <div class="post-comentarios" id="coment-${post.autor}-${post.id}">
            ${gerarComentarios(post.comentarios)}
        </div>

        <div class="post-comentar">
            <input type="text" class="input-comentario" id="input-${post.autor}-${post.id}" placeholder="Escreva um comentário...">
            <button onclick="comentar('${post.autor}','${post.id}')">Enviar</button>
        </div>
    </div>`;
}

/* --------------------------
GERAR HTML DOS COMENTÁRIOS
--------------------------- */
function gerarComentarios(lista) {
    if (!lista) return "";

    let html = "";
    Object.values(lista).forEach(c => {
        html += `
        <div class="comentario">
            <img src="${c.foto}" class="coment-foto">
            <div class="coment-texto">
                <b>@${c.usuario}</b><br>
                ${c.texto}
            </div>
        </div>`;
    });

    return html;
}

/* --------------------------
      PUBLICAR POST
--------------------------- */
publicarBtn.onclick = async function () {

    if (!usuario) {
        alert("Faça login primeiro.");
        return;
    }

    const texto = postTexto.value.trim();
    const file = postImagem.files[0];

    if (!texto && !file) {
        alert("Escreva algo ou selecione uma imagem.");
        return;
    }

    publicarBtn.innerText = "Enviando...";

    // Buscar foto global do usuário
    const userRef = ref(db, "usuarios/" + usuario);
    const snap = await get(userRef);
    const dadosUser = snap.val();
    const fotoAutor = dadosUser.foto;

    let urlImg = null;

    if (file) {
        const caminho = `posts/${usuario}/${Date.now()}.jpg`;
        const store = sRef(storage, caminho);

        await uploadBytes(store, file);
        urlImg = await getDownloadURL(store);
    }

    // Criar post
    const novoPostRef = push(ref(db, "posts/" + usuario));

    await set(novoPostRef, {
        texto: texto,
        imagem: urlImg,
        fotoAutor: fotoAutor,
        timestamp: Date.now()
    });

    postTexto.value = "";
    postImagem.value = "";
    publicarBtn.innerText = "Publicar";

    carregarFeed();
};

/* --------------------------
       COMENTAR POST
--------------------------- */
window.comentar = async function (autorPost, postId) {

    if (!usuario) return alert("Faça login.");

    const input = document.getElementById(`input-${autorPost}-${postId}`);
    const texto = input.value.trim();
    if (!texto) return;

    // Buscar foto do usuário
    const snap = await get(ref(db, "usuarios/" + usuario));
    const fotoUser = snap.val().foto;

    const comentariosRef = ref(db, `posts/${autorPost}/${postId}/comentarios`);
    const novo = push(comentariosRef);

    await set(novo, {
        usuario: usuario,
        foto: fotoUser,
        texto: texto
    });

    input.value = "";

    carregarFeed();
};

/* --------------------------
   INICIAR FEED AUTOMATICO
--------------------------- */
carregarFeed();

</script>
