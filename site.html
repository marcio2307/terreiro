<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Mural Neon ‚Äì Social</title>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Google Login -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- ====================== PARTE 2 (CSS COMPLETO) VEM NA PARTE 2 ====================== -->
<style></style>

</head>
<body>

<!-- ====================== LOGIN GOOGLE ====================== -->
<div id="loginBox" style="
position:fixed; inset:0; background:rgba(0,0,0,0.92);
display:flex; justify-content:center; align-items:center; flex-direction:column;
z-index:999999;
">
    <img src="https://i.ibb.co/r28TNTmK/5c081edd-21e9-48fb-9a91-834cfdd112fc-removebg-preview.png"
         style="height:150px;margin-bottom:25px;">
    <div id="googleLogin"></div>
</div>

<!-- ====================== MENU NEON ====================== -->
<nav class="top-menu">
    <a href="#"><i class="fa-solid fa-comments"></i> BATE PAPO</a>
    <a href="#"><i class="fa-solid fa-book"></i> ESTUDO</a>
    <a href="#"><i class="fa-solid fa-video"></i> REUNI√ÉO ONLINE</a>
    <a href="#" onclick="logoutGoogle()"><i class="fa-solid fa-right-from-bracket"></i> SAIR</a>
</nav>

<!-- ====================== PERFIL DO USU√ÅRIO ====================== -->
<div id="userHeader" style="display:none;text-align:center;margin-top:10px;">
    <img id="userPhoto" style="
        width:95px;height:95px;border-radius:50%;
        border:3px solid #00ff8c;object-fit:cover;">
    <div id="userName"
         style="margin-top:8px;color:#00ff8c;font-size:1.2rem;font-weight:bold;"></div>
</div>

<!-- ====================== STORIES ====================== -->
<div class="stories-wrapper">
    <div class="stories-row" id="storiesRow">

        <!-- CARD 1: CRIAR STORY -->
        <div class="card" id="card1">
            <label for="storyUpload"><div class="plus">+</div></label>
            <input id="storyUpload" type="file" accept="image/*,video/*" style="display:none;">
            <span style="margin-top:10px;">Criar Story</span>
        </div>

        <!-- CARD 2: SEUS STORIES (inicia oculto) -->
        <div class="card" id="card2" style="display:none;">
            <div id="thumb"></div>
        </div>

    </div>
</div>

<!-- VIEWER DOS STORIES -->
<div id="viewer">
    <div class="topBars" id="bars"></div>
    <div class="dots" id="dots">‚ãÆ</div>
    <div class="deleteBtn" id="deleteBtn">Excluir</div>

    <div class="tapLeft" id="tapLeft"></div>
    <div class="tapRight" id="tapRight"></div>

    <div id="viewerMedia"></div>
</div>

<!-- ====================== FEED ====================== -->
<div class="create-post">
    <input id="postText" class="input-box" 
           placeholder="No que voc√™ est√° pensando?"
           oninput="updateButton()">

    <div class="add-btn" id="btnMain" onclick="buttonAction()">+</div>

    <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
</div>

<div class="preview" id="previewBox">
    <h3>Pr√©via da m√≠dia</h3>
    <div id="previewContent"></div>

    <button onclick="removerPreview()" class="btnExcluirMidia">Excluir m√≠dia</button>
    <button onclick="postar()" class="btnPostarMidia">Postar</button>
</div>

<div id="feed"></div>

<!-- ====================== FIREBASE CONFIG ====================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

window.firebaseConfig = {
    apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
    authDomain: "coletivo-f34d4.firebaseapp.com",
    databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
    projectId: "coletivo-f34d4",
    storageBucket: "coletivo-f34d4.firebasestorage.app",
    messagingSenderId: "296376447787",
    appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

window.app = initializeApp(window.firebaseConfig);
</script>

<!-- ====================== LOGIN GOOGLE SCRIPT ====================== -->
<script>
let usuario = null;
let fotoUsuario = null;

/* UNIFICADO ‚Äî SEM DUPLICA√á√ÉO */
window.addEventListener("load", () => {

    google.accounts.id.initialize({
        client_id: "627442405379-srqriainr8okj7ldg96njd1va5bvt7oi.apps.googleusercontent.com",
        callback: handleLoginGoogle
    });

    google.accounts.id.renderButton(
        document.getElementById("googleLogin"),
        { theme: "filled_black", size: "large", width: 260 }
    );

    const salvo = localStorage.getItem("usuarioLogado");
    if (salvo) restaurarLogin(salvo);
});

function handleLoginGoogle(resp) {
    const dados = decodificar(resp.credential);

    usuario = dados.email.split("@")[0];
    fotoUsuario = dados.picture;

    localStorage.setItem("usuarioLogado", usuario);
    localStorage.setItem("fotoPerfil_" + usuario, fotoUsuario);

    atualizarInterface();
}

function decodificar(t) { return JSON.parse(atob(t.split(".")[1])); }

function restaurarLogin(nome) {
    usuario = nome;
    fotoUsuario = localStorage.getItem("fotoPerfil_" + usuario);
    atualizarInterface();
}

function atualizarInterface() {

    loginBox.style.display = "none";

    userHeader.style.display = "flex";
    userName.textContent = usuario;
    userPhoto.src = fotoUsuario;

    if (window.iniciarPresencaFinal) iniciarPresencaFinal();
}

function logoutGoogle() {
    google.accounts.id.disableAutoSelect();
    localStorage.clear();
    location.reload();
}
</script>
<style>

/* ================================================================
   RESET E BASE DO SITE
================================================================ */

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
}

html, body {
    overflow-x: hidden;
    width: 100%;
}


/* ================================================================
   MENU NEON
================================================================ */

.top-menu {
    width: 100%;
    background: #0d0d0d;
    padding: 18px 0;
    display: flex;
    justify-content: center;
    gap: 50px;
    align-items: center;
    border-bottom: 2px solid #00ff8c;
    box-shadow: 0 0 15px #00ff8c;
    position: sticky;
    top: 0;
    z-index: 9999;
}

.top-menu.hide {
    display: none !important;
}

.top-menu a {
    color: #00ff8c;
    text-decoration: none;
    font-size: 22px;
    font-weight: bold;
    display: flex;
    gap: 10px;
    align-items: center;
    letter-spacing: 1px;
    transition: 0.2s;
    text-shadow: 0 0 10px #00ff8c, 0 0 20px #00ff8c;
}

.top-menu a:hover {
    transform: scale(1.1);
}

.top-menu a i {
    font-size: 24px;
}

@media(max-width:480px){
    .top-menu { gap: 22px; padding: 14px 0; }
    .top-menu a { font-size: 15px; }
    .top-menu a i { font-size: 17px; }
}


/* ================================================================
   √ÅREA DE STORIES
================================================================ */

.stories-wrapper {
    padding: 15px 10px;
    padding-bottom: 5px;
}

.stories-row {
    display: flex;
    gap: 12px;
    overflow-x: auto;
}

.stories-row::-webkit-scrollbar {
    height: 5px;
}
.stories-row::-webkit-scrollbar-thumb {
    background: #00ff8c;
    border-radius: 10px;
}

.card {
    width: 110px;
    height: 180px;
    background: #1a1c1e;
    border-radius: 16px;
    border: 2px solid #00ff8c;
    box-shadow: 0 0 18px #00ff8c;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    flex-shrink: 0;
    transition: 0.3s;
}

.card:hover {
    transform: scale(1.03);
}

.plus {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    border: 4px solid #0e0f10;
    background: #00ff8c;
    color: #003b23;
    font-size: 38px;
    display: flex;
    justify-content: center;
    align-items: center;
    text-shadow: 0 0 12px #00ff8c;
    box-shadow: 0 0 25px #00ff8c;
}

#thumb img,
#thumb video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#card2 {
    display: none;
}

/* efeito neon ao criar story */
.neonEffect {
    animation: neonGlow 1.5s ease-out;
}

@keyframes neonGlow {
    0% { transform: scale(1); box-shadow: 0 0 10px #00ff8c; }
    50% { transform: scale(1.05); box-shadow: 0 0 35px #00ff8c; }
    100% { transform: scale(1); box-shadow: 0 0 10px #00ff8c; }
}


/* ================================================================
   VIEWER DOS STORIES
================================================================ */

#viewer {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.93);
    z-index: 999999;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

#viewerMedia img,
#viewerMedia video {
    max-width: 90%;
    max-height: 78%;
    border-radius: 14px;
}

/* BARRAS DO TOPO */
.topBars {
    position: absolute;
    top: 15px;
    left: 0;
    width: 100%;
    padding: 0 10px;
    display: flex;
    gap: 6px;
    z-index: 20;
}

.bar {
    flex: 1;
    height: 4px;
    background: rgba(255,255,255,0.3);
    border-radius: 3px;
    overflow: hidden;
}

.barFill {
    width: 0%;
    height: 100%;
    background: #00ff8c;
    box-shadow: 0 0 14px #00ff8c;
    transition: width linear;
}

.dots {
    position: absolute;
    top: 12px;
    right: 22px;
    font-size: 36px;
    cursor: pointer;
    z-index: 30;
}

.deleteBtn {
    position: absolute;
    top: 65px;
    right: 25px;
    padding: 10px 16px;
    border-radius: 8px;
    background: #00ff8c;
    font-weight: bold;
    color: #000;
    cursor: pointer;
    box-shadow: 0 0 12px #00ff8c;
    display: none;
    z-index: 40;
}

.tapLeft,
.tapRight {
    position: absolute;
    top: 0;
    width: 50%;
    height: 100%;
    z-index: 10;
}

.tapLeft { left: 0; }
.tapRight { right: 0; }


/* ================================================================
   FEED / MURAL
================================================================ */

.create-post{
    background:#0d0d0d;
    margin:12px 15px;
    padding:15px;
    border-radius:18px;
    border:1px solid #00ff9d;
    display:flex;
    align-items:center;
    gap:10px;
    box-shadow:0 0 10px #00ff9d;
}

.input-box{
    flex:1;
    background:#111;
    padding:10px 18px;
    border-radius:30px;
    border:1px solid #00ff9d;
    color:#fff;
    font-size:16px;
    outline:none;
    box-shadow:inset 0 0 8px #00ff9d;
}

.add-btn{
    width:48px;
    height:48px;
    border-radius:50%;
    border:2px solid #00ff9d;
    background:#111;
    color:#00ff9d;
    font-size:24px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:0.2s;
}

.whatsapp-send{
    width:48px;
    height:48px;
    border-radius:50%;
    background:#00ff9d;
    border:2px solid #004d39;
    color:#004d39;
    font-size:26px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:0.2s;
    box-shadow:0 0 15px #00ff9d;
}

.preview{
    background:#0d0d0d;
    margin:0 15px 15px 15px;
    padding:15px;
    border-radius:16px;
    border:1px solid #00ff9d;
    box-shadow:0 0 10px #00ff9d;
    display:none;
}

.btnExcluirMidia {
    width:100%;
    padding:15px;
    margin-top:10px;
    font-size:20px;
    font-weight:bold;
    background:#ff6464;
    border:none;
    border-radius:14px;
    color:white;
    cursor:pointer;
}

.btnPostarMidia {
    width:100%;
    padding:15px;
    margin-top:10px;
    font-size:22px;
    font-weight:bold;
    background:#7bffb5;
    border:none;
    border-radius:14px;
    color:black;
    cursor:pointer;
}

.post{
    background:#0d0d0d;
    margin:15px;
    padding:15px;
    border-radius:14px;
    border:1px solid #00ff9d;
    box-shadow:0 0 10px #00ff9d;
    position:relative;
}

.post img,
.post video{
    width:100%;
    border-radius:12px;
    margin-top:10px;
}


/* ================================================================
   CURTIDAS / COMENT√ÅRIOS
================================================================ */

.post-actions{
    margin-top:15px;
    display:flex;
    justify-content:space-around;
}

.btn-action{
    color:#00ff9d;
    padding:8px 14px;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
    transition:0.3s;
}

.btn-action:hover{
    transform: scale(1.05);
}

.contador{
    margin-top:5px;
    font-size:13px;
    color:#00ff9d;
    text-align:center;
}

.coment-area{
    background:#111;
    margin-top:10px;
    padding:12px;
    border-radius:10px;
    display:none;
}

.coment-menu-btn {
    float:right;
    margin-left:8px;
    font-size:20px;
    cursor:pointer;
    color:#00ff9d;
}

.coment-menu-box {
    position:absolute;
    top:6px;
    right:6px;
    background:#00ff9d;
    padding:6px 12px;
    border-radius:6px;
    color:black;
    font-weight:bold;
    display:none;
    cursor:pointer;
    box-shadow:0 0 10px #00ff9d;
}


/* ================================================================
   MENU DE EXCLUS√ÉO DO POST
================================================================ */

.menu-btn {
    position:absolute;
    right:10px;
    top:10px;
    font-size:28px;
    cursor:pointer;
    color:#00ff9d;
}

.menu-box {
    position:absolute;
    right:10px;
    top:42px;
    background:#00ff9d;
    padding:10px 14px;
    border-radius:8px;
    color:black;
    font-weight:bold;
    display:none;
    cursor:pointer;
    box-shadow:0 0 12px #00ff9d;
}


/* ================================================================
   AJUSTES MOBILE
================================================================ */

@media(max-width:480px){
    .card { width:95px; height:165px; }
    .add-btn, .whatsapp-send { width:42px; height:42px; font-size:22px; }
    .btn-action { font-size:13px; }
}

</style>
<script type="module">

import { getStorage, ref as sref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

import { getDatabase, ref, set, onValue, remove }
from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const db = getDatabase(app);
const storage = getStorage(app);

/* ======================================================
   VARI√ÅVEIS
====================================================== */
let storiesUser = [];     // stories do usu√°rio logado
let storiesOthers = [];   // stories de outros usu√°rios

/* ======================================================
   1) UPLOAD DO STORY (+)
====================================================== */

storyUpload.onchange = async e => {

    const file = e.target.files[0];
    if (!file || !usuario) return;

    const id = Date.now();
    const r = sref(storage, `stories/${usuario}/${id}`);

    await uploadBytes(r, file);
    const url = await getDownloadURL(r);

    await set(ref(db, `coletivo_mural/stories/${usuario}/${id}`), {
        id,
        url,
        tipo: file.type.includes("image") ? "image" : "video",
        user: usuario
    });

    // efeito neon ao postar
    card2.classList.add("neonEffect");
    setTimeout(() => card2.classList.remove("neonEffect"), 1500);

    storyUpload.value = "";
};

/* ======================================================
   2) CARREGAMENTO EM TEMPO REAL (SEM BUG, SEM VAZIO)
====================================================== */

onValue(ref(db, "coletivo_mural/stories"), snap => {

    storiesUser = [];
    storiesOthers = [];

    if (!snap.exists()) {
        atualizarThumb();
        limparStoriesOutros();
        return;
    }

    snap.forEach(userNode => {

        const nome = userNode.key;
        const lista = [];

        userNode.forEach(st => {
            const v = st.val();

            if (!v || !v.url || !v.tipo) return; // evita story vazio

            lista.push({
                id: Number(v.id),
                url: v.url,
                tipo: v.tipo,
                user: nome
            });
        });

        if (lista.length === 0) return;

        lista.sort((a, b) => a.id - b.id); // ordem correta

        if (nome === usuario) storiesUser = lista;
        else storiesOthers.push(lista);
    });

    atualizarThumb();
    montarStoriesOutros();
});

/* ======================================================
   3) SEUS STORIES ‚Äî CARD DO USU√ÅRIO
====================================================== */

function atualizarThumb() {

    if (storiesUser.length === 0) {
        card2.style.display = "none";
        return;
    }

    card2.style.display = "flex";

    const ultimo = storiesUser[storiesUser.length - 1];

    thumb.innerHTML = ultimo.tipo === "image"
        ? `<img src="${ultimo.url}">`
        : `<video src="${ultimo.url}" autoplay muted loop></video>`;
}

card2.onclick = () => {
    if (storiesUser.length > 0)
        abrirViewer(storiesUser);
};

/* ======================================================
   4) MONTAR STORIES DE OUTROS (CORRIGIDO)
====================================================== */

function limparStoriesOutros() {
    document.querySelectorAll(".card-outro").forEach(e => e.remove());
}

function montarStoriesOutros() {

    limparStoriesOutros();

    const row = document.getElementById("storiesRow");

    if (storiesOthers.length === 0) return;

    storiesOthers.forEach(lista => {

        if (!lista || lista.length === 0) return;

        const ultimo = lista[lista.length - 1];

        const c = document.createElement("div");
        c.className = "card card-outro";

        c.innerHTML = ultimo.tipo === "image"
            ? `<img src="${ultimo.url}" style="width:100%;height:100%;object-fit:cover;">`
            : `<video src="${ultimo.url}" autoplay muted loop style="width:100%;height:100%;object-fit:cover;"></video>`;

        c.onclick = () => abrirViewer(lista);

        row.appendChild(c);
    });
}

/* ======================================================
   5) VIEWER DOS STORIES
====================================================== */

let listaAtual = [];
let indexAtual = 0;

function abrirViewer(lista) {
    listaAtual = lista;
    indexAtual = 0;

    viewer.style.display = "flex";
    document.querySelector(".top-menu").classList.add("hide");

    mostrarStory();
}

function fecharViewer() {
    viewer.style.display = "none";
    viewerMedia.innerHTML = "";
    document.querySelector(".top-menu").classList.remove("hide");
}

/* ======================================================
   6) EXIBIR STORY (IMAGEM / V√çDEO)
====================================================== */

function mostrarStory() {

    viewerMedia.innerHTML = "";
    bars.innerHTML = "";
    deleteBtn.style.display = "none";

    const s = listaAtual[indexAtual];

    /* Barras */
    listaAtual.forEach((_, i) => {
        bars.innerHTML += `
            <div class="bar">
                <div class="barFill" id="bar_${i}"></div>
            </div>`;
    });

    const barra = document.getElementById("bar_" + indexAtual);

    setTimeout(() => {
        barra.style.transition = "width 5500ms linear";
        barra.style.width = "100%";
    }, 50);

    /* M√≠dia */
    if (s.tipo === "image") {

        viewerMedia.innerHTML = `<img src="${s.url}">`;

        setTimeout(nextStory, 5500);

    } else {

        const vid = document.createElement("video");
        vid.src = s.url;
        vid.autoplay = true;
        vid.muted = false;

        vid.onloadedmetadata = () => {

            const dur = Math.min(vid.duration * 1000, 5500);
            setTimeout(nextStory, dur);
        };

        viewerMedia.appendChild(vid);
    }

    if (s.user === usuario) deleteBtn.style.display = "block";
}

/* ======================================================
   7) NAVEGA√á√ÉO
====================================================== */

tapRight.onclick = nextStory;
tapLeft.onclick = prevStory;

function nextStory() {

    indexAtual++;

    if (indexAtual >= listaAtual.length) {
        fecharViewer();
    } else {
        mostrarStory();
    }
}

function prevStory() {

    if (indexAtual === 0) return;

    indexAtual--;
    mostrarStory();
}

/* ======================================================
   8) EXCLUS√ÉO DO STORY
====================================================== */

deleteBtn.onclick = async () => {

    const s = listaAtual[indexAtual];
    if (!s || s.user !== usuario) return;

    await remove(ref(db, `coletivo_mural/stories/${usuario}/${s.id}`));

    nextStory();
};

</script>
<!-- ========================== PARTE 4 ‚Äî FEED CORRIGIDO ========================== -->

<script type="module">

/* IMPORTA FIREBASE */
import {
    getStorage,
    ref as sref,
    uploadBytes,
    getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

import {
    getDatabase,
    ref,
    set,
    push,
    onValue,
    remove
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const db = getDatabase(app);
const storage = getStorage(app);

/* =====================================================================
                        VARI√ÅVEIS GLOBAIS
===================================================================== */
let selectedFile = null;
let modoTexto = false;
let likeCache = {};
let longPress = {};
let pressTimer = null;

/* =====================================================================
        BOT√ÉO + ‚Üí vira bot√£o WhatsApp (‚û§) quando tem texto digitado
===================================================================== */
window.updateButton = function () {

    const texto = postText.value.trim();

    if (texto.length > 0) {

        btnMain.className = "whatsapp-send";
        btnMain.innerHTML = "‚û§";
        modoTexto = true;

    } else {

        btnMain.className = "add-btn";
        btnMain.innerHTML = "+";
        modoTexto = false;
    }
};

window.buttonAction = function () {

    if (modoTexto) postarTexto();
    else fileInput.click();
};

/* =====================================================================
                PREVIEW DA M√çDIA (IMAGEM OU V√çDEO)
===================================================================== */
fileInput.onchange = e => {

    selectedFile = e.target.files[0];
    if (!selectedFile) return;

    const url = URL.createObjectURL(selectedFile);

    previewContent.innerHTML = selectedFile.type.startsWith("image/")
        ? `<img src="${url}" style="width:100%;border-radius:10px;">`
        : `<video src="${url}" controls style="width:100%;border-radius:10px;"></video>`;

    previewBox.style.display = "block";
};

/* Remover pr√©via */
window.removerPreview = function () {

    selectedFile = null;
    previewBox.style.display = "none";
    previewContent.innerHTML = "";
};

/* =====================================================================
                     POSTAR SOMENTE TEXTO
===================================================================== */
window.postarTexto = async function () {

    const texto = postText.value.trim();
    if (texto === "" || !usuario) return;

    await salvarPost(texto, null, null);

    postText.value = "";
    updateButton();
};

/* =====================================================================
                     POSTAR M√çDIA (IMAGEM/V√çDEO)
===================================================================== */
window.postar = async function () {

    if (!selectedFile) return;

    const id = Date.now();
    const caminho = `posts/${usuario}/${id}`;
    const fileRef = sref(storage, caminho);

    await uploadBytes(fileRef, selectedFile);

    const url = await getDownloadURL(fileRef);
    const tipo = selectedFile.type.startsWith("image/") ? "image" : "video";

    await salvarPost(postText.value.trim(), url, tipo);

    selectedFile = null;
    previewBox.style.display = "none";
    previewContent.innerHTML = "";
    postText.value = "";
    updateButton();
};

/* =====================================================================
                            SALVAR POST
===================================================================== */
async function salvarPost(texto, midia, tipo) {

    if (!usuario) return;

    const id = "post_" + Date.now();

    await set(ref(db, `coletivo_mural/posts/${id}`), {
        id,
        user: usuario,
        foto: fotoUsuario,
        texto,
        midia,
        tipo,
        timestamp: Date.now()
    });
}

/* =====================================================================
            CARREGAR FEED EM TEMPO REAL ‚Äî SEM BUGS
===================================================================== */
onValue(ref(db, "coletivo_mural/posts"), snap => {

    feed.innerHTML = "";

    if (!snap.exists()) return;

    let posts = [];
    snap.forEach(n => posts.push(n.val()));

    posts.sort((a, b) => b.timestamp - a.timestamp);

    posts.forEach(renderPost);
});

/* =====================================================================
                         RENDERIZAR POST
===================================================================== */
function renderPost(p) {

    const midiaHTML = p.midia
        ? (p.tipo === "image"
            ? `<img src="${p.midia}" onclick="abrirImagem('${p.midia}')">`
            : `<video controls src="${p.midia}"></video>`)
        : "";

    feed.innerHTML += `

    <div class="post" id="${p.id}">

        ${p.user === usuario ? `
        <div class="menu-btn" onclick="toggleMenu('${p.id}')">‚ãÆ</div>
        <div class="menu-box" id="menu_${p.id}">
            <div onclick="excluirPost('${p.id}')">Excluir</div>
        </div>
        ` : ""}

        <h3>
            <img src="${p.foto || ''}" 
                 style="width:38px;height:38px;border-radius:50%;
                 border:2px solid #00ff8c;margin-right:8px;vertical-align:middle;">
            ${p.user || "Usu√°rio"}
        </h3>

        <p>${p.texto || ""}</p>

        ${midiaHTML}

        <!-- A√á√ïES -->
        <div class="post-actions">

            <!-- Curtir / Amei -->
            <div style="text-align:center;">
                <div class="btn-action"
                     id="curtir_${p.id}"
                     
                     ontouchstart="iniciarPress('${p.id}')"
                     ontouchend="finalizarPress('${p.id}')"

                     onmousedown="iniciarPress('${p.id}')"
                     onmouseup="finalizarPress('${p.id}')"

                     onclick="curtir('${p.id}')">
                     üëç Curtir
                </div>
                <div class="contador" id="contadorCurtidas_${p.id}"></div>
            </div>

            <!-- Coment√°rios -->
            <div style="text-align:center;">
                <div class="btn-action" onclick="abrirComentarios('${p.id}')">
                    üí¨ Comentar
                </div>
                <div class="contador" id="contadorComentarios_${p.id}"></div>
            </div>

        </div>

        <!-- √Årea dos coment√°rios -->
        <div class="coment-area" id="comentarios_${p.id}">
            <div id="listaComentarios_${p.id}" style="margin-bottom:10px;"></div>

            <input type="text" id="comentarioInput_${p.id}"
                placeholder="Escreva um coment√°rio..."
                style="
                    width:100%;padding:10px;border-radius:8px;
                    border:1px solid #00ff9d;background:#000;color:#fff;
                ">

            <button onclick="enviarComentario('${p.id}')"
                style="margin-top:8px;background:#00ff9d;padding:8px 15px;
                       border:none;border-radius:8px;cursor:pointer;">
                Enviar
            </button>
        </div>

    </div>

    `;

    carregarCurtidas(p.id);
    carregarComentarios(p.id);
}

/* =====================================================================
                   SISTEMA COMPLETO CURTIR / AMEI
===================================================================== */

window.iniciarPress = function (id) {
    longPress[id] = false;

    pressTimer = setTimeout(() => {
        longPress[id] = true;
        amar(id);
    }, 500);
};

window.finalizarPress = function (id) {
    if (pressTimer) clearTimeout(pressTimer);
};

window.curtir = function (postId) {
    if (longPress[postId]) return;
    salvarCurtida(postId, "curtida");
};

window.amar = function (postId) {
    salvarCurtida(postId, "amei");
};

async function salvarCurtida(postId, tipo) {

    const local = ref(db, `coletivo_mural/posts/${postId}/likes/${usuario}`);

    if (likeCache[postId]?.[usuario] === tipo) {
        remove(local);
        return;
    }

    await set(local, tipo);
}

function carregarCurtidas(postId) {

    onValue(ref(db, `coletivo_mural/posts/${postId}/likes`), snap => {

        let total = 0;
        let data = {};
        let voce = false;
        let amou = false;

        snap.forEach(n => {
            total++;
            data[n.key] = n.val();
            if (n.key === usuario) {
                voce = true;
                amou = n.val() === "amei";
            }
        });

        likeCache[postId] = data;

        const btn = document.getElementById("curtir_" + postId);
        const cont = document.getElementById("contadorCurtidas_" + postId);

        if (voce) {

            if (amou) {
                btn.textContent = "‚ù§Ô∏è Voc√™ amou";
                btn.style.color = "#ff008c";
            } else {
                btn.textContent = "üëç Voc√™ curtiu";
                btn.style.color = "#00ff9d";
            }

        } else {
            btn.textContent = "üëç Curtir";
            btn.style.color = "#00ff9d";
        }

        if (total === 0) cont.innerHTML = "";
        else if (total === 1 && voce) cont.innerHTML = "Voc√™ curtiu";
        else if (voce) cont.innerHTML = `Voc√™ e mais ${total - 1} curtiram`;
        else cont.innerHTML = `${total} curtidas`;
    });
}

/* =====================================================================
                          COMENT√ÅRIOS COMPLETOS
===================================================================== */

window.abrirComentarios = function (postId) {

    const box = document.getElementById("comentarios_" + postId);
    box.style.display = box.style.display === "block" ? "none" : "block";
};

window.enviarComentario = async function (postId) {

    const input = document.getElementById("comentarioInput_" + postId);
    const texto = input.value.trim();

    if (texto === "") return;

    const novo = push(ref(db, `coletivo_mural/posts/${postId}/comentarios`));

    await set(novo, {
        id: novo.key,
        user: usuario,
        foto: fotoUsuario,
        texto
    });

    input.value = "";
};

function carregarComentarios(postId) {

    onValue(ref(db, `coletivo_mural/posts/${postId}/comentarios`), snap => {

        const lista = document.getElementById("listaComentarios_" + postId);
        const contador = document.getElementById("contadorComentarios_" + postId);

        lista.innerHTML = "";

        if (!snap.exists()) {
            contador.innerHTML = "";
            return;
        }

        let total = 0;

        snap.forEach(n => {

            total++;
            const c = n.val();

            lista.innerHTML += `

                <div id="cmt_${c.id}"
                    style="background:#000;border:1px solid #00ff9d;
                           padding:8px;border-radius:8px;margin-bottom:5px;
                           position:relative;">

                    <img src="${c.foto}"
                         style="width:26px;height:26px;border-radius:50%;
                         border:1px solid #00ff9d;margin-right:5px;">
                    <b>${c.user}</b>: ${c.texto}

                    ${c.user === usuario ? `
                        <span class="coment-menu-btn"
                              onclick="toggleComentMenu('${postId}','${c.id}')">‚ãÆ</span>

                        <div class="coment-menu-box" id="menu_${postId}_${c.id}"
                             onclick="excluirComentario('${postId}','${c.id}')">
                             Excluir
                        </div>
                    ` : ""}
                </div>

            `;
        });

        if (total === 0) contador.innerHTML = "";
        else if (total === 1) contador.innerHTML = "1 coment√°rio";
        else contador.innerHTML = `${total} coment√°rios`;
    });
}

window.toggleComentMenu = function (postId, cid) {
    const box = document.getElementById("menu_" + postId + "_" + cid);
    box.style.display = box.style.display === "block" ? "none" : "block";
};

window.excluirComentario = async function (postId, cid) {
    await remove(ref(db, `coletivo_mural/posts/${postId}/comentarios/${cid}`));
};

/* =====================================================================
                         EXCLUIR POST
===================================================================== */
window.toggleMenu = function (id) {
    const box = document.getElementById("menu_" + id);
    box.style.display = box.style.display === "block" ? "none" : "block";
};

window.excluirPost = async function (id) {
    await remove(ref(db, `coletivo_mural/posts/${id}`));
};

/* =====================================================================
                     MODAL DE IMAGEM EM TELA CHEIA
===================================================================== */
window.abrirImagem = function (src) {

    const modal = document.createElement("div");

    modal.style = `
        position:fixed; inset:0; background:rgba(0,0,0,.9);
        display:flex; justify-content:center; align-items:center;
        z-index:999999;
    `;

    modal.innerHTML = `
        <img src="${src}" style="max-width:90%;max-height:90%;
                                 border-radius:12px;">
    `;

    modal.onclick = () => modal.remove();
    document.body.appendChild(modal);
};

</script>
<script type="module">

import {
    getDatabase,
    ref,
    set,
    onDisconnect,
    onValue
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const db = getDatabase(app);

/* ============================================================
      INICIAR PRESEN√áA (IGUAL AO SEU SISTEMA DE CHAT)
============================================================ */

window.iniciarPresencaFinal = function () {

    if (!usuario) return;

    const caminho = `coletivo_mural/presenca/${usuario}`;

    const refUser = ref(db, caminho);

    // Define presen√ßa como "online"
    set(refUser, {
        status: "online",
        foto: fotoUsuario || "",
        user: usuario,
        atualizado: Date.now()
    });

    // Remove presen√ßa ao fechar o navegador
    onDisconnect(refUser).remove();

    // Atualizar atividade a cada 25 segundos
    setInterval(() => {

        set(refUser, {
            status: "online",
            foto: fotoUsuario || "",
            user: usuario,
            atualizado: Date.now()
        });

    }, 25000);

    monitorarOnline();
};

/* ============================================================
     MONITORAR PRESEN√áA DOS USU√ÅRIOS CONECTADOS
============================================================ */

function monitorarOnline() {

    const listaOnline = ref(db, "coletivo_mural/presenca");

    onValue(listaOnline, snap => {

        if (!snap.exists()) return;

        let alguemOnline = [];

        snap.forEach(u => {
            const val = u.val();
            const diff = Date.now() - val.atualizado;

            // Consideramos offline ap√≥s 60 segundos sem atividade
            if (diff < 60000) {
                alguemOnline.push(val.user);
            }
        });

        exibirOnline(alguemOnline);
    });
}

/* ============================================================
     MOSTRAR INFORMA√á√ÉO NO TOPO DO PERFIL
============================================================ */

function exibirOnline(lista) {

    if (!usuario) return;

    const estaOnline = lista.includes(usuario);

    // Cria o elemento visual da bolinha se n√£o existir
    if (!document.getElementById("onlineDot")) {
        const dot = document.createElement("div");

        dot.id = "onlineDot";
        dot.style = `
            width:18px;
            height:18px;
            border-radius:50%;
            background:#00ff8c;
            box-shadow:0 0 12px #00ff8c, 0 0 25px #00ff8c;
            margin:10px auto 5px auto;
            animation:pulse 1.4s infinite;
        `;

        userHeader.appendChild(dot);

        // ANIMA√á√ÉO NEON
        const style = document.createElement("style");
        style.innerHTML = `
            @keyframes pulse {
                0% { transform:scale(1); box-shadow:0 0 10px #00ff8c; }
                50% { transform:scale(1.25); box-shadow:0 0 25px #00ff8c; }
                100% { transform:scale(1); box-shadow:0 0 10px #00ff8c; }
            }
        `;
        document.head.appendChild(style);
    }

    const dot = document.getElementById("onlineDot");

    // Atualiza visual
    dot.style.background = estaOnline ? "#00ff8c" : "#444";
    dot.style.boxShadow = estaOnline
        ? "0 0 12px #00ff8c, 0 0 25px #00ff8c"
        : "0 0 4px #555";
}

</script>
