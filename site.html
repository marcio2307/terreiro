<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Menu + Stories estilo Insta + Feed Completo</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  *{ box-sizing: border-box; }
  html, body{ width:100%; max-width:100%; overflow-x:hidden; }
  body{ margin:0; background:#000; font-family: Arial, sans-serif; color:#fff; padding-bottom: env(safe-area-inset-bottom); }

  /* ======================== MENU NEON ======================== */
  .top-menu {
    width: 100%;
    background: #0d0d0d;
    padding: 18px 10px;
    display: flex;
    justify-content: center;
    gap: 50px;
    align-items: center;
    border-bottom: 2px solid #00ff8c;
    box-shadow: 0 0 15px #00ff8c;
    position: sticky;
    top: 0;
    z-index: 9999;
  }
  .top-menu.hide { display:none !important; }
  .top-menu a {
    color: #00ff8c;
    text-decoration: none;
    font-size: 22px;
    font-weight: bold;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.3s;
    letter-spacing: 1.2px;
    text-shadow: 0 0 10px #00ff8c, 0 0 20px #00ff8c, 0 0 35px #00ff8c;
    white-space: nowrap;
  }
  .top-menu a:hover { transform: scale(1.06); }
  .top-menu a i {
    font-size: 24px;
    text-shadow: 0 0 10px #00ff8c, 0 0 20px #00ff8c, 0 0 40px #00ff8c;
  }
  @media(max-width:480px){
    .top-menu { gap: 18px; padding: 14px 10px; }
    .top-menu a { font-size: 14px; letter-spacing:.8px; }
    .top-menu a i { font-size: 18px; }
  }

  /* ======================== STORIES (ESTILO INSTA) ======================== */
  .stories-wrapper{ padding: 12px 10px 6px 10px; }
  .stories-row{
    display:flex;
    gap: 14px;
    overflow-x:auto;
    padding: 8px 4px 12px 4px;
    -webkit-overflow-scrolling: touch;
    align-items: stretch;
  }
  .stories-row::-webkit-scrollbar{ height:6px; }
  .stories-row::-webkit-scrollbar-thumb{ background:#00ff8c; border-radius:999px; }

  .storyCard{
    width: clamp(120px, 42vw, 160px);
    height: clamp(220px, 70vw, 290px);
    border-radius: 22px;
    overflow:hidden;
    position:relative;
    flex-shrink:0;
    cursor:pointer;
    background:#121314;
    box-shadow: 0 10px 28px rgba(0,0,0,.45);
    border: 1px solid rgba(255,255,255,.08);
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .storyCard:hover{ transform: translateY(-2px); box-shadow: 0 14px 32px rgba(0,0,0,.55); }

  .storyMedia{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover; display:block;
    filter: contrast(1.05) saturate(1.05);
    background:#000;
  }
  .storyShade{
    position:absolute; inset:auto 0 0 0;
    height: 48%;
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 35%, rgba(0,0,0,.78) 100%);
    pointer-events:none;
  }
  .segRow{
    position:absolute; top:10px; left:10px; right:10px;
    display:flex; gap:4px; z-index:5;
  }
  .seg{
    flex:1; height:3px;
    background: rgba(255,255,255,.35);
    border-radius:999px; overflow:hidden;
  }
  .avatarCircle{
    position:absolute; top:14px; left:14px;
    width:42px; height:42px;
    border-radius:50%;
    background:#0f1112;
    border:3px solid #2f6bff;
    box-shadow: 0 0 0 3px rgba(0,0,0,.25);
    overflow:hidden;
    z-index:6;
    display:flex; align-items:center; justify-content:center;
  }
  .avatarCircle img{ width:100%; height:100%; object-fit:cover; display:block; }
  .avatarInitials{
    font-weight:900; font-size:14px; color:#fff;
    text-shadow: 0 0 10px rgba(0,0,0,.6);
  }
  .storyName{
    position:absolute; left:14px; right:14px; bottom:14px;
    z-index:6;
    font-size:18px;
    font-weight:900;
    line-height:1.05;
    text-shadow: 0 2px 10px rgba(0,0,0,.75);
    display:-webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow:hidden;
  }
  .createCard{
    display:flex; align-items:center; justify-content:center;
    flex-direction:column; gap:10px;
    background: linear-gradient(180deg, #0f1112 0%, #0b0c0d 100%);
  }
  .plusBtn{
    width: 68px; height: 68px; border-radius: 50%;
    background:#00ff8c;
    border: 6px solid rgba(0,0,0,.55);
    display:flex; align-items:center; justify-content:center;
    color:#003b23; font-weight:900; font-size:42px;
    box-shadow:0 0 24px rgba(0,255,140,.55);
  }
  .createLabel{ font-weight:800; opacity:.95; }

  /* ======================== VIEWER ======================== */
  #viewer{
    position:fixed; inset:0;
    background: rgba(0,0,0,.92);
    display:none;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:99999;
  }
  #viewerMedia img, #viewerMedia video{
    max-width: 92%;
    max-height: 82%;
    border-radius: 16px;
  }
  .topBars{
    position:absolute; top: 14px; left:0;
    width:100%;
    display:flex;
    gap:5px;
    padding: 0 10px;
    z-index:10;
  }
  .bar{
    flex:1; height:4px;
    background: rgba(255,255,255,.3);
    border-radius:999px;
    overflow:hidden;
  }
  .barFill{
    width:0%;
    height:100%;
    background:#00ff8c;
    box-shadow:0 0 15px #00ff8c;
    transition: width linear;
  }
  .tapLeft,.tapRight{
    position:absolute; top:0;
    height:100%; width:50%;
    z-index:5;
  }
  .tapLeft{ left:0; }
  .tapRight{ right:0; }

  .dots{
    position:absolute; top: 10px; right: 20px;
    font-size: 35px;
    cursor:pointer;
    z-index:20;
    user-select:none;
  }
  .deleteBtn{
    position:absolute; top: 55px; right: 20px;
    background:#00ff8c;
    color:#000;
    padding:10px 15px;
    border-radius:10px;
    cursor:pointer;
    display:none;
    font-weight:900;
    z-index:20;
    box-shadow:0 0 14px rgba(0,255,140,.6);
    user-select:none;
  }

  /* ====================== LOGIN (100% responsivo) ====================== */
  .login-overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.94);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 9999999;
    padding: 16px;
  }
  .login-card{
    width: min(520px, 94vw);
    max-width: 94vw;
    background:#0d0d0d;
    border:2px solid #00ff8c;
    border-radius:22px;
    box-shadow:0 0 28px rgba(0,255,140,.45);
    padding: 18px;
    text-align:center;
  }
  .login-title{
    font-size: clamp(18px, 6vw, 26px);
    font-weight: 900;
    color:#00ff8c;
    text-transform:uppercase;
    letter-spacing:1.2px;
    text-shadow: 0 0 10px #00ff8c, 0 0 22px #00ff8c;
    margin: 4px 0 14px 0;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .login-input{
    width: 100%;
    max-width: 100%;
    display:block;
    background:#111;
    border:1px solid #00ff9d;
    border-radius: 999px;
    padding: 14px 18px;
    color:#fff;
    outline:none;
    font-size: 16px;
    box-shadow: inset 0 0 10px rgba(0,255,157,.22);
  }
  .login-btn{
    width: 100%;
    margin-top: 12px;
    border:none;
    border-radius: 999px;
    padding: 16px 12px;
    font-weight: 900;
    cursor:pointer;
    font-size: 18px;
    transition:.18s;
    background:#00ff8c;
    color:#003b23;
    box-shadow:0 0 18px rgba(0,255,140,.55);
  }
  .login-btn:active{ transform: scale(.99); }

  /* ===================== FEED COMPLETO ===================== */
  .create-post{
    background:#0d0d0d;
    margin:10px 12px 15px 12px;
    padding:14px;
    border-radius:22px;
    border:1px solid #00ff9d;
    display:flex;
    gap:10px;
    align-items:center;
    box-shadow:0 0 10px rgba(0,255,157,.45);
  }
  .input-box{
    flex:1;
    min-width: 0;
    background:#111;
    padding:12px 18px;
    border-radius:999px;
    border:1px solid #00ff9d;
    color:#fff;
    font-size:16px;
    outline:none;
    box-shadow:inset 0 0 8px rgba(0,255,157,.35);
  }
  .add-btn{
    background:#111;
    border:2px solid #00ff9d;
    color:#00ff9d;
    width:46px;
    height:46px;
    border-radius:50%;
    font-size:22px;
    font-weight:bold;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow:0 0 10px rgba(0,255,157,.45);
    transition:.2s;
    flex: 0 0 auto;
  }
  .whatsapp-send{
    width:46px; height:46px;
    background:#00ff9d;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:26px;
    color:#003b23;
    cursor:pointer;
    box-shadow:0 0 15px rgba(0,255,157,.55);
    transition:.2s;
    border:2px solid #003b23;
    flex: 0 0 auto;
  }
  #fileInput{display:none;}

  .preview{
    margin:0 12px 15px 12px;
    padding:15px;
    background:#0d0d0d;
    border:1px solid #00ff9d;
    border-radius:15px;
    box-shadow:0 0 10px rgba(0,255,157,.45);
    display:none;
  }

  .post{
    background:#0d0d0d;
    margin:15px 12px;
    padding:15px;
    border-radius:16px;
    border:1px solid #00ff9d;
    box-shadow:0 0 10px rgba(0,255,157,.45);
    position:relative;
  }
  .post img,.post video{
    width:100%;
    border-radius:12px;
    margin-top:10px;
    background:#000;
  }

  .post-actions{
    display:flex;
    justify-content:space-around;
    margin-top:15px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .btn-action{
    color:#00ff9d;
    padding:10px 12px;
    border-radius:12px;
    font-weight:bold;
    cursor:pointer;
    transition:0.2s;
    text-align:center;
    border: 1px solid rgba(0,255,157,.25);
    background: rgba(0,0,0,.15);
    user-select:none;
  }

  .contador{
    margin-top:6px;
    font-size:13px;
    color:#00ff9d;
    text-align:center;
    opacity:.95;
    line-height:1.35;
    word-break: break-word;
  }

  .coment-area{
    background:#111;
    padding:10px;
    margin-top:10px;
    border-radius:12px;
    display:none;
  }

  .menu-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 28px;
    cursor: pointer;
    color: #00ff9d;
    z-index: 10;
    user-select:none;
  }
  .menu-box {
    position: absolute;
    top: 45px;
    right: 10px;
    background: #00ff9d;
    color: #000;
    padding: 10px 15px;
    border-radius: 10px;
    display: none;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 0 12px rgba(0,255,157,.55);
    z-index: 15;
  }

  .coment-menu-btn {
    float:right;
    font-size:20px;
    cursor:pointer;
    color:#00ff9d;
    margin-left:8px;
    user-select:none;
  }
  .coment-menu-box {
    position:absolute;
    top:5px;
    right:5px;
    background:#00ff9d;
    color:#000;
    padding:5px 10px;
    border-radius:8px;
    display:none;
    font-weight:bold;
    cursor:pointer;
    box-shadow: 0 0 10px rgba(0,255,157,.55);
    z-index:5;
  }

  /* ===================== LOADING OVERLAY (post/story) ===================== */
  .loadingOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.78);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 99999999;
    padding: 18px;
  }
  .loadingCard{
    width: min(520px, 92vw);
    background:#0d0d0d;
    border:2px solid #00ff8c;
    border-radius:18px;
    box-shadow:0 0 25px rgba(0,255,140,.45);
    padding:18px;
    text-align:center;
  }
  .spinner{
    width:46px;height:46px;border-radius:50%;
    border:4px solid rgba(0,255,140,.25);
    border-top-color:#00ff8c;
    margin:0 auto 10px auto;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg);} }
  .loadingText{ color:#00ff8c; font-weight:900; letter-spacing:.6px; }
  .loadingSub{ margin-top:6px; color:#fff; opacity:.85; font-size:14px; }

  .pendingBadge{
    display:inline-block;
    margin-left:8px;
    padding:4px 10px;
    border-radius:999px;
    background: rgba(0,255,140,.18);
    border:1px solid rgba(0,255,140,.35);
    color:#00ff8c;
    font-size:12px;
    font-weight:900;
  }

  @media (max-width:360px){
    .top-menu{ gap: 12px; }
    .btn-action{ font-size:12px; padding:9px 10px; }
    .menu-btn{ font-size:26px; }
  }
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-title"><i class="fa-solid fa-user"></i> ENTRAR</div>
    <input id="loginName" class="login-input" maxlength="24" placeholder="Digite seu nome" autocomplete="off">
    <button class="login-btn" onclick="confirmarNome()">Entrar</button>
  </div>
</div>

<!-- LOADING -->
<div class="loadingOverlay" id="loadingOverlay">
  <div class="loadingCard">
    <div class="spinner"></div>
    <div class="loadingText" id="loadingText">Enviando...</div>
    <div class="loadingSub" id="loadingSub">Aguarde um instante</div>
  </div>
</div>

<!-- MENU (BATE PAPO removido) -->
<nav class="top-menu">
  <a href="https://marcio2307.github.io/terreiro/estudo.html"><i class="fa-solid fa-book"></i> ESTUDO</a>
  <a href="https://marcio2307.github.io/terreiro/sala.html"><i class="fa-solid fa-video"></i> REUNI√ÉO ONLINE</a>
  <a href="#" onclick="sairNome()"><i class="fa-solid fa-right-from-bracket"></i> SAIR</a>
</nav>

<!-- STORIES -->
<div class="stories-wrapper">
  <div class="stories-row" id="storiesRow"></div>
</div>

<!-- VIEWER -->
<div id="viewer">
  <div class="topBars" id="bars"></div>
  <div class="dots" id="dots">‚ãÆ</div>
  <div class="deleteBtn" id="deleteBtn">Excluir</div>
  <div class="tapLeft" id="tapLeft"></div>
  <div class="tapRight" id="tapRight"></div>
  <div id="viewerMedia"></div>
</div>

<!-- FEED / MURAL (SEM COMPARTILHAR) -->
<div class="create-post">
  <input type="text" id="postText" class="input-box" placeholder="No que voc√™ est√° pensando?" oninput="updateButton()">
  <div class="add-btn" id="btnMain" onclick="buttonAction()">+</div>
  <input type="file" id="fileInput" accept="image/*,video/*">
</div>

<div class="preview" id="previewBox">
  <h3>Pr√©via da m√≠dia</h3>
  <div id="previewContent"></div>

  <div style="margin-top:15px; display:flex; flex-direction:column; gap:12px;">
    <button onclick="removerPreview()"
      style="width:100%;padding:15px;font-size:20px;font-weight:bold;border:none;border-radius:18px;background:#ff6b6b;color:#fff;cursor:pointer;">
      Excluir imagem
    </button>

    <button onclick="postar()"
      style="width:100%;padding:15px;font-size:22px;font-weight:bold;border:none;border-radius:18px;background:#7bffb5;color:#000;cursor:pointer;">
      Postar
    </button>
  </div>
</div>

<div id="feed"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
/* ====================== FIREBASE ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();
const ST = firebase.storage();

/* ====================== ‚úÖ SOM (MP3 DO GITHUB) ======================
   Troque a URL abaixo pela URL RAW do seu mp3 no GitHub (raw.githubusercontent.com)
*/
const ACTION_SOUND_URL = "som.mp3";

/* player √∫nico */
const actionSfx = new Audio(ACTION_SOUND_URL);
actionSfx.preload = "auto";
actionSfx.volume = 1.0;

/* destrava √°udio no primeiro toque (celular) */
let audioUnlocked = false;
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  try{
    actionSfx.muted = false;
    const p = actionSfx.play();
    if(p && p.then){
      p.then(()=>{ actionSfx.pause(); actionSfx.currentTime = 0; }).catch(()=>{});
    }else{
      actionSfx.pause(); actionSfx.currentTime = 0;
    }
  }catch(e){}
}
document.addEventListener("touchstart", unlockAudioOnce, { once:true, passive:true });
document.addEventListener("click", unlockAudioOnce, { once:true });

function playActionSound(){
  if(!ACTION_SOUND_URL || ACTION_SOUND_URL.includes("COLE_AQUI")) return;
  try{
    actionSfx.pause();
    actionSfx.currentTime = 0;
    actionSfx.play().catch(()=>{});
  }catch(e){}
}

/* ====================== LOGIN + UID por aba ====================== */
function getOrCreateUID(){
  let uid = sessionStorage.getItem("uid_passageiro");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    sessionStorage.setItem("uid_passageiro", uid);
  }
  return uid;
}
let UID = getOrCreateUID();

function getNomeSalvo(){
  return (localStorage.getItem("nome_passageiro") || "").trim();
}
let USER_NAME = getNomeSalvo();

function abrirLogin(){
  loginOverlay.style.display = "flex";
  document.body.style.overflow = "hidden";
  setTimeout(()=>{ try{ loginName.focus(); }catch(e){} }, 50);
}
function fecharLogin(){
  loginOverlay.style.display = "none";
  document.body.style.overflow = "";
}
function confirmarNome(){
  let nome = (loginName.value || "").trim();
  if(nome.length < 2){
    alert("Digite um nome com pelo menos 2 letras.");
    try{ loginName.focus(); }catch(e){}
    return;
  }
  localStorage.setItem("nome_passageiro", nome);
  USER_NAME = nome;
  UID = getOrCreateUID();
  fecharLogin();
  setTimeout(()=>{ location.reload(); }, 80);
}
(function exigirLogin(){ if(!USER_NAME) abrirLogin(); })();

function sairNome(){
  localStorage.removeItem("nome_passageiro");
  sessionStorage.removeItem("nome_passageiro");
  sessionStorage.removeItem("uid_passageiro");
  USER_NAME = "";
  UID = getOrCreateUID();
  abrirLogin();
}
function precisaLogin(){
  if(!USER_NAME){ abrirLogin(); return true; }
  return false;
}
document.addEventListener("keydown", (e)=>{
  if(loginOverlay.style.display === "flex" && e.key === "Enter"){ confirmarNome(); }
});

/* Helpers */
function escapeHTML(str){
  return (str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}

/* limites */
const MAX_IMG_MB = 15;
const MAX_VID_MB = 120;
function checkSize(file){
  const mb = file.size/(1024*1024);
  if(file.type.startsWith("image/") && mb>MAX_IMG_MB){
    alert(`Imagem muito grande (${mb.toFixed(1)}MB). Envie at√© ${MAX_IMG_MB}MB.`);
    return false;
  }
  if(file.type.startsWith("video/") && mb>MAX_VID_MB){
    alert(`V√≠deo muito grande (${mb.toFixed(1)}MB). Envie at√© ${MAX_VID_MB}MB.`);
    return false;
  }
  return true;
}

/* Loading */
function showLoading(title, sub){
  loadingText.textContent = title || "Enviando...";
  loadingSub.textContent = sub || "Aguarde um instante";
  loadingOverlay.style.display = "flex";
}
function hideLoading(){
  loadingOverlay.style.display = "none";
}
</script>

<script>
/* ===================== STORIES estilo Insta ===================== */
const menuTop = document.querySelector('.top-menu');

let allStories = [];
let groupedStories = [];
let activeStories = [];
let current = 0;
let viewerTimer = null;

function renderCreateCard(){
  const card = document.createElement("div");
  card.className = "storyCard createCard";
  const inputId = "uploadStoryInput";
  card.innerHTML = `
    <div class="plusBtn">+</div>
    <div class="createLabel">Criar Hist√≥ria</div>
    <input id="${inputId}" type="file" accept="image/*,video/*" style="display:none;">
  `;
  card.onclick = ()=>{
    if(precisaLogin()) return;
    document.getElementById(inputId).click();
  };
  setTimeout(()=>{
    const upload = document.getElementById(inputId);
    upload.onchange = e=>{
      if(precisaLogin()) return;
      const file = e.target.files[0];
      if(!file) return;
      if(!checkSize(file)) { upload.value=""; return; }
      addStory(file);
      upload.value = "";
    };
  }, 0);
  return card;
}

function buildSegRow(count){
  const max = Math.min(count, 12);
  return `
    <div class="segRow">
      ${Array.from({length:max}).map(()=>`<div class="seg"></div>`).join("")}
    </div>
  `;
}

/* preview do card continua muted (como estava) */
function renderUserCard(group){
  const card = document.createElement("div");
  card.className = "storyCard";
  card.dataset.uid = group.uid;

  const cover = group.last;
  const uname = group.userName || "Usu√°rio";
  const segs = buildSegRow(group.items.length);

  let mediaHTML = "";
  if((cover.type||"").includes("image")){
    mediaHTML = `<img class="storyMedia" src="${cover.url}" alt="story" loading="lazy">`;
  }else{
    mediaHTML = `
      <video class="storyMedia"
        src="${cover.url}"
        autoplay muted loop playsinline
        preload="metadata">
      </video>
    `;
  }

  const avatarHTML = ((cover.type||"").includes("image"))
    ? `<div class="avatarCircle"><img src="${cover.url}" alt="avatar" loading="lazy"></div>`
    : `<div class="avatarCircle"><div class="avatarInitials">${escapeHTML(initials(uname))}</div></div>`;

  card.innerHTML = `
    ${mediaHTML}
    <div class="storyShade"></div>
    ${segs}
    ${avatarHTML}
    <div class="storyName">${escapeHTML(uname)}</div>
  `;

  card.onclick = ()=>{
    if(group.items.length === 0) return;
    activeStories = group.items.slice().sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
    openViewer(0);
  };

  return card;
}

function renderStoriesRow(){
  const row = document.getElementById("storiesRow");
  row.innerHTML = "";

  row.appendChild(renderCreateCard());

  const myGroup = groupedStories.find(g => g.uid === UID);
  if(myGroup) row.appendChild(renderUserCard(myGroup));

  groupedStories
    .filter(g => g.uid !== UID)
    .sort((a,b)=>(b.last?.createdAt||0)-(a.last?.createdAt||0))
    .forEach(g => row.appendChild(renderUserCard(g)));
}

async function addStory(file){
  if(precisaLogin()) return;
  try{
    showLoading("Enviando story...", "Seu v√≠deo/foto vai aparecer j√° j√°");
    const storyId = "story_" + Date.now() + "_" + Math.random().toString(36).slice(2);
    const path = `stories/${UID}/${storyId}`;
    const ref = ST.ref().child(path);

    await ref.put(file, { contentType: file.type });
    const url = await ref.getDownloadURL();

    const data = {
      url,
      type: file.type,
      uid: UID,
      userName: USER_NAME,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      storagePath: path
    };

    await DB.ref("stories/" + storyId).set(data);

    playActionSound(); /* postou story */
  }catch(err){
    console.log(err);
    alert("Erro ao enviar story.");
  }finally{
    hideLoading();
  }
}

/* VIEWER */
function openViewer(idx){
  current = idx;
  viewer.style.display = "flex";
  menuTop.classList.add("hide");
  showStory();
}
function closeViewer(){
  stopVideo();
  viewer.style.display = "none";
  deleteBtn.style.display = "none";
  menuTop.classList.remove("hide");
  clearTimeout(viewerTimer);
  viewerTimer = null;
}
function showStory(){
  clearTimeout(viewerTimer);
  viewerTimer = null;

  viewerMedia.innerHTML = "";
  bars.innerHTML = "";

  const total = activeStories.length;
  for(let i=0;i<total;i++){
    const bar = document.createElement("div");
    bar.className = "bar";
    const fill = document.createElement("div");
    fill.className = "barFill";
    bar.appendChild(fill);
    bars.appendChild(bar);
    if(i<current) fill.style.width="100%";
    if(i===current) fill.id="currentFill";
  }

  const s = activeStories[current];
  if(!s){ closeViewer(); return; }

  deleteBtn.style.display = "none";

  if((s.type||"").includes("image")){
    const el = document.createElement("img");
    el.src = s.url;
    viewerMedia.appendChild(el);
    runProgress(120000);
    viewerTimer = setTimeout(()=>nextStory(), 120000);
  }else{
    const el = document.createElement("video");
    el.src = s.url;

    /* ‚úÖ AQUI EST√Å A CORRE√á√ÉO: ABRE E TOCA COM SOM */
    el.autoplay = true;
    el.muted = false;
    el.volume = 1;

    el.controls = true;
    el.playsInline = true;
    el.preload = "metadata";

    el.onloadedmetadata = ()=>{
      const realDur = (el.duration||0)*1000;
      const dur = Math.min(realDur||6000, 120000);
      runProgress(dur);
      viewerTimer = setTimeout(()=>nextStory(), dur);
    };

    viewerMedia.appendChild(el);

    /* tenta tocar com som (como o clique abriu o viewer, costuma funcionar) */
    el.play().catch(()=>{
      /* se algum celular bloquear, ao menos fica pronto pro usu√°rio apertar play */
    });
  }
}
function runProgress(ms){
  const fill = document.getElementById("currentFill");
  if(!fill) return;
  fill.style.transition="none";
  fill.style.width="0";
  setTimeout(()=>{
    fill.style.transition = `width ${ms}ms linear`;
    fill.style.width="100%";
  }, 40);
}
function stopVideo(){
  const vid = viewerMedia.querySelector("video");
  if(vid){
    try{ vid.pause(); }catch(e){}
    try{ vid.currentTime = 0; }catch(e){}
    try{ vid.src = ""; }catch(e){}
  }
}
function nextStory(){
  stopVideo();
  current++;
  if(current >= activeStories.length) closeViewer();
  else showStory();
}
function prevStory(){
  if(current<=0) return;
  stopVideo();
  current--;
  showStory();
}
tapRight.onclick = nextStory;
tapLeft.onclick = prevStory;

dots.onclick = ()=>{ deleteBtn.style.display = (deleteBtn.style.display==="block" ? "none" : "block"); };
deleteBtn.onclick = async ()=>{
  const s = activeStories[current];
  if(!s) return;
  try{
    stopVideo();
    await DB.ref("stories/" + s.id).remove();
    if(s.storagePath){
      await ST.ref().child(s.storagePath).delete().catch(()=>{});
    }

    playActionSound(); /* excluiu story */

    if(current>0) current--;
    closeViewer();
  }catch(err){
    console.log(err);
    alert("Erro ao excluir story.");
  }
};

/* Listener stories */
(function listenStories(){
  const ref = DB.ref("stories").orderByChild("createdAt").limitToLast(500);
  ref.on("value", snap=>{
    const obj = snap.val() || {};
    allStories = Object.keys(obj).map(id=>({id, ...obj[id]}))
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    const map = {};
    allStories.forEach(s=>{
      if(!s.uid) return;
      if(!map[s.uid]) map[s.uid] = { uid:s.uid, userName:s.userName||"Usu√°rio", items:[] };
      map[s.uid].items.push(s);
      map[s.uid].userName = s.userName || map[s.uid].userName;
    });

    groupedStories = Object.values(map).map(g=>{
      const items = g.items.slice().sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
      return { uid:g.uid, userName:g.userName, items, last: items[items.length-1] };
    });

    renderStoriesRow();
  });
})();
</script>

<script>
/* ===================== FEED / MURAL (mais r√°pido) ===================== */
let selectedFile = null;
let mode = "add";
let longPress = {};
let holdTimer = null;

const postsCache = new Set();
const MAX_RENDER_PER_FRAME = 8;
let renderQueue = [];
let pumping = false;

function updateButton(){
  let t = postText.value.trim();
  if(t.length > 0){
    btnMain.className = "whatsapp-send";
    btnMain.innerHTML = "‚û§";
    mode = "postar";
  } else {
    btnMain.className = "add-btn";
    btnMain.innerHTML = "+";
    mode = "add";
  }
}
function buttonAction(){
  if(precisaLogin()) return;
  mode === "add" ? fileInput.click() : postarTexto();
}

/* preview sem vazamento */
let previewUrlToRevoke = null;

fileInput.onchange = e=>{
  if(precisaLogin()) return;
  selectedFile = e.target.files[0];
  if(!selectedFile) return;
  if(!checkSize(selectedFile)){ selectedFile=null; fileInput.value=""; return; }

  if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
  const url = URL.createObjectURL(selectedFile);
  previewUrlToRevoke = url;

  previewContent.innerHTML =
    selectedFile.type.startsWith("image/")
      ? `<img src="${url}" style="width:100%;border-radius:10px;" loading="lazy">`
      : `<video src="${url}" controls preload="metadata" playsinline style="width:100%;border-radius:10px;background:#000;"></video>`;
  previewBox.style.display = "block";
};

async function postarTexto(){
  if(precisaLogin()) return;
  const t = postText.value.trim();
  if(!t) return;
  showLoading("Postando...", "Publicando no mural");
  try{
    await criarPostFirebase(t, null, null, null);
    playActionSound(); /* postou publica√ß√£o */
    postText.value = "";
    updateButton();
  }finally{
    hideLoading();
  }
}

async function postar(){
  if(precisaLogin()) return;
  if(!selectedFile){
    alert("Selecione uma m√≠dia primeiro.");
    return;
  }

  const texto = postText.value || "";
  const file = selectedFile;

  const postId = "post_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  const localUrl = URL.createObjectURL(file);

  criarPostOptimista(postId, {
    text: texto,
    mediaUrl: localUrl,
    mediaType: file.type,
    uid: UID,
    userName: USER_NAME,
    createdAt: Date.now(),
    _pending: true
  });

  showLoading("Enviando m√≠dia...", "No celular pode demorar um pouco dependendo da internet");

  try{
    await criarPostFirebase(texto, file, file.type, postId);
    playActionSound(); /* postou publica√ß√£o */
  }catch(err){
    console.log(err);
    alert("Erro ao postar.");
    const el = document.getElementById(postId);
    if(el) el.remove();
    postsCache.delete(postId);
  }finally{
    hideLoading();

    selectedFile = null;
    postText.value = "";
    previewBox.style.display = "none";
    previewContent.innerHTML = "";
    if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
    updateButton();
  }
}

function removerPreview(){
  selectedFile = null;
  previewBox.style.display = "none";
  previewContent.innerHTML = "";
  if(previewUrlToRevoke){ URL.revokeObjectURL(previewUrlToRevoke); previewUrlToRevoke=null; }
}

async function criarPostFirebase(texto, fileOrNull, fileTypeOrNull, forcedPostId){
  const postId = forcedPostId || ("post_" + Date.now() + "_" + Math.random().toString(36).slice(2));
  try{
    let mediaUrl = null;
    let mediaType = null;
    let storagePath = null;

    if(fileOrNull){
      mediaType = fileTypeOrNull || fileOrNull.type || "";
      storagePath = `posts/${UID}/${postId}`;
      const ref = ST.ref().child(storagePath);
      await ref.put(fileOrNull, { contentType: mediaType });
      mediaUrl = await ref.getDownloadURL();
    }

    const data = {
      text: (texto || "").toString(),
      mediaUrl,
      mediaType,
      uid: UID,
      userName: USER_NAME,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      storagePath
    };

    await DB.ref("posts/" + postId).set(data);
    return postId;
  }catch(err){
    throw err;
  }
}

function pressionarCurtir(id){
  longPress[id] = false;
  holdTimer = setTimeout(()=>{
    longPress[id] = true;
    amei(id);
  }, 500);
}
function soltarCurtir(){
  if(holdTimer) clearTimeout(holdTimer);
}

async function curtir(id){
  if(precisaLogin()) return;
  if(longPress[id]){ longPress[id] = false; return; }
  try{
    const likeRef = DB.ref(`likes/${id}/${UID}`);
    const snap = await likeRef.once("value");
    const cur = snap.val();
    if(cur) await likeRef.remove();
    else await likeRef.set({ type:"like", uid:UID, userName:USER_NAME, createdAt: firebase.database.ServerValue.TIMESTAMP });

    playActionSound(); /* curtir */
  }catch(err){
    console.log(err);
    alert("Erro ao curtir.");
  }
}
async function amei(id){
  if(precisaLogin()) return;
  try{
    const likeRef = DB.ref(`likes/${id}/${UID}`);
    const snap = await likeRef.once("value");
    const cur = snap.val();
    if(cur && cur.type === "love") await likeRef.remove();
    else await likeRef.set({ type:"love", uid:UID, userName:USER_NAME, createdAt: firebase.database.ServerValue.TIMESTAMP });

    playActionSound(); /* amei */
  }catch(err){
    console.log(err);
    alert("Erro ao amar.");
  }
}

function atualizarCurtidasUI(postId, likesObj){
  const btn = document.getElementById("curtir_"+postId);
  const cont = document.getElementById("contadorCurtidas_"+postId);
  if(!btn || !cont) return;

  const likes = likesObj || {};
  const entries = Object.values(likes);
  const total = entries.length;
  const my = likes[UID];

  if(my){
    if(my.type === "love"){
      btn.textContent = "‚ù§Ô∏è Voc√™ amou";
      btn.style.color = "#ff008c";
    }else{
      btn.textContent = "üëç Voc√™ curtiu";
      btn.style.color = "#00ff9d";
    }
  }else{
    btn.textContent = "üëç Curtir";
    btn.style.color = "#00ff9d";
  }

  if(total === 0){ cont.innerHTML = ""; return; }

  const sorted = entries.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
  const nomes = sorted.map(x => (x.uid === UID ? "Voc√™" : escapeHTML(x.userName || "Usu√°rio")));
  cont.innerHTML = `Curtidas (${total}): <b>${nomes.join(", ")}</b>`;
}

function abrirComentarios(id){
  const box = document.getElementById("comentarios_"+id);
  if(!box) return;
  box.style.display = "block";

  document.removeEventListener("click", fecharBox);
  function fecharBox(e){
    const insideBox = box.contains(e.target);
    const clickedButton = e.target.closest(".btn-action");
    if(!insideBox && !clickedButton){
      box.style.display = "none";
      document.removeEventListener("click", fecharBox);
    }
  }
  setTimeout(()=> document.addEventListener("click", fecharBox), 50);
}

async function enviarComentario(id){
  if(precisaLogin()) return;
  const input = document.getElementById("comentarioInput_"+id);
  if(!input) return;
  const texto = input.value.trim();
  if(!texto) return;

  try{
    const commentId = "cmt_" + Date.now() + "_" + Math.random().toString(36).slice(2);
    await DB.ref(`comments/${id}/${commentId}`).set({
      uid: UID,
      userName: USER_NAME,
      text: texto,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    });
    input.value = "";

    playActionSound(); /* comentou */
  }catch(err){
    console.log(err);
    alert("Erro ao comentar.");
  }
}

function toggleComentMenu(cid){
  const menu = document.getElementById("menu_"+cid);
  if(!menu) return;
  menu.style.display = (menu.style.display==="block" ? "none" : "block");
}

async function excluirComentario(cid, postId){
  try{
    await DB.ref(`comments/${postId}/${cid}`).remove();
    playActionSound(); /* excluiu coment√°rio */
  }
  catch(err){ console.log(err); alert("Erro ao excluir coment√°rio."); }
}

function toggleMenu(id){
  let m = document.getElementById("menu_"+id);
  if(!m) return;
  m.style.display = (m.style.display==="block" ? "none" : "block");
}

async function excluirPost(id){
  try{
    const snap = await DB.ref("posts/" + id).once("value");
    const data = snap.val();

    await DB.ref("posts/" + id).remove();
    await DB.ref("likes/" + id).remove().catch(()=>{});
    await DB.ref("comments/" + id).remove().catch(()=>{});

    if(data && data.storagePath){
      await ST.ref().child(data.storagePath).delete().catch(()=>{});
    }

    const el = document.getElementById(id);
    if(el) el.remove();
    postsCache.delete(id);

    playActionSound(); /* excluiu post */
  }catch(err){
    console.log(err);
    alert("Erro ao excluir post.");
  }
}

/* post HTML */
function postHTML(id, postData){
  let midia = "";
  if(postData.mediaUrl){
    const isImg = (postData.mediaType || "").startsWith("image/");
    midia = isImg
      ? `<img src="${postData.mediaUrl}" loading="lazy">`
      : `<video src="${postData.mediaUrl}" controls preload="metadata" playsinline></video>`;
  }

  const nome = escapeHTML(postData.userName || "Usu√°rio");
  const texto = escapeHTML(postData.text || "");
  const quando = postData.createdAt
    ? `<div style="font-size:12px;color:#00ff9d;opacity:.85;margin-top:-6px;">${fmtDate(postData.createdAt)}</div>`
    : "";

  const pending = postData._pending ? `<span class="pendingBadge">ENVIANDO‚Ä¶</span>` : "";

  return `
  <div class="post" id="${id}" ${postData._pending ? 'data-pending="1"' : ''}>
    <div class="menu-btn" onclick="toggleMenu('${id}')">‚ãÆ</div>
    <div class="menu-box" id="menu_${id}">
      <div onclick="excluirPost('${id}')">Excluir</div>
    </div>

    <h3>üåü ${nome} ${pending}</h3>
    ${quando}
    <p>${texto}</p>

    <div class="mediaWrap" id="mediaWrap_${id}">
      ${midia}
    </div>

    <div class="post-actions">
      <div style="text-align:center; min-width:160px;">
        <div class="btn-action"
          id="curtir_${id}"
          onmousedown="pressionarCurtir('${id}')"
          onmouseup="soltarCurtir()"
          ontouchstart="pressionarCurtir('${id}')"
          ontouchend="soltarCurtir()"
          onclick="curtir('${id}')">
          üëç Curtir
        </div>
        <div class="contador" id="contadorCurtidas_${id}"></div>
      </div>

      <div style="text-align:center; min-width:160px;">
        <div class="btn-action" onclick="abrirComentarios('${id}')">üí¨ Comentar</div>
        <div class="contador" id="contadorComentarios_${id}"></div>
      </div>
    </div>

    <div class="coment-area" id="comentarios_${id}">
      <div id="listaComentarios_${id}" style="margin-bottom:15px;"></div>

      <input type="text" id="comentarioInput_${id}"
        placeholder="Escreva um coment√°rio..."
        style="width:100%;padding:10px;border-radius:8px;border:1px solid #00ff9d;background:#000;color:#fff;">

      <button onclick="enviarComentario('${id}')"
        style="margin-top:8px;background:#00ff9d;border:none;padding:8px 15px;border-radius:8px;cursor:pointer;">
        Enviar
      </button>
    </div>
  </div>
  `;
}

/* post instant√¢neo */
function criarPostOptimista(id, postData){
  if(postsCache.has(id)) return;
  postsCache.add(id);
  longPress[id] = false;

  const feed = document.getElementById("feed");
  const temp = document.createElement("div");
  temp.innerHTML = postHTML(id, postData).trim();
  feed.prepend(temp.firstChild);

  listenLikes(id);
  listenComments(id);
}

function atualizarPostDoServidor(id, data){
  const el = document.getElementById(id);
  if(!el) return;

  const h3 = el.querySelector("h3");
  if(h3){
    const nome = escapeHTML(data.userName || "Usu√°rio");
    h3.innerHTML = `üåü ${nome}`;
  }

  const whenDiv = el.querySelector("div[style*='font-size:12px']");
  if(whenDiv && data.createdAt){
    whenDiv.textContent = fmtDate(data.createdAt);
  }

  const p = el.querySelector("p");
  if(p) p.textContent = (data.text || "");

  const wrap = document.getElementById("mediaWrap_"+id);
  if(wrap){
    if(data.mediaUrl){
      const isImg = (data.mediaType||"").startsWith("image/");
      wrap.innerHTML = isImg
        ? `<img src="${data.mediaUrl}" loading="lazy">`
        : `<video src="${data.mediaUrl}" controls preload="metadata" playsinline></video>`;
    }else{
      wrap.innerHTML = "";
    }
  }

  el.removeAttribute("data-pending");
}

function listenLikes(postId){
  DB.ref("likes/" + postId).on("value", snap=>{
    atualizarCurtidasUI(postId, snap.val() || {});
  });
}

function listenComments(postId){
  DB.ref("comments/" + postId).orderByChild("createdAt").on("value", snap=>{
    const lista = document.getElementById("listaComentarios_"+postId);
    const contador = document.getElementById("contadorComentarios_"+postId);
    if(!lista || !contador) return;

    const obj = snap.val() || {};
    const arr = Object.keys(obj).map(cid=>({ cid, ...obj[cid] }))
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    lista.innerHTML = arr.map(c=>{
      const nome = escapeHTML(c.userName || "Usu√°rio");
      const txt = escapeHTML(c.text || "");
      return `
        <div id="${c.cid}" style="background:#000;border:1px solid #00ff9d;padding:8px;border-radius:8px;margin-bottom:5px;position:relative;">
          <b style="color:#00ff9d;">${nome}:</b> üí¨ ${txt}
          <span class="coment-menu-btn" onclick="toggleComentMenu('${c.cid}')">‚ãÆ</span>
          <div class="coment-menu-box" id="menu_${c.cid}"
            onclick="excluirComentario('${c.cid}','${postId}')">
            Excluir
          </div>
        </div>
      `;
    }).join("");

    const total = arr.length;
    if(total === 0) contador.innerHTML = "";
    else if(total === 1) contador.innerHTML = "1 coment√°rio";
    else contador.innerHTML = `${total} coment√°rios`;
  });
}

/* listener posts */
(function listenPostsFast(){
  const ref = DB.ref("posts").orderByChild("createdAt").limitToLast(200);

  ref.on("child_added", snap=>{
    const id = snap.key;
    const data = snap.val() || {};

    const el = document.getElementById(id);
    if(el){
      atualizarPostDoServidor(id, data);
      return;
    }

    if(postsCache.has(id)) return;
    renderQueue.push({ id, data });
    pumpRenderQueue();
  });

  ref.on("child_removed", snap=>{
    const id = snap.key;
    postsCache.delete(id);
    const el = document.getElementById(id);
    if(el) el.remove();
  });
})();

function pumpRenderQueue(){
  if(pumping) return;
  pumping = true;

  const step = ()=>{
    let n = 0;
    while(renderQueue.length && n < MAX_RENDER_PER_FRAME){
      const it = renderQueue.shift();
      if(!postsCache.has(it.id)){
        postsCache.add(it.id);
        const feed = document.getElementById("feed");
        const temp = document.createElement("div");
        temp.innerHTML = postHTML(it.id, it.data).trim();
        feed.prepend(temp.firstChild);
        listenLikes(it.id);
        listenComments(it.id);
      }
      n++;
    }
    if(renderQueue.length){
      requestAnimationFrame(step);
    }else{
      pumping = false;
    }
  };
  requestAnimationFrame(step);
}

updateButton();
</script>

</body>
</html>
