<!-- ===========================
  PREVIA.HTML (com bot√£o SEGUIR)
  =========================== -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Pr√©via do Perfil</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  *{ box-sizing:border-box; }
  html,body{ width:100%; max-width:100%; overflow-x:hidden; }
  body{
    margin:0;
    background:#18191A;
    color:#E4E6EB;
    font-family: Arial, sans-serif;
    padding-bottom: env(safe-area-inset-bottom);
  }

  :root{
    --fb-bg:#18191A;
    --fb-surface:#242526;
    --fb-surface-2:#2D2E30;
    --fb-border:rgba(255,255,255,.10);
    --fb-text:#E4E6EB;
    --fb-muted:rgba(228,230,235,.72);
    --fb-blue:#0866FF;
    --fb-green:#31A24C;
    --fb-shadow:0 8px 18px rgba(0,0,0,.35);
    --fb-radius:16px;
  }

  .topbar{
    position: sticky; top:0; z-index:9999;
    background: var(--fb-surface);
    border-bottom:1px solid var(--fb-border);
    box-shadow: 0 6px 16px rgba(0,0,0,.25);
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .topbar .center{ flex:1; display:flex; justify-content:center; align-items:center; min-width:0; }
  .brand{
    font-weight:900;
    color: var(--fb-text);
    letter-spacing:.3px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 92vw;
  }
  .iconBtn{
    width:44px; height:44px;
    border-radius:999px;
    border:1px solid var(--fb-border);
    background: var(--fb-surface-2);
    color: var(--fb-text);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;
    box-shadow: 0 6px 14px rgba(0,0,0,.22);
  }
  .iconBtn:active{ transform:scale(.99); }

  .wrap{ width:min(980px, 100%); margin:0 auto; }

  .cover{
    position:relative;
    width:100%;
    height: clamp(190px, 36vw, 340px);
    background: #111;
    overflow:hidden;
    border-bottom:1px solid var(--fb-border);
    cursor:pointer;
  }
  .cover img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    background:#000;
    filter: contrast(1.02) saturate(1.03);
  }
  .coverShade{
    position:absolute; inset:auto 0 0 0;
    height:55%;
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 35%, rgba(0,0,0,.85) 100%);
    pointer-events:none;
  }

  .avatarRow{
    position:relative;
    padding: 0 12px 12px 12px;
    margin-top: -58px;
    display:flex;
    gap:12px;
    align-items:flex-end;
    flex-wrap:wrap;
  }
  .avatar{
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow:hidden;
    background: #3A3B3C;
    border:4px solid var(--fb-bg);
    box-shadow: 0 0 0 3px rgba(8,102,255,.22), 0 10px 28px rgba(0,0,0,.55);
    flex:0 0 auto;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .avatar img{
    width:100%;
    height:100%;
    object-fit:cover;
    object-position:center;
    display:block;
  }
  .avatarInitial{
    font-weight:900; font-size:34px;
    color:#fff;
    text-shadow:0 0 14px rgba(0,0,0,.55);
  }

  .identity{ min-width: 220px; flex:1; }
  .identity h1{
    margin:0;
    font-size: clamp(22px, 6vw, 34px);
    font-weight: 900;
    letter-spacing:.2px;
    color: var(--fb-text);
    text-shadow:0 2px 14px rgba(0,0,0,.55);
  }
  .sub{
    margin-top:8px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .pill{
    display:inline-flex;
    gap:8px;
    align-items:center;
    padding:7px 12px;
    border-radius:999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    color: var(--fb-text);
    font-weight:900;
    font-size:13px;
    user-select:none;
  }
  .dot{ width:10px; height:10px; border-radius:50%; box-shadow:0 0 14px rgba(0,0,0,.35); }
  .dot.online{ background: var(--fb-green); box-shadow:0 0 14px rgba(49,162,76,.6); animation: blinkDot 1.0s infinite; }
  .dot.offline{ background:#F7B928; box-shadow:0 0 14px rgba(247,185,40,.55); }
  @keyframes blinkDot{ 0%,100%{ transform:scale(1); opacity:1; } 50%{ transform:scale(1.25); opacity:.35; } }
  .pill.offline{ background: rgba(247,185,40,.08); border-color: rgba(247,185,40,.28); color:#F7B928; }

  .card{
    background: var(--fb-surface);
    border:1px solid var(--fb-border);
    border-radius: var(--fb-radius);
    padding: 12px;
    box-shadow: var(--fb-shadow);
    margin: 12px;
  }

  .bioBox{
    border:1px solid rgba(255,255,255,.06);
    background: rgba(255,255,255,.03);
    border-radius:14px;
    padding:12px;
    margin-top:10px;
  }
  .bioTitle{
    font-weight:900;
    color: var(--fb-text);
    letter-spacing:.4px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .bioTitle i{ color: var(--fb-blue); }
  .bioText{
    margin-top:10px;
    opacity:.92;
    line-height:1.45;
    word-break:break-word;
    color: rgba(228,230,235,.95);
  }

  .rowActionsTop{
    margin-top:10px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .btn{
    border:none;
    cursor:pointer;
    font-weight:900;
    padding:12px 14px;
    border-radius:999px;
    background: var(--fb-blue);
    color:#fff;
    user-select:none;
    display:inline-flex;
    align-items:center;
    gap:10px;
    justify-content:center;
    transition:.15s;
    box-shadow: 0 10px 18px rgba(8,102,255,.18);
  }
  .btn:active{ transform:scale(.99); }
  .btn.ghost{
    background: rgba(255,255,255,.06);
    color: var(--fb-text);
    border:1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 18px rgba(0,0,0,.18);
  }
  .btn.ghost:hover{ background: rgba(255,255,255,.09); }
  .btn.red{
    background: rgba(255,90,90,.16);
    border:1px solid rgba(255,90,90,.35);
    color:#ff8080;
    box-shadow:none;
  }

  .post{
    background: var(--fb-surface);
    margin: 12px 0;
    padding: 12px;
    border-radius: var(--fb-radius);
    border:1px solid var(--fb-border);
    box-shadow: var(--fb-shadow);
    position:relative;
  }
  .postHead{ display:flex; align-items:center; gap:10px; }
  .postAvatar{
    width:42px; height:42px;
    border-radius:50%;
    overflow:hidden;
    background:#3A3B3C;
    border:1px solid rgba(255,255,255,.08);
    flex:0 0 auto;
    display:flex; align-items:center; justify-content:center;
  }
  .postAvatar img{ width:100%; height:100%; object-fit:cover; object-position:center; display:block; }
  .postAvatar .init{ font-weight:900; color: var(--fb-text); }

  .postName{
    font-weight:900;
    font-size:15px;
    color: var(--fb-text);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 62vw;
  }
  .when{ font-size:12px; color: var(--fb-muted); margin-top:3px; }
  .post p{ margin:10px 0 0 0; font-size:14px; line-height:1.35; color: rgba(228,230,235,.95); }

  .mediaWrap img, .mediaWrap video{
    width:100%;
    border-radius: 14px;
    margin-top:10px;
    background:#000;
    display:block;
    border:1px solid rgba(255,255,255,.08);
  }

  .videoWrap{ position:relative; margin-top:10px; }
  .videoWrap video{
    width:100%;
    border-radius: 14px;
    background:#000;
    display:block;
    border:1px solid rgba(255,255,255,.08);
  }
  .tapToSound{
    position:absolute;
    left: 12px;
    bottom: 12px;
    display:inline-flex;
    gap:10px;
    align-items:center;
    padding:10px 12px;
    border-radius:999px;
    background: rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.14);
    color: var(--fb-text);
    font-weight:900;
    font-size:13px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 10px 22px rgba(0,0,0,.35);
    user-select:none;
    pointer-events:none;
  }
  .tapToSound i{ color: var(--fb-blue); }
  .tapToSound.hide{ display:none; }

  .post-actions{
    display:flex;
    justify-content:space-around;
    margin-top:12px;
    flex-wrap:wrap;
    gap: 8px;
  }
  .btn-action{
    color: var(--fb-text);
    padding: 10px 12px;
    border-radius: 10px;
    font-weight:900;
    cursor:pointer;
    transition:.15s;
    text-align:center;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    user-select:none;
    min-width: 150px;
  }
  .btn-action:hover{ background: rgba(255,255,255,.08); }
  .btn-action:active{ transform: scale(.99); }

  .contador{
    margin-top:6px;
    font-size:12px;
    color: var(--fb-muted);
    text-align:center;
    line-height:1.35;
    word-break: break-word;
  }

  .coment-area{
    background: rgba(255,255,255,.04);
    padding:10px;
    margin-top:10px;
    border-radius: 14px;
    display:none;
    border:1px solid rgba(255,255,255,.10);
  }

  .cRow{
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.10);
    padding:10px;
    border-radius: 14px;
    margin-bottom:8px;
  }
  .cHead{ display:flex; align-items:center; gap:10px; margin-bottom:6px; min-width:0; }
  .cAvatar{
    width:30px; height:30px;
    border-radius:50%;
    overflow:hidden;
    background:#3A3B3C;
    border:1px solid rgba(255,255,255,.08);
    flex:0 0 auto;
    display:flex; align-items:center; justify-content:center;
  }
  .cAvatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .cAvatar .init{ font-weight:900; color: var(--fb-text); }
  .cName{
    font-weight:900;
    color: var(--fb-text);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 62vw;
    font-size:14px;
  }
  .cText{ opacity:.95; font-size:13px; color: rgba(228,230,235,.92); }

  .empty{
    opacity:.9;
    padding:12px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
    border-radius:14px;
    margin-top:12px;
    color: var(--fb-text);
  }

  .login-overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.94);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 9999999;
    padding: 16px;
  }
  .login-card{
    width: min(520px, 94vw);
    max-width: 94vw;
    background: var(--fb-surface);
    border:1px solid var(--fb-border);
    border-radius: 18px;
    box-shadow: var(--fb-shadow);
    padding: 18px;
    text-align:center;
  }
  .login-title{
    font-size: clamp(18px, 6vw, 24px);
    font-weight: 900;
    color: var(--fb-text);
    letter-spacing:.5px;
    margin: 4px 0 14px 0;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .login-title i{ color: var(--fb-blue); }
  .login-input{
    width: 100%;
    display:block;
    background:#3A3B3C;
    border:1px solid rgba(255,255,255,.10);
    border-radius: 999px;
    padding: 14px 18px;
    color: var(--fb-text);
    outline:none;
    font-size: 16px;
  }
  .login-btn{
    width: 100%;
    margin-top: 12px;
    border:none;
    border-radius: 999px;
    padding: 14px 12px;
    font-weight: 900;
    cursor:pointer;
    font-size: 16px;
    transition:.15s;
    background: var(--fb-blue);
    color:#fff;
    box-shadow: 0 10px 20px rgba(0,0,0,.22);
  }
  .login-btn:active{ transform:scale(.99); }

  .toastStatus{
    position: fixed;
    left: 50%;
    bottom: calc(16px + env(safe-area-inset-bottom));
    transform: translateX(-50%);
    background: rgba(36,37,38,.92);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 20px rgba(0,0,0,.35);
    color: var(--fb-text);
    padding: 10px 14px;
    border-radius: 999px;
    font-weight: 900;
    display:none;
    align-items:center;
    gap:10px;
    z-index: 99999999;
    max-width: 92vw;
    text-align:center;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .toastDot{ width:10px; height:10px; border-radius:50%; box-shadow: 0 0 0 3px rgba(0,0,0,.18); }
  .toastDot.on{ background: var(--fb-green); box-shadow:0 0 14px rgba(49,162,76,.55); }
  .toastDot.off{ background:#F7B928; box-shadow:0 0 14px rgba(247,185,40,.45); }

  @media(max-width:480px){
    .avatar{ width:104px; height:104px; }
  }
</style>
</head>

<body>

<!-- LOGIN (pra curtir/comentar/seguir) -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-title"><i class="fa-solid fa-user"></i> ENTRAR</div>
    <input id="loginName" class="login-input" maxlength="24" placeholder="Digite seu nome" autocomplete="off">
    <button class="login-btn" onclick="confirmarNome()">Entrar</button>
  </div>
</div>

<!-- TOAST STATUS -->
<div class="toastStatus" id="toastStatus" aria-live="polite">
  <span class="toastDot on" id="toastDot"></span>
  <span id="toastText">Online</span>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div style="width:44px;"></div>
  <div class="center">
    <div class="brand" id="brandTitle">Pr√©via do Perfil</div>
  </div>
  <button class="iconBtn" id="infoBtn" title="Status" aria-label="Status">
    <i class="fa-solid fa-circle-info"></i>
  </button>
</div>

<div class="wrap">

  <!-- CAPA -->
  <div class="cover" id="previewClickableCover" title="Toque para ver o status">
    <img id="coverImg" alt="Capa do perfil">
    <div class="coverShade"></div>
  </div>

  <!-- FOTO PERFIL + IDENTIDADE -->
  <div class="avatarRow">
    <div class="avatar" id="previewClickableAvatar" title="Toque para ver o status">
      <img id="avatarImg" alt="Foto do perfil" style="display:none;">
      <div id="avatarInitial" class="avatarInitial">U</div>
    </div>

    <div class="identity">
      <h1 id="profileName">Carregando...</h1>
      <div class="sub">
        <span class="pill" id="statusPill">
          <span class="dot online" id="statusDot"></span>
          <span id="statusText">Online</span>
        </span>
        <span class="pill"><i class="fa-solid fa-location-dot" style="color:var(--fb-blue)"></i> <span id="cityText">‚Äî</span></span>
        <span class="pill"><i class="fa-solid fa-user-plus" style="color:var(--fb-blue)"></i> <span id="followersCount">0 seguidores</span></span>
      </div>

      <!-- ‚úÖ SEGUIR -->
      <div class="rowActionsTop">
        <button class="btn" id="followBtn" onclick="toggleFollow()" style="display:none;">
          <i class="fa-solid fa-user-plus"></i> Seguir
        </button>
        <button class="btn ghost" id="backBtn" onclick="goBack()" style="display:none;">
          <i class="fa-solid fa-arrow-left"></i> Voltar
        </button>
      </div>
    </div>
  </div>

  <!-- BIO + FEED -->
  <div class="card">
    <div class="bioTitle"><i class="fa-solid fa-circle-info"></i> Biografia</div>

    <div class="bioBox">
      <div class="bioText" id="bioText">Carregando...</div>
    </div>

    <div style="margin-top:14px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight:900; color: var(--fb-text); letter-spacing:.4px;">
        <i class="fa-solid fa-list" style="color:var(--fb-blue)"></i> Feed do usu√°rio
      </div>
      <div style="opacity:.85; font-size:13px; color: var(--fb-muted);" id="postsCount">0 postagens</div>
    </div>

    <div id="feed" style="margin-top:10px;"></div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ====================== FIREBASE (MESMO DO SEU SITE) ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};
firebase.initializeApp(firebaseConfig);
const DB = firebase.database();

/* ====================== PARAMS: uid do perfil ====================== */
function getParams(){
  const u = new URLSearchParams(location.search);
  return {
    uid: (u.get("uid") || "").trim(),
    back: (u.get("back") || "").trim()
  };
}
const PARAMS = getParams();
const TARGET_UID = PARAMS.uid;

/* ====================== LOGIN (pra curtir/comentar/seguir) ====================== */
const loginOverlay = document.getElementById("loginOverlay");
const loginName = document.getElementById("loginName");

function getOrCreateUID(){
  let uid = localStorage.getItem("uid_passageiro");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem("uid_passageiro", uid);
  }
  return uid;
}
let UID = getOrCreateUID();
let USER_NAME = (localStorage.getItem("nome_passageiro") || "").trim();

function abrirLogin(){
  loginOverlay.style.display = "flex";
  document.body.style.overflow = "hidden";
  setTimeout(()=>{ try{ loginName.focus(); }catch(e){} }, 50);
}
function fecharLogin(){
  loginOverlay.style.display = "none";
  document.body.style.overflow = "";
}
function confirmarNome(){
  let nome = (loginName.value || "").trim();
  if(nome.length < 2){
    alert("Digite um nome com pelo menos 2 letras.");
    try{ loginName.focus(); }catch(e){}
    return;
  }
  localStorage.setItem("nome_passageiro", nome);
  USER_NAME = nome;
  UID = getOrCreateUID();
  fecharLogin();
}
function precisaLogin(){
  if(!USER_NAME){
    abrirLogin();
    return true;
  }
  return false;
}
document.addEventListener("keydown", (e)=>{
  if(loginOverlay.style.display === "flex" && e.key === "Enter"){ confirmarNome(); }
});

/* Helpers */
function escapeHTML(str){
  str = (str == null ? "" : String(str));
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function initials(name){
  const n = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!n.length) return "U";
  const a = n[0][0] || "U";
  const b = (n.length>1 ? n[n.length-1][0] : "") || "";
  return (a+b).toUpperCase();
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString("pt-BR"); }catch(e){ return ""; }
}

/* ====================== UI: AVATAR / CAPA / STATUS ====================== */
const coverImg = document.getElementById("coverImg");
const avatarImg = document.getElementById("avatarImg");
const avatarInitial = document.getElementById("avatarInitial");
const profileName = document.getElementById("profileName");
const bioText = document.getElementById("bioText");
const cityText = document.getElementById("cityText");
const statusText = document.getElementById("statusText");
const statusDot = document.getElementById("statusDot");
const statusPill = document.getElementById("statusPill");
const feed = document.getElementById("feed");
const postsCount = document.getElementById("postsCount");
const brandTitle = document.getElementById("brandTitle");
const followersCount = document.getElementById("followersCount");
const followBtn = document.getElementById("followBtn");
const backBtn = document.getElementById("backBtn");

function setAvatar(url, name){
  if(url){
    avatarImg.src = url;
    avatarImg.style.display = "block";
    avatarInitial.style.display = "none";
  }else{
    avatarImg.style.display = "none";
    avatarInitial.style.display = "block";
    avatarInitial.textContent = initials(name || "U");
  }
}
function setCover(url){
  coverImg.src = url || "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="520">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#242526"/>
          <stop offset="1" stop-color="#18191A"/>
        </linearGradient>
      </defs>
      <rect width="100%" height="100%" fill="url(#g)"/>
      <circle cx="170" cy="260" r="120" fill="rgba(8,102,255,.18)"/>
      <circle cx="1030" cy="150" r="150" fill="rgba(8,102,255,.10)"/>
      <text x="50%" y="58%" dominant-baseline="middle" text-anchor="middle"
            fill="rgba(228,230,235,.28)" font-size="52" font-family="Arial" font-weight="900">
        PERFIL
      </text>
    </svg>
  `);
}

/* status do perfil aberto */
let CURRENT_TARGET_ONLINE = false;
/* status do pr√≥prio usu√°rio */
let CURRENT_SELF_ONLINE = true;

function setStatus(isOnline){
  CURRENT_TARGET_ONLINE = !!isOnline;
  if(isOnline){
    statusText.textContent = "Online";
    statusDot.classList.remove("offline");
    statusDot.classList.add("online");
    statusPill.classList.remove("offline");
  }else{
    statusText.textContent = "Offline";
    statusDot.classList.remove("online");
    statusDot.classList.add("offline");
    statusPill.classList.add("offline");
  }
}

/* ====================== PRESEN√áA DO PR√ìPRIO USU√ÅRIO ====================== */
function startSelfPresence(){
  const ref = DB.ref("presence/" + UID);

  const ping = ()=>{
    ref.update({
      uid: UID,
      userName: USER_NAME || "Usu√°rio",
      online: true,
      lastActive: firebase.database.ServerValue.TIMESTAMP
    }).catch(()=>{});
  };

  if(USER_NAME) ping();
  setInterval(()=>{ if(USER_NAME) ping(); }, 25000);

  try{
    window.addEventListener("beforeunload", ()=>{
      ref.update({ online:false, lastActive: Date.now() }).catch(()=>{});
    });
  }catch(e){}
}
function listenSelfPresence(){
  DB.ref("presence/" + UID).on("value", snap=>{
    const u = snap.val() || {};
    const last = u.lastActive || 0;
    const now = Date.now();
    CURRENT_SELF_ONLINE = (u.online === true) && (now - last < 65000);
  });
}

/* ====================== TOAST STATUS ====================== */
const toastStatus = document.getElementById("toastStatus");
const toastDot = document.getElementById("toastDot");
const toastText = document.getElementById("toastText");
const previewClickableCover = document.getElementById("previewClickableCover");
const previewClickableAvatar = document.getElementById("previewClickableAvatar");
const infoBtn = document.getElementById("infoBtn");

let toastTimer = null;
function showStatusToast(){
  const isSelfProfile = (TARGET_UID && UID && TARGET_UID === UID);
  const on = isSelfProfile ? (CURRENT_SELF_ONLINE === true) : (CURRENT_TARGET_ONLINE === true);
  const label = isSelfProfile
    ? (on ? "Voc√™ est√° Online" : "Voc√™ est√° Offline")
    : (on ? "Online agora" : "Offline agora");

  toastDot.classList.toggle("on", on);
  toastDot.classList.toggle("off", !on);
  toastText.textContent = label;

  toastStatus.style.display = "inline-flex";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ toastStatus.style.display = "none"; }, 1600);
}
previewClickableCover.addEventListener("click", showStatusToast);
previewClickableAvatar.addEventListener("click", showStatusToast);
infoBtn.addEventListener("click", showStatusToast);

/* ====================== ‚úÖ SEGUIDORES (followers/{target}/{me}) ====================== */
let IS_FOLLOWING = false;
let TARGET_PROFILE_CACHE = { name:"Usu√°rio", avatarUrl:"" };

async function fetchMyAvatarUrl(){
  try{
    const s = await DB.ref("profiles/" + UID).once("value");
    const p = s.val() || {};
    return (p.avatarDataUrl || p.avatarUrl || "").toString();
  }catch(e){ return ""; }
}
async function fetchMyNameFromProfileOrLogin(){
  try{
    const s = await DB.ref("profiles/" + UID).once("value");
    const p = s.val() || {};
    return (p.name || USER_NAME || "Usu√°rio").toString();
  }catch(e){ return (USER_NAME || "Usu√°rio").toString(); }
}

function setFollowBtn(){
  // n√£o mostra se for voc√™ mesmo ou sem target
  if(!TARGET_UID || TARGET_UID === UID){
    followBtn.style.display = "none";
    return;
  }
  followBtn.style.display = "inline-flex";

  if(IS_FOLLOWING){
    followBtn.classList.add("ghost");
    followBtn.classList.remove("red");
    followBtn.innerHTML = `<i class="fa-solid fa-user-check"></i> Seguindo`;
  }else{
    followBtn.classList.remove("ghost");
    followBtn.classList.remove("red");
    followBtn.innerHTML = `<i class="fa-solid fa-user-plus"></i> Seguir`;
  }
}

async function toggleFollow(){
  if(!TARGET_UID) return;
  if(TARGET_UID === UID){
    alert("Voc√™ n√£o pode seguir voc√™ mesmo.");
    return;
  }
  if(precisaLogin()) return;
  startSelfPresence();

  // pega dados do seguidor
  const myName = await fetchMyNameFromProfileOrLogin();
  const myAvatar = await fetchMyAvatarUrl();

  const ref = DB.ref(`followers/${TARGET_UID}/${UID}`);
  const snap = await ref.once("value");
  const cur = snap.val();

  if(cur){
    await ref.remove().catch(()=>{});
  }else{
    await ref.set({
      uid: UID,
      userName: myName,
      avatarUrl: myAvatar || "",
      followedAt: firebase.database.ServerValue.TIMESTAMP
    }).catch(()=>{});
  }
}

function listenFollowState(){
  if(!TARGET_UID) return;

  // estado de "eu sigo este perfil?"
  DB.ref(`followers/${TARGET_UID}/${UID}`).on("value", s=>{
    IS_FOLLOWING = !!s.val();
    setFollowBtn();
  });

  // contador de seguidores
  DB.ref(`followers/${TARGET_UID}`).on("value", s=>{
    const obj = s.val() || {};
    const total = Object.keys(obj).length;
    followersCount.textContent = `${total} seguidor${total>1?"es":""}`;
  });
}

/* voltar */
function goBack(){
  if(PARAMS.back){
    window.location.href = PARAMS.back;
  }else{
    history.back();
  }
}
(function(){
  if(PARAMS.back) backBtn.style.display = "inline-flex";
})();

/* ====================== ‚úÖ V√çDEOS: autoplay SEM SOM + som s√≥ ao clicar ====================== */
function setupVideoAutoplay(container){
  const videos = (container || document).querySelectorAll("video[data-autopreview='1']");
  videos.forEach(v=>{
    v.muted = true;
    v.defaultMuted = true;
    v.setAttribute("muted", "");
    v.autoplay = true;
    v.setAttribute("autoplay", "");
    v.loop = true;
    v.setAttribute("loop", "");
    v.playsInline = true;
    v.setAttribute("playsinline", "");
    v.setAttribute("preload", "metadata");
    v.controls = false;

    const tryPlay = ()=>{
      const p = v.play();
      if(p && typeof p.catch === "function"){ p.catch(()=>{}); }
    };
    tryPlay();

    const wrap = v.closest(".videoWrap");
    const badge = wrap ? wrap.querySelector(".tapToSound") : null;
    if(badge) badge.classList.remove("hide");

    const onClick = ()=>{
      document.querySelectorAll("video[data-autopreview='1']").forEach(other=>{
        if(other !== v){
          other.muted = true;
          other.defaultMuted = true;
          other.setAttribute("muted","");
          const w = other.closest(".videoWrap");
          const b = w ? w.querySelector(".tapToSound") : null;
          if(b) b.classList.remove("hide");
        }
      });

      v.muted = false;
      v.defaultMuted = false;
      v.removeAttribute("muted");
      v.controls = true;
      tryPlay();

      if(badge) badge.classList.add("hide");
    };

    if(!v.__soundClickBound){
      v.addEventListener("click", onClick);
      v.__soundClickBound = true;
    }
  });
}

/* ====================== CARREGAR PERFIL ====================== */
async function loadProfile(){
  if(!TARGET_UID){
    profileName.textContent = "Perfil inv√°lido";
    brandTitle.textContent = "Pr√©via do Perfil";
    bioText.textContent = "Nenhum UID informado na URL. Use: ?uid=XXXX";
    setCover("");
    setAvatar("", "U");
    setStatus(false);
    cityText.textContent = "‚Äî";
    return;
  }

  DB.ref("profiles/" + TARGET_UID).on("value", snap=>{
    const p = snap.val() || {};
    const name = p.name || "Usu√°rio";
    const city = p.city || "Sem cidade";
    const bio  = p.bio  || "Sem biografia.";

    TARGET_PROFILE_CACHE = {
      name,
      avatarUrl: (p.avatarDataUrl || p.avatarUrl || "").toString()
    };

    profileName.textContent = name;
    brandTitle.textContent = name;
    cityText.textContent = city;
    bioText.textContent = bio;

    setCover(p.coverDataUrl || p.coverUrl || "");
    setAvatar(p.avatarDataUrl || p.avatarUrl || "", name);
  });

  DB.ref("presence/" + TARGET_UID).on("value", snap=>{
    const u = snap.val() || {};
    const last = u.lastActive || 0;
    const now = Date.now();
    const online = (u.online === true) && (now - last < 65000);
    setStatus(online);
  });
}

/* ====================== FEED DO USU√ÅRIO (curtir / comentar) ====================== */
let cachedName = "Usu√°rio";
let cachedAvatar = "";

/* fotos nos coment√°rios */
const avatarCache = {};
function getAvatarUrlFromProfile(p){
  return (p && (p.avatarDataUrl || p.avatarUrl || "")) || "";
}
function fetchAvatarUrl(uid){
  return new Promise((resolve)=>{
    if(!uid){ resolve(""); return; }
    if(avatarCache[uid] !== undefined){ resolve(avatarCache[uid]); return; }
    DB.ref("profiles/" + uid).once("value").then(s=>{
      const p = s.val() || {};
      const url = getAvatarUrlFromProfile(p) || "";
      avatarCache[uid] = url;
      resolve(url);
    }).catch(()=>{ avatarCache[uid]=""; resolve(""); });
  });
}

function postHTML(postId, d){
  let midia = "";
  if(d.mediaUrl){
    const isImg = (d.mediaType || "").startsWith("image/");
    if(isImg){
      midia = `<img src="${escapeHTML(d.mediaUrl)}" loading="lazy" alt="imagem">`;
    }else{
      midia = `
        <div class="videoWrap">
          <video
            src="${escapeHTML(d.mediaUrl)}"
            data-autopreview="1"
            muted
            autoplay
            loop
            playsinline
            preload="metadata"
          ></video>
          <div class="tapToSound"><i class="fa-solid fa-volume-high"></i> Toque para ouvir</div>
        </div>
      `;
    }
  }

  const texto = escapeHTML(d.text || "");
  const quando = d.createdAt ? fmtDate(d.createdAt) : "";

  const av = cachedAvatar
    ? `<img src="${escapeHTML(cachedAvatar)}" alt="avatar">`
    : `<div class="init">${escapeHTML(initials(cachedName))}</div>`;

  return `
    <div class="post" id="${escapeHTML(postId)}">
      <div class="postHead">
        <div class="postAvatar">${av}</div>
        <div style="min-width:0;">
          <div class="postName">${escapeHTML(cachedName)}</div>
          <div class="when">${escapeHTML(quando)}</div>
        </div>
      </div>

      ${texto ? `<p>${texto}</p>` : ""}

      <div class="mediaWrap">
        ${midia}
      </div>

      <div class="post-actions">
        <div style="text-align:center;">
          <div class="btn-action" id="btnLike_${escapeHTML(postId)}" onclick="curtir('${escapeHTML(postId)}')">üëç Curtir</div>
          <div class="contador" id="likesCount_${escapeHTML(postId)}"></div>
        </div>

        <div style="text-align:center;">
          <div class="btn-action" onclick="toggleComentarios('${escapeHTML(postId)}')">üí¨ Comentar</div>
          <div class="contador" id="commentsCount_${escapeHTML(postId)}"></div>
        </div>
      </div>

      <div class="coment-area" id="comentBox_${escapeHTML(postId)}">
        <div id="commentsList_${escapeHTML(postId)}" style="margin-bottom:12px;"></div>

        <input type="text" id="commentInput_${escapeHTML(postId)}"
          placeholder="Escreva um coment√°rio..."
          style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#3A3B3C;color:var(--fb-text);outline:none;">

        <button class="login-btn" style="margin-top:10px;width:100%;" onclick="enviarComentario('${escapeHTML(postId)}')">
          Enviar coment√°rio
        </button>
      </div>
    </div>
  `;
}

function toggleComentarios(postId){
  const box = document.getElementById("comentBox_"+postId);
  if(!box) return;
  box.style.display = (box.style.display === "block") ? "none" : "block";
}

async function curtir(postId){
  if(precisaLogin()) return;
  startSelfPresence();

  const likeRef = DB.ref(`likes/${postId}/${UID}`);
  const snap = await likeRef.once("value");
  const cur = snap.val();

  if(cur) await likeRef.remove();
  else await likeRef.set({
    type:"like",
    uid: UID,
    userName: USER_NAME,
    createdAt: firebase.database.ServerValue.TIMESTAMP
  });
}

async function enviarComentario(postId){
  if(precisaLogin()) return;
  startSelfPresence();

  const input = document.getElementById("commentInput_"+postId);
  if(!input) return;
  const texto = (input.value || "").trim();
  if(!texto) return;

  const commentId = "cmt_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  const myAvatarUrl = await fetchAvatarUrl(UID);

  await DB.ref(`comments/${postId}/${commentId}`).set({
    uid: UID,
    userName: USER_NAME,
    avatarUrl: myAvatarUrl || "",
    text: texto,
    createdAt: firebase.database.ServerValue.TIMESTAMP
  });
  input.value = "";
}

function listenLikes(postId){
  DB.ref("likes/" + postId).on("value", snap=>{
    const obj = snap.val() || {};
    const total = Object.values(obj).length;
    const mine = obj[UID];

    const btn = document.getElementById("btnLike_"+postId);
    const cont = document.getElementById("likesCount_"+postId);
    if(!btn || !cont) return;

    if(mine){
      btn.textContent = "üëç Voc√™ curtiu";
      btn.style.opacity = "1";
      btn.style.borderColor = "rgba(8,102,255,.35)";
      btn.style.boxShadow = "0 0 0 3px rgba(8,102,255,.12)";
    }else{
      btn.textContent = "üëç Curtir";
      btn.style.opacity = ".95";
      btn.style.borderColor = "rgba(255,255,255,.10)";
      btn.style.boxShadow = "none";
    }

    cont.textContent = total ? `${total} curtida${total>1?"s":""}` : "";
  });
}

function listenComments(postId){
  DB.ref("comments/" + postId).orderByChild("createdAt").on("value", async snap=>{
    const obj = snap.val() || {};
    const arr = Object.keys(obj).map(id=>({ id, ...obj[id] }))
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    const cont = document.getElementById("commentsCount_"+postId);
    const list = document.getElementById("commentsList_"+postId);
    if(!cont || !list) return;

    const total = arr.length;
    cont.textContent = total ? `${total} coment√°rio${total>1?"s":""}` : "";

    if(total === 0){
      list.innerHTML = `<div class="empty">Nenhum coment√°rio ainda.</div>`;
      return;
    }

    const htmlParts = await Promise.all(arr.map(async (c)=>{
      const nome = c.userName || "Usu√°rio";
      const txt = escapeHTML(c.text || "");
      const uid = c.uid || "";
      let url = (c.avatarUrl || "").trim();
      if(!url && uid) url = await fetchAvatarUrl(uid);

      const avatarHTML = url
        ? `<img src="${escapeHTML(url)}" alt="foto">`
        : `<div class="init">${escapeHTML(initials(nome))}</div>`;

      return `
        <div class="cRow">
          <div class="cHead">
            <div class="cAvatar">${avatarHTML}</div>
            <div class="cName">${escapeHTML(nome)}</div>
          </div>
          <div class="cText">üí¨ ${txt}</div>
        </div>
      `;
    }));

    list.innerHTML = htmlParts.join("");
  });
}

function listenFeed(){
  if(!TARGET_UID) return;

  DB.ref("profiles/" + TARGET_UID).on("value", snap=>{
    const p = snap.val() || {};
    cachedName = p.name || "Usu√°rio";
    cachedAvatar = p.avatarDataUrl || p.avatarUrl || "";
  });

  const ref = DB.ref("posts").limitToLast(300);
  ref.on("value", snap=>{
    const obj = snap.val() || {};
    const entries = Object.keys(obj)
      .map(id=>({ id, ...obj[id] }))
      .filter(p => (p.uid || "") === TARGET_UID)
      .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

    postsCount.textContent = `${entries.length} postagens`;

    if(entries.length === 0){
      feed.innerHTML = `<div class="empty">Este usu√°rio ainda n√£o postou nada.</div>`;
      return;
    }

    feed.innerHTML = entries.slice().reverse().map(p=> postHTML(p.id, p)).join("");

    setupVideoAutoplay(feed);

    entries.forEach(p=>{
      listenLikes(p.id);
      listenComments(p.id);
    });
  });
}

/* ====================== BOOT ====================== */
(async function boot(){
  setCover("");
  setAvatar("", "U");
  setStatus(false);

  startSelfPresence();
  listenSelfPresence();

  await loadProfile();
  listenFeed();
  listenFollowState();
  setFollowBtn();
})();
</script>

</body>
</html>
